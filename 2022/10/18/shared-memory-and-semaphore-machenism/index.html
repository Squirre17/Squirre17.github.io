<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>shared-memory-and-semaphore-machenism | Squirre17 Blog</title><meta name="keywords" content="wp"><meta name="author" content="Squirre17"><meta name="copyright" content="Squirre17"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="# 分类  管道 消息队列 信号 共享内存 信号量 套接字  # 共享内存 1234int shmget(key_t key, size_t size, int shmflg);void *shmat(int shmid, const void *shmaddr, int shmflg);int shmdt(const void *shmaddr);int shmctl(int shmid, in">
<meta property="og:type" content="article">
<meta property="og:title" content="shared-memory-and-semaphore-machenism">
<meta property="og:url" content="https://squirre17.github.io/2022/10/18/shared-memory-and-semaphore-machenism/index.html">
<meta property="og:site_name" content="Squirre17 Blog">
<meta property="og:description" content="# 分类  管道 消息队列 信号 共享内存 信号量 套接字  # 共享内存 1234int shmget(key_t key, size_t size, int shmflg);void *shmat(int shmid, const void *shmaddr, int shmflg);int shmdt(const void *shmaddr);int shmctl(int shmid, in">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://squirre17.github.io/imgs/yume2.png">
<meta property="article:published_time" content="2022-10-18T06:57:37.000Z">
<meta property="article:modified_time" content="2022-10-18T07:05:35.333Z">
<meta property="article:author" content="Squirre17">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://squirre17.github.io/imgs/yume2.png"><link rel="shortcut icon" href="/img/favicon-32x32.png"><link rel="canonical" href="https://squirre17.github.io/2022/10/18/shared-memory-and-semaphore-machenism/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'shared-memory-and-semaphore-machenism',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-18 15:05:35'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Squirre17 Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">7</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/imgs/yume2.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Squirre17 Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">shared-memory-and-semaphore-machenism</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-10-18T06:57:37.000Z" title="Created 2022-10-18 14:57:37">2022-10-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-10-18T07:05:35.333Z" title="Updated 2022-10-18 15:05:35">2022-10-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="shared-memory-and-semaphore-machenism"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="分类"><a class="markdownIt-Anchor" href="#分类">#</a> 分类</h1>
<ul>
<li>管道</li>
<li>消息队列</li>
<li>信号</li>
<li>共享内存</li>
<li>信号量</li>
<li>套接字</li>
</ul>
<h1 id="共享内存"><a class="markdownIt-Anchor" href="#共享内存">#</a> 共享内存</h1>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">shmget</span><span class="params">(<span class="type">key_t</span> key, <span class="type">size_t</span> size, <span class="type">int</span> shmflg)</span>;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">shmat</span><span class="params">(<span class="type">int</span> shmid, <span class="type">const</span> <span class="type">void</span> *shmaddr, <span class="type">int</span> shmflg)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">shmdt</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *shmaddr)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">shmctl</span><span class="params">(<span class="type">int</span> shmid, <span class="type">int</span> cmd, <span class="keyword">struct</span> shmid_ds *buf)</span>;</span><br></pre></td></tr></table></figure>
<pre><code>   shmget()  returns  the identifier of the System V shared memory segment associated with the value of the argument key.  It may be used either to obtain the identifier of a previously created shared memory segment  (when shmflg is zero and key does not have the value IPC_PRIVATE), or to create a new set.
</code></pre>
<p>shmflg 和文件的控制权限一样。<br>
注意到如果 key 是 <code>IPC_PRIVATE</code> ，那就相当于匿名 shm，只能用于有亲属关系的进程通信。</p>
<pre><code>   shmat()  attaches  the  System V shared memory segment identified by shmid to the address space of the calling process.  The attaching address is specified by shmaddr with one of the following criteria:
</code></pre>
<p>shmaddr 一般为空 让操作系统决定</p>
<pre><code>   shmdt() detaches the shared memory segment located at the address specified by shmaddr from the address  space of the calling process.

   shmctl()  performs  the control operation specified by cmd on the System V shared memory segment whose identifier is given in shmid.
</code></pre>
<p>删除共享内存用 <code>PC_RMID</code></p>
<h2 id="实操1"><a class="markdownIt-Anchor" href="#实操1">#</a> 实操 1</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PATHNAME <span class="string">&quot;.&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROJ_ID 0x6666</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> shmid;</span><br><span class="line">    <span class="type">key_t</span> key = ftok(PATHNAME, PROJ_ID);</span><br><span class="line">    assert(key != <span class="number">-1</span>);</span><br><span class="line">    shmid = shmget(key, PAGE_SIZE, <span class="number">0640</span>|IPC_CREAT);</span><br><span class="line">    assert(shmid != <span class="number">-1</span>);</span><br><span class="line">    <span class="type">char</span> *shmptr = shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(</span><br><span class="line">        <span class="string">&quot;shmptr is %p\n&quot;</span></span><br><span class="line">        <span class="string">&quot;procid is %d\n&quot;</span></span><br><span class="line">        ,shmptr, getpid()</span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">memset</span>(shmptr, <span class="string">&quot;A&quot;</span>, <span class="number">0x10</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    shmdt(shmptr);</span><br><span class="line">    <span class="type">int</span> res = shmctl(shmid, IPC_RMID, <span class="number">0</span>);</span><br><span class="line">    assert(res != <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用一个可以访问的目录创建 shmid（proj 号和当前目录可以返回一个唯一的 shmid）<br>
在当前路径下创建一次共享内存 不删除的话就一直存在。</p>
<p>用命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ipcs -m # 查看所有共享内存</span><br><span class="line">ipcrm -m &lt;shmid&gt; # 删除一个共享内存</span><br></pre></td></tr></table></figure>
<h2 id="实操2"><a class="markdownIt-Anchor" href="#实操2">#</a> 实操 2</h2>
<p>server.c 用来创建共享内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PATHNAME <span class="string">&quot;.&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROJ_ID 0x6666</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">key_t</span> key = ftok(PATHNAME, PROJ_ID);</span><br><span class="line">    assert(key != <span class="number">-1</span>);</span><br><span class="line">    <span class="type">int</span> shmid;</span><br><span class="line">    <span class="keyword">if</span>((shmid = shmget(key, PAGE_SIZE, IPC_CREAT | IPC_EXCL | <span class="number">0666</span>)) == <span class="number">-1</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;shmget&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *shmptr = shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i++ &lt; <span class="number">26</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;client# %s\n&quot;</span>,shmptr);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    shmdt(shmptr);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    assert(shmctl(shmid,IPC_RMID,<span class="literal">NULL</span>) != <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client.c 用来连上共享内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PATHNAME <span class="string">&quot;.&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROJ_ID 0x6666</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">key_t</span> key = ftok(PATHNAME,PROJ_ID);</span><br><span class="line">    assert(key != <span class="number">-1</span>);</span><br><span class="line">    <span class="type">int</span> shmid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>((shmid = shmget(key, PAGE_SIZE, <span class="number">0</span>)) == <span class="number">-1</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;shmget&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *shmptr = shmat(shmid,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; <span class="number">26</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        shmptr[i] = <span class="string">&#x27;A&#x27;</span> + i;</span><br><span class="line">        i++;</span><br><span class="line">        shmptr[i] = <span class="number">0</span>;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    shmdt(shmptr);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2022/10/18/shared-memory-and-semaphore-machenism/1.png" alt="1"></p>
<h1 id="信号量"><a class="markdownIt-Anchor" href="#信号量">#</a> 信号量</h1>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">semget</span><span class="params">(<span class="type">key_t</span> key, <span class="type">int</span> nsems, <span class="type">int</span> semflg)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">semop</span><span class="params">(<span class="type">int</span> semid, <span class="keyword">struct</span> sembuf *sops, <span class="type">size_t</span> nsops)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">semctl</span><span class="params">(<span class="type">int</span> semid, <span class="type">int</span> semnum, <span class="type">int</span> cmd, ...)</span>;</span><br></pre></td></tr></table></figure>
<pre><code>   The  semget()  system  call  returns the System V semaphore set identifier associated with the argument key.
</code></pre>
<p>创建方法两种 一种用 key 里的 <code>IPC_PRIVATE</code> ，一种用 semflg 里的 <code>IPC_CREAT</code> <br>
nsems 是信号量个数。</p>
<p>semop 就是等待锁和释放锁<br>
在 semctl 中 需要用到 <code>semun</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">semun</span> &#123;</span></span><br><span class="line">    <span class="type">int</span>              val;    <span class="comment">/* Value for SETVAL */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> *<span class="title">buf</span>;</span>    <span class="comment">/* Buffer for IPC_STAT, IPC_SET */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span>  *<span class="built_in">array</span>;  <span class="comment">/* Array for GETALL, SETALL */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span>  *__<span class="title">buf</span>;</span>  <span class="comment">/* Buffer for IPC_INFO</span></span><br><span class="line"><span class="comment">                                (Linux-specific) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>semop 中 需要用到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span>&#123;</span></span><br><span class="line">         <span class="type">unsigned</span> <span class="type">short</span> sem_num;  <span class="comment">/* semaphore number */</span></span><br><span class="line">         <span class="type">short</span>          sem_op;   <span class="comment">/* semaphore operation */</span></span><br><span class="line">         <span class="type">short</span>          sem_flg;  <span class="comment">/* operation flags */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong>sem_op 参数</strong>：</p>
<ul>
<li>sem_op &gt; 0          信号加上 sem_op 的值，表示进程释放控制的资源；</li>
<li>sem_op = 0          如果没有设置 IPC_NOWAIT，则调用进程进入睡眠状态，直到信号量的值为 0；否则进程不回睡眠，直接返回 EAGAIN</li>
<li>sem_op &lt; 0          信号加上 sem_op 的值。若没有设置 IPC_NOWAIT ，则调用进程阻塞，直到资源可用；否则进程直接返回 EAGAIN</li>
</ul>
</li>
<li>
<p><strong>sem_flg 参数</strong>：</p>
<ul>
<li>该参数可设置为 IPC_NOWAIT 或 SEM_UNDO 两种状态。只有将 sem_flg 指定为 SEM_UNDO 标志后，semadj （所指定信号量针对调用进程的调整值）才会更新。   此外，如果此操作指定 SEM_UNDO，系统更新过程中会撤消此信号灯的计数（semadj）。此操作可以随时进行 — 它永远不会强制等待的过程。调用进程必须有改变信号量集的权限。</li>
</ul>
</li>
<li></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CSEM</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">private:</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">semun</span>  // 用于信号灯操作的共同体。</span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> *<span class="title">buf</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> *arry;</span><br><span class="line">  &#125;;</span><br><span class="line"> </span><br><span class="line">  <span class="type">int</span>  sem_id;  <span class="comment">// 信号灯描述符。</span></span><br><span class="line">public:</span><br><span class="line">  <span class="type">bool</span> <span class="title function_">init</span><span class="params">(<span class="type">key_t</span> key)</span>; <span class="comment">// 如果信号灯已存在，获取信号灯；如果信号灯不存在，则创建信号灯并初始化。</span></span><br><span class="line">  <span class="type">bool</span> <span class="title function_">wait</span><span class="params">()</span>;          <span class="comment">// 等待信号灯挂出。</span></span><br><span class="line">  <span class="type">bool</span> <span class="title function_">post</span><span class="params">()</span>;          <span class="comment">// 挂出信号灯。</span></span><br><span class="line">  <span class="type">bool</span> <span class="title function_">destroy</span><span class="params">()</span>;       <span class="comment">// 销毁信号灯。</span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">   CSEM sem;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// 用key值0x5000 初始信号灯。</span></span><br><span class="line">   <span class="keyword">if</span> (sem.init(<span class="number">0x5000</span>)==<span class="literal">false</span>) </span><br><span class="line">    &#123; <span class="built_in">printf</span>(<span class="string">&quot;sem.init failed.\n&quot;</span>); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sem.init ok\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 等待信信号挂出，等待成功后，将持有锁。</span></span><br><span class="line">   <span class="keyword">if</span> (sem.wait() == <span class="literal">false</span>) </span><br><span class="line">    &#123; <span class="built_in">printf</span>(<span class="string">&quot;sem.wait failed.\n&quot;</span>); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sem.wait ok\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">   sleep(<span class="number">10</span>);  <span class="comment">// 在sleep的过程中，运行其它的book259程序将等待锁。</span></span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 挂出信号灯，释放锁。</span></span><br><span class="line">   <span class="keyword">if</span> (sem.post() == <span class="literal">false</span>) </span><br><span class="line">    &#123; <span class="built_in">printf</span>(<span class="string">&quot;sem.post failed.\n&quot;</span>); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sem.post ok\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 销毁信号灯。</span></span><br><span class="line">   <span class="comment">// if (sem.destroy()==false) &#123; printf(&quot;sem.destroy failed.\n&quot;); return -1; &#125;</span></span><br><span class="line">   <span class="comment">// printf(&quot;sem.destroy ok\n&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">bool</span> <span class="title function_">CSEM::init</span><span class="params">(<span class="type">key_t</span> key)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 获取信号灯。</span></span><br><span class="line">  <span class="keyword">if</span> ( (sem_id=semget(key,<span class="number">1</span>,<span class="number">0640</span>)) == <span class="number">-1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 如果信号灯不存在，创建它。</span></span><br><span class="line">    <span class="comment">// No semaphore set exists for key and semflg did not specify IPC_CREAT.</span></span><br><span class="line">    <span class="keyword">if</span> (errno == ENOENT) </span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (sem_id=semget(key,<span class="number">1</span>,<span class="number">0640</span>|IPC_CREAT)) == <span class="number">-1</span>)</span><br><span class="line">        &#123; perror(<span class="string">&quot;init 1 semget()&quot;</span>); <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// 信号灯创建成功后，还需要把它初始化成可用的状态。</span></span><br><span class="line">      <span class="class"><span class="keyword">union</span> <span class="title">semun</span> <span class="title">sem_union</span>;</span></span><br><span class="line">      <span class="comment">// 就是设置值为1</span></span><br><span class="line">      sem_union.val = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (semctl(sem_id,<span class="number">0</span>,SETVAL,sem_union) &lt;  <span class="number">0</span>) </span><br><span class="line">        &#123; perror(<span class="string">&quot;init semctl()&quot;</span>); <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123; perror(<span class="string">&quot;init 2 semget()&quot;</span>); <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">bool</span> <span class="title function_">CSEM::destroy</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (semctl(sem_id,<span class="number">0</span>,IPC_RMID) == <span class="number">-1</span>) </span><br><span class="line">    &#123; perror(<span class="string">&quot;destroy semctl()&quot;</span>); <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">bool</span> <span class="title function_">CSEM::wait</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sem_b</span>;</span></span><br><span class="line">  sem_b.sem_num = <span class="number">0</span>;</span><br><span class="line">  sem_b.sem_op = <span class="number">-1</span>;</span><br><span class="line">  sem_b.sem_flg = SEM_UNDO;</span><br><span class="line">  <span class="keyword">if</span> (semop(sem_id, &amp;sem_b, <span class="number">1</span>) == <span class="number">-1</span>) &#123; perror(<span class="string">&quot;wait semop()&quot;</span>); <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">bool</span> <span class="title function_">CSEM::post</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sem_b</span>;</span></span><br><span class="line">  sem_b.sem_num = <span class="number">0</span>;</span><br><span class="line">  sem_b.sem_op = <span class="number">1</span>;  </span><br><span class="line">  sem_b.sem_flg = SEM_UNDO;</span><br><span class="line">  <span class="keyword">if</span> (semop(sem_id, &amp;sem_b, <span class="number">1</span>) == <span class="number">-1</span>) &#123; perror(<span class="string">&quot;post semop()&quot;</span>); <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个代码最重要的一点是，在 semop 为 - 1 这里<br>
等待一个其他进程执行 <code>(semop(sem_id, &amp;sem_b, 1)</code>  ，其中 <code>sem_b.sem_op = 1</code> , 也就是释放一个资源.<br>
 而最初的资源数量是 <code>SETVAL</code>  所创建的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">CSEM::wait</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sem_b</span>;</span></span><br><span class="line">  sem_b.sem_num = <span class="number">0</span>;</span><br><span class="line">  sem_b.sem_op = <span class="number">-1</span>;</span><br><span class="line">  sem_b.sem_flg = SEM_UNDO;</span><br><span class="line">  <span class="keyword">if</span> (semop(sem_id, &amp;sem_b, <span class="number">1</span>) == <span class="number">-1</span>) &#123; perror(<span class="string">&quot;wait semop()&quot;</span>); <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="信号量对共享内存加锁"><a class="markdownIt-Anchor" href="#信号量对共享内存加锁">#</a> 信号量对共享内存加锁</h1>
<p>就是在共享内存操作之中使用上文提到的 wait 和 post，这其实就是个 P-V 操作，搞这么神神叨叨的。<br>
然后这 PV 之间才对共享内存操作.<br>
 部分代码再上文。<br>
client.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *shmptr = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">shm_register</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> shmid = <span class="built_in">shmget</span>( (<span class="type">key_t</span>)<span class="number">0x5005</span>, <span class="number">1024</span>, <span class="number">0640</span>|IPC_CREAT);</span><br><span class="line">    <span class="keyword">if</span> ( shmid == <span class="number">-1</span> )</span><br><span class="line">      &#123; <span class="built_in">printf</span>(<span class="string">&quot;shmget() failed\n&quot;</span>);  <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line">    shmptr = (<span class="type">char</span> *)<span class="built_in">shmat</span>(shmid, <span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> shmid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   CSEM sem;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// 用key值0x5000 初始信号灯。</span></span><br><span class="line">   <span class="keyword">if</span> (sem.<span class="built_in">init</span>(<span class="number">0x5000</span>)==<span class="literal">false</span>) </span><br><span class="line">    &#123; <span class="built_in">printf</span>(<span class="string">&quot;sem.init failed.\n&quot;</span>); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sem.init ok\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 等待信信号挂出，等待成功后，将持有锁。</span></span><br><span class="line">   <span class="keyword">if</span> (sem.<span class="built_in">wait</span>() == <span class="literal">false</span>) </span><br><span class="line">    &#123; <span class="built_in">printf</span>(<span class="string">&quot;sem.wait failed.\n&quot;</span>); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sem.wait ok\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// 申请一个共享内存并将shmptr指过去</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Proc1 write 0x10 A to shm&quot;</span>);</span><br><span class="line">   <span class="type">int</span> shmid = <span class="built_in">shm_register</span>();</span><br><span class="line">   <span class="built_in">memset</span>(shmptr, <span class="string">&#x27;A&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">   <span class="built_in">getchar</span>();</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 挂出信号灯，释放锁。</span></span><br><span class="line">   <span class="keyword">if</span> (sem.<span class="built_in">post</span>() == <span class="literal">false</span>) </span><br><span class="line">    &#123; <span class="built_in">printf</span>(<span class="string">&quot;sem.post failed.\n&quot;</span>); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sem.post ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">getchar</span>();</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Proc1 shm contents: %s\n&quot;</span>, shmptr);</span><br><span class="line">   <span class="comment">//detach shared memory</span></span><br><span class="line">   <span class="built_in">shmdt</span>(shmptr);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 销毁信号灯。</span></span><br><span class="line">   <span class="comment">// if (sem.destroy()==false) &#123; printf(&quot;sem.destroy failed.\n&quot;); return -1; &#125;</span></span><br><span class="line">   <span class="comment">// printf(&quot;sem.destroy ok\n&quot;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>server.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *shmptr = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">shm_attach</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> shmid = <span class="built_in">shmget</span>( (<span class="type">key_t</span>)<span class="number">0x5005</span>, <span class="number">1024</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( shmid == <span class="number">-1</span> )</span><br><span class="line">      &#123; <span class="built_in">printf</span>(<span class="string">&quot;shmget() failed\n&quot;</span>);  <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line">    shmptr = (<span class="type">char</span> *)<span class="built_in">shmat</span>(shmid, <span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> shmid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   CSEM sem;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// 用key值0x5000 初始信号灯。</span></span><br><span class="line">   <span class="keyword">if</span> (sem.<span class="built_in">init</span>(<span class="number">0x5000</span>)==<span class="literal">false</span>) </span><br><span class="line">    &#123; <span class="built_in">printf</span>(<span class="string">&quot;sem.init failed.\n&quot;</span>); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sem.init ok\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 等待信信号挂出，等待成功后，将持有锁。</span></span><br><span class="line">   <span class="keyword">if</span> (sem.<span class="built_in">wait</span>() == <span class="literal">false</span>) </span><br><span class="line">    &#123; <span class="built_in">printf</span>(<span class="string">&quot;sem.wait failed.\n&quot;</span>); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sem.wait ok\n&quot;</span>);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// 申请一个共享内存并将shmptr指过去</span></span><br><span class="line">   <span class="type">int</span> shmid = <span class="built_in">shm_attach</span>();</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Proc2 contents is %s\n&quot;</span>, shmptr);</span><br><span class="line">   <span class="built_in">memset</span>(shmptr, <span class="string">&#x27;B&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">   <span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 挂出信号灯，释放锁。</span></span><br><span class="line">   <span class="keyword">if</span> (sem.<span class="built_in">post</span>() == <span class="literal">false</span>) </span><br><span class="line">    &#123; <span class="built_in">printf</span>(<span class="string">&quot;sem.post failed.\n&quot;</span>); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;sem.post ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//detach shared memory</span></span><br><span class="line">   <span class="built_in">shmdt</span>(shmptr);</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 销毁信号灯。</span></span><br><span class="line">   <span class="comment">// if (sem.destroy()==false) &#123; printf(&quot;sem.destroy failed.\n&quot;); return -1; &#125;</span></span><br><span class="line">   <span class="comment">// printf(&quot;sem.destroy ok\n&quot;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>client 先初始化信号量，然后获取资源，申请到共享内存，写入’A’，释放资源</li>
<li>server 连上这个信号量，连上这个 shm，打印出 client 写入的’A’，获取资源，写入’B’</li>
<li>client 释放资源之后再看内存，已经变成’B’的形状了</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/2022/10/18/shared-memory-and-semaphore-machenism/2.png" alt="2"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="Squirre17">Squirre17</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://squirre17.github.io/2022/10/18/shared-memory-and-semaphore-machenism/">https://squirre17.github.io/2022/10/18/shared-memory-and-semaphore-machenism/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://Squirre17.github.io">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="/imgs/yume2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/10/26/Ghidra-INDIRECT-explanation/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/yuigahama1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Ghidra-INDIRECT-explanation</div></div></a></div><div class="next-post pull-right"><a href="/2022/10/18/llvm-init/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/aijo1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">llvm-init</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2021/08/11/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/" title="CVE-2021-4030 polkit-pkexec 本地提权分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/yume1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-11</div><div class="title">CVE-2021-4030 polkit-pkexec 本地提权分析</div></div></a></div><div><a href="/2022/09/11/kernel-notebook-three-solutions/" title="kernel-notebook-three-solutions"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/takina1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-11</div><div class="title">kernel-notebook-three-solutions</div></div></a></div><div><a href="/2022/09/12/2022-cakeCTF-pwn-wp/" title="2022-cakeCTF-pwn-wp"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/chisato1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">2022-cakeCTF-pwn-wp</div></div></a></div><div><a href="/2022/09/16/a-easy-virtualization-challenge/" title="a-easy-virtualization-challenge"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/kurisu1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-16</div><div class="title">a-easy-virtualization-challenge</div></div></a></div><div><a href="/2022/09/29/hexp-2020-kernel-rop/" title="hexp-2020-kernel-rop"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/aijo2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-29</div><div class="title">hexp-2020-kernel-rop</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Squirre17</div><div class="author-info__description">introvert</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Squirre17"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Squirre17" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:Ler2sq@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Beta Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E7%B1%BB"><span class="toc-number">1.</span> <span class="toc-text"> 分类</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="toc-number">2.</span> <span class="toc-text"> 共享内存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D1"><span class="toc-number">2.1.</span> <span class="toc-text"> 实操 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D2"><span class="toc-number">2.2.</span> <span class="toc-text"> 实操 2</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="toc-number">3.</span> <span class="toc-text"> 信号量</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F%E5%AF%B9%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E5%8A%A0%E9%94%81"><span class="toc-number">4.</span> <span class="toc-text"> 信号量对共享内存加锁</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/10/30/debugger-impl/" title="debugger-impl"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/hitoli1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="debugger-impl"/></a><div class="content"><a class="title" href="/2022/10/30/debugger-impl/" title="debugger-impl">debugger-impl</a><time datetime="2022-10-30T06:46:09.000Z" title="Created 2022-10-30 14:46:09">2022-10-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/26/Ghidra-INDIRECT-explanation/" title="Ghidra-INDIRECT-explanation"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/yuigahama1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ghidra-INDIRECT-explanation"/></a><div class="content"><a class="title" href="/2022/10/26/Ghidra-INDIRECT-explanation/" title="Ghidra-INDIRECT-explanation">Ghidra-INDIRECT-explanation</a><time datetime="2022-10-26T10:05:02.000Z" title="Created 2022-10-26 18:05:02">2022-10-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/18/shared-memory-and-semaphore-machenism/" title="shared-memory-and-semaphore-machenism"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/yume2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="shared-memory-and-semaphore-machenism"/></a><div class="content"><a class="title" href="/2022/10/18/shared-memory-and-semaphore-machenism/" title="shared-memory-and-semaphore-machenism">shared-memory-and-semaphore-machenism</a><time datetime="2022-10-18T06:57:37.000Z" title="Created 2022-10-18 14:57:37">2022-10-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/18/llvm-init/" title="llvm-init"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/aijo1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="llvm-init"/></a><div class="content"><a class="title" href="/2022/10/18/llvm-init/" title="llvm-init">llvm-init</a><time datetime="2022-10-18T02:27:10.000Z" title="Created 2022-10-18 10:27:10">2022-10-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/29/hexp-2020-kernel-rop/" title="hexp-2020-kernel-rop"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/imgs/aijo2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="hexp-2020-kernel-rop"/></a><div class="content"><a class="title" href="/2022/09/29/hexp-2020-kernel-rop/" title="hexp-2020-kernel-rop">hexp-2020-kernel-rop</a><time datetime="2022-09-29T14:53:15.000Z" title="Created 2022-09-29 22:53:15">2022-09-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Squirre17</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>